---
title: Публичные и внутренние формы. Контроль доступа
kbId: 4789
tags:
    - анонимная ссылка
    - внутренняя форма
    - внешние страницы
    - внешняя форма
    - внешняя ссылка
    - внешняя страница
    - форма
    - формы для внешних пользователей
    - доступ к форме
    - контроль доступа
    - ограничение доступа к форме
    - публичная форма
    - разграничение доступа
hide:
    - tags
---

# Публичные, внутренние и внешние формы. Контроль доступа {: #form_access_control }

## Введение {: #form_access_control_intro }

Для любого шаблона (кроме шаблона процесса) можно создать неограниченное число форм. На них можно поместить разные атрибуты, и каждая форма может предназначаться для отдельной категории пользователей.

Доступ пользователей к форме определяется с помощью **[ролей][roles]** и **типа формы**.

Здесь представлены инструкции по контролю доступа к формам посредством **типа формы**, а также по созданию ссылок на формы для внешних пользователей.

!!! question "Определения"

    Предусмотрено три **типа форм**: **публичная**, **внутренняя**, **внешняя**.

    - **Публичные** и **внутренние** формы предназначены для пользователей, выполнивших вход в **{{ productName }}**.
        - К **публичной** форме можно перейти с помощью селектора форм <i class="fa-light fa-angle-down anchor"></i> рядом с заголовком записи.
        - **Внутренняя** форма не отображается в селекторе форм.
            - **Внутренняя** форма отображается, только если она вложена в другую форму или указана в качестве формы для записей (например, при запуске процесса, при создании записи, в диалоговых окнах).
            - К **внутренней** форме можно перейти по прямой ссылке.
        - Вложенная форма отображается в составе родительской формы независимо от того, является ли она **внутренней** или **публичной**, и независимо от разрешения на просмотр вложенной формы в роли пользователя.
        - Ни **внутренняя**, ни **публичная** форма не отображается, если роль пользователя не разрешает просмотр данной формы.
        - По умолчанию формы являются **публичными**. Чтобы ограничить доступ к форме через селектор форм, необходимо сменить тип формы на **внутреннюю**.

        См. _[Пример настройки внутренней формы для ограничения доступа к ней](#form_access_control_internal_example)_.

    - **Внешние формы** предназначены для пользователей мобильного приложения и мобильных браузеров, у которых нет аккаунта в **{{ productName }}**.
        - К **внешней форме** можно перейти по специальной ссылке без входа в **{{ productName }}**.

        См. _[Пример создания ссылки на внешнюю форму](#form_access_control_external_link)_.

!!! note "Доступ к стартовым формам и формам пользовательских задач процессов"

    В **начальном событии** и **пользовательской задаче** отображается только определённая форма связанного шаблона записи и **селектор форм недоступен**.

    [**Стартовая форма** и **форма пользовательской задачи**][process_diagram_forms] всегда являются **публичными**.

    Стартовые формы и формы пользовательских задач **не могут быть внешними**.

## Пример настройки внутренней формы для ограничения доступа к ней {: #form_access_control_internal_example }

В качестве примера создадим в шаблоне записи две формы и разграничим доступ к ним:

- _Клиент_ — **публичная** форма, будет доступна через селектор форм <i class="fa-light  fa-angle-down  anchor"></i> наряду с **основной формой** шаблона.
- _Диспетчер_ — **внутренняя** форма, не будет доступна через селектор форм. Пользователь сможет перейти к этой форме только по прямой ссылке, например, отправленной в эл. письме.

### Настройка форм {: #form_access_control_configure }

1. Создайте приложение _«Оформление заявок»_.
2. Создайте шаблон записи _«Заявки»_ со следующими атрибутами:

    | Название                | Тип                 | Свойства                                                                        |
    | ----------------------- | ------------------- | ------------------------------------------------------------------------------- |
    | _Тип ТС_                | **Список значений** | Добавьте значения _«легковой автомобиль»_, _«автобус»_, _«грузовой автомобиль»_ |
    | _Количество пассажиров_ | **Число**           | **Количество знаков после запятой: 0**                                          |
    | _Водитель_              | **Аккаунт**         |                                                                                 |

3. Поместите на **основную форму** шаблона атрибуты _«Тип ТС»_ и _«Количество пассажиров»_.
4. Создайте форму _«Клиент»_ и поместите на неё атрибут _«Количество пассажиров»_.
5. Создайте форму _«Диспетчер»_ и поместите на неё атрибуты _«Тип ТС»_, _«Количество пассажиров»_, _«Водитель»_.
6. В свойствах формы _«Диспетчер»_ выберите **тип** «**Внутренняя**».

### Тестирование внешней формы {: #form_access_control_test .pageBreakBefore }

1. Создайте новую запись в шаблоне _«Заявки»_.
2. Откроется основная форма шаблона.
3. Нажмите селектор форм <i class="fa-light fa-angle-down  anchor"></i> рядом с заголовком записи:

    - В раскрывающемся списке под селектором будут отображаться **основная форма** шаблона и форма _«Клиент»_.
    - Форма _«Диспетчер»_ в списке отображаться не будет.

4. Выберите и просмотрите форму _«Клиент»_.
5. Перейдите к форме _«Диспетчер»_, используя ссылку вида:

    ``` html
    http://<hostname>/#form/<oa.XX>/<form.XX>/<RecordID>
    ```

    Здесь:

    - `http://<hostname>/` — адрес сервера **{{ productName }}**;
    - `<oa.XX>` — ID шаблона записи _«Заявки»_ (его видно в [списке шаблонов][templates_view_in_app]);
    - `<form.XX>` — ID формы _«Диспетчер»_ (его видно в адресной строке браузера в [конструкторе формы][forms]);
    - `<RecordID>` — ID записи _«Заявки»_.

## Пример создания ссылки на внешнюю форму {: #form_access_control_external_form }

Рассмотрим пример настройки ссылки на внешнюю форму _«Клиент»_ из _[предыдущего примера](#form_access_control_configure)_, чтобы любой клиент мог оставлять заявку, не выполняя вход в **{{ productName }}**.

Для формирования ссылки на внешнюю форму используется метод System Core API `/Base/EncryptedNavigationReferenceService/Generate`, поэтому **вам потребуется доступ к API**.

См. _«[Аутентификация для доступа к API][api_intro_authentication]»_ и _«[Методы System Core API][api_system_core_encrypted_navigation_reference]»_.

!!! warning "Логика работы внешних форм"

    Если для создана ссылка на внешнюю форму, она действует следующим образом:
    
    - Пользователь переходит по ссылке на внешнюю форму:
        - если пользователь не вошёл в **{{ productName }}**, для него будет создан аккаунт в группе «**Анонимные пользователи**» с соответствующими разрешениями;
        - если пользователь перед открытием ссылки вошёл в **{{ productName }}**, он будет работать обычным образом с учётом разрешений своего аккаунта.
    - Если в ссылке закодированы значения атрибутов, форма будет заполнена этими данными.
    - Форма откроется для пользователя.
    - Пользователь заполнит и сохранит форму.
    - При сохранении формы будет создана запись в шаблоне, к которому относится форма.
    
!!! note "Особенности внешних форм"

    - Внешние ссылки работают только в мобильном приложении и мобильном браузере.
    - Для обработки данных формы применяются разрешения, настроенные в роли, которая назначена группе «**Анонимные пользователи**».

!!! question "Данные для формирования ссылки на внешнюю форму"

    Для формирования ссылки на внешнюю форму соберите следующие данные:
    
    - `<your-host>` — URL экземпляра **{{ productName }}**;
    - `SolutionId` — `строка` вида `sol.XXX`, ID приложения, к которому относится форма;
    - `ObjectId` — `строка` вида `oa.XXX`, ID шаблона записи, к которому относится форма;
    - `TargetId` — `строка` вида `form.XXX`, ID формы, которую должны открывать внешние пользователи;
    - `UserCommandId` — `строка` вида `event.XXX`, ID кнопки, которую требуется добавить на форму (**необязательный параметр**). Эта кнопка будет добавлена к кнопкам, настроенным с помощью конструктора формы.
    - Объект со значениями атрибутов для предварительного заполнения формы (**необязательный аргумент**):

        ``` json
        "PredefinedData":
        {
            "attribute1SystemName": "value",
            "attribute2SystemName": "value",
            ...
            "attributeNSystemName": "value"
        }
        ```

1. Соберите следующие данные для формирования ссылки:

    - ID приложения _«Оформление заявок»_, например `sol.1`;
    - ID шаблона _«Заявки»_, например `oa.1`;
    - ID формы _«Клиент»_, например `form.1`;
    - Значение атрибута _«Количество пассажиров»_ для заполнения формы, например `2`.

2. Выполните `POST`‑запрос к методу `Base/EncryptedNavigationReferenceService/Generate`:

    ``` bash
    curl -X POST \
    "https://<your-host>/api/public/system/Base/EncryptedNavigationReferenceService/Generate" \
    -H "Content-Type: application/json" \
    -u <username>:<password> \
    -d '{
        "SolutionId": "sol.1",
        "ObjectId": "oa.1",
        "TargetId": "form.1",
        "TargetType": "Form"
        }'
    ```

    Здесь: `"TargetType": "Form"` — **обязательный** фиксированный параметр, который **не следует изменять**.

    !!! warning "Подставьте фактические ID"

        Не забудьте указать в запросе фактические идентификаторы сущностей из своего экземпляра **{{ productName }}**.

3. В ответ придёт сгенерированная ссылка на форму вида:

    ```
    "https://<your-host>/Resolve?data=<encryptedData>"
    ```

4. Проверьте, что ссылка сформирована корректно, с помощью метода `Base/EncryptedNavigationReferenceService/Decrypt`, указав в теле запроса закодированную строку `<encryptedData>` (**без части `https://<your-host>/Resolve?data=`**):

    ```bash
    curl -X POST \
    "https://<your-host>/api/public/system/Base/EncryptedNavigationReferenceService/Decrypt" \
    -H "Content-Type: application/json" \
    -u <username>:<password> \
    -d "<encrypted>"
    ```

5. В ответ должен прийти объект со свойствами целевой формы:

    ``` json
    {
        "SolutionId": "sol.1",
        "ObjectId": "oa.1",
        "TargetId": "form.1",
        "TargetType": "Form"
    }
    ```

### Тестирование внешней формы {: #form_access_control_external_form_test .pageBreakBefore }

1. Откройте браузер **на мобильном устройстве** в режиме «**Инкогнито**», чтобы протестировать форму от лица внешнего пользователя.
2. Вставьте в адресную строку ссылку на внешнюю форму вида:

    ```html
    https://<your-host>/Resolve?data=<encryptedData>
    ```

3. Должна открыться форма _«Клиент»_.
4. Заполните и сохраните форму.
5. Откройте браузер на компьютере.
6. Войдите в **{{ productName }}**.
7. Удостоверьтесь, что в шаблоне _«Заявки»_ появилась запись, заполненная с помощью внешней формы на мобильном устройстве.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- _[Формы. Определения, редактирование, удаление, использование списка форм][forms]_
- _[Стартовая форма и форма пользовательской задачи][process_diagram_forms]_
- _[Роли в приложении. Определения, настройка, объединение, удаление][roles]_

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

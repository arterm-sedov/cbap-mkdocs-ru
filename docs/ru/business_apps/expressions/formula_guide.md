---
title: 'Язык формул. Общие сведения'
kbId: 4999
---

[](){: #formula_introduction }
# Язык формул. Общие сведения {: #formula_guide }

## Описание языка формул {{ companyName }} {: #formula_guide_description}

Настройка рабочей среды и пользовательского интерфейса **{{ productName }}** производится простым перетаскиванием элементов и не требует программирования.

В случае если ваш бизнес требует нетривиального подхода, воспользуйтесь возможностями языка формул Comindware, легкого, но эффективного языка программирования, встроенного в продукт.

С помощью формул вы сможете неограниченно масштабировать бизнес-процессы в согласии с нуждами вашего бизнеса.

Возможности языка формул Comindware:

- Изменение и определение значений атрибутов на основе данных, хранящихся в различных шаблонах записи.
- Проверка и изменение процессных данных.
- Задание временных рамок выполнения тех или иных процессных действий, например, разрешенные запросы в техподдержку могут закрываться автоматически после двух недель в неактивном состоянии.
- Назначение исполнителей задачи на основании того или иного условия (например, в зависимости от категории запроса).
- Настройка межпроцессного взаимодействия.
- Настройка вызова стороннего процесса внутри текущего.
- Настройка условий ветвления процесса.
- Защита платформы от негативного влияния человеческого фактора.

См. также:

- [Литералы и функции в формулах. Справочник, описания, примеры][formula_reference]
- [Форматирование значений атрибутов в файле шаблона экспорта и формулах][export_template_file_formula_format_values]
- [Системные атрибуты шаблона аккаунта][account_template_attribute_system_names]
- [Примеры формул][formula_use_examples]

[](){: #formula_context }
## Контекст вычисления формул. Понятие и изменение {: #formula_guide_context }

Понятие контекста всегда используется для настройки бизнес-логики и вычислений в **{{ productName }}**. В первую очередь, у любой информационной системы есть база данных, и чтобы получить какие-то данные из нее, нужно написать запрос к базе.

**Контекст** — это отправная точка запроса к базе данных. Границами контекста являются шаблоны записи, шаблоны процессов и пользовательские задачи, в которых пишется запрос (в форме вычисляемых атрибутов, правил на форме, фильтров и т.д.), и их нужно различать для правильного написания формулы.

`$` — обозначение изначального контекста.

Для смены контекста используются атрибуты типа «Запись» или запроса вида `from a in db`. Чтобы поменять контекст на связанную запись, используются системные имена атрибутов типа «Запись» после `$` и символы `->` после системного имени атрибута. В сценариях можно менять контекст по самим атрибутам типа «Запись» или по выражению типа `from a in db`.

### Примеры смены контекста {: #formula_guide_context_examples }

- **Пример 1:** искомый атрибут находится в другом шаблоне, и в текущем контексте (шаблоне) есть ссылка на связанный шаблон.

    ``` sql
    $link->atributSystemName
    ```

    Здесь:

    - `link`: системное имя атрибута типа «**Запись**»;
    - `atributSystemName` — системное имя атрибута в связанной записи.

    Больше о вызове связанных данных читайте в статье [Вызов связанных данных](https://kb.comindware.ru/article.php?id=4998).

- **Пример 2:** искомый атрибут находится в другом шаблоне записи, но в текущем контексте (шаблоне записи) нет ссылки на другой шаблон записи.

    ``` sql
    from a in db->recordTemplateSystemName
    where EQUALS(a->attirbute1, $attribute2)
    select a->id
    ```

    Здесь:

    - `recordTemplateSystemName`: системное имя искомого шаблона;
    - `attribute1`: системное имя атрибута в искомом шаблоне;
    - `attribute2`: системное имя атрибута в текущем шаблоне, с которым нужно сравнить `attribute1`.

См. _«[Написание запросов на языке формул](#formula_guide_queries)»_.

- **Пример 3:** текущий контекст — это контекст задачи, а искомый атрибут находится в связанном с шаблоном процесса шаблоне записи.

    ``` sql
    $cmw.task.objectId->op.11
    ```

    Здесь `op.11` — ID атрибута в связанном шаблоне записи.

- **Пример 4:** текущий контекст — это контекст процесса, а искомый атрибут находится в связанном шаблоне записи.

    ``` sql
    $$BusinessObject->attributeSystemName 
    ```

    Здесь `attributeSystemName` — системное имя атрибута в связанном шаблоне записи.

## Основные правила написания формул {: #formula_guide_rules }

Работая с формулами в **{{ productName }}**, придерживайтесь следующих правил:

1. В формулах используйте только идентификаторы и системные имена, а не отображаемые названия объектов.
2. Для идентификаторов и системных имен учитывается регистр: буквы `A` и `а` считаются разными.
3. Системные имена должны начинаться с буквы или символа подчеркивания (`_`). В самом системном имени можно использовать латинские и русские буквы (`A`–`Z`, `a`–`z`, `А`–`Я`, `а`–`я`), числа (`0`–`9`) и символы подчеркивания (`_`).
4. Системные имена должны быть уникальны только в рамках одного шаблона. Системные атрибуты создаются автоматически под формализованными именами, такими как `id`, `_creationDate`, `_creator`, `_lastWriteDate` и др.
5. Для того чтобы обратиться к тому или иному свойству текущего объекта, используйте оператор `$attributeSystemName` (`$->attributeSystemName`), где символ `$` представляет текущий шаблон, а `attributeSystemName` — системное имя атрибута этого шаблона.
6. Вы можете складывать и вычитать значения атрибутов типа «**Дата и время**» и «**Длительность**» между собой, руководствуясь следующей таблицей:

| Действие                      | Результат    |
| ----------------------------- | ------------ |
| Длительность +/- Длительность | Длительность |
| Дата и время +/- Длительность | Дата и время |
| Дата и время - Дата и время   | Длительность |

См. также _«[Написание запросов на языке формул](#formula_guide_queries)»_.

## Вызов связанных данных {: #formula_guide_relations }

Для того чтобы обратиться к данным связанного шаблона записи через атрибут типа «**Запись**», который ссылается на этот шаблон, введите системное имя атрибута типа «**Запись**», символ `->` и системное имя атрибута связанного шаблона записи.

Пример:

| Шаблоны записи      | Атрибуты                                     |
| ------------------ | -------------------------------------------- |
| `Staff` (Персонал) | `Name` (Имя) — системное имя атрибута с Ф.&nbsp;И.&nbsp;О. сотрудника. |
| `Cars` (Автомобили) | `Driver` (Водитель) — системное имя атрибута типа «**Запись**», ссылающегося на шаблон записи Staff (Персонал). |

Чтобы получить имя водителя для записи из шаблона _«Автомобили»_, используйте следующее выражение: 

``` sql
$Driver->Name
```

Переходить по ссылкам можно неограниченное количество раз, но будьте внимательны, чтобы не образовалось зацикливание.

## Написание запросов на языке формул {: #formula_guide_queries }

Здесь представлен синтаксис и примеры предложений и операторов для запросов на языке формул **{{ productName }}**.

!!! warning "Зарезервированные слова"

    - Следующие слова нельзя использовать в запросе в качестве [локальной переменной](#formula_guide_queries_operators), так как они зарезервированы как системные:
        - `and`, `ascending`, `between`, `by`, `db`, `descending`, `equals`, `from`, `group`, `in`, `into`, `item`, `join`, `let`, `on`, `orderby`, `select`, `source`, `where`;
        - слова, начинающиеся с символа подчеркивания (`_`);
        - имена [функций][formula_reference_functions] и [литералы][formula_reference_literals];
    - [Предложение `from`](#formula_guide_queries_operators) может содержать подзапросы (также начинающиеся с `from`).

### Операторы запросов {: #formula_guide_queries_operators }

<table markdown="block">
<tbody markdown="block">
<tr markdown="block">
<th colspan="2" markdown="block">

`from`

</th>
</tr>
<tr markdown="block">
<td markdown="block" class="functionDescriptionColumn">
**Описание**
</td>
<td markdown="block">

Запрос должен начинаться с предложения `from`. Предложение `from` состоит из следующих частей:

- оператор `from`;
- локальная переменная (например, `queryVar`), которая представляет отдельные элементы источника данных (например, запись в шаблоне или аккаунт);
- оператор `in`;
- источник данных, по которому выполняется запрос.

</td>
</tr>
<tr markdown="block">
<td markdown="block" >
**Синтаксис**
</td>
<td markdown="block">

`from queryVar in dataSource`

</td>
</tr>
<tr markdown="block">
<td markdown="block">
**Аргументы**
</td>
<td markdown="block">

- `queryVar`: имя локальной переменной
- `dataSource`:
    - `db->templateName`: шаблон;
    - `$path->to->attribute`: путь к атрибуту шаблона;
    - `from queryVar2 in dataSource2 where condition2 select attribute2`: подзапрос;

</td>
</tr>
<tr markdown="block">
<th colspan="2" markdown="block">

`where`

</th>
</tr>
<tr markdown="block">
<td markdown="block" class="functionDescriptionColumn">
**Описание**
</td>
<td markdown="block">

Предложение `where` задаёт условие выборки элементов в источнике данных. Условие может содержать несколько предикатов, возвращающих `True` или `False`.

В условие можно включить несколько предикатов с помощью логических операторов `&&` (И),  `||` (ИЛИ),  `==` (РАВНО),  `!=` (НЕ РАВНО) и функций `AND()`, `OR()`, `EQUALS()`, `IF()`, `NOT()`, `ANY()`, `ALL()`.

</td>
</tr>
<tr markdown="block">
<td markdown="block">
**Синтаксис**
</td>
<td markdown="block">

`where condition`

</td>
</tr>

<tr markdown="block">
<td markdown="block">
**Аргументы**
</td>
<td markdown="block">

`condition`: логическое значение или выражение, возвращающее `True` или `False`.

</td>
</tr>
<tr markdown="block">
<th colspan="2" markdown="block">

`orderby`

</th>
</tr>
<tr markdown="block">
<td markdown="block" class="functionDescriptionColumn">
**Описание**
</td>
<td markdown="block">

Предложение `orderby` позволяет отсортировать результаты запроса по значению атрибута искомых объектов.

Предложение `orderby` следует использовать между предложениями `where` и `select`.

Предложение `orderby` состоит из следующих частей:

- оператор  `orderby`;
- атрибут объекта, по которому следует выполнять сортировку результатов запроса;
- оператор порядка сортировки — `ascending` по возрастанию (по умолчанию, можно не указывать) или `descending` — по убыванию.

</td>
</tr>
<tr markdown="block">
<td markdown="block">
**Синтаксис**
</td>
<td markdown="block">

- Сортировка по возрастанию: `orderby templateAttribute ascending` или `orderby templateAttribute`
- Сортировка по убыванию: `orderby templateAttribute descending`

</td>
</tr>

<tr markdown="block">
<td markdown="block">
**Аргументы**
</td>
<td markdown="block">

`templateAttribute`: атрибут шаблона (источника данных).

 </td>
</tr>
<tr markdown="block">
<td markdown="block">

`select`

 </th>
</tr>
<tr markdown="block">
<td markdown="block" class="functionDescriptionColumn">
**Описание**
</td>
<td markdown="block">

Предложение `select` задаёт, атрибут объекта, значения которого вернёт запрос. В конечном результате учитываются как работа предыдущих операторов, так и любые выражения в самом операторе `select`.

</td>
</tr>
<tr markdown="block">
<td markdown="block">
**Синтаксис**
</td>
<td markdown="block">

 `select templateAttribute`

</td>
</tr>

<tr markdown="block">
<td markdown="block">
**Аргументы**
</td>
<td markdown="block">

 `templateAttribute`: атрибут шаблона.

</td>
</tr>
</tbody>
</table>

### Примеры запросов

- Запрос записей районов Москвы с сортировкой по убыванию названия района.

    ``` sql
    from a in db->Cities
    where a->CityName == "Москва"
    orderby a->Districts->DistrictName descending
    select a->Districts
    ```

- Запрос названий и авторов книг, у которых указан автор, с сортировкой по возрастанию имени автора и выводом в формате _«Название: название книги. Автор: имя автора»_.

    ``` sql
    from book in db->Books
    where NOT(EMPTY(book->Author))
    orderby book->Author->Name
    select CONCAT(
        LIST(
            'Название: ', book->Name, '. Автор: ', book->Author->Name
        )
    )
    ```

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- [Литералы и функции в формулах. Справочник, описания, примеры][formula_reference]
- [Форматирование значений атрибутов в файле шаблона экспорта и формулах][export_template_file_formula_format_values]
- [Системные атрибуты шаблона аккаунта][account_template_attribute_system_names]
- [Примеры формул][formula_use_examples]

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

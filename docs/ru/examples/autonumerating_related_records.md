---
kbId: 5092
title: 'Автонумерация связанных записей с помощью сценария'
tags:
    - язык формул
    - формулы
    - язык выражений
    - выражения
hide:
    - tags
---

# Автонумерация связанных записей с помощью сценария  {: #auto_numerating_related_records}

## Введение

Каждой записи, пользовательской задаче, форме и экземпляру процесса присваивается уникальный ID. В рамках сервера **{{ productName }}** ID не повторяются.

Сценарий позволяет настроить нумерацию связанных записей при сохранении основной записи. При этом нумерация служит для подсчёта связанных записей и будет обновляться при каждом изменении их количества. Для каждой основной записи будет собственная нумерация

Здесь представлены настройки для автонумерации связанных записей. Настройки по автонумерации всех записей в шаблоне см. _«[Автонумерация записей с помощью формулы, C#-скрипта или выражения N3][auto_numerating_records]»_.

## Прикладная задача

Требуется настроить автонумерацию документов, хранящихся в шаблоне _«Реестр документов»_ и связанных с записями в шаблоне _«Заявки»_, для подсчёта их количества.

## Исходные данные

Имеются шаблон _«Заявки»_ и _«Реестр документов»_.

В шаблоне _«Заявки»_ имеется атрибут «**Документы**» со следующими свойствами:

- **Тип данных: запись**
- **Связанный шаблон:** _Реестр документов_
- **Системное имя:** _Documents_
- **Хранить несколько значений:** флажок установлен

В шаблоне _«Реестр документов»_ имеются следующие атрибуты:

- _«Порядковый номер»_ типа «**Текст**»;
- _«Файл»_ типа «**Документ**».

На форму шаблона _«Заявки»_ вынесен атрибут _«Документы»_ с представлением в виде таблицы. В таблицу добавлены столбцы  _«Порядковый номер»_ и _«Файл»_. На область кнопок таблицы помещены кнопки «**Сохранить**» и «**Удалить**».

## Настройка автонумерации связанных записей

1. Добавьте текстовый атрибут _«Порядковый номер»_ в шаблоне _«Реестр документов»_.
2. Создайте новый сценарий _«Автонумерация»_.
3. Настройте начальное событие «**Нажата кнопка**»:

    - **Контекстный шаблон:** _Заявки_
    - **Кнопка: Сохранить**

4. Добавьте действие «**Проверить результат выражения**» со следующими свойствами:

    - **Выражение: N3**

        ``` turtle
        # Импортируем функции для работы с переменными
        @prefix variable: <http://comindware.com/ontology/session/variable#>.
        @prefix operator: <http://comindware.com/ontology/session/operator#>.
        {
            # Создаём переменную индекс и
            # задаём ей значение 0
            variable:index operator:replace 0.
            true -> ?value.
        }
        ```

5. Добавьте действие «**Сменить контекст**» со следующими свойствами:

    - **Целевой шаблон записи:** _Реестр документов_
    - **Атрибут или выражения для поиска объектов: формула**

        ``` cs
        # Собираем ID всех связанных записей с атрибутом Documents (Документы)
        from a in $Documents select a->id
        ```

6. Добавьте действие «**Изменить значения атрибутов**» внутрь действие «**Сменить контекст**» со следующими свойствами:

    - **Атрибут:** _Порядковый номер_
    - **Действие: заменить**
    - **Значение: N3**

        ``` turtle
        # Импортируем функции для работы с переменными
        @prefix variable: <http://comindware.com/ontology/session/variable#>.
        @prefix operator: <http://comindware.com/ontology/session/operator#>.
        @prefix session: <http://comindware.com/ontology/session#>.
        @prefix string: <http://www.w3.org/2000/10/swap/string#>.
        @prefix math: <http://www.w3.org/2000/10/swap/math#>.
        {
            # Находим переменную index и помещаем
            # её в ?startValue
            session:context variable:index ?startValue.
            # Увеличиваем значение ?startValue на 1
            # и помещаем результат в ?result
            (?startValue 1) math:sum ?result.
            # Приводим значение ?result к типу данных «Текст»
            # и помещаем в ?resultFormat
            ("{0}" ?result) string:format ?resultFormat.
            # Заменяем значение переменной индекс
            # на значение ?result
            variable:index operator:replace ?result.
            # Возвращаем в значение атрибута ?resultFormat
            ?resultFormat -> ?value.
        }
        ```

## Тестирование

1. Создайте запись в шаблоне _«Заявки»_.
2. Создайте несколько записей в атрибуте _«Документы»_.
3. Сохраните запись.
4. В столбце _«Порядковый номер»_ отобразятся нумерация записей.
5. Удалите одну запись в атрибуте _«Документы»_.
6. Сохраните запись.
7. В столбце _«Порядковый номер»_ отобразятся обновлённая нумерация записей.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- _[Автонумерация записей с помощью формулы, C#-скрипта или выражения N3][auto_numerating_records]_
- _[Переменные приложения. Просмотр списка, настройка и использование][variables]_

</div>

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}
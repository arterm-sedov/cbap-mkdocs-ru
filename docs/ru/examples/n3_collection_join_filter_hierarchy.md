---
title: 'Атрибут типа «Запись». Объединение и фильтрация иерархических коллекций с помощью N3'
kbTitle: 'Атрибут типа «Запись». Объединение и фильтрация иерархических коллекций с помощью N3'
kbId: 5108
tags:
  - запись
  - коллекция
  - таксономия
  - объединение
  - join
  - список
  - фильтрация
  - иерархия
  - N3
  - Notation3
  - Notation 3
  - тройки
  - триплеты
  - права
  - доступ
  - роли
hide: tags
---

# Атрибут типа «Запись». Объединение и фильтрация иерархических коллекций с помощью N3 {: #example_n3_collection_join_filter_hierarchy }

## Введение {: #example_n3_collection_join_filter_hierarchy_intro }

Атрибут типа «**Запись**» хранит ID записей в связанном шаблоне (ссылки на них).

Зачастую требуется предоставлять пользователю для выбора списки записей, объединённые из нескольких шаблонов и отфильтрованные по сложным правилам. Например, когда данные находятся в иерархически связанных справочниках.

Здесь представлен пример формирования с помощью N3 списка поставщиков на основе трехуровневой иерархии товарных категорий и его фильтрации по данным текущего пользователя.

## Прикладная задача {: #example_n3_collection_join_filter_hierarchy_use_case }

Менеджер по закупкам подбирает поставщиков товаров. Для этого он создаёт запрос с указанием необходимой товарной категории.

Система должна предложить менеджеру для выбора только тех поставщиков, которые работают с продукцией из указанной категории.

Предусмотрено два типа категорий: общие — регламентированные для поставщика, внутренние — регламентированные для менеджера по закупкам.

Для каждой внутренней категории указывается общая категория. Несколько внутренних категорий могут ссылаться на одну общую категорию.

Внутренние категории классифицируются по трём иерархическим уровням. Если для третьего уровня не нашлось поставщиков, поиск должен идти по второму уровню, а затем — по первому.

Кроме того, к запроса от менеджера должны иметь доступ только сотрудники поставщиков, указанных в запросе.

## Исходные данные {: #example_n3_collection_join_filter_hierarchy_initial_data }

Имеются шаблоны: _Категории_, _Поставщики_, _Контакты_, _Запросы_.

В шаблоне записи _«Категории»_ хранится справочник всех категорий.

Атрибуты в шаблоне:

- _Общая категория_
    - **Описание:** _Ссылка на запись общей категории_
    - **Тип данных: запись**
    - **Связанный шаблон:** _Категории_
    - **Хранить несколько значений:** флажок снят

В шаблоне записи _«Поставщики»_ хранится карточка клиента или партнера.

Атрибуты в шаблоне:

- _Товарные категории_
    - **Описание:** _Коллекция общих категорий, с которыми работает поставщик_
    - **Тип данных: запись**
    - **Связанный шаблон:** _Категории_
    - **Хранить несколько значений:** флажок установлен
- _Контакты_
    - **Описание:** _Коллекция контактных лиц поставщика_
    - **Тип данных: запись**
    - **Связанный шаблон:** _Контакты_
    - **Хранить несколько значений:** флажок установлен

В шаблоне записи _«Контакты»_ хранится контактное лицо в организации.

Атрибуты в шаблоне:

- _Сотрудник_
    - **Описание:** _Ссылка на аккаунт сотрудника_
    - **Тип данных: аккаунт**
    - **Связанный шаблон:** _Сотрудники_
    - **Хранить несколько значений:** флажок снят
- _Ответственный_
    - **Описание:** _`True`, если сотрудник является ответственным менеджером для поставщика_
    - **Тип данных: логический**

В шаблоне записи _«Запросы»_ выполняются основные вычисления.

Атрибуты в шаблоне:

- _Категория ур. 1_, _Категория ур. 2_, _Категория ур. 3_
    - **Описание:** _Ссылка на категорию уровня 1, 2 или 3 для потребности_
    - **Тип данных: запись**
    - **Связанный шаблон:** _Категории_
    - **Хранить несколько значений:** флажок снят
- _Доступные поставщики_
    - **Описание:** _Список доступных поставщиков_
    - **Тип данных: запись**
    - **Связанный шаблон:** _Поставщик_
    - **Хранить несколько значений:** флажок установлен

## Настройка вычислений {: #example_n3_collection_join_filter_hierarchy_calculation .pageBreakBefore }

Логику можно разделить на две части:

1. Сбор всех поставщиков по трём уровням категорий.
2. Фильтрация полученного списка по текущему пользователю для настройки прав доступа.

### 1. Вычисление списка поставщиков

1. Откройте для редактирования форму шаблона _«Запросы»_.
2. Поместите на форму атрибут _«Доступные поставщики»_.
3. Настройте свойства поля _«Доступные поставщики»_:

    - **Представление: раскрывающийся список**
    - **Доступ: разрешить ввод**
    - **Фильтр: N3**

    ```turtle
    # Импортируем префиксы для работы со списками и объектами
    @prefix object: <http://comindware.com/ontology/object#>.
    @prefix list: <http://www.w3.org/2000/10/swap/list#>.

    {
        # Убедитесь, что системные имена соответствуют именам в вашем приложении.
        # Получаем атрибуты для дальнейших вычислений
        ("Поставщики" "Товарныекатегории") object:findAttribute ?CounterpartyCategoriesAttribute.
        ("Запросы" "Категорияур3") object:findAttribute ?RequestCategoryLevel3Attribute.
        ("Запросы" "Категорияур2") object:findAttribute ?RequestCategoryLevel2Attribute.
        ("Запросы" "Категорияур1") object:findAttribute ?RequestCategoryLevel1Attribute.
        ("Категории" "Общаякатегория") object:findAttribute ?CommonCategoryAttribute.

        # Собираем коллекцию поставщиков, работающих с требуемой категорией третьего уровня
        # для текущей потребности (?item).
        from {
            ?item ?RequestCategoryLevel3Attribute ?RequestCategoryLevel3.
            # Получаем общую категорию для выбранной категории уровня 3.
            ?RequestCategoryLevel3 ?CommonCategoryAttribute ?CommonCategory3.
            # Ищем всех поставщиков (?Counterparties3), у которых товарная категория
            # совпадает с общей категорией (?CommonCategory3).
            ?Counterparties3 ?CounterpartyCategoriesAttribute ?CommonCategory3.
        }
        select ?Counterparties3 -> ?Counterparties3List.

        # Собираем коллекцию поставщиков, работающих с требуемой категорией второго уровня.
        from {
            ?item ?RequestCategoryLevel2Attribute ?RequestCategoryLevel2.
            ?RequestCategoryLevel2 ?CommonCategoryAttribute ?CommonCategory2.
            ?Counterparties2 ?CounterpartyCategoriesAttribute ?CommonCategory2.
        }
        select ?Counterparties2 -> ?Counterparties2List.

        # Собираем коллекцию поставщиков, работающих с требуемой категорией первого уровня.
        from {
            ?item ?RequestCategoryLevel1Attribute ?RequestCategoryLevel1.
            ?RequestCategoryLevel1 ?CommonCategoryAttribute ?CommonCategory1.
            ?Counterparties1 ?CounterpartyCategoriesAttribute ?CommonCategory1.
        }
        select ?Counterparties1 -> ?Counterparties1List.

        # Объединяем коллекции поставщиков категорий второго и третьего уровней.
        (?Counterparties3List ?Counterparties2List) list:append ?Counterparties32List.

        # Объединяем коллекции поставщиков категорий первого, второго и третьего уровней.
        (?Counterparties32List ?Counterparties1List) list:append ?RequestCounterpartiesList.

        # Возвращаем итоговую коллекцию категорий
        ?RequestCounterpartiesList list:member ?value.
    }
    ```

### 2. Фильтрация для роли

Чтобы предоставить доступ к запросам только ответственным сотрудникам указанных в запросе поставщиков в роль добавить тройку в фильтр аккаунтов для шаблона Запросы.

``` turtle
# Импортируем префиксы для работы со списками и объектами
@prefix object: <http://comindware.com/ontology/object#>.
@prefix list: <http://www.w3.org/2000/10/swap/list#>.
{
    # Убедитесь, что системные имена соответствуют именам в вашем приложении.
    # Получаем атрибут «Доступные поставщики» из предыдущего вычисления
    ("Запросы" "Доступныепоставщики") object:findAttribute ?RequestCounterpartiesList.

    # Получаем атрибуты для проверки связи поставщиков с текущим пользователем.
    ("Поставщики" "Контакты") object:findAttribute ?ContactsAttribute.
    ("Контакт" "Ответственный") object:findAttribute ?IsResponsibleAttribute.
    ("Контакт" "Сотрудник") object:findAttribute ?EmployeeAttribute.
    
    # Получаем аккаунт текущего пользователя
    cmw:securityContext cmw:currentUser ?user.

    # Отбираем поставщиков,
    # у которых текущий пользователь является ответственным
    # по текущему запросу.
    ?item ?RequestCounterpartiesList ?RequestCounterparties.
    ?RequestCounterparties ?ContactsAttribute ?Contacts.
    ?Contacts ?IsResponsibleAttribute true.
    ?Contacts ?EmployeeAttribute ?user.
    # Возвращаем текущего пользователя, 
    # если ему разрешено работать с текущим запросом.
    ?user -> ?value.
}
```

## Тестирование {: #example_n3_collection_join_filter_hierarchy_test .pageBreakBefore }

1. Создайте тестовые записи в справочниках: `Категории` (с иерархией уровней), `Поставщики`, `Контакты` и несколько аккаунтов.
2. Для нескольких поставщиков укажите общие категории и добавьте в `Контакты` аккаунты сотрудников. Для некоторых сотрудников установите флажок `Ответственный` и укажите свой аккаунт в поле `Сотрудник`.
3. Создайте `Запрос`.
4. В запросе укажите категории уровней 1—3.
5. В поле `Доступные поставщики` должен появиться список поставщиков, работающих по выбранным категориям.
6. Выберите поставщиков и сохраните запрос.
7. Выйдите из системы и войдите с аккаунтом, который **не** указан в качестве ответственного лица ни у одного из поставщиков, выбранных на шаге 6.
8. Откройте список всех запросов. Вы не должны видеть созданный ранее запрос.

1. Создайте несколько тестовых аккаунтов.
2. Создайте записи в шаблоне _«Категории»_

        - создайте общие категории;
        - создайте категории уровней 1–3, указав для них разные **общие** категории.

3. Создайте записи в шаблоне _«Контакты»_:

    - добавьте тестовые аккаунты в поле _«Сотрудник»_.
    - для некоторых контактов установите флажок _«Ответственный»_ и укажите свой аккаунт в поле _«Сотрудник»_.

4. Создайте записи в шаблоне _«Поставщики»_:

    - укажите в поле _«Товарные категории»_ разные **общие** категории;
    - в _«Контакты»_ добавьте записи из шаблона _«Контакты»_.

5. Создайте запись в шаблоне _«Запрос»_.
6. В запросе выберите категории уровней 1, 2 и 3.
7. Откройте раскрывающийся список _«Доступные поставщики»_. В нём должны отображается поставщики, работающие по выбранным категориям.
8. Выберите поставщиков и сохраните запрос.
9. Выйдите из системы и войдите под аккаунтом, который **не** указан как ответственное лицо ни у одного из  поставщиков, выбранных в созданном ранее запросе.
10. Откройте список всех _«Запросов»_. Созданный ранее _«Запрос»_ не должен отображаться для вас, так как ваш тестовый аккаунт не является ответственным лицом какого-либо поставщика по запросу.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- [Атрибут типа «Запись»][attribute_record]
- [Язык N3][n3_guide]
- [Настройка ролей][roles]

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

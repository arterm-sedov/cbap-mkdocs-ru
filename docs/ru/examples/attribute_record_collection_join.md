---
title: 'Атрибут «Запись». Фильтрация списка выбора по данным текущего пользователя'
kbId: 5107
tags:
  - запись
  - коллекция
  - список
  - фильтрация
  - права
  - доступ
  - N3
  - Notation3
  - Notation 3
  - тройки
  - триплеты
hide: tags
---

# Атрибут «Запись». Фильтрация раскрывающегося списка по данным текущего пользователя {: #attribute_record_collection_join }

## Введение {: #attribute_record_collection_join_intro }

Атрибут типа «**Запись**» позволяет ссылаться на другие записи в системе и отображать их в виде раскрывающегося списка. В некоторых случаях требуется, чтобы этот список был не статичным, а динамически фильтровался в зависимости от того, кто с ним работает.

Например, пользователю нужно предоставить для выбора только те организации, с которыми он связан. При этом исходный перечень организаций может формироваться из нескольких источников.

Здесь представлен пример, как с помощью N3-выражения объединить два списка записей и отфильтровать его по данным, связанным с текущим пользователем.

## Прикладная задача {: #attribute_record_collection_join_use_case }

При оформлении командировки сотрудник должен выбрать принимающую организацию из раскрывающегося списка. Список организаций должен формироваться из двух справочников («Клиенты» и «Партнеры») и содержать только те записи, в которых текущий пользователь указан как активное контактное лицо.

## Исходные данные {: #attribute_record_collection_join_initial_data }

Для реализации этого сценария используются четыре шаблона: «Организация», «Контакт», «Сотрудник» и «Командировка».

В шаблоне **«Организация»** хранятся названия компаний и список их контактных лиц в атрибуте `Контакты` (ссылка на шаблон «Контакт», множественный).

В шаблоне **«Контакт»** указывается связь между организацией и сотрудником. Он содержит ссылку на запись сотрудника в атрибуте `Сотрудник` и флажок `Активен`, показывающий, является ли контакт действующим.

Шаблон **«Сотрудник»** содержит ФИО и ссылку на `Учетную запись` пользователя в системе.

В шаблоне **«Командировка»** есть два атрибута для выбора организаций: `Клиенты` и `Партнеры` (оба — ссылка на «Организация», множественные). Финальный отфильтрованный список для выбора будет вычисляться в атрибуте `Принимающая организация` (ссылка на «Организация», вычисляемый).

## Настройка вычислений {: #attribute_record_collection_join_calculation .pageBreakBefore }

1. В шаблоне «Командировка» создайте атрибут «**Принимающая организация**» со следующими параметрами:
    - **Тип данных**: Запись, ссылка на шаблон «Организация»
    - **Вычислять автоматически**
    - **Вычисляемое значение**: N3

    ``` turtle
    # Импортируем префиксы для работы со списками, объектами и системными данными
    @prefix w3list: <http://www.w3.org/2000/10/swap/list#>.
    @prefix cmw: <http://comindware.com/ontology/cmw#>.
    @prefix object: <http://comindware.com/ontology/object#>.

    {
        # Получаем идентификатор текущего пользователя
        cmw:securityContext cmw:currentUser ?user.

        # Получаем URI (идентификаторы) атрибутов, по которым будем строить связи
        ("Командировка" "Клиенты") object:findProperty ?clientsProperty.
        ("Командировка" "Партнеры") object:findProperty ?partnersProperty.
        ("Организация" "Контакты") object:findProperty ?relationsProperty.
        ("Контакт" "Активен") object:findProperty ?activeProperty.
        ("Контакт" "Сотрудник") object:findProperty ?individualProperty.
        ("Сотрудник" "УчетнаяЗапись") object:findProperty ?accountProperty.

        # Получаем списки клиентов и партнеров из текущей записи (?item)
        ?item ?clientsProperty ?clientsList.
        ?item ?partnersProperty ?partnersList.

        # Объединяем два списка организаций в один
        (?clientsList ?partnersList) w3list:append ?organizations.

        # Отбираем из объединенного списка только те организации,
        # где текущий пользователь является активным контактным лицом
        from {
            ?organizations w3list:member ?org.
            ?org ?relationsProperty ?relation.
            ?relation ?activeProperty true.
            ?relation ?individualProperty ?individual.
            ?individual ?accountProperty ?user.
        } select ?org.

    } -> ?value.
    ```

2. Разместите атрибуты «Клиенты», «Партнеры» и «Принимающая организация» на форме шаблона «Командировка».

## Тестирование {: #attribute_record_collection_join_test .pageBreakBefore }

1. Создайте несколько записей в шаблонах «Сотрудник», «Контакт» и «Организация» в соответствии с описанной структурой. Убедитесь, что:
    - У записей сотрудников указаны учетные записи реальных пользователей системы.
    - В записях организаций в атрибуте «Контакты» добавлены созданные контакты.
    - Часть контактов отмечена как активные (`Да`), а часть — как неактивные (`Нет`).
2. Создайте новую запись «Командировка».
3. В атрибутах «Клиенты» и «Партнеры» выберите несколько организаций.
4. Откройте раскрывающийся список атрибута «Принимающая организация». В нем должны отображаться только те организации из обоих списков, в которых вы (текущий пользователь) указаны как активное контактное лицо.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- [Атрибут типа «Запись»][attribute_record]
- [Атрибут типа «Пользователь»][attribute_user]
- [Атрибут типа «Логический»][attribute_boolean]
- [Язык N3][n3_guide]

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

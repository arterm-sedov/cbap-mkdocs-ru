---
title: 'Автонумерация записей'
tags:
    - C#
    - скрипт
    - C#-скрипт
    - скрипты
    - язык формул
    - формулы
    - язык выражений
    - выражения
hide:
    - tags
kbId: 4895
---

# Автонумерация записей с помощью формулы, C#-скрипта или выражения N3 {: #auto_numerating_records}

## Введение

В **{{ productName }}** каждой записи, пользовательской задаче, форме, экземпляру процесса и любому объекту присваиваются уникальный ID. В рамках одного экземпляра **{{ productName }}** ID не повторяются. После удаления объекта его ID не используется повторно. Кроме того, ID записей имеют сквозную нумерацию для всех шаблонов и приложений, не являются наглядными и малоинформативны для бизнеса.

При этом в приложениях зачастую требуется присваивать создаваемым записям порядковые номера.

Здесь даны примеры настройки автоматической нумерации новых записей в шаблоне следующими способами:

- с помощью [формулы](#автонумерация-с-помощью-формулы);
- с помощью [C#-скрипта в процессе](#автонумерация-с-помощью-c-скрипта-в-процессе);
- с помощью [C#-скрипта в сценарии](#автонумерация-с-помощью-c-скрипта-в-сценарии);
- с помощью [выражения N3](#автонумерация-с-помощью-выражения-n3).

!!! warning "Внимание!"

    - Представленные здесь алгоритмы, не присваивают порядковые номера уже существующим записям и не пересчитывают нумерацию при удалении записей.
    - Для нумерации имеющихся и новых записей с учётом их удаления см. _[пример настройки автонумерации записей с пересчётом при удалении][auto_numerating_related_records]_.

## Прикладная задача

Имеется шаблон записи _«Заявки»_.

Необходимо настроить нумерацию заявок, создаваемых в шаблоне _«Заявки»_ при запуске процесса _«Оформление заявки»_, связанного с шаблоном записи _«Заявки»_.

Нумерация заявок будет отличаться от ID записей, которые им присваиваются автоматически: порядковые номера будут присваиваться только записям этого шаблона.

## Автонумерация с помощью формулы {: .pageBreakBefore }

Для шаблонов с небольшим количеством записей можно использовать автонумерацию с помощью формулы.

!!! warning "Внимание!"

    - Так как данный способ не учитывает возможность удаления записей, при удалении записей порядковые номера могут дублироваться.

    - Так как этот способ учитывает количество существующих записей, новой записи будет присвоен такой порядковый номер, как если бы все предыдущие записи были тоже пронумерованы.

1. В шаблоне записи _«Заявки»_ создайте и поместите на форму атрибут _«Номер заявки»_ типа «**Текст**».
2. Откройте **сценарий на выходе** из начального события процесса _«Оформление заявки»_ и добавьте в него действие «**Изменить значения атрибутов**» со следующими свойствами:

    | Атрибут            | Операция со значениями | Значение|
    | ------------------ | ---------------------- | --------|
    | _Номер заявки_ | **Заменить**           | **Формула:** <p>```FORMAT("{0}",LIST(COUNT((from a in db->Zayavki select a->id))))```</p> |

    !!! question "Синтаксис формулы"

        - `FORMAT()` — эта функция принимает строку с заполнителями вида `{0}`…`{N}` и список значений. Функция подставляет значения из списка в соответствующие заполнители и возвращает результирующую строку.
        - `LIST()` — эта функция принимает перечень значений и возвращает список, состоящий из этих значений.
        - `COUNT()` — эта функция подсчитывает количество записей в шаблоне записи, возвращённых в запросом `from a in db`.
        - `from a in db->Zayavki select a->id` — запрос всех записей из шаблона _«Заявки»_.
        - `Zayavki` — системное имя шаблона записи _«Заявки»_.

3. Опубликуйте диаграмму процесса.

### Тестирование

1. Создайте экземпляр процесса _«Оформление заявки»_.
2. При запуске процесса будет создана новая запись в шаблоне _«Заявки»_.
3. Новой заявке должен быть присвоен _Номер заявки_ на 1 больше количества существующих записей в шаблоне _«Заявки»_.

## Автонумерация с помощью C#-скрипта в процессе {: .pageBreakBefore }

Если в шаблоне будет много записей, то рекомендуется использовать автонумерацию с помощью C#-скрипта для повышения производительности.

Кроме того, при автонумерации с помощью C#-скрипта удаление записей не приведёт к дублированию порядковых номеров как при использовании формулы.

1. На странице администрирования приложения выберите пункт «**Переменные**».
2. Создайте переменную со следующими свойствами:

    - **Название** — _Порядковый номер_
    - **Тип** — **число**
    - **Значение** — _1_

3. В шаблоне записи _«Заявки»_ создайте и поместите на форму **атрибут** _«Номер заявки»_ типа «**Число**».
4. В шаблоне процесса _«Оформление заявки»_ добавьте **задачу-выполнение сценария** сразу после начального события.
5. В свойствах задачи-выполнения сценария на вкладке «**Дополнительные**» добавьте следующий **C#-скрипт**:

    ```cs
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using Comindware.Data.Entity;
    using Comindware.TeamNetwork.Api.Data.UserCommands;
    using Comindware.TeamNetwork.Api.Data;
    public class Script
    {
        public static void Main(Comindware.Process.Api.Data.ScriptContext context, Comindware.Entities entities)
        {
    // BusinessObjectId — запись, связанная с экземпляром процесса.
            var objectId = context.BusinessObjectId;
    // Получаем значение переменной «Порядковый номер» по её ID — svar.1.
    // Присваиваем полученное значение переменной sequenceNumber.
            var sequenceNumber = (decimal)Api.Solution.SolutionVariableService.GetValue("svar.1");
    // Nomerzayavki — системное имя атрибута «Номер заявки».
    // Создаём словарь data со значением атрибута «Номер заявки»,
    // равным значению переменной «Порядковый номер».
            var data = new Dictionary<string, object>
            {
                {"Nomerzayavki", sequenceNumber}
            };
    // Zayavki — системное имя шаблона записи «Заявки».
    // Записываем значение атрибута «Порядковый номер» в текущей Заявке
            Api.TeamNetwork.ObjectService.EditWithAlias("Zayavki", objectId, data);
    // Приращиваем на 1 значение переменной «Порядковый номер»
            Api.Solution.SolutionVariableService.SetValue("svar.1", sequenceNumber+1);
        }
    }
    ```

6. Опубликуйте диаграмму.

### Тестирование

1. Создайте экземпляр процесса.
2. В поле атрибута _«Номер заявки»_ должен отобразиться её порядковый номер.
3. В свойствах переменной _«Порядковый номер»_ значение должно увеличиться на 1.

## Автонумерация с помощью C#-скрипта в сценарии {: .pageBreakBefore }

C#-скрипт также можно применять для автонумерации в сценариях.

При автонумерации с помощью C#-скрипта удаление записей не приведёт к дублированию порядковых номеров как при использовании формулы.

1. На странице администрирования приложения выберите пункт «**Переменные**».
2. Создайте переменную со следующими свойствами:

    - **Название** — _Порядковый номер_
    - **Тип** — **число**
    - **Значение** — _1_

3. В шаблоне записи _«Заявки»_ создайте и поместите на форму **атрибут** _«Номер заявки»_ типа «**Число**».
4. Создайте новый сценарий _«Автонумерация»_ и настройте его событие:

    - **Тип: создание записи**;
    - **Контекстный шаблон записи:** _Заявки_.

5. Добавьте действие «**Изменить значения скриптом**» со следующими свойствами:

    - **Атрибут:** _Номер заявки_
    - **Операция со значениями: заменить**
    - **Значение: C#**

        ``` cs
        public class Script
        {
        // ObjectID — запись, в контексте которой выполняется скрипт.
            public static decimal Main(string ObjectID)
            {
        // Получаем значение переменной «Порядковый номер» по её ID — svar.1.
        // Присваиваем полученное значение переменной sequenceNumber.
                var sequenceNumber = (decimal)Api.Solution.SolutionVariableService.GetValue("svar.1");
        // Приращиваем на 1 значение переменной «Порядковый номер»
                Api.Solution.SolutionVariableService.SetValue("svar.1", sequenceNumber+1);
        // Возвращаем значение sequenceNumber в указанный атрибут.
                return sequenceNumber;
            }
        }
        ```

### Тестирование

1. Создайте экземпляр записи в шаблоне _«Заявки»_.
2. В поле атрибута _«Номер заявки»_ должен отобразиться её порядковый номер.
3. В свойствах переменной _«Порядковый номер»_ значение должно увеличиться на 1.

## Автонумерация с помощью выражения N3

Для автонумерации записей также можно использовать выражение N3. При этом удаление записей не приведёт к дублированию порядковых номеров как при использовании формулы

1. На странице администрирования приложения выберите пункт «**Переменные**».
2. Создайте переменную со следующими свойствами:

    - **Название** — _Порядковый номер_
    - **Тип** — **число**
    - **Значение** — _1_

3. В шаблоне записи _«Заявки»_ создайте и поместите на форму **атрибут** _«Номер заявки»_ типа «**Число**».
4. Создайте новый сценарий _«Автонумерация»_ и настройте его событие:

    - **Тип: создание записи**
    - **Контекстный шаблон записи:** _Заявки_

5. Добавьте действие «**Изменить значения атрибутов**» со следующими свойствами:

    - **Атрибут:** _Номер заявки_
    - **Операция со значениями: заменить**
    - **Значение: N3**

        ``` turtle
        # Импортируем функции для работы с переменными
        @prefix globalvariable: <http://comindware.com/ontology/variable#>.
        @prefix cmwnullable: <http://comindware.com/ontology/entity/nullable#>.

        {
            # Получаем значение переменной «Порядковый номер»
            # по её ID — svar.1 и помещаем в ?globalVar.
            "svar.1" globalvariable:getValueById ?globalVar.
            # Увеличиваем значение переменной «Порядковый номер»
            # на 1 и сохраняем в ?resultSum.
            (?globalVar 1) cmwnullable:sum ?resultSum.
            # Присваиваем переменной значение ?resultSum.
            "svar.1" globalvariable:setValue ?resultSum.
            # Передаем в атрибут значение ?globalVar (переменной до её увеличения).
            ?globalVar -> ?value.
        }
        ```

### Тестирование

1. Создайте экземпляр записи в шаблоне _«Заявки»_.
2. В поле атрибута _«Номер заявки»_ должен отобразиться её порядковый номер.
3. В свойствах переменной _«Порядковый номер»_ значение должно увеличиться на 1.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- _[Автонумерация записей с пересчётом при удалении][auto_numerating_related_records]_
- _[Список функций языка формул Comindware][formula_function_list]_
- _[Переменные приложения. Просмотр списка, настройка и использование][variables]_
- _[Написание скриптов на языке C#][csharp_guide]_

</div>

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}

---
title: 'Объединение и фильтрация коллекций по многоуровневой иерархии. С помощью N3'
kbId: 5108
tags:
  - запись
  - коллекция
  - список
  - фильтрация
  - иерархия
  - N3
  - Notation3
  - Notation 3
  - тройки
  - триплеты
hide: tags
---

# Объединение и фильтрация коллекций по многоуровневой иерархии. С помощью N3 {: #example_n3_collection_join_filter_multilevel }

## Введение {: #example_n3_collection_join_filter_multilevel_intro }

Атрибут типа «**Запись**» хранит ID записей в связанном шаблоне (ссылки на них).

Зачастую требуется предоставлять пользователю для выбора списки записей, объединённые из нескольких шаблонов и отфильтрованные по сложным правилам. Например, когда данные находятся в иерархически связанных справочниках.

Здесь представлен пример формирования с помощью N3 списка контрагентов на основе трехуровневой иерархии продуктовых категорий и его фильтрации по данным текущего пользователя.

## Прикладная задача {: #example_n3_collection_join_filter_multilevel_use_case }

Менеджер по продажам оформляет заявку на квоту для клиента. В заявке он указывает продуктовую категорию, к которой относится квота. Система должна предложить ему для выбора только тех контрагентов, которые работают с продукцией из указанной категории.

Иерархия категорий трехуровневая. Если в верхнем уровне не нашлось контрагентов, поиск должен идти по среднему уровню, а затем по нижнему.

Кроме того, в итоговом списке менеджер должен видеть только тех контрагентов, за которых он является ответственным.

## Исходные данные {: #example_n3_collection_join_filter_multilevel_initial_data }

Имеются шаблоны: _Общая категория продуктов_, _Продуктовая категория_, _Контрагент_, _Контакт_, _Сотрудник_, _Заявка на квоту_.

В шаблоне записи _«Общая категория продуктов»_ хранится справочник верхнего уровня:

- **Описание:** справочник верхнего уровня
- _Название_
    - **Тип данных:** текст

В шаблоне записи _«Продуктовая категория»_ хранится справочник для всех уровней иерархии:

- **Описание:** справочник для всех уровней иерархии
- _Название_
    - **Тип данных:** текст
- _Общая категория_
    - **Описание:** ссылка на общую категорию продуктов
    - **Тип данных:** запись
    - **Связанный шаблон:** _Общая категория продуктов_
    - **Хранить несколько значений:** флажок снят

В шаблоне записи _«Контрагент»_ хранится карточка клиента или партнера и имеются следующие атрибуты:

- _Название_
    - **Тип данных:** текст
- _Продуктовые категории_
    - **Описание:** коллекция продуктовых категорий контрагента
    - **Тип данных:** запись
    - **Связанный шаблон:** _Общая категория продуктов_
    - **Хранить несколько значений:** флажок установлен
- _Контакты_
    - **Описание:** коллекция контактных лиц контрагента
    - **Тип данных:** запись
    - **Связанный шаблон:** _Контакт_
    - **Хранить несколько значений:** флажок установлен

В шаблоне записи _«Контакт»_ хранится контактное лицо в организации и имеются следующие атрибуты:

- _Ответственный_
    - **Описание:** ссылка на сотрудника, ответственного за контрагента
    - **Тип данных:** запись
    - **Связанный шаблон:** _Сотрудник_
    - **Хранить несколько значений:** флажок снят
- _Активен_
    - **Описание:** признак активности контакта
    - **Тип данных:** логический

В шаблоне записи _«Сотрудник»_ хранится карточка сотрудника:

- **Описание:** карточка сотрудника
- _Учетная запись_
    - **Тип данных:** пользователь

В шаблоне записи _«Заявка на квоту»_ происходят основные вычисления и имеются следующие атрибуты:

- _Категория (ур. 1)_
    - **Тип данных:** запись
    - **Связанный шаблон:** _Продуктовая категория_
    - **Хранить несколько значений:** флажок снят
- _Категория (ур. 2)_
    - **Тип данных:** запись
    - **Связанный шаблон:** _Продуктовая категория_
    - **Хранить несколько значений:** флажок снят
- _Категория (ур. 3)_
    - **Тип данных:** запись
    - **Связанный шаблон:** _Продуктовая категория_
    - **Хранить несколько значений:** флажок снят
- _Доступные контрагенты_
    - **Описание:** вычисляемый список доступных контрагентов
    - **Тип данных:** запись
    - **Связанный шаблон:** _Контрагент_
    - **Хранить несколько значений:** флажок установлен

## Настройка вычислений {: #example_n3_collection_join_filter_multilevel_calculation .pageBreakBefore }

Логику можно разделить на две части:
1.  Сбор всех контрагентов по трем уровням категорий.
2.  Фильтрация полученного списка по текущему пользователю для настройки прав доступа.

### 1. Вычисление списка контрагентов

В шаблоне `Заявка на квоту` для атрибута `Доступные контрагенты` настройте вычисление на N3.

```turtle
# Импортируем префиксы для работы со списками и объектами
@prefix object: <http://comindware.com/ontology/object#>.
@prefix list: <http://www.w3.org/2000/10/swap/list#>.

{
    # Находим URI нужных атрибутов
    ("LegalEntities" "ProductCategories") object:findProperty ?ProductCategoriesProperty.
    ("Quotas" "ProductCategorieslevel3") object:findProperty ?ProductCategorieslevel3Property.
    ("Quotas" "ProductCategorieslevel2") object:findProperty ?ProductCategorieslevel2Property.
    ("Quotas" "ProductCategorieslevel1") object:findProperty ?ProductCategorieslevel1Property.
    ("ProductCategories" "CommonCategory") object:findProperty ?CommonCategoryProperty.

    # Ищем контрагентов для категории 3-го уровня
    from {
        ?item ?ProductCategorieslevel3Property ?ProductCategorieslevel3.
        ?ProductCategorieslevel3 ?CommonCategoryProperty ?CommonCategory3.
        # Ищем всех контрагентов (?LegalEntities3), у которых продуктовая категория
        # совпадает с общей категорией, найденной выше.
        ?LegalEntities3 ?ProductCategoriesProperty ?CommonCategory3.
    }
    select ?LegalEntities3 -> ?LegalEntities3List.

    # Аналогично для категории 2-го уровня
    from {
        ?item ?ProductCategorieslevel2Property ?ProductCategorieslevel2.
        ?ProductCategorieslevel2 ?CommonCategoryProperty ?CommonCategory2.
        ?LegalEntities2 ?ProductCategoriesProperty ?CommonCategory2.
    }
    select ?LegalEntities2 -> ?LegalEntities2List.

    # Объединяем списки по 2-му и 3-му уровням
    (?LegalEntities3List ?LegalEntities2List) list:append ?LegalEntities32List.

    # Аналогично для категории 1-го уровня
    from {
        ?item ?ProductCategorieslevel1Property ?ProductCategorieslevel1.
        ?ProductCategorieslevel1 ?CommonCategoryProperty ?CommonCategory1.
        ?LegalEntities1 ?ProductCategoriesProperty ?CommonCategory1.
    }
    select ?LegalEntities1 -> ?LegalEntities1List.

    # Объединяем список по 1-му уровню с остальными
    (?LegalEntities32List ?LegalEntities1List) list:append ?LegalEntitiesList.

    # Возвращаем уникальные значения из итогового списка
    ?LegalEntitiesList list:member ?value.
}
```

!!! note "Важно"
    В N3-выражении используются внутренние имена шаблонов и атрибутов (`LegalEntities`, `ProductCategorieslevel1` и т.д.). Убедитесь, что они соответствуют именам в вашей системе.

### 2. Фильтрация для роли

Чтобы ограничить доступ к списку, можно использовать похожее N3-выражение в настройках роли доступа к шаблону `Контрагент`. Это выражение проверит, является ли текущий пользователь ответственным за данного контрагента.

```turtle
{
    # ... (блок получения ?LegalEntitiesList из предыдущего примера) ...

    # Получаем идентификатор текущего пользователя
    cmw:securityContext cmw:currentUser ?user.

    # Находим URI атрибутов для проверки связи с пользователем
    ("LegalEntity" "Contacts") object:findProperty ?relationsProperty.
    ("Contact" "Active") object:findProperty ?activeProperty.
    ("Contact" "Responsible") object:findProperty ?individualProperty.
    ("Employee" "Account") object:findProperty ?accountProperty.

    # Из полного списка контрагентов отбираем только те,
    # где текущий пользователь является активным ответственным
    from {
        ?LegalEntitiesList list:member ?legalEntity.
        ?legalEntity ?relationsProperty ?relation.
        ?relation ?activeProperty true.
        ?relation ?individualProperty ?individual.
        ?individual ?accountProperty ?user.
    } select ?legalEntity -> ?value.

} 
```

## Тестирование {: #example_n3_collection_join_filter_multilevel_test .pageBreakBefore }

1.  Заполните справочники `Общая категория продуктов`, `Продуктовая категория`, `Сотрудник` и `Контрагент`.
2.  Для нескольких контрагентов укажите продуктовые категории и назначьте активных ответственных (указав свою учетную запись).
3.  Создайте новую `Заявку на квоту`.
4.  Выберите `Категорию (ур. 1)`, `(ур. 2)` или `(ур. 3)`.
5.  В поле `Доступные контрагенты` должен появиться отфильтрованный список. Например, если вы выбрали категорию, с которой работает 3 контрагента, но вы ответственны только за одного из них, в списке будет только одна запись.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- [Атрибут типа «Запись»][attribute_record]
- [Язык N3][n3_guide]
- [Настройка ролей][roles]

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %} 
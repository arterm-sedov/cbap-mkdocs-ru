---
title: 'Получение данных от API ФНС с помощью C#'
kbId: 4924
tags: 
    - интеграция
    - ФНС
    - скрипт
hide: tags
---

# Получение данных от API ФНС с помощью C# {: #example_csharp_tax_service_integrate }

## Введение {: #example_csharp_tax_service_integrate_intro }

Здесь представлен пример скрипта для автоматического получения данных о компании по её ИНН из базы ФНС.

Скрипт запускается по нажатию кнопки в записи контрагента и заполняет атрибуты данными, полученными из ФНС.

Интеграция с сервисом ФНС осуществляется через подключение к [API-ФНС](https://api-fns.ru/index) посредством метода `multinfo`.

Приведённый пример скрипта поддерживает получение следующих данных:

- **Наименование юридического лица/ИП**
- **Количество сотрудников**
- **Годовой доход**
- **ФИО руководителя**
- **ОГРН/ОГРНИП**
- **КПП** (для юридических лиц)
- **Юридический адрес**
- **ОКВЭД**
- **Вид деятельности**

## Прикладная задача {: #example_csharp_tax_service_integrate_use_case }

Имеется шаблон записи для хранения данных о контрагентах.

Требуется автоматически получать актуальные данные о контрагенте из базы ФНС по его ИНН.

Данные необходимо получать по нажатию кнопки на форме контрагента.

Скрипт должен определять тип контрагента (юридическое лицо или ИП) и заполнять соответствующие поля:

Для юридического лица:

- Наименование юридического лица
- Количество сотрудников
- Годовой доход
- ФИО руководителя
- ОГРН
- КПП
- Юридический адрес
- ОКВЭД
- Вид деятельности

Для ИП:

- Наименование
- ФИО руководителя
- ОГРНИП
- Юридический адрес
- ОКВЭД
- Вид деятельности

## Настройка скрипта {: #example_csharp_tax_service_integrate_script_configure .pageBreakBefore }

!!! warning "Логика работы скрипта"

    Представленный здесь скрипт работает следующим образом:

    1. Получает значение ИНН из текущей записи контрагента.
    2. Формирует запрос к API ФНС с полученным ИНН.
    3. Обрабатывает ответ от API и извлекает данные.
    4. Определяет тип контрагента (ЮЛ или ИП) и выбирает соответствующий набор данных.
    5. Записывает полученные данные в соответствующие атрибуты.
    6. Обрабатывает возможные ошибки и возвращает понятные сообщения пользователю.
    7. Отображает результат выполнения операции.

1. Зарегистрируйтесь на сайте [API-ФНС](https://api-fns.ru/index) и получите API ключ для подключения.
2. В шаблоне записи контрагента создайте кнопку со следующими свойствами:

    - **Отображаемое название:** _Получить данные из ФНС_
    - **Контекст операции:** запись
    - **Операция:** C#-скрипт

3. Создайте все необходимые атрибуты в шаблоне для хранения данных:

   - ИНН (для поиска)
   - Наименование юридического лица/ИП
   - Количество сотрудников
   - Годовой доход
   - ФИО руководителя
   - ОГРН/ОГРНИП
   - КПП
   - Юридический адрес
   - ОКВЭД
   - Вид деятельности

4. На вкладке «**Скрипт**» введите следующий код:

    !!! warning "Системные имена атрибутов"

        Замените в коде следующие имена на на фактические системные имена атрибутов в своём шаблоне контрагентов:

        - `"ИНН"` — системное имя атрибута с ИНН.
        - `"123"` — полученный ключ API ФНС.
        - `"НаименованиеЮЛ"` — системное имя атрибута для наименования юр. лица.
        - `"КоличествоСотрудников"` — системное имя атрибута для количества сотрудников.
        - `"ГодовойДоход"` — системное имя атрибута для годового дохода.
        - `"ФИОРуководителя"` — системное имя атрибута для ФИО руководителя.
        - `"ОГРН"` — системное имя атрибута для ОГРН/ОГРНИП.
        - `"КПП"` — системное имя атрибута для КПП.
        - `"ЮридическийАдрес"` — системное имя атрибута для юр. адреса.
        - `"ОКВЭД"` — системное имя атрибута для ОКВЭД.
        - `"ВидДеятельности"` — системное имя атрибута для вида деятельности.
        - `"Контрагенты"` — системное имя шаблона записи.
        - `"НаименованиеИП"` — системное имя атрибута для наименования ИП.

    ```cs
    // Импорт базовых типов и функций .NET Framework.
    using System; 
    // Импорт коллекций и словарей для хранения данных.
    using System.Collections.Generic;
    // Импорт расширений LINQ для работы с коллекциями и выполнения запросов.
    using System.Linq;
    // Импорт классов для работы с сущностями данных.
    using Comindware.Data.Entity;
    // Импорт классов для обработки нажатий кнопок и возврата результатов выполнения скрипта.
    using Comindware.TeamNetwork.Api.Data.UserCommands;
    // Импорт основных классов для работы с данными.
    using Comindware.TeamNetwork.Api.Data;
    // Импорт библиотеки RestSharp для выполнения HTTP-запросов к API ФНС.
    using RestSharp;
    // Импорт библиотеки Newtonsoft.Json для обработки JSON-ответов от API.
    using Newtonsoft.Json.Linq;

    class Script{
        public static UserCommandResult Main(UserCommandContext userCommandContext, Comindware.Entities entities)    { 
            // Получаем ID текущей записи контрагента.
            var contextObjectId = userCommandContext.ObjectIds[0];
            // Флаг успешного выполнения операции.
            var sucssesFlag = true;
            // Текст сообщения для пользователя.
            string text = "Выполнено";
            // Инициализация переменных для работы с API.
            IRestResponse response = new RestResponse();
            // URL API ФНС для получения данных о компании.
            string url_Source = "https://api-fns.ru/api/multinfo";
            // Создаем клиент для отправки HTTP-запросов.
            var client = new RestClient(url_Source);
            // Создаем GET-запрос к API.
            var request = new RestSharp.RestRequest("", Method.GET);
            // Устанавливаем заголовки запроса для получения JSON-ответа.
            request.AddHeader("RestRequest", "application/json");
            request.AddHeader("Accept", "application/json");
            // Переменная для хранения годового дохода компании.
            long money = 0;
            // Словарь для хранения данных, которые будут записаны в атрибуты.
            Dictionary<string,object> data = new Dictionary<string,object>();
            // Массив с именем атрибута, содержащего ИНН.
            var Properties = new[] {"ИНН"}; // ИНН для поиска
            try{
                // Получаем значение ИНН из текущей записи.
                var data2 = Api.TeamNetwork.ObjectService.GetPropertyValues(new[]{userCommandContext.ObjectIds[0]}, new[] {"ИНН"});
                // Создаем словарь для хранения ID записи и значения ИНН.
                Dictionary<string, object> data_Dictionary = new Dictionary<string, object> {{"id", data2.FirstOrDefault().Key}};
                // Извлекаем значение ИНН из полученных данных.
                foreach (string Property in Properties){
                    object _Value = null;
                    if (data2.FirstOrDefault().Value.TryGetValue(Property, out object obj) && obj != null){_Value = obj;}
                    data_Dictionary.Add(Property, _Value);
                }
                // Добавляем параметры запроса: ИНН и API-ключ.
                request.AddParameter("req", data_Dictionary["ИНН"].ToString());
                request.AddParameter("key", "123"); // Замените на ваш API-ключ
                try{
                    // Выполняем запрос к API ФНС.
                    response = client.Execute(request);
                    // Проверяем успешность запроса и наличие данных в ответе.
                    if((int)response.StatusCode == 200 && response.Content.Length>15){
                        // Парсим JSON-ответ от API.
                        JObject jObject = JObject.Parse(response.Content);
                        // Определяем тип контрагента (ЮЛ или ИП).
                        var mass = jObject["items"][0].ToString().Split('{');
                        mass = mass[1].Split(':');
                        mass = mass[0].Split('"');
                        string gg= mass[1];
                        // Обрабатываем данные для юридического лица.
                        if (gg == "ЮЛ"){
                            // Извлекаем годовой доход (выручку) компании.
                            try{money = (long)jObject["items"][0]["ЮЛ"]["Финансы"]["Выручка"] *1000;}catch{}
                            // Извлекаем и сохраняем наименование юридического лица.
                            try{data.Add("НаименованиеЮЛ", jObject["items"][0]["ЮЛ"]["НаимСокрЮЛ"].ToString());}catch{}
                            // Извлекаем и сохраняем количество сотрудников.
                            try{data.Add("КоличествоСотрудников", (int)jObject["items"][0]["ЮЛ"]["ОткрСведения"]["КолРаб"] );
                            }catch{}
                            // Сохраняем годовой доход.
                            try{data.Add("ГодовойДоход", money);}catch{}
                            // Извлекаем и сохраняем ФИО руководителя.
                            try{data.Add("ФИОРуководителя", jObject["items"][0]["ЮЛ"]["Руководитель"]["ФИОПолн"].ToString());
                            }catch{}
                            // Извлекаем и сохраняем ОГРН.
                            try{data.Add("ОГРН", jObject["items"][0]["ЮЛ"]["ОГРН"].ToString());}catch{}
                            // Извлекаем и сохраняем КПП.
                            try{data.Add("КПП", jObject["items"][0]["ЮЛ"]["КПП"].ToString());}catch{}
                            // Извлекаем и сохраняем юридический адрес.
                            try {data.Add("ЮридическийАдрес", jObject["items"][0]["ЮЛ"]["Адрес"]["АдресПолн"].ToString());
                            }catch{}
                            // Извлекаем и сохраняем код ОКВЭД.
                            try{data.Add("ОКВЭД", jObject["items"][0]["ЮЛ"]["ОснВидДеят"]["Код"].ToString());}catch{}
                            // Извлекаем и сохраняем текстовое описание вида деятельности.
                            try{data.Add("ВидДеятельности", jObject["items"][0]["ЮЛ"]["ОснВидДеят"]["Текст"].ToString());}catch{}
                            // Обновляем запись контрагента с полученными данными.
                            Api.TeamNetwork.ObjectService.EditWithAlias("Контрагенты", contextObjectId, data);
                        }
                        // Обрабатываем данные для индивидуального предпринимателя.
                        else if(gg == "ИП"){
                            // Извлекаем и сохраняем наименование ИП.
                            try{data.Add("НаименованиеИП", jObject["items"][0]["ИП"]["НаимПолнЮЛ"].ToString());}catch{}
                            // Извлекаем и сохраняем ФИО ИП.
                            try{data.Add("ФИОРуководителя", jObject["items"][0]["ИП"]["ФИОПолн"].ToString());}catch{}
                            // Извлекаем и сохраняем ОГРНИП.
                            try{data.Add("ОГРН", jObject["items"][0]["ИП"]["ОГРНИП"].ToString());}catch{}
                            // Извлекаем и сохраняем юридический адрес.
                            try{data.Add("ЮридическийАдрес", jObject["items"][0]["ИП"]["Адрес"]["АдресПолн"].ToString());
                            }catch{}
                            // Извлекаем и сохраняем код ОКВЭД.
                            try{data.Add("ОКВЭД", jObject["items"][0]["ИП"]["ОснВидДеят"]["Код"].ToString());}catch{}
                            // Извлекаем и сохраняем текстовое описание вида деятельности.
                            try{data.Add("ВидДеятельности", jObject["items"][0]["ИП"]["ОснВидДеят"]["Текст"].ToString());
                            }catch{}
                            // Обновляем запись контрагента с полученными данными.
                            Api.TeamNetwork.ObjectService.EditWithAlias("Контрагенты", contextObjectId, data);
                        }
                    }
                    // Обрабатываем случай, когда компания не найдена по ИНН.
                    else if( response.Content.Length<15){
                        text = "Нет компании по такому ИНН";
                        sucssesFlag = false;
                    }
                    // Обрабатываем другие ошибки API.
                    else{
                        text = "Непредвиденная ошибка";
                    }
                }
                // Обрабатываем исключения при выполнении запроса к API.
                catch(Exception e){
                    text = "Проблема с ответом "+ e.Message;
                    sucssesFlag = false;
                }
            }
            // Обрабатываем случай, когда ИНН не указан в записи.
            catch{
                text = "Нет Инн";
                sucssesFlag = false;
            }
            // Формируем результат выполнения скрипта с сообщением для пользователя.
            var result = new UserCommandResult{
                Success = sucssesFlag,
                Commited = true,
                ResultType = UserCommandResultType.Notificate,
                Messages = new[]{
                    new UserCommandMessage{
                        Severity = SeverityLevel.Normal,
                        Text = text
                    }
                }
            };
            return result;
        }
    }
    ```

5. Сохраните кнопку.
6. Поместите кнопку _«Получить данные из ФНС»_ на форму контрагента.

## Тестирование {: #example_csharp_tax_service_integrate_test }

1. Откройте или создайте запись контрагента.
2. Введите ИНН существующей компании или ИП.
3. Нажмите кнопку _«Получить данные из ФНС»_.
4. Через некоторое время поля записи должны заполниться данными из ФНС.
5. Убедитесь, что данные соответствуют типу контрагента (юридическое лицо или ИП).

!!! note "Возможные сообщения об ошибках"

    - _Нет ИНН_ — не указан ИНН на форме контрагента.
    - _Проблема с ответом_ — проблема обмена данными с API ФНС.
    - _Нет компании по такому ИНН_ — компания не найдена в базе ФНС.
    - _Пустые поля_ — запрашиваемые данные не получены от ФНС.
    - _Непредвиденная ошибка_ — иные проблемы.

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

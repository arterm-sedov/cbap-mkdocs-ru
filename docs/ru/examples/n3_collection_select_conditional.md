---
title: 'Получение доступных позиций в заказе с помощью N3'
tags:
    - процессы
    - заказы
    - N3
    - тройки
    - коллекции
    - выбор позиций
    - фильтрация
    - примеры
hide:
    - tags
kbId: 9999
---

# Получение доступных позиций в заказе с помощью N3 {: #n3_collection_select_conditional }

## Введение {: #n3_collection_select_conditional_intro }

В **{{ productName }}** часто возникает задача — определить, какие позиции в заказе ещё не заняты и могут быть выбраны для дальнейшего использования. Это особенно актуально при работе с коллекциями, когда необходимо исключить уже использованные элементы из доступных для выбора.

В данной статье приведён пример выражения на языке N3, позволяющего вычислить список свободных позиций в заказе. Такой подход востребован при настройке бизнес-логики и интерфейсов, где требуется динамически формировать выборку доступных значений.

## Прикладная задача {: #n3_collection_select_conditional_use_case }

В бизнес-процессе обработки заказов необходимо реализовать следующий сценарий:

- В каждом заказе есть список всех возможных позиций (например, места, товары, услуги).
- Часть позиций уже используется (например, занята или выбрана ранее).
- Требуется отобразить пользователю только те позиции, которые ещё не заняты.

## Исходные данные {: #n3_collection_select_conditional_initial_data }

- В шаблоне заказа присутствуют два атрибута:
    - **Все позиции** (например, `all_positions`) — коллекция всех возможных значений.
    - **Использованные позиции** (например, `used_positions`) — коллекция уже выбранных значений.
- Необходимо реализовать вычисление, которое будет возвращать только свободные позиции для выбора.

## Настройка вычислений {: #n3_collection_select_conditional_configure }

1. Убедитесь, что в шаблоне заказа есть два атрибута:
    - `all_positions` — коллекция всех возможных позиций заказа.
    - `used_positions` — коллекция уже занятых позиций.
2. В нужном месте (например, в фильтре поля или вычисляемом атрибуте) используйте следующее выражение N3:

```turtle
@prefix object: <http://comindware.com/ontology/object#>.
@prefix list: <http://www.w3.org/2000/10/swap/list#>.
@prefix assert: <http://comindware.com/logics/assert#>.

{
  # ?allPositionsProp — ссылка на атрибут всех позиций заказа.
  ("order" "all_positions") object:findProperty ?allPositionsProp.
  # ?usedPositionsProp — ссылка на атрибут использованных позиций.
  ("order" "used_positions") object:findProperty ?usedPositionsProp.

  from {
      # Для каждого значения из всех позиций проверяется, встречается ли оно среди использованных.
      ?Item ?allPositionsProp ?positionValue.

      {
          ?Item ?usedPositionsProp ?usedPositionValue.
          ?usedPositionValue == ?positionValue.
      }
      assert:count ?usedCount.

      # Если позиция не встречается среди использованных (?usedCount == 0), она считается свободной.
      ?usedCount == 0.
  } select ?positionValue -> ?availablePositionsList.

  # Все такие позиции собираются в список ?availablePositionsList, из которого выбираются отдельные значения для дальнейшего использования.
  ?availablePositionsList list:member ?value.
}
```

### Пояснения к выражению

- `?allPositionsProp` — ссылка на атрибут всех позиций заказа.
- `?usedPositionsProp` — ссылка на атрибут использованных позиций.
- Для каждого значения из всех позиций проверяется, встречается ли оно среди использованных.
- Если позиция не встречается среди использованных (`?usedCount == 0`), она считается свободной.
- Все такие позиции собираются в список `?availablePositionsList`, из которого выбираются отдельные значения для дальнейшего использования.

## Тестирование {: #n3_collection_select_conditional_test }

1. Создайте тестовый заказ с заполненными атрибутами **Все позиции** и **Использованные позиции**.
2. Примените выражение N3 в фильтре поля или вычисляемом атрибуте.
3. Откройте форму выбора позиций — должны отображаться только те позиции, которые ещё не были выбраны.
4. Добавьте новую использованную позицию и убедитесь, что она исчезла из доступных для выбора.
5. Проверьте работу сценария на разных данных и убедитесь, что логика работает корректно.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- [Вычисление пользователей, у которых есть активные задачи][n3_calculate_active_task_accounts]
- [Фильтр списка по активным задачам текущего пользователя][n3_filter_active_tasks]
- [Периодические напоминания об открытых задачах][n3_periodic_task_notifications]

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

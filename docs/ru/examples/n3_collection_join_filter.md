---
title: 'Записи и коллекции. Объединение и фильтрация коллекций с помощью N3'
kbTitle: 'Записи и коллекции. Объединение и фильтрация коллекций с помощью N3'
kbId: 5109
tags:
  - N3
  - Notation 3
  - Notation3
  - RDF
  - атрибут типа «Запись»
  - доступ
  - вычисление
  - объединение
  - права
  - список
  - триплеты
  - тройка
  - тройки
  - фильтрация
  - запись
  - join
  - коллекция
hide: tags
---

# Записи и коллекции. Объединение и фильтрация коллекций с помощью N3 {: #example_n3_dataset_join_filter }

## Введение {: #example_n3_dataset_join_filter_intro }

Атрибут типа «**Запись**» хранит ID записей в связанном шаблоне (ссылки на них).

Бизнесу может потребоваться собрать коллекцию записей из нескольких шаблонов и фильтровать их по определённым условиям.

Например, пользователю необходимо предоставить для выбора в раскрывающемся списке только организации, с которыми он работает, когда перечень организаций формируется из нескольких источников.

Здесь представлен пример объединения и фильтрации списков записей по данным, связанным с текущим пользователем.

## Прикладная задача {: #example_n3_dataset_join_filter_use_case }

При оформлении грузового отправления сотрудник (текущий пользователь) должен выбрать грузополучателя из раскрывающегося списка.

Список возможных грузополучателей должен формироваться из двух справочников: _Клиенты_ и _Партнёры_.

Список должен содержать только тех контрагентов, для которых сотрудник указан как ответственный менеджер.

## Исходные данные {: #example_n3_dataset_join_filter_initial_data }

Имеются шаблоны: _Контрагенты_, _Контакты_, _Сотрудники_, _Отправления_.

В шаблоне записи _«Контрагенты»_ хранятся сведения о компаниях и ссылки на контактные лица.

Атрибут в шаблоне:

- _Контакты_
    **Описание:** _Коллекция записей контактных лиц контрагента_
    - **Тип данных: запись**
    - **Связанный шаблон:** _Контакты_
    - **Хранить несколько значений:** флажок установлен

В шаблоне записи _«Контакты»_ хранятся сведения о связях сотрудников с организациями.

Атрибуты в шаблоне:

- _Сотрудник_
    - **Описание:** _Ссылка на аккаунт сотрудника_
    - **Тип данных: аккаунт**
    - **Связанный шаблон:** _Сотрудники_
    - **Хранить несколько значений:** флажок снят
- _Ответственный_
    - **Описание:** _`True`, если сотрудник является ответственным менеджером для контрагента_
    - **Тип данных: логический**

В шаблоне _«Отправления»_ хранятся сведения о возможных и фактических получателях грузов.

Атрибуты в шаблоне:

- _Клиенты_ и _Партнёры_
    - **Описание:** _Отдельные коллекции организаций партнёров и клиентов_
    - **Тип данных: запись**
    - **Связанный шаблон:** _Контрагенты_
    - **Хранить несколько значений:** флажок установлен
- _Грузополучатель_
    - **Описание:** _Организация, которой предназначено отправление_
    - **Тип данных: запись**
    - **Связанный шаблон:** _Контрагенты_
    - **Хранить несколько значений:** флажок снят

## Настройка вычислений {: #example_n3_dataset_join_filter_calculation .pageBreakBefore }

1. Откройте для редактирования форму шаблона _«Отправления»_.
2. Поместите на форму атрибут _«Грузополучатель»_.
3. Настройте свойства поля _«Грузополучатель»_:

    - **Представление: раскрывающийся список**
    - **Доступ: разрешить ввод**
    - **Фильтр: N3**

    ``` turtle
    # Импортируем префиксы для работы
    # со списками, объектами и системными данными.
    @prefix list: <http://www.w3.org/2000/10/swap/list#>.
    @prefix cmw: <http://comindware.com/logics#>.
    @prefix object: <http://comindware.com/ontology/object#>.
    {
        # Получаем идентификатор текущего пользователя.
        cmw:securityContext cmw:currentUser ?user.

        # Получаем атрибуты, по которым будем определять связи сущностей.
        # Убедитесь, что системные имена соответствуют именам в вашем приложении.
        ("Отправления" "Клиенты") object:findProperty ?clientsAttribute.
        ("Отправления" "Партнёры") object:findProperty ?partnersAttribute.
        ("Контрагенты" "Контакты") object:findProperty ?contactsAttribute.
        ("Контакты" "Ответственный") object:findProperty ?responsibleAttribute.
        ("Контакты" "Сотрудник") object:findProperty ?employeeAttribute.

        # Получаем списки клиентов и партнёров из текущей записи.
        ?item ?clientsAttribute ?clientsList.
        ?item ?partnersAttribute ?partnersList.

        # Объединяем два списка организаций в один.
        (?clientsList ?partnersList) list:append ?organizations.

        # Отбираем из объединенного списка только организации,
        # где текущий пользователь является активным контактным лицом.
        ?organizations list:member ?userOrgs.
        ?userOrgs ?contactsAttribute ?orgContacts.
        ?orgContacts ?responsibleAttribute true.
        ?orgContacts ?employeeAttribute ?user.
          
        # Возвращаем итоговый список
        ?userOrgs -> ?value.
    } 
    ```

4. Поместите на форму атрибуты _«Клиенты»_ и _«Партнёры»_ и настройте их:

    - выберите **представление** «**Таблица**»;
    - добавьте кнопки «**Создать**», «**Добавить**», «**Исключить**», «**Удалить**».

5. На форму шаблона _«Контрагенты»_ поместите атрибут _«Контакты»_ и настройте его:

    - выберите **представление** «**Таблица**»;
    - добавьте столбцы _«Ответственный»_ и _«Сотрудник»_;
    - добавьте кнопки «**Создать**», «**Добавить**», «**Исключить**», «**Удалить**».

## Тестирование {: #example_n3_dataset_join_filter_test .pageBreakBefore }

1. Создайте несколько тестовых аккаунтов.
2. Создайте записи в шаблоне _«Контрагенты»_:

    - заполните таблицу _«Контакты»_:
        - укажите различные аккаунты, в том числе свой аккаунт;
        - для части контактов установите флажок _«Ответственный»_;

3. Создайте запись в шаблоне _«Отправления»_.
4. Добавьте в таблицы _«Клиенты»_ и _«Партнёры»_ разных контрагентов.
5. Откройте раскрывающийся список _«Грузополучатель»_. В нём должны отображаться только клиенты и партнёры, в которых вы (текущий пользователь) указаны как _ответственный_ менеджер.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- [Атрибут типа «Запись»][attribute_record]
- [Атрибут типа «Аккаунт»][attribute_account]
- [Атрибут типа «Логический»][attribute_boolean]
- [Язык N3][n3_guide_cat]

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

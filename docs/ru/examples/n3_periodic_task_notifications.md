---
title: 'Периодические напоминания об открытых задачах'
kbTitle: 'Периодические напоминания об открытых задачах. Настройка процессов, сценария и HTML-текста письма'
tags:
    - HTML
    - N3
    - Notation 3
    - RDF
    - email
    - процессы
    - письма
    - триплеты
    - тройка
    - тройки
    - уведомления
    - задачи
    - таблица в письме
    - эл. почта
    - вычисление
hide:
    - tags
kbId: 4905
---

# Периодические напоминания об открытых задачах. Настройка с помощью N3 {: #n3_periodic_task_notifications }

## Введение {: #n3_periodic_task_notifications_intro }

**{{ productName }}** поддерживает отправку пользователю стандартных уведомлений о назначенных ему задачах или процессных уведомлений с информацией из бизнес-процесса.

Здесь представлен пример настройки отправки исполнителям эл. писем с процессными уведомлениями о задачах в формате HTML.

См. также _«[Уведомления. Типы, назначение, настройка, использование][notification_types]»_.

## Прикладная задача {: #n3_periodic_task_notifications_use_case }

Требуется отправлять сотрудникам эл.&nbsp;письма с напоминаниями о назначенных им задачах:

- напоминания необходимо отправлять ежедневно в в 7:00;
- письмо должно содержать перечень открытых задач сотрудника в виде таблицы.

## Пример решения {: #n3_periodic_task_notifications_solution }

Для реализации прикладной задачи настроим два бизнес-процесса:

- _Поиск сотрудников с активными задачами_ — запускается по таймеру и находит сотрудников, у которых есть открытые задачи на момент запуска, затем для каждого сотрудника запускает процесс _«Отправка напоминания»_.
- _Отправка напоминания_ — формирует и отправляет эл.&nbsp;письмо каждому сотруднику.

### Настройка процесса «Отправка напоминания» {: #n3_periodic_task_notifications_configure_send .pageBreakBefore }

!!! warning "Внимание!"

    Для корректной работы вычислений и запуска процессов указывайте в выражениях именно те системные имена шаблонов и атрибутов, которые фактически используются в вашем приложении. Они могут отличаться от указанных в примере.

1. Создайте шаблон записи _«Напоминания»_.
2. Создайте шаблон процесса _«Отправка напоминания»_, связанный с шаблоном _«Напоминания»_.
3. В шаблоне _«Напоминания»_ создайте следующие атрибуты:

    - _Сотрудник_
        - **Системное имя:** `Сотрудник`
        - **Тип данных: аккаунт**
        - **Описание:** _Пользователь, которому будет отправляться напоминание_
    - _Кому_
        - **Системное имя:** `Кому`
        - **Тип данных: текст**
        - **Описание:** _Адрес эл. почты сотрудника_
        - **Вычислять автоматически:** флажок установлен
        - **Вычисляемое значение: формула**

    ``` sql
    $Сотрудник->cmw.account.mbox
    ```

    - _Текст письма_
        - **Системное имя:** `Текстписьма`
        - **Тип данных: текст**
        - **Формат отображения: HTML-текст**
        - **Описание**: _Текст письма с таблицей задач в формате HTML_
        - **Вычислять автоматически:** флажок установлен
        - **Вычисляемое значение: N3**

    ``` turtle
    # Импортируем функции для работы с логикой, строками, объектами, 
    # конфигурацией, статусами задач, аккаунтами и ролями.
    @prefix cmw: <http://comindware.com/logics#>.
    @prefix string: <http://www.w3.org/2000/10/swap/string#>.
    @prefix cmwstring: <http://comindware.com/logics/string#>.
    @prefix object: <http://comindware.com/ontology/object#>.
    @prefix configuration: <http://comindware.com/ontology/configuration#>.
    @prefix taskStatus: <http://comindware.com/ontology/taskStatus#>.
    @prefix account: <http://comindware.com/ontology/account#>.
    @prefix role: <http://comindware.com/ontology/role#>.
    {
            # Получаем базовый URL системы для формирования ссылок на задачи.
            # Вместо <yourhost> подставьте адрес вашего сайта {{ productName }}
            # либо используйте конструкцию:
            #?confid configuration:baseUri ?baseUri.
            ?baseUri a "https://<yourhost>/".
            # Находим атрибут «Сотрудник» в шаблоне «Напоминания»
            # для получения данных об пользователе,
            # которому будет отправлено напоминание.
            ("Напоминания" "Сотрудник") object:findProperty ?Employee.
            ?item ?Employee ?EmployeeVal.
            # Формируем заголовок таблицы с задачами
            # Создаем HTML-заголовок и начало таблицы со столбцами "Задача" и "Срок"
            ("<p style='font-size: 100%' >Перечень Ваших задач</p>" "<table border='1' style='width: 60%; border-collapse: collapse; border: 1px solid black' ><tBody> <tr><td style='padding: 2px; width: 200px; border: 1px solid black'>Задача</td> <td style='width: 200px; padding: 2px; border: 1px solid black'>Срок</td></tr>") string:concatenation ?firstHeaderRow.
            # Собираем задачи пользователя
            from {
                # Получаем все задачи.
                ?tasks a cmw:UserTask.
                # Получаем активные задачи.
                ?tasks cmw:taskStatus taskStatus:inProgress.
                # Получаем роли пользователя.
                ?roles role:roleMembers ?EmployeeVal.
                # Получаем группы, в которые входит пользователь.
                ?EmployeeVal account:userGroupMembership ?groups.
                # Получаем роли, в которые входят группы пользователя.
                ?roleGroups role:roleMembers ?groups.
                # Проверяем, является ли пользователь
                # фактическим или возможным исполнителем задачи.
                # Проверяем различные варианты назначения задачи.
                or {
                    # Проверяем, назначена ли задача на пользователя.
                    ?tasks cmw:assignee ?EmployeeVal.
                }
                or {
                    # Проверяем, является ли пользователь возможным исполнителем.
                    ?tasks cmw:possibleAssignee ?EmployeeVal.
                }
                or {
                    # Проверяем, назначена ли задача на роль пользователя.
                    ?tasks cmw:assignee ?roles.
                }
                or {
                    # Проверяем, является ли роль возможным исполнителем.
                    ?tasks cmw:possibleAssignee ?roles.
                }
                or {
                    # Проверяем, назначена ли задача на группу пользователя.
                    ?tasks cmw:assignee ?roleGroups.
                }
                or {
                    # Проверяем, является ли группа возможным исполнителем.
                    ?tasks cmw:possibleAssignee ?roleGroups.
                }.
                # Получаем название и ID задачи.
                ?tasks cmw:title ?title.
                ?tasks cmw:id ?id.
                # Форматируем название и ID задачи для вставки в HTML.
                ("{0}" ?title) string:format ?titleVal.
                ("{0}" ?id) string:format ?idVal.
                # Получаем срок выполнения задачи (если есть).
                or {?tasks cmw:dueDate ?dueDate.}
                or {"" -> ?dueDate.}.
                # Форматируем дату для отображения.
                ("{0}" ?dueDate) string:format ?dueDateVal.
                # Формируем строку таблицы с ссылкой на задачу и сроком.
                ("<tr><td class='A' style='padding: 2px; border: 1px solid black; '><a href='"?baseUri"#task/" ?idVal "'>" ?titleVal "</a></td><td align='right' style='padding: 2px; border: 1px solid black; text-align: right'>" ?dueDateVal "</td></tr>") string:concatenation ?firstRow.
            } select ?firstRow -> ?firstFactRow.
            # Объединяем все строки таблицы.
            (" " ?firstFactRow) cmwstring:join ?firstFact.
            # Формируем финальный HTML с заголовком, таблицей и закрывающими тегами.
            (?firstHeaderRow ?firstFact "</tBody></table> <br/>") string:concatenation ?first.
            # Возвращаем результат.
            ?first  -> ?value.
    }
    ```

4. Постройте диаграмму процесса по показанному на следующей иллюстрации образцу:

    _![Диаграмма процесса «Отправка напоминания»](https://kb.comindware.ru/assets/timenotif7.jpg)_

5. Настройте событие-отправку сообщения. См. _«[Отправка эл.&nbsp;почты из сценариев][scenario_send_email]»_.
6. Опубликуйте процесс.

### Настройка процесса «Поиск сотрудников с активными задачами» {: #n3_periodic_task_notifications_configure_search .pageBreakBefore }

1. Создайте шаблон записи _«Сотрудники для напоминаний»_.
2. Создайте шаблон процесса _«Поиск сотрудников с активными задачами»_, связанный с шаблоном _«Сотрудники для напоминаний»_.
3. В шаблоне _«Сотрудники для напоминаний»_ создайте атрибут:

    - _Сотрудники_
        - **Системное имя:** `Сотрудники`
        - **Тип данных: аккаунт**
        - **Хранить несколько значений:** флажок установлен
        - **Вычислять автоматически:** флажок установлен
        - **Вычисляемое значение: N3**

    ``` turtle
    # Импортируем основные функции для работы 
    # с логикой, контейнерами, аккаунтами и статусами задач
    @prefix cmw: <http://comindware.com/logics#>.
    @prefix container: <http://comindware.com/ontology/container#>.
    @prefix account: <http://comindware.com/ontology/account#>.
    @prefix taskStatus: <http://comindware.com/ontology/taskStatus#>.
    {
        # Получаем все задачи.
        ?tasks a cmw:UserTask.
        # Получаем активные задачи.
        ?tasks cmw:taskStatus taskStatus:inProgress.
        # Получаем фактических и возможных исполнителей задач.
        # Проверяем различные варианты назначения задач.
        or{
            # Возвращаем фактического исполнителя,
            # если он назначен через группы и роли.
            ?tasks cmw:assignee ?assigneeRoles.
            ?assigneeRoles role:roleMembers ?groupMembers.
            ?groupMembers account:groupUsers ?value.
        }
        or {

            # Возвращаем фактического исполнителя,
            # если он назначен через роли.
            ?tasks cmw:assignee ?assigneeRoles.
            ?assigneeRoles role:roleMembers ?value.
        }
        or {
            # Возвращаем фактического исполнителя,
            # если он назначен через аккаунт.
            ?tasks cmw:assignee ?value.
        }
        or{
            # Возвращаем список возможных исполнителей,
            # если они назначены через группы и роли.
            ?tasks cmw:possibleAssignee ?possibleRoles.
            ?assigneeRoles role:roleMembers ?groupMembers.
            ?groupMembers account:groupUsers ?value.
        }
        or {

            # Возвращаем список возможных исполнителей,
            # если они назначены через роли.
            ?tasks cmw:possibleAssignee ?possibleRoles.
            ?assigneeRoles role:roleMembers ?value.
        }
        or {
            # Возвращаем список возможных исполнителей,
            # если они назначены через аккаунты.
            ?tasks cmw:possibleAssignee ?value.
        }.
        # Оставляем только активные аккаунты.
        ?value account:active true.
        # Исключаем отключенные аккаунты
        not {?value cmw:isDisabled true.}.
    }
    ```

    - _Сотрудникам на отправку_
        - **Системное имя:** `Сотрудникамнаотправку`
        - **Тип данных: запись**
        - **Связанный шаблон:** _Напоминания_
        - **Взаимная связь с новым атрибутом:** _Найденные сотрудники_ (`Найденныесотрудники`)
        - **Хранить несколько значений:** флажок установлен

4. Постройте диаграмму процесса по показанному на следующей иллюстрации образцу:

    _![Диаграмма процесса «Отправка напоминания»](https://kb.comindware.ru/assets/timenotif2.jpg)_

5. Настройте начальное событие-таймер на запуск ежедневно в 7:00.

    _![Настройка таймера](https://kb.comindware.ru/assets/timenotif3.jpg)_

    !!! note "Примечание"

        При необходимости предусмотрите также простое начальное событие для запуска процесса вручную без необходимости ожидания нового рабочего дня.

6. Настройте сценарий на входе в действие «**Вызов процесса**» для создания записей, по которым будет запускаться подпроцесс.

    _![Действия сценария на входе](https://kb.comindware.ru/assets/trigger1.jpg)_

    1. Внутрь действия «**Сменить контекст**» добавьте действие «**Цикл по объектам**» и настройте его, как показано ниже.

        _![Добавление действия «Цикл по объектам»](https://kb.comindware.ru/assets/trigger2.jpg)_

        Переменная `local` хранит поочередно по одному экземпляру из указанной выборки.

        Внизу укажите атрибут _«Сотрудники»_, в котором вычисляются сотрудники с активными задачами.

    2. Добавьте действие «**Создать запись**» и настройте его.

        _![Добавление действия «Создать запись»](https://kb.comindware.ru/assets/trigger3.jpg)_

        - **Целевой шаблон записи** — укажите шаблон записи _«Напоминания»_.
        - **Ссылка на новую запись** — укажите атрибут _«Сотрудникам на отправку»_, созданный на шаге 3.
        - **Операция со значениями** — укажите «**Добавить**».

    3. Добавьте действие «**Изменить значения атрибутов**» и настройте таблицу атрибутов следующим образом:

        - **Атрибут:** _Сотрудник_
        - **Операция со значениями: заменить**
        - **Значение:** `$$local`

        _![Настройка действия «Изменить значения атрибутов»](https://kb.comindware.ru/assets/trigger4.jpg)_

7. Настройте вызов процесса:

    - **Записи для запуска процесса**: атрибут _«Сотрудникам на отправку»_
    - **Шаблон вызываемого процесса**: атрибут _«Отправка напоминания»_

    _![Настройка подпроцесса](https://kb.comindware.ru/assets/trigger5.jpg)_

8. Опубликуйте и протестируйте процесс.

    Перед началом тестирования проверьте работоспособность подключения для отправки почты и правильность настройки исходящего пути передачи данных.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- [Вычисление пользователей, у которых есть активные задачи][example_n3_calculate_active_task_accounts]
- [Отправка эл.&nbsp;почты из сценариев][scenario_send_email]
- [Фильтр списка по активным задачам текущего пользователя: по всем процессам, по конкретному процессу][n3_filter_active_tasks]
- [Уведомления. Типы, назначение, настройка, использование][notification_types]
- [Уведомления о задачах. Настройка особого текста][task_notifications]

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

---
title: 'Периодические напоминания об открытых задачах'
kbTitle: 'Периодические напоминания об открытых задачах. Настройка процессов, сценария и HTML-текста письма'
tags:
    - процессы
    - уведомления
    - N3
    - HTML
    - email
    - эл. почта
    - письма
    - таблица в письме
hide:
    - tags
kbId: 4905
---

# Периодические напоминания об открытых задачах. Настройка процессов, сценария и HTML-текста письма {: #n3_periodic_task_notifications }

## Введение {: #n3_periodic_task_notifications_intro }

**{{ productName }}** поддерживает  отправку пользователю стандартных уведомлений о назначенных задачах или процессного уведомления с информацией из бизнес-процесса.

Иногда возникает необходимость настроить напоминания сотруднику об его открытых задачах, например, ежедневно в определенное время.

Для данной настройки создайте два бизнес-процесса:

- Поиск сотрудников для отправки напоминания;
- Отправка ежедневного напоминания.

Первый процесс будет запускаться по таймеру ежедневно, например, в 7:00 и искать сотрудников, у которых есть открытые задачи в этот момент времени, и по каждому запускать параллельно в цикле подпроцесс «*Отправка ежедневного напоминания*», который в свою очередь будет формировать и отправлять перечень открытых задач сотрудника на эл. почту в виде таблицы.

## Настройка процесса «Отправка ежедневного напоминания» {: #n3_periodic_task_notifications_configure_send .pageBreakBefore }

1. Создайте шаблон записи _«Напоминания»_.
2. Создайте шаблон процесса _«Отправка ежедневного напоминания»_, связанный с шаблоном _«Напоминания»_.
3. В шаблоне _«Напоминания»_ создайте атрибуты:

    - _Сотрудник_
        - **Системное имя:** `Сотрудник`
        - **Тип данных: аккаунт**
        - **Описание:** _Пользователь, которому будет отправляться напоминание_
    - _Текст письма_
        - **Системное имя:** `Текстписьма`
        - **Тип данных: текст**
        - **Формат отображения: HTML-текст**
        - **Описание**: _Текст письма с таблицей задач в формате HTML_
        - **Вычислять автоматически:** флажок установлен
        - **Вычисляемое значение: N3**

    ``` turtle
    @prefix cmw: <http://comindware.com/logics#>.
    @prefix string: <http://www.w3.org/2000/10/swap/string#>.
    @prefix cmwstring: <http://comindware.com/logics/string#>.
    @prefix object: <http://comindware.com/ontology/object#>.
    @prefix configuration: <http://comindware.com/ontology/configuration#>.
    @prefix taskStatus: <http://comindware.com/ontology/taskStatus#>. 
    {
            # Вместо <yourhost> подставьте адрес вашего сайта {{ productName }}
            ?baseUri a "https://<yourhost>".
            ("Напоминания" "Сотрудник") object:findProperty ?Sotrudnik.
            ?item ?Sotrudnik ?SotrudnikVal.

        #First table
        ("<p style='font-size: 100%' >Перечень Ваших задач</p>" "<table border='1' style='width: 60%; border-collapse: collapse; border: 1px solid black' ><tBody> <tr><td style='padding: 2px; width: 200px; border: 1px solid black'>Задача</td> <td style='width: 200px; padding: 2px; border: 1px solid black'>Срок</td></tr>") string:concatenation ?firstHeaderRow.

        from {
            ?tasks a cmw:UserTask.
            or {?tasks cmw:assignee ?SotrudnikVal.}
            or {?tasks cmw:possibleAssignee ?SotrudnikVal.}.
            ?tasks cmw:taskStatus taskStatus:inProgress.
            ?tasks cmw:title ?title.
            ?tasks cmw:id ?id.

            ("{0}" ?title) string:format ?titleVal.
            ("{0}" ?id) string:format ?idVal.
            
            or {?tasks cmw:dueDate ?dueDate.}
            or {"" -> ?dueDate.}.

            ("{0}" ?dueDate) string:format ?dueDateVal.
                        
            ("<tr><td class='A' style='padding: 2px; border: 1px solid black; '><a href='" ?baseUri "#task/" ?idVal "'>" ?titleVal "</a></td><td align='right' style='padding: 2px; border: 1px solid black; text-align: right'>" ?dueDateVal "</td></tr>") string:concatenation ?firstRow.

        } select ?firstRow -> ?firstFactrow.

        (" " ?firstFactrow) cmwstring:join ?firstFact.
        (?firstHeaderRow ?firstFact "</tBody></table> <br/>") string:concatenation ?first.
        ?first  -> ?value.
    }
    ```

    - _Кому_ (to) — атрибут типа «Текст» с адресом эл. почты сотрудника. Установите флажок «Вычислять автоматически». В поле «**Вычисляемое значение**» введите следующую **формулу**:

    ``` sql
    $Sotrudnik->cmw.account.mbox
    ``` 

4. Постройте диаграмму процесса по показанному на следующей иллюстрации образцу:

    _![Диаграмма процесса «Отправка ежедневного напоминания»](https://kb.comindware.ru/assets/timenotif7.jpg)_

5. Настройте событие-отправку сообщения.
6. Опубликуйте процесс.

## Настройка процесса «Поиск сотрудников для отправки напоминания» {: #n3_periodic_task_notifications_configure_search .pageBreakBefore }

1. Создайте шаблон записи _«Сотрудники для напоминаний»_.
2. Создайте шаблон процесса _«Поиск сотрудников для отправки напоминания»_, связанный с шаблоном _«Сотрудники для напоминаний»_.
3. В шаблоне _«Сотрудники для напоминаний»_ создайте атрибуты:

    - _Сотрудники_
        - **Системное имя:** `Сотрудники`
        - **Тип данных: аккаунт**
        - **Хранить несколько значений:** флажок установлен
        - **Вычислять автоматически:** флажок установлен
        - **Вычисляемое значение: N3**

    ``` turtle
    @prefix cmw: <http://comindware.com/logics#>.
    @prefix container: <http://comindware.com/ontology/container#>.
    @prefix account: <http://comindware.com/ontology/account#>.
    @prefix taskStatus: <http://comindware.com/ontology/taskStatus#>.
    {
            ?class cmw:className "Account".
            ?value a ?class.
            ?value account:active true.
            not {?value cmw:isDisabled true.}.
            or {?tasks cmw:assignee ?value.}
            or {?tasks cmw:possibleAssignee ?value.}.
            ?tasks cmw:taskStatus taskStatus:inProgress.
    }
    ```

    - _Сотрудникам на отправку_
        - **Системное имя:** `Отправленныенапоминания`
        - **Тип данных: запись**
        - **Связанный шаблон:** _Сотрудникам на отправку_
        - **Взаимная связь с новым атрибутом:** _Поиск_ (`Поиск`)
        - **Хранить несколько значений:** флажок установлен

4. Постройте схему процесса по показанному на следующей иллюстрации образцу:

    _![Типовая схема процесса](https://kb.comindware.ru/assets/timenotif2.jpg)_

5. Настройте начальное событие-таймер.

    _![Настройка таймера](https://kb.comindware.ru/assets/timenotif3.jpg)_

    !!! note "Примечание"

        Если нужно, предусмотрите также простое начальное событие для запуска процесса вручную без необходимости ожидания нового рабочего дня.

6. Настройте сценарий на входе в повторно используемый подпроцесс для создания записей, по которым затем будет запущен подпроцесс.

    _![Действия сценария на входе](https://kb.comindware.ru/assets/trigger1.jpg)_

    5.1. Первые два блока являются системными, поэтому начните с добавления действия «Цикл по объектам» и его настройки.

    _![Добавление действия «Цикл по объектам»](https://kb.comindware.ru/assets/trigger2.jpg)_

    Переменная `local` хранит в себе поочередно по одному экземпляру из указанной выборки. Внизу укажите атрибут «Сотрудники», в котором вычисляются сотрудники с активными задачами.

    5.2. Добавьте действие «Создать запись» и настройте его.

    _![Добавление действия «Создать запись»](https://kb.comindware.ru/assets/trigger3.jpg)_

    - **Целевой шаблон записи** — укажите шаблон записи _«Отправка ежедневного напоминания»_.
    - **Ссылка на новую запись** — укажите атрибут _«Сотрудникам на отправку»_, созданный на шаге 3.
    - **Операция со значениями** — укажите «**Добавить**».

    5.3. Добавьте действие «Изменить значения атрибутов» и настройте его.

    _![Добавление действия «Изменить значения атрибутов»](https://kb.comindware.ru/assets/trigger4.jpg)_

    Нажмите «**Создать**», выберите атрибут _«Сотрудник»_, укажите «**Заменить**» в «**Операция со значениями**» и вставьте формулу `$$local` в последнем столбце.

7. Настройте вызов подпроцесса.

    _![Настройка подпроцесса](https://kb.comindware.ru/assets/trigger5.jpg)_

    В «**Записи для запуска процесса**» укажите атрибут _«Сотрудникам на отправку»_, а в «**Шаблоне вызываемого процесса**» — _«Отправка ежедневного напоминания»_.

8. Опубликуйте процесс и протестируйте.

    Перед началом тестирования проверьте работоспособность подключения для отправки почты и правильность настройки исходящего пути передачи данных.

!!! note "Примечание"

    Для корректной работы вычислений и запуска подпроцесса удостоверьтесь в точном соответствии системных имен всех шаблонов и атрибутов, указанных в выражениях на N3.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- [Вычисление пользователей, у которых есть активные задачи][calculate_active_task_accounts]
- [Настройка процесса для отправки email][process_email_configure]
- [Фильтр списка по активным задачам текущего пользователя: по всем процессам, по конкретному процессу][filter_active_tasks]
- [Уведомления. Типы, назначение, настройка, использование][notification_types]
- [Уведомления о задачах. Настройка особого текста][task_notifications]

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

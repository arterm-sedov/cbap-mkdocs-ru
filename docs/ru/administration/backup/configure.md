---
title: 'Резервное копирование'
kbTitle: 'Резервное копирование. Настройка, запуск и просмотр журнала сеансов'
kbId: 4642
tags:
    - резервная копия
    - S3
    - история
    - восстановление
    - журнал резервного копирования
    - конфигурация резервного копирования
hide: tags
---

# Резервное копирование. Настройка, запуск и просмотр журнала сеансов {: #backup_configure }

## Введение {: #intro }

Для обеспечения бесперебойной работы **{{ productName }}** необходимо настроить регулярное резервное копирование данных экземпляра ПО.

Здесь представлены рекомендации по настройке и запуску резервного копирования, а также по просмотру журнала сеансов.

Прежде чем приступать к настройке резервного копирования ознакомьтесь с _[рекомендациями по организации и оптимизации резервного копирования и восстановления][backup_recommendations]_.

{% if userGuide or kbExport %}
Дополнительные инструкции по резервному копированию и восстановлению данных встроенными и внешними средствами см. в разделе _«[Резервное копирование и восстановление][backup_and_restore]»_ базы знаний **{{ companyName }}**.
{% endif %}

## Инструменты резервного копирования и восстановления {{ productName }} {: #backup_configure_tools }

- В **{{ productName }}** предусмотрена функция резервного копирования полного образа экземпляра ПО в формате файла с расширением `.CDBBZ`.
    - В такой резервной копии сохраняются все данные всех приложений и настройки экземпляра ПО **{{ productName }}**.
    - Резервные копии могут храниться как в файловой системе сервера **{{ productName }}**, так и в хранилище S3. См. _«[Настройка экземпляра ПО {{ productName }} для хранения резервных копий в хранилище S3](#backup_configure_instance_s3)»_.
    - Резервное копирование может запускаться вручную или по расписанию.
    - Резервное копирование следует настраивать и запускать с помощью страницы «**Администрирование**» — «**Инфраструктура**» — «**Резервное копирование**». См. _«[Просмотр списка и настройка конфигураций резервного копирования](#backup_configure_list_view)»_.
    - В **{{ productName }}** предусмотрен [журнал сеансов резервного копирования](#backup_configure_list_view).
- Восстановление данных осуществляется на стороне сервера **{{ productName }}**. См. _«[Восстановление базы данных из файла резервной копии в формате .CDBBZ][backup_restore_cdbbz]»_.
- В зависимости от требуемого уровня надежности, доступности и отказоустойчивости системы, резервное копирование также можно выполнять средствами виртуализации, файловой системы, {{ apacheIgniteVariants }}, {{ openSearchVariants }} и {{ apacheIgniteVariants }}. См. _[Рекомендации по организации и оптимизации резервного копирования и восстановления][backup_recommendations]_.

## Порядок резервного копирования и восстановления {: #backup_configure_procedure .pageBreakBefore }

1. Настройте конфигурацию экземпляра ПО **{{ productName }}**:

    - Настройте папку или репозиторий S3 для хранения резервных копий.
    - Настройте используемые по умолчанию параметры резервного копирования в файле конфигурации экземпляра ПО.

    {% if not gostech %}См. _«[Настройка экземпляра ПО {{ productName }} для хранения резервных копий на диске](#backup_configure_instance)»_ и _«[Настройка экземпляра ПО {{ productName }} для хранения резервных копий в хранилище S3](#backup_configure_instance_s3)»_.{% endif %}

2. Настройте резервное копирование данных {{ openSearchVariants }}. См. {% if gostech %}_[документацию Platform V Search](https://client.sbertech.ru/docs/public/SRH/1.6.0/index.html)_{% else %}_«[Настройка резервного копирования данных {{ openSearchVariants }}](#backup_configure_elasticsearch)»_{% endif %}.
3. Настройте одну или несколько [конфигураций резервного копирования](#backup_configure_list_view).
4. [Запустите резервное копирование](#backup_configure_start) с использованием настроенных конфигураций вручную или по расписанию.
5. Просмотрите статус [сеансов в журнале резервного копирования](#backup_configure_sessions_list).
6. Восстановите данные из резервной копии.

{% if not gostech %}
## Настройка экземпляра ПО {{ productName }} для хранения резервных копий на диске {: #backup_configure_instance_disk .pageBreakBefore }

1. Создайте на сервере с экземпляром ПО **{{ productName }}** директорию, в которой будут сохраняться резервные копии. Для этой директории предоставьте разрешения на полный доступ, чтобы система могла сохранять в неё резервные копии, например:

    **Astra Linux, Ubuntu, Rocky**

    ``` shell
    mkdir /var/backups/comindware/<instanceName>
    chmod 777 /var/backups/comindware/<instanceName>
    chown -R www-data:www-data /var/backups/comindware/<instanceName>
    ```

    **Альт Сервер, РЕД ОС**

    ``` shell
    mkdir /var/backups/comindware/<instanceName>
    chmod 777 /var/backups/comindware/<instanceName>
    chown -R _nginx:_nginx /var/backups/comindware/<instanceName>
    ```

    **Здесь** `<instanceName>` — имя экземпляра ПО.

2. Откройте для редактирования файл конфигурации экземпляра ПО (`/usr/share/comindware/configs/instance/<instanceName>.yml`).
3. Настройте используемые по умолчанию путь и имя файла резервной копии. Заданные в этих директивах параметры используются по умолчанию при создании конфигураций резервного копирования:

    ``` yaml
    #################### Конфигурация резервного копирования ####################
    # Папка для резервного копирования по умолчанию
    backup.defaultFolder: /var/lib/comindware/<instanceName>/Backup

    # Имя файла для резервного копирования по умолчанию
    # К нему будут добавляться метка времени и расширение cdbbz, например:
    # Backup.202202161625.cdbbz
    backup.defaultFileName: Backup
    ```

4. Перезапустите экземпляр ПО.
5. Настройте конфигурацию резервного копирования на диск c помощью _«[списка конфигураций резервного копирования](#backup_configure_list_view)»_.

## Настройка экземпляра ПО {{ productName }} для хранения резервных копий в хранилище S3 {: #backup_configure_instance_s3 .pageBreakBefore }

1. Откройте для редактирования файл конфигурации экземпляра ПО (`/usr/share/comindware/configs/instance/<instanceName>.yml`).
2. Настройте подключение к хранилищу S3 по умолчанию.

    !!! warning "Внимание!"

        Это подключение будет использоваться для конфигураций, настроенных в списке конфигураций резервного копирования.
        
        См. _«[Просмотр списка и настройка конфигураций резервного копирования](#backup_configure_list_view)»_.

    ``` yaml
    ##### Конфигурация подключения к хранилищу S3 по умолчанию #####
    # Описание конфигурации.
    # `default` — обязательное имя подключения
    # для основного хранилища резервных копий
    s3.default.description: Подключение к S3 для основного хранилища резервных копий
    # Адрес и порт сервера S3.
    s3.default.endpointURL: http://<s3hostname>:<s3port>
    # Информация учётной записи. Ключ подключения к хранилищу S3
    s3.default.accessKey: xxxx
    # Информация учётной записи. Секретный ключ подключения к хранилищу S3.
    s3.default.secretKey: xxxx
    # Установите значение true, если сервер принимает только запросы path-style вида:
    # https://<s3hostname>/bucket-name/key-name
    #s3.default.pathStyleAccess: true
    ```

3. Перезапустите экземпляр ПО.
4. Настройте конфигурацию резервного копирования в хранилище S3 c помощью _«[списка конфигураций резервного копирования](#backup_configure_list_view)»_.

## Настройка резервного копирования в хранилище S3 с помощью файла конфигурации экземпляра ПО {{ productName }} {: #backup_configure_instance_s3_advanced .pageBreakBefore }

При необходимости можно настроить конфигурацию резервного копирования с дополнительным подключением к S3.

!!! warning "Внимание!"

    Это подключение можно указать в директивах `backup.default.<backupName>.repository.s3.connection` и `backup.default.<backupName>.extraRepository.s3.connection` в файле конфигурации `<instanceName>.yml`. 

    Это подключение нельзя использовать в конфигурациях резервного копирования, настроенных в [списке конфигураций резервного копирования](#backup_configure_list_view).

1. Откройте для редактирования файл конфигурации экземпляра ПО (`/usr/share/comindware/configs/instance/<instanceName>.yml`).
2. Настройте дополнительное подключение к хранилищу S3.

    ``` yaml
    ##### Конфигурация дополнительного подключения к хранилищу S3 #####
    # <s3connectionName> — задайте имя подключения.
    s3.<s3connectionName>.description: Дополнительное подключение к S3
    s3.<s3connectionName>.endpointURL: http://<s3hostnameForFiles>:<s3port>
    s3.<s3connectionName>.accessKey: xxxx
    s3.<s3connectionName>.secretKey: xxxx
    #s3.<s3connectionName>.pathStyleAccess: true
    ```

3. Настройте конфигурацию резервного копирования по умолчанию. Эта конфигурация не будет отображаться в списке конфигураций. Она будет запускаться автоматически по заданному расписанию.

    ``` yaml
    ##### Конфигурация резервного копирования по умолчанию #####
    # <backupName> — имя конфигурации резервного копирования, без пробелов
    # Имя файлов резервных копий.
    # К нему будут добавляться метка времени и расширение cdbbz, например:
    # Backup.202202161625.cdbbz
    backup.default.<backupName>.name: Backup
    # Тип хранилища.
    backup.default.<backupName>.repository.type: S3
    # Имя корзины S3 для хранения файлов резервных копий.
    backup.default.<backupName>.repository.s3.bucket: <backup-files-bucket>
    # Имя подключения к S3, например 'default' или .
    backup.default.<backupName>.repository.s3.connection: <s3connectionName>
    # Описание конфигурации
    backup.default.<backupName>.description:
    # Периодичность запуска резервного копирования.
    backup.default.<backupName>.period: 23:00
    # Дни запуска резервного копирования.
    backup.default.<backupName>.days: [Sunday,  Monday, Tuesday, Wednesday, Thursday, Friday, Saturday]
    # Время начала запуска резервного копирования.
    backup.default.<backupName>.timeFrom: 00:01
    # Время окончания запуска резервного копирования.
    backup.default.<backupName>.timeUpTo: 23:59
    # Количество резервных копий одновременно хранящихся в системе.
    # Старые будут удалены автоматически.
    backup.default.<backupName>.keepRecent: 10
    # Управление составом резервной копии — загруженные файлы
    backup.default.<backupName>.withStreams: true
    # Управление составом резервной копии —  файлы скриптов.
    backup.default.<backupName>.withScripts: true
    # Управление составом резервной копии — файлы истории ({{ openSearchVariants }}).
    backup.default.<backupName>.withJournal: true
    ```

4. Перезапустите экземпляр ПО.

## Настройка резервного копирования данных {{ openSearchVariants }} {: #backup_configure_elasticsearch .pageBreakBefore }

Для корректного резервного копирования данных истории необходимо настроить конфигурацию службы {{ openSearchVariants }} и экземпляра ПО **{{ productName }}**.

1. В файле конфигурации {{ openSearchVariants }} (`/etc/elasticsearch/elasticsearch.yml`) должен быть указан путь к репозиторию резервных копий, например:

    **Для репозитория на локальном диске**

    ``` shell
    # Директория репозитория должна быть доступна экземпляру ПО
    # {{ productName }}
    path.repo: /var/www/backups/elasticsearch
    ```

    !!! warning "Внимание"

        Предоставьте доступ {{ openSearchVariants }} к репозиторию резервных копий:

        ``` sh
        chmod -R 777 /var/www/backups/elasticsearch
        chown -R elasticsearch:elasticsearch /var/www/backups/elasticsearch
        ```

    **Для репозитория в хранилище S3**

    ``` shell
    s3.client.default.endpoint: localhost:9000
    s3.client.default.protocol: http
    s3.client.default.path_style_access: true
    ```

    {% include-markdown ".snippets/s3_warning.md" %}

2. В файле конфигурации экземпляра ПО (`/usr/share/comindware/configs/instance/<instanceName>.yml`) необходимо указать тип репозитория резервных копий {{ openSearchVariants }} (`LocalDisk` или `S3`) и путь к репозиторию, например:

    **Для репозитория на локальном диске**

    ``` shell
    # Тип хранилища резервных копий {{ openSearchVariants }}: LocalDisk или S3
    backup.journalRepository.type: LocalDisk
    Путь к файлам резервных копий
    backup.journalRepository.localDisk.path: /var/www/backups/elasticsearch
    ```

    !!! note "Примечание"

        В данном примере {{ openSearchVariants }} и **{{ productName }}** работают на одной машине.
        В противном случае следует примонтировать папку репозитория {{ openSearchVariants }} на машине с **{{ productName }}** и указать её в директиве `backup.journalRepository.localDisk.path`.

    **Для репозитория в хранилище S3**
    {: .pageBreakBefore }

    ``` shell
    # Конфигурация подключения к хранилищу S3, используемого по умолчанию
    s3.default.endpointURL: http://localhost:9000
    s3.default.accessKey: xxxxx
    s3.default.secretKey: xxxxx
    s3.default.pathStyleAccess: true
    s3.default.description: Подключение к S3 по умолчанию

    # Конфигурация репозитория резервных копий {{ openSearchVariants }} в хранилище S3
    backup.journalRepository.type: S3
    # Имя корзины в хранилище S3 для хранения резервных копий данных {{ openSearchVariants }}
    backup.journalRepository.s3.bucket: <instanceName>-backups
    # Имя подключения к хранилищу S3, используемому по умолчанию
    # на стороне {{ productName }}
    backup.journalRepository.s3.platformConnection: default
    # Имя подключения к хранилищу S3, используемому по умолчанию на стороне {{ openSearchVariants }}
    backup.journalRepository.s3.journalConnection: default
    ```

{% endif %}

## Просмотр списка и настройка конфигураций резервного копирования {: #backup_configure_list_view .pageBreakBefore }

1. В разделе [«**Администрирование**» — «**Инфраструктура**»][administration] выберите пункт «**Резервное копирование**» <i class="fa-light  fa-coins">‌</i>.
2. Отобразится список конфигураций резервного копирования.
3. Нажмите кнопку «**Создать**» или дважды нажмите строку конфигурации в списке.
4. Настройте и сохраните конфигурацию резервного копирования:

    - **Отключить резервное копирование** — установите этот флажок, чтобы прекратить резервное копирование с использованием данной конфигурации.
    - **Название** — введите наглядное наименование конфигурации резервного копирования.
    - **Имя файла** — введите имя файла резервных копий. В процессе резервного копирования к этому имени будут добавляться метка времени в формате `ГГГГММДДЧЧММ` и расширение `CDBBZ`, например для имени файла Backup: `Backup.202202161625.cdbbz`.
    - **Репозиторий для резервных копий** — выберите хранилище для резервных копий:
        - **Не определено** — не использовать репозиторий для хранения резервных копий.
        - **Файловая система** — сохранять резервные копии в файловой системе сервера **{{ productName }}**.
            - **Путь к папке** — путь к директории на сервере, в которой будут сохраняться резервные копии. Эта директория должна существовать на сервере. {% if not gostech%}См. _«[Настройка экземпляра ПО {{ productName }} для хранения резервных копий на диске](#backup_configure_instance_disk)»_.{% endif %}
        - **Хранилище S3** — сохранять резервные копии во внешнем сервисе S3.
            - **Имя корзины** — введите имя контейнера в хранилище S3, к котором будут сохраняться резервные копии.

            !!! warning "Внимание!"

                Для резервного копирования в основной и дополнительный репозитории будет использоваться только подключение `s3.default`, настроенное в файле конфигурации экземпляра ПО (`<instanceName>.yml`).

                См. _«[Настройка экземпляра ПО {{ productName }} для хранения резервных копий в хранилище S3](#backup_configure_instance_s3)»_.
            !!! tip "Совет"
                
                Настроить более сложную конфигурацию резервного копирования можно в файле `<instanceName>.yml`. См. _«[Настройка резервного копирования в хранилище S3 с помощью файла конфигурации экземпляра ПО {{ productName }}](#backup_configure_instance_s3_advanced)»_.

    - **Дополнительный репозиторий для резервных копий** — выберите хранилище, в которое будут сохраняться дубликаты резервных копий.
    - **С файлами** — установите этот флажок, чтобы включить в состав резервной копии загруженные файлы (папка `Streams`).
    - **Со скриптами** — установите этот флажок, чтобы включить в состав резервной копии скрипты (папка `Data`).
    - **С историей** — установите этот флажок, чтобы включить в состав резервной копии данные журнала транзакций (папка `History`).

        !!! warning "Внимание!"

            Для резервного копирования журнала транзакций (истории) необходимо настроить экземпляр ПО и службу {{ openSearchVariants }}.
            
            {% if gostech %}
            См. _[документацию Platform V Search](https://client.sbertech.ru/docs/public/SRH/1.6.0/index.html)_.
            {% else %}
            См. _«[Настройка резервного копирования данных {{ openSearchVariants }}](#backup_configure_elasticsearch)»_.
            {% endif %}

    - **Режим запуска**
        - **Вручную** — для запуска резервного копирования потребуется нажимать кнопку «**Запустить копирование**» в [списке конфигураций резервного копирования](#backup_configure_start).
        - **По расписанию** — резервное копирование будет выполняться по расписанию со следующими параметрами:
            - **Максимум копий** — максимальное количество резервных копий, которые будут храниться в папке на сервере. Укажите значение 0, чтобы хранить все резервные копии.
            - **Периодичность** — частота, с которой будет выполняться копирование.
            - **Интервал**
            {: .pageBreakBefore}
                - **С** — время суток, начиная с которого может выполняться копирование в указанные дни недели.
                - **До** — время суток, вплоть до которого может выполняться копирование в указанные дни недели.
            - **Дни запуска** — дни недели, по которым будет выполняться копирование с указанной периодичностью.
            {% include-markdown ".snippets/pdfEndOfBlockHack.md" %}

_![Настройка свойств резервного копирования](backup_create_config.png)_

## Запуск резервного копирования {: #backup_configure_start .pageBreakBefore }

1. С помощью флажка выбора выберите одну конфигурацию резервного копирования в списке конфигураций.
2. Нажмите кнопку «**Запустить копирование**». Эта кнопка отображается, только если выбрана одна конфигурация.
3. В фоновом режиме начнется процесс резервного копирования.
4. Прогресс и результат резервного копирования можно просмотреть [в журнале резервного копирования](#backup_configure_list_view).

_![Запуск резервного копирования](backup_start.png)_

## Просмотр списка сеансов резервного копирования {: #backup_configure_sessions_list .pageBreakBefore }

1. В разделе [«**Администрирование**» — «**Инфраструктура**»][administration] выберите пункт «**Резервное копирование**» <i class="fa-light fa-coins ">‌</i>.
2. Отобразится список конфигураций резервного копирования.
3. Выберите вкладку «**Журнал**».
4. Отобразится список сеансов резервного копирования со следующими сведениями:

    - **ID** — уникальный идентификатор резервной копии.
    - **Конфигурация** — название конфигурации резервного копирования.
    - **Добавлено в очередь** — дата и время постановки резервной копии в очередь резервного копирования.
    - **Время запуска** — дата и время фактического начала резервного копирования.
    - **Время окончания** — дата и время окончания резервного копирования.
    - **Статус** — текущее состояние резервного копирования.
    - **Размер архива** — размер сохраненной резервной копии.

5. Если отображаются не все ожидаемые сеансы, нажмите кнопку «**Обновить**», чтобы загрузить в список данные о текущих сеансах резервного копирования.

_![Список сеансов резервного копирования](backup_log.png)_

## Удаление конфигурации резервного копирования {: #backup_configure_delete_config .pageBreakBefore }

1. Выберите подлежащие удалению конфигурации резервного копирования в [списке конфигураций](#backup_configure_list_view).
2. Нажмите кнопку «**Удалить**».
3. Подтвердите удаление резервных копий.
4. Конфигурация резервного копирования будет удалена из списка.
5. Будут безвозвратно удалены сохранённые файлы резервных копий и соответствующие записи [в журнале резервного копирования](#backup_configure_list_view).

## Удаление сеанса резервного копирования и резервной копии {: #backup_configure_delete_session }

1. Выберите один или несколько сеансов в [списке сеансов резервного копирования](#backup_configure_list_view).
2. Нажмите кнопку «**Удалить**».
3. Подтвердите удаление сеансов резервного копирования.
4. Выбранные сеансы резервного копирования будут удалены из журнала резервного копирования.
5. Соответствующие файлы резервных копий будут удалены из хранилища.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- _[Резервное копирование и восстановление. Рекомендации по организации и оптимизации][backup_recommendations]_
- _[Восстановление базы данных из файла резервной копии в формате .CDBBZ][backup_restore_cdbbz]_
- _[Хранилище S3. Настройка экземпляра ПО и подключения][s3_connection]_
- _[Пути и содержимое директорий экземпляра ПО][paths]_
- _[Конфигурация экземпляра, компонентов ПО и служб. Настройка в Linux][configuration_files_linux]_
{% if kbExport %}
- _[Резервное копирование и восстановление. Содержание раздела][backup_and_restore]_
{% endif %}
{% if gostech %}
_[Документация {{ openSearchVariants }}](https://client.sbertech.ru/docs/public/SRH/1.6.0/index.html)_.
{% endif %}

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

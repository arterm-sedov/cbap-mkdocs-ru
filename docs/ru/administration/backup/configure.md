---
title: 'Резервное копирование'
kbTitle: 'Резервное копирование. Настройка, запуск и просмотр журнала сеансов'
kbId: 4642
tags:
    - резервная копия
    - S3
    - история
    - восстановление
    - журнал резервного копирования
    - конфигурация резервного копирования
hide: tags
---

# Резервное копирование. Настройка, запуск и просмотр журнала сеансов {: #backup_configure }

## Введение {: #intro }

Для обеспечения бесперебойной работы **{{ productName }}** необходимо настроить регулярное резервное копирование данных экземпляра ПО.

Здесь представлены рекомендации по настройке и запуску резервного копирования, а также по просмотру журнала сеансов.

Прежде чем приступать к настройке резервного копирования ознакомьтесь с _[рекомендациями по организации и оптимизации резервного копирования и восстановления][backup_recommendations]_.

{% if userGuide or kbExport %}
Дополнительные инструкции по резервному копированию и восстановлению данных встроенными и внешними средствами см. в разделе _«[Резервное копирование и восстановление][backup_and_restore]»_ базы знаний **{{ companyName }}**.
{% endif %}

## Инструменты резервного копирования и восстановления {{ productName }} {: #backup_configure_tools }

- В **{{ productName }}** предусмотрена функция резервного копирования полного образа экземпляра ПО в формате файла с расширением `.CDBBZ`.
    - В такой резервной копии сохраняются все данные всех приложений и настройки экземпляра ПО **{{ productName }}**.
    - Резервные копии могут храниться как в файловой системе сервера **{{ productName }}**, так и в [хранилище S3][s3_connection].
    - Резервное копирование может запускаться вручную или по расписанию.
    - Резервное копирование следует настраивать и запускать с помощью страницы «**Администрирование**» — «**Инфраструктура**» — «**Резервное копирование**». См. _«[Просмотр списка и настройка конфигураций резервного копирования](#backup_configure_list_view)»_.
    - В **{{ productName }}** предусмотрен [журнал сеансов резервного копирования](#backup_configure_list_view).
- Восстановление данных осуществляется на стороне сервера **{{ productName }}**. См. _«[Восстановление базы данных из файла резервной копии в формате .CDBBZ][backup_restore_cdbbz]»_.
- В зависимости от требуемого уровня надежности, доступности и отказоустойчивости системы, резервное копирование также можно выполнять средствами виртуализации, файловой системы, {{ apacheIgniteVariants }}, {{ openSearchVariants }} и {{ apacheIgniteVariants }}. См. _[Рекомендации по организации и оптимизации резервного копирования и восстановления][backup_recommendations]_.

## Порядок резервного копирования и восстановления {: #backup_configure_procedure }

1. Настройте конфигурацию экземпляра ПО **{{ productName }}**:

    - Настройте папку или репозиторий S3 для хранения резервных копий.
    - Настройте используемые по умолчанию параметры резервного копирования в файле конфигурации экземпляра ПО.

    См. _«[Настройка экземпляра ПО {{ productName }}][backup_configure_instance]»_ и _«[Хранилище S3. Настройка экземпляра ПО и подключения][s3_connection]»_.

2. Настройте [резервное копирование данных {{ openSearchVariants }}](#backup_configure_elasticsearch).
3. Настройте одну или несколько [конфигураций резервного копирования](#backup_configure_list_view).
4. [Запустите резервное копирование](#backup_configure_start) с использованием настроенных конфигураций вручную или по расписанию.
5. Просмотрите статус [сеансов в журнале резервного копирования](#backup_configure_sessions_list).
6. Восстановите данные из резервной копии.

## Настройка экземпляра ПО {{ productName }} {: #backup_configure_instance }

1. Создайте на сервере с экземпляром ПО **{{ productName }}** директорию, в которой будут сохраняться резервные копии. Для этой директории предоставьте разрешения на полный доступ, чтобы система могла сохранять в неё резервные копии, например:

    **Astra Linux, Ubuntu, Rocky**

    ``` shell
    mkdir /var/backups/comindware/<instanceName>
    chmod 777 /var/backups/comindware/<instanceName>
    chown -R www-data:www-data /var/backups/comindware/<instanceName>
    ```

    **Альт Сервер, РЕД ОС**

    ``` shell
    mkdir /var/backups/comindware/<instanceName>
    chmod 777 /var/backups/comindware/<instanceName>
    chown -R _nginx:_nginx /var/backups/comindware/<instanceName>
    ```

    **Здесь** `<instanceName>` — имя экземпляра ПО.

2. Настройте используемые по умолчанию путь и имя файла резервной копии. Эти параметры используются по умолчанию при создании конфигураций резервного копирования. В файле конфигурации экземпляра ПО (`<instanceName>.yml`) настройте следующие директивы:

    ```
    #################### Конфигурация резервного копирования ####################
    # Папка для резервного копирования по умолчанию
    backup.defaultFolder: /var/lib/comindware/cmwdata/Backup

    # Имя файла для резервного копирования по умолчанию
    backup.defaultFileName: Backup
    ```

    См. _«[Пути и содержимое директорий экземпляра ПО][paths]»_ и _«[Конфигурация экземпляра, компонентов ПО и служб. Настройка в Linux][configuration_files_linux]»_.

3. Перезапустите экземпляр ПО.

## Настройка резервного копирования данных {{ openSearchVariants }} {: #backup_configure_elasticsearch .pageBreakBefore }

Для корректного резервного копирования данных истории необходимо настроить конфигурацию службы {{ openSearchVariants }} и экземпляра ПО **{{ productName }}**.

1. В файле конфигурации {{ openSearchVariants }} (`/etc/elasticsearch/elasticsearch.yml`) должен быть указан путь к репозиторию резервных копий, например:

    **Для репозитория на локальном диске**

    ``` shell
    # Директория репозитория должна быть доступна экземпляру ПО
    # {{ productName }}
    path.repo: /var/www/backups/elasticsearch
    ```

    !!! warning "Внимание"

        Предоставьте доступ {{ openSearchVariants }} к репозиторию резервных копий:

        ``` sh
        chmod -R 777 /var/www/backups/elasticsearch
        chown -R elasticsearch:elasticsearch /var/www/backups/elasticsearch
        ```

    **Для репозитория в хранилище S3**

    ``` shell
    s3.client.default.endpoint: localhost:9000
    s3.client.default.protocol: http
    s3.client.default.path_style_access: true
    ```

2. В файле конфигурации экземпляра ПО (`/usr/share/comindware/configs/instance/<instanceName>.yml`) необходимо указать тип репозитория резервных копий {{ openSearchVariants }} (`LocalDisk` или `S3`) и путь к репозиторию, например:

    **Для репозитория на локальном диске**

    ``` shell
    # Тип хранилища резервных копий {{ openSearchVariants }}: LocalDisk или S3
    backup.journalRepository.type: LocalDisk
    Путь к файлам резервных копий
    backup.journalRepository.localDisk.path: /var/www/backups/elasticsearch
    ```

    !!! note "Примечание"

        В данном примере {{ openSearchVariants }} и **{{ productName }}** работают на одной машине.
        В противном случае следует примонтировать папку репозитория {{ openSearchVariants }} на машине с **{{ productName }}** и указать её в директиве `backup.journalRepository.localDisk.path`.

    **Для репозитория в хранилище S3**
    {: .pageBreakBefore }

    ``` shell
    # Конфигурация подключения к хранилищу S3, используемого по умолчанию
    s3Connection.default.endpointURL: http://localhost:9000
    s3Connection.default.accessKey: xxxxx
    s3Connection.default.secretKey: xxxxx
    s3Connection.default.pathStyleAccess: true
    s3Connection.default.description: Подключение к S3 по умолчанию

    # Конфигурация репозитория резервных копий {{ openSearchVariants }} в хранилище S3
    backup.journalRepository.type: S3
    # Имя корзины в хранилище S3 для хранения резервных копий данных {{ openSearchVariants }}
    backup.journalRepository.s3.bucket: <instanceName>-backups
    # Имя подключения к хранилищу S3, используемому по умолчанию
    # на стороне {{ productName }}
    backup.journalRepository.s3.platformConnection: default
    # Имя подключения к хранилищу S3, используемому по умолчанию на стороне {{ openSearchVariants }}
    backup.journalRepository.s3.elasticConnection: default
    ```

## Просмотр списка и настройка конфигураций резервного копирования {: #backup_configure_list_view .pageBreakBefore }

1. В разделе [«**Администрирование**» — «**Инфраструктура**»][administration] выберите пункт «**Резервное копирование**» <i class="fa-light  fa-coins">‌</i>.
2. Отобразится список конфигураций резервного копирования.
3. Нажмите кнопку «**Создать**» или дважды нажмите строку конфигурации в списке.
4. Настройте и сохраните конфигурацию резервного копирования:

    - **Отключить резервное копирование** — установите этот флажок, чтобы прекратить резервное копирование с использованием данной конфигурации.
    - **Название** — введите наглядное наименование конфигурации резервного копирования.
    - **Имя файла** — введите имя файла резервных копий. В процессе резервного копирования к этому имени будут добавляться метка времени в формате `ГГГГММДДЧЧММ` и расширение `CDBBZ`, например для имени файла Backup: `Backup.202202161625.cdbbz`.
    - **Репозиторий для резервных копий** — выберите хранилище для резервных копий:
        - **Не определено** — не использовать репозиторий для хранения резервных копий.
        - **Файловая система** — сохранять резервные копии в файловой системе сервера **{{ productName }}**.
            - **Путь к папке** — путь к директории на сервере, в которой будут сохраняться резервные копии. Эта директория должна существовать на сервере. См. _«[Предварительная настройка экземпляра ПО {{ productName }}][backup_configure_instance]»_.
        - **Хранилище S3** — сохранять резервные копии во внешнем сервисе S3. См. _«[Хранилище S3. Настройка экземпляра ПО и подключения][s3_connection]»_.
            - **Имя корзины** — введите имя контейнера в хранилище S3, к котором будут сохраняться резервные копии.

            !!! warning "Внимание!"

                Для резервного копирования в основной и дополнительный репозитории будет использоваться только подключение к S3, заданное в файле конфигурации экземпляра ПО (`/usr/share/comindware/configs/instance/<instanceName>.yml`) с помощью директивы `s3Connection.default`

    - **Дополнительный репозиторий для резервных копий** — выберите хранилище, в которое будут сохраняться дубликаты резервных копий.
    - **С файлами** — установите этот флажок, чтобы включить в состав резервной копии загруженные файлы (папка `Streams`).
    - **Со скриптами** — установите этот флажок, чтобы включить в состав резервной копии скрипты (папка `Data`).
    - **С историей** — установите этот флажок, чтобы включить в состав резервной копии данные журнала транзакций (папка `History`).

        !!! warning "Внимание!"

            Для резервного копирования журнала транзакций (истории) необходимо настроить экземпляр ПО и службу {{ openSearchVariants }}.
            
            См. _«[Настройка резервного копирования данных {{ openSearchVariants }}](#backup_configure_elasticsearch)»_.

    - **Режим запуска**
        - **Вручную** — для запуска резервного копирования потребуется нажимать кнопку «**Запустить копирование**» в [списке конфигураций резервного копирования](#backup_configure_start).
        - **По расписанию** — резервное копирование будет выполняться по расписанию со следующими параметрами:
            - **Максимум копий** — максимальное количество резервных копий, которые будут храниться в папке на сервере. Укажите значение 0, чтобы хранить все резервные копии.
            - **Периодичность** — частота, с которой будет выполняться копирование.
            - **Интервал**
            {: .pageBreakBefore}
                - **С** — время суток, начиная с которого может выполняться копирование в указанные дни недели.
                - **До** — время суток, вплоть до которого может выполняться копирование в указанные дни недели.
            - **Дни запуска** — дни недели, по которым будет выполняться копирование с указанной периодичностью.
            {% include-markdown ".snippets/pdfEndOfBlockHack.md" %}

_![Настройка свойств резервного копирования](backup_create_config.png)_

## Запуск резервного копирования {: #backup_configure_start .pageBreakBefore }

1. С помощью флажка выбора выберите одну конфигурацию резервного копирования в списке конфигураций.
2. Нажмите кнопку «**Запустить копирование**». Эта кнопка отображается, только если выбрана одна конфигурация.
3. В фоновом режиме начнется процесс резервного копирования.
4. Прогресс и результат резервного копирования можно просмотреть [в журнале резервного копирования](#backup_configure_list_view).

_![Запуск резервного копирования](backup_start.png)_

## Просмотр списка сеансов резервного копирования {: #backup_configure_sessions_list .pageBreakBefore }

1. В разделе [«**Администрирование**» — «**Инфраструктура**»][administration] выберите пункт «**Резервное копирование**» <i class="fa-light fa-coins ">‌</i>.
2. Отобразится список конфигураций резервного копирования.
3. Выберите вкладку «**Журнал**».
4. Отобразится список сеансов резервного копирования со следующими сведениями:

    - **ID** — уникальный идентификатор резервной копии.
    - **Конфигурация** — название конфигурации резервного копирования.
    - **Добавлено в очередь** — дата и время постановки резервной копии в очередь резервного копирования.
    - **Время запуска** — дата и время фактического начала резервного копирования.
    - **Время окончания** — дата и время окончания резервного копирования.
    - **Статус** — текущее состояние резервного копирования.
    - **Размер архива** — размер сохраненной резервной копии.

5. Если отображаются не все ожидаемые сеансы, нажмите кнопку «**Обновить**», чтобы загрузить в список данные о текущих сеансах резервного копирования.

_![Список сеансов резервного копирования](backup_log.png)_

## Удаление конфигурации резервного копирования {: #backup_configure_delete_config .pageBreakBefore }

1. Выберите подлежащие удалению конфигурации резервного копирования в [списке конфигураций](#backup_configure_list_view).
2. Нажмите кнопку «**Удалить**».
3. Подтвердите удаление резервных копий.
4. Конфигурация резервного копирования будет удалена из списка.
5. Будут безвозвратно удалены сохранённые файлы резервных копий и соответствующие записи [в журнале резервного копирования](#backup_configure_list_view).

## Удаление сеанса резервного копирования и резервной копии {: #backup_configure_delete_session }

1. Выберите один или несколько сеансов в [списке сеансов резервного копирования](#backup_configure_list_view).
2. Нажмите кнопку «**Удалить**».
3. Подтвердите удаление сеансов резервного копирования.
4. Выбранные сеансы резервного копирования будут удалены из журнала резервного копирования.
5. Соответствующие файлы резервных копий будут удалены из хранилища.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- _[Резервное копирование и восстановление. Рекомендации по организации и оптимизации][backup_recommendations]_
- _[Восстановление базы данных из файла резервной копии в формате .CDBBZ][backup_restore_cdbbz]_
- _[Хранилище S3. Настройка экземпляра ПО и подключения][s3_connection]_
- _[Пути и содержимое директорий экземпляра ПО][paths]_
- _[Конфигурация экземпляра, компонентов ПО и служб. Настройка в Linux][configuration_files_linux]_
{% if kbExport %}
- _[Резервное копирование и восстановление. Содержание раздела][backup_and_restore]_
{% endif %}


</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

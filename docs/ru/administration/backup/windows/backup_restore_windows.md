---
title: Резервное копирование и восстановление в Windows
kbId: 4644
---

# Резервное копирование и восстановление {{ productName }} в ОС Windows {: #backup_restore_windows}

## Введение

Здесь представлены инструкции по резервному копированию и восстановлению данных **{{ productName }}** в ОС Windows.

!!! question "Определения"

    **{{ openSearchVariants }}** — служба журналирования транзакций в составе **{{ productName }}**.

    **Снимок** — набор данных, сохранённый на определённый момент времени.

## Подготовка к резервному копированию и восстановлению данных

Для создания резервных копий и восстановления из них данных {{ productName }} необходимо подготовить конфигурацию резервного копирования, как указано ниже.

1. <a id="P1.1"></a>Подготовьте следующие данные о конфигурации экземпляра продукта:

    - Название экземпляра продукта — `<InstanceName>`(например, `CBAP4.2`).
    - Путь к папке с базой данных экземпляра продукта, например `DatabasePath` (по умолчанию: `C:\ProgramData\Comindware\Instances\<InstanceName>\Data`).
    - Путь к папке резервных копий базы данных — `DatabaseBackupPath` (например, `С:\DatabaseBackups`).
    - Имя репозитория снимков Elasticsearch — *`repository_name`* (например, `elastic_backup`).
    - Путь к репозиторию снимков Elasticsearch — `elastic_backup_path`(например, `e:\elastic_backup`).
    - Имя снимка Elasticsearch — `snapshot_name` (например, `<InstanceName>01022022080800` — в формате `<<InstanceName>><Date><Time>`). См. инструкции Elasticsearch по формированию имён снимков с использованием текущей даты  (на английском языке): <https://www.elastic.co/guide/en/elasticsearch/reference/current/api-conventions.html#api-date-math-index-names>.

2. Настройте конфигурацию репозитория снимков сервера Elasticseach.

    1. Откройте файл `elasticsearch.yml` в папке с данными конфигурации Elasticseach (например: `C:\ElasticsearchData`)

    2. <a id="P1.2.2"></a>В файле `elasticsearch.yml` и добавьте директиву `path.repo` и через двоеточие укажите путь к репозиторию снимков (папке с резервными копиями), например:

    ``` yml
    path.repo: elastic_backup_path
    ```

## Порядок резервного копирования данных экземпляра продукта

Данные экземпляра продукта хранятся в двух независимых друг от друга хранилищах: на сервере Elasticsearch и в папке с базой данных экземпляра продукта — `DatabasePath`. Cм. _«[Подготовка к резервному копированию и восстановлению данных](#подготовка-к-резервному-копированию-и-восстановлению-данных)»_.

Так как осуществить одновременное резервное копирование двух хранилищ не представляется возможным, резервное копирование данных из каждого хранилища выполняется отдельно в два этапа и в отдельные папки:

1. [Создание снимка сервера Elasticsearch](#регистрация-репозитория-и-создание-снимка-elasticsearch) — данные истории и мониторинга копируются в отдельную папку.
2. [Сохранение резервной копии базы данных экземпляра продукта](#сохранение-резервной-копии-базы-данных-экземпляра-продукта) в папку `DatabaseBackupPath`.

## Выполнение резервного копирования

### Регистрация репозитория и создание снимка Elasticsearch

1. Чтобы зарегистрировать репозиторий, выполните следующую команду, указав в URL имя репозитория `repository_name` (см. _«[Подготовка к резервному копированию и восстановлению данных](#подготовка-к-резервному-копированию-и-восстановлению-данных)»_), а в параметре `location` — путь к репозиторию из директивы `path.repo` в файле конфигурации сервера Elasticsearch:

    ``` sh
    curl -X PUT "localhost:9200/_snapshot/repository_name?pretty" -H 'Content-Type: application/json' -d' {"type": "fs", "settings": {"location": "elastic_backup_path"}}'
    ```

    Подробные сведения о регистрации репозитория Elasticsearch см. в официальной документации (на английском языке): <https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-register-repository.html>

2. Чтобы создать снимок Elasticsearch, выполните следующую команду, указав имя снимка `snapshot_name`, а в параметре `indices` — индексы, которые требуется включить в снимок (индексы {{ productName }} имеют префикс, например, `cmw_<<InstanceName>>_`):

    ``` sh
    curl -X PUT "localhost:9200/_snapshot/repository_name/snapshot_name?wait_for_completion=true&pretty" -H 'Content-Type: application/json' -d' {"indices": "cmw_<<InstanceName>>_*", "ignore_unavailable": true, "include_global_state": false}'
    ```

    Подробные сведения о создании снимка Elasticsearch см. в официальной документации (на английском языке): <https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-take-snapshot.html>

### Сохранение резервной копии базы данных экземпляра продукта

1. В экземпляре продукта откройте раздел «**Администрирование**» — «**Инфраструктура**» — «**Резервное копирование**».
2. Нажмите кнопку «**Создать**» в списке конфигураций резервного копирования.

    _![Создание новой конфигурации резервного копирования](https://kb.comindware.ru/assets/img_6321d80a2b32d.png)_

3. <a id="P3.2.3"></a>В окне «**Новая конфигурация резервного копирования**»:

    1. В поле «**Название**» укажите наглядное название конфигурации (например, «`Резервная копия <InstanceName>`»).
    2. В поле «**Путь к файлу**» укажите путь к файлу резервной копии в папке `DatabaseBackupPath` на сервере. См. _«[Подготовка к резервному копированию и восстановлению данных](#подготовка-к-резервному-копированию-и-восстановлению-данных)»_.
    3. В поле «**Имя файла**» укажите имя файла резервной копии (например, `Backup`).
    4. Установите флажки «**С файлами**» и «**Со скриптами**».
    5. Нажмите кнопку «**Сохранить**».

    _![Настройка новой конфигурации резервного копирования](https://kb.comindware.ru/assets/img_6321d7573245a.png)_

4. Запустите резервное копирование:

    1. В списке конфигураций резервного копирования с помощью флажка выбора выберите созданную на [шаге 3](#P3.2.3) конфигурацию.
    2. Нажмите кнопку «**Запустить копирование**».

    _![Запуск резервного копирования](https://kb.comindware.ru/assets/img_6321d902288c2.png)_

5. В фоновом режиме начнется процесс резервного копирования.
6. Прогресс и результат резервного копирования можно просмотреть в журнале резервного копирования, выбрав вкладку «**Журнал**» над списком конфигураций резервного копирования.
7. В процессе резервного копирования к имени файла, указанному [на шаге 3](#P3.2.3) будут добавлена метка времени в формате `ГГГГММДДЧЧММ` и расширение `CDBBZ`, например для имени файла `Backup`: `Backup``.202202161625.cdbbz`

    _![Переход к журналу резервного копирования](https://kb.comindware.ru/assets/img_6321dbd1da164.png)_

## Порядок восстановления данных экземпляра продукта

Данные экземпляра продукта хранятся в трех независимых друг от друга хранилищах:  сервере Apache Ignite, сервере Elasticsearch и папке `DatabaseBackupPath` (см. _«[Подготовка к резервному копированию и восстановлению данных](#подготовка-к-резервному-копированию-и-восстановлению-данных)»_). Поэтому восстановление осуществляется последовательно для каждого хранилища.

!!! warning "Внимание!"
    Восстановление следует выполнять при остановленном экземпляре продукта.

Восстановление данных из резервных копий выполняется в два этапа:

1. [Восстановление снимка сервера Elasticsearch](#восстановление-снимка-elasticsearch).
2. [Восстановление базы данных экземпляра продукта](#восстановление-базы-данных-экземпляра-продукта) из папки `DatabaseBackupPath`.

## Выполнение восстановления

### Восстановление снимка Elasticsearch

1. Выполните следующую команду, указав имя репозитораия `repository_name` и имя снимка `snapshot_name` (см. _«[Подготовка к резервному копированию и восстановлению данных](#подготовка-к-резервному-копированию-и-восстановлению-данных)»_):

``` sh
curl -X POST "localhost:9200/_snapshot/repository_name/snapshot_name/_restore?pretty"
```

Подробные сведения о восстановлении снимков Elasticsearch см. в официальной документации (на английском языке): <https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-restore-snapshot.html>

### Восстановление базы данных экземпляра продукта

1. Восстановите базу данных экземпляра продукта согласно инструкциям в статье «[Восстановление экземпляра продукта из резервной копии][admin_utility_instance_backup_restore]».

## Проверка конфигурации экземпляра ПО

1. Запустите экземпляр ПО.
2. При необходимости откроется страница настройки подключения к службе Elasticsearch.
3. В поле «URI» введите адрес автоматически своего сервера Elasticsearch.
4. Введите **префикс индекса**, **имя пользователя** и **пароль сервера Elasticsearch**. .
5. Нажмите кнопку «**Далее**».

    _![Настройка подключения к Elasticsearch](https://kb.comindware.ru/assets/Picture16.png)_

6. При необходимости откроется страница инициализации данных в Elasticsearch.
7. Нажмите кнопку «**Обновить**».

    _![Страница инициализации данных в Elasticsearch](https://kb.comindware.ru/assets/Picture17.png)_

8. Дождитесь открытия начальной страницы **{{ productName }}**.
9. Откройте страницу «**Администрирование**» — «**Подключения**».

    _![Переход к свойства подключения к Elasticsearch](https://kb.comindware.ru/assets/img_64d09fd6ec3ba.png)_

10. Откройте подключение к серверу Elasticsearch.
11. Удостоверьтесь, что корректно указаны **префикс индекса** и **URL подключения** к серверу Elasticsearch.

    _![Свойства подключения к серверу Elasticsearch](https://kb.comindware.ru/assets/img_64d0a41fc5e0b.png)_

12. Откройте страницу «**Администрирование**» — «**Глобальная конфигурация**».
13. Удостоверьтесь, что указан корректный **URL-адрес сервера**.

    _![URL-адрес сервера в глобальной конфигурации](https://kb.comindware.ru/assets/img_64d0a4feebc80.png)_

14. Откройте страницу «**Администрирование**» — «**Резервное копирование**».
15. Удостоверьтесь, что в конфигурациях резервного копирования правильно указаны пути для сохранения резервных копий.

    _![Путь к папке резервных копий в конфигурации резервного копирования](https://kb.comindware.ru/assets/img_64d0a5817d06a.png)_

16. При необходимости измените конфигурации резервного копирования, указав корректные пути к файлам.

    _![Настройка пути к файлам резервной копии](https://kb.comindware.ru/assets/img_64d0a5f075838.png)_

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

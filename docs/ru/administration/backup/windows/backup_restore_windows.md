---
title: Резервное копирование и восстановление в Windows
kbId: 4644
---

# Резервное копирование и восстановление {{ productName }} в ОС Windows {: #backup_restore_windows }

## Введение

Здесь представлены инструкции по резервному копированию и восстановлению данных **{{ productName }}** в ОС Windows.

!!! question "Определения"

    **{{ openSearchVariants }}** — служба журналирования транзакций в составе **{{ productName }}**.

    **Снимок** — набор данных, сохранённый на определённый момент времени.

## Подготовка к резервному копированию и восстановлению данных

Для создания резервных копий и восстановления из них данных {{ productName }} необходимо подготовить конфигурацию резервного копирования, как указано ниже.

1. <a id="P1.1"></a>Подготовьте следующие данные о конфигурации экземпляра продукта:

    - Название экземпляра продукта — `<instanceName>`(например, `CBAP4.2`).
    - Путь к папке с базой данных экземпляра продукта, например `DatabasePath` (по умолчанию: `C:\ProgramData\Comindware\Instances\<instanceName>\Data`).
    - Путь к папке резервных копий базы данных — `DatabaseBackupPath` (например, `С:\DatabaseBackups`).
    - Имя репозитория снимков {{ openSearchVariants }} — *`repository_name`* (например, `elastic_backup`).
    - Путь к репозиторию снимков {{ openSearchVariants }} — `elastic_backup_path`(например, `e:\elastic_backup`).
    - Имя снимка {{ openSearchVariants }} — `snapshot_name` (например, `<instanceName>01022022080800` — в формате `<instanceName><Date><Time>`). См. инструкции {{ openSearchVariants }} по формированию имён снимков с использованием текущей даты  (на английском языке): <https://www.elastic.co/guide/en/elasticsearch/reference/current/api-conventions.html#api-date-math-index-names>.

2. Настройте конфигурацию репозитория снимков сервера {{ openSearchVariants }}.

    1. Откройте файл `elasticsearch.yml` в папке с данными конфигурации {{ openSearchVariants }} (например: `C:\ElasticsearchData`)

    2. <a id="P1.2.2"></a>В файле `elasticsearch.yml` и добавьте директиву `path.repo` и через двоеточие укажите путь к репозиторию снимков (папке с резервными копиями), например:

    ``` yaml
    path.repo: elastic_backup_path
    ```

## Порядок резервного копирования данных экземпляра продукта

Данные экземпляра продукта хранятся в двух независимых друг от друга хранилищах: на сервере {{ openSearchVariants }} и в папке с базой данных экземпляра продукта — `DatabasePath`. Cм. _«[Подготовка к резервному копированию и восстановлению данных](#подготовка-к-резервному-копированию-и-восстановлению-данных)»_.

Так как осуществить одновременное резервное копирование двух хранилищ не представляется возможным, резервное копирование данных из каждого хранилища выполняется отдельно в два этапа и в отдельные папки:

1. [Создание снимка сервера {{ openSearchVariants }}](#backup_restore_windows_registry_snapshot) — данные истории и мониторинга копируются в отдельную папку.
2. [Сохранение резервной копии базы данных экземпляра продукта](#сохранение-резервной-копии-базы-данных-экземпляра-продукта) в папку `DatabaseBackupPath`.

## Выполнение резервного копирования

### Регистрация репозитория и создание снимка {{ openSearchVariants }} {: #backup_restore_windows_registry_snapshot}

1. Чтобы зарегистрировать репозиторий, выполните следующую команду, указав в URL имя репозитория `repository_name` (см. _«[Подготовка к резервному копированию и восстановлению данных](#подготовка-к-резервному-копированию-и-восстановлению-данных)»_), а в параметре `location` — путь к репозиторию из директивы `path.repo` в файле конфигурации сервера {{ openSearchVariants }}:

    ``` sh
    curl -X PUT "<openSearchHost>:<opeSearchPort>/_snapshot/repository_name?pretty" -H 'Content-Type: application/json' -d' {"type": "fs", "settings": {"location": "elastic_backup_path"}}'
    ```

    Подробные сведения о регистрации репозитория {{ openSearchVariants }} см. в официальной документации (на английском языке): <https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-register-repository.html>

2. Чтобы создать снимок {{ openSearchVariants }}, выполните следующую команду, указав имя снимка `snapshot_name`, а в параметре `indices` — индексы, которые требуется включить в снимок (индексы {{ productName }} имеют префикс, например, `cmw_<instanceName>_`):

    ``` sh
    curl -X PUT "<openSearchHost>:<opeSearchPort>/_snapshot/repository_name/snapshot_name?wait_for_completion=true&pretty" -H 'Content-Type: application/json' -d' {"indices": "cmw_<instanceName>_*", "ignore_unavailable": true, "include_global_state": false}'
    ```

    Подробные сведения о создании снимка {{ openSearchVariants }} см. в официальной документации (на английском языке): <https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-take-snapshot.html>

### Сохранение резервной копии базы данных экземпляра продукта

1. В экземпляре продукта откройте раздел «**Администрирование**» — «**Инфраструктура**» — «**Резервное копирование**».
2. Нажмите кнопку «**Создать**» в списке конфигураций резервного копирования.

    _![Создание новой конфигурации резервного копирования](https://kb.comindware.ru/assets/img_6321d80a2b32d.png)_

3. <a id="P3.2.3"></a>В окне «**Новая конфигурация резервного копирования**»:

    1. В поле «**Название**» укажите наглядное название конфигурации (например, «`Резервная копия <instanceName>`»).
    2. В поле «**Путь к файлу**» укажите путь к файлу резервной копии в папке `DatabaseBackupPath` на сервере. См. _«[Подготовка к резервному копированию и восстановлению данных](#подготовка-к-резервному-копированию-и-восстановлению-данных)»_.
    3. В поле «**Имя файла**» укажите имя файла резервной копии (например, `Backup`).
    4. Установите флажки «**С файлами**» и «**Со скриптами**».
    5. Нажмите кнопку «**Сохранить**».

    _![Настройка новой конфигурации резервного копирования](https://kb.comindware.ru/assets/img_6321d7573245a.png)_

4. Запустите резервное копирование:

    1. В списке конфигураций резервного копирования с помощью флажка выбора выберите созданную на [шаге 3](#P3.2.3) конфигурацию.
    2. Нажмите кнопку «**Запустить копирование**».

    _![Запуск резервного копирования](https://kb.comindware.ru/assets/img_6321d902288c2.png)_

5. В фоновом режиме начнется процесс резервного копирования.
6. Прогресс и результат резервного копирования можно просмотреть в журнале резервного копирования, выбрав вкладку «**Журнал**» над списком конфигураций резервного копирования.
7. В процессе резервного копирования к имени файла, указанному [на шаге 3](#P3.2.3) будут добавлена метка времени в формате `ГГГГММДДЧЧММ` и расширение `CDBBZ`, например для имени файла `Backup`: `Backup``.202202161625.cdbbz`

    _![Переход к журналу резервного копирования](https://kb.comindware.ru/assets/img_6321dbd1da164.png)_

## Порядок восстановления данных экземпляра продукта

Данные экземпляра продукта хранятся в трех независимых друг от друга хранилищах:  сервере {{ apacheIgniteVariants }}, сервере {{ openSearchVariants }} и папке `DatabaseBackupPath` (см. _«[Подготовка к резервному копированию и восстановлению данных](#подготовка-к-резервному-копированию-и-восстановлению-данных)»_). Поэтому восстановление осуществляется последовательно для каждого хранилища.

!!! warning "Внимание!"
    Восстановление следует выполнять при остановленном экземпляре продукта.

Восстановление данных из резервных копий выполняется в два этапа:

1. [Восстановление снимка сервера {{ openSearchVariants }}](#backup_restore_windows_opensearch).
2. [Восстановление базы данных экземпляра продукта](#восстановление-базы-данных-экземпляра-продукта) из папки `DatabaseBackupPath`.

## Выполнение восстановления

### Восстановление снимка {{ openSearchVariants }} {: #backup_restore_windows_opensearch }

1. Выполните следующую команду, указав имя репозитораия `repository_name` и имя снимка `snapshot_name` (см. _«[Подготовка к резервному копированию и восстановлению данных](#подготовка-к-резервному-копированию-и-восстановлению-данных)»_):

``` sh
curl -X POST "<openSearchHost>:<opeSearchPort>/_snapshot/repository_name/snapshot_name/_restore?pretty"
```

Подробные сведения о восстановлении снимков {{ openSearchVariants }} см. в официальной документации (на английском языке): <https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-restore-snapshot.html>

### Восстановление базы данных экземпляра продукта

1. Запустите _PowerShell_ от имени администратора.
2. Перейдите в директорию со скриптами для развёртывания ПО **{{ productName }}**:

    ``` powershell
    cd "<distPath>\CMW_Windows<versionNumber>\scripts"
    ```

    Здесь:  `<distPath>` — путь к распакованному дистрибутиву ПО.

3. Остановите экземпляр ПО:

    ``` powershell
    .\instance_stop.ps1 -name <instanceName>
    ```

4. Удалите или переместите директорию `Database` из  директории  экземпляра ПО:

    ``` powershell
    Remove-Item -Path "C:\ProgramData\comindware\Instances\<instanceName>\Database" -Recurse
    ```

5. Распакуйте файл резервной копии экземпляра ПО с расширением `CDBBZ`.
6. Скопируйте в экземпляр ПО распакованную резервную копию базы данных:

    ``` powershell
    Copy-Item -Path "<config_backup_path>\Database" -Destination "C:\ProgramData\сomindware\Instances\<instanceName>" -Recurse -Force
    ```

    Здесь: `<config_backup_path>` — директория с распакованной резервной копией экземпляра ПО.

7. Запустите экземпляр ПО:

    ``` powershell
    .\instance_start.ps1 -name <instanceName>
    ```

8.  Откройте сайт экземпляра ПО в браузере, одновременно открыв выдачу журналов экземпляра в _PowerShell_:

    ``` powershell
    Get-Content "C:\ProgramData\comindware\Instances\<instanceName>\Logs\heartbeat_<ГГГГ-ММ-ДД>.log" -Wait
    ```

9. [Проверьте конфигурацию](#upgrade_version_windows_instance_prepare) и работоспособность восстановленного экземпляра ПО.

## Проверка конфигурации экземпляра ПО {: #upgrade_version_windows_instance_prepare .pageBreakBefore }

<!--backup-restore-instance-check-windows-start-->
1. Запустите экземпляр ПО и откройте его сайт в браузере.
2. При необходимости откроется страница настройки подключения к службе {{ openSearchVariants }}.
3. В поле «URI» введите адрес автоматически своего сервера {{ openSearchVariants }}.
4. Введите **префикс индекса**, **имя пользователя** и **пароль сервера {{ openSearchVariants }}**.
5. Нажмите кнопку «**Далее**».
6. При необходимости откроется страница инициализации данных в {{ openSearchVariants }}.
7. Нажмите кнопку «**Обновить**».
8. Дождитесь открытия начальной страницы **{{ productName }}**.
9. Откройте страницу «**Администрирование**» — «**Подключения**».
10. Удостоверьтесь, что в подключении к серверу {{ openSearchVariants }} корректно указаны **префикс индекса** и **URL подключения** к серверу {{ openSearchVariants }}.
13. Удостоверьтесь, что настроено подключение к почтовому серверу для отправки писем для сброса пароля и двухфакторной аутентификации.
14. Откройте страницу «**Администрирование**» — «**Глобальная конфигурация**».
15. Удостоверьтесь, что указан корректный **URL-адрес сервера**.
16. Откройте страницу «**Администрирование**» — «**Резервное копирование**».
17. Проверьте конфигурации резервного копирования и при необходимости необходимости задайте корректные пути пути для сохранения резервных копий.
18. Создайте резервную копию работоспособного экземпляра **{{ productName }}**.
<!--backup-restore-instance-check-windows-end-->

--8<-- "related_topics_heading.md"

- [Настройка конфигураций и запуск резервного копирования][backup_configure_list_view]
- [Пути и содержимое директорий экземпляра ПО][paths]
- [Установка, запуск, инициализация и остановка Comindware Platform в Windows][deploy_guide_windows]
- [Отправка почты из процесса. Настройка подключения][process_sending_connection]

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

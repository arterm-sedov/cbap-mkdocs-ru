---
title: Адаптеры
tags:
    - адаптеры
    - создание адаптера
    - подключения
    - создание подключения
hide:
    - tags
kbId: 4672
---

# Адаптеры. Определения, настройка, удаление {: #adapters}

<div class="admonition question" markdown="block">
## Определения {: .admonition-title}

- **Адаптер** — это заказной модуль для подключения **{{ productName }}** к внешним системам.
- Адаптер собирается на стороне **{{ productName }}** из исходного кода.
- Адаптер включает в себя модель данных и методы отправки или получения запросов.
- Для использования адаптера необходимо загрузить и скомпилировать его исходный код на стороне сервера **{{ productName }}**.
- После компиляции адаптера для него необходимо настроить соответствующие подключение, путь передачи данных и сценарий для взаимодействия с внешней системой.

</div>

## Преимущества использования адаптеров

Адаптеры дают следующие преимущества:

- быстрота и гибкость реализации необходимых бизнесу способов обмена данными;
- возможность обрабатывать и преобразовывать данные на уровне специализированных протоколов;
- обработка различных моделей данных с помощью одного адаптера;
- повышенная отказоустойчивость благодаря обмену данными с **{{ productName }}** через брокер сообщений.

## Порядок настройки адаптера

!!! warning "Внимание"

    Для успешной компиляции адаптера должны быть установлены библиотеки .NET версии не ниже 6.0 на машине, на которой развёрнут экземпляр ПО.

1. [Определите модель данных](#построение-модели-данных), передаваемых через адаптер.
2. [Определите методы](#устройство-адаптера) адаптера на C# для отправки и получения данных.
3. [Подготовьте решение](#структура-исходного-кода-адаптера) Visual Studio с исходным кодом адаптера.
4. [Загрузите и скомпилируйте адаптер](#просмотр-списка-адаптеров-и-настройка-адаптера) на сервере **{{ productName }}**.
5. Настройте подключение согласно протоколу соединения с внешней системой.
6. Настройте путь передачи данных согласно модели данных и логике взаимодействия с внешней системой.
7. Настройте шаблоны и сценарий для обработки запросов с помощью адаптера.

## Построение модели данных

Для разработки адаптера сформируйте модель данных:

1. Подготовьте описание структуры данных в стандартизированном формате (например, XML, JSON) или в виде таблицы.
2. Преобразуйте описание структуры данных в модель классов C# адаптера, например с помощью автогенератора <https://json2csharp.com/code-converters/xml-to-csharp>.
3. Модифицируйте полученную модель в соответствии с необходимой бизнес-логикой.

## Устройство адаптера

Адаптер должен состоять из следующих блоков:

- блок сериализации или десериализации данных;
- блок описания моделей данных и их преобразования во внутренние модели адаптера;
- блок конечных точек адаптера (эндпоинтов), распределяющий запросы между методами согласно модели данных адаптера;
- блок служб, который отвечает за работу Kestrel, отправку сообщений, таймауты, проверку данных и т. д.

## Структура исходного кода адаптера

Образец решения запросите у представителя **{{ companyName }}**.

Адаптер представляет собой решение Visual Studio из перечисленных ниже компонентов:

- проект с исходным кодом адаптера, включая один файл решения (`.sln`) в корневой папке;
- подпроекты, содержащие интерфейсы для разработки и последующей компиляции адаптера;
- подпроект, содержащий основной функционал адаптера;
- дополнительные подпроекты, например для локализации;
- папка с подключаемыми библиотеками.

Готовое решение упакуйте в ZIP-архив для компиляции в **{{ productName }}**.

_![Пример содержимого архива с исходным кодом адаптера](img/adapter_archive_content.png)_
{% include-markdown ".snippets/pdfEndOfBlockHack.md" %}

Далее используются следующие обозначения:

- `{adapterName}` — имя адаптера, которое используется в названии решения Visual Studio и в системном имени адаптера в **{{ productName }}**. Например:
    - `IncomingAdapter` — адаптер для получения данных;
    - `OutgoingAdapter` — адаптер для отправки данных.
- `{communicationRouteName}` — название пути передачи данных, который реализуется в адаптере.

### Библиотеки, необходимые в адаптерах

- Инфраструктурные библиотеки:
    - `Comindware.Adapter` — библиотека с базовыми данными адаптера.
    - `Comindware.Adapter.ConnectionManager` — библиотека для подключения к внешним службам.
    - `Comindware.Infrastructure.Heartbeat` — библиотека для мониторинга состояния адаптера.
    - `Localization.Adapter` — библиотека для локализации сообщений и интерфейсов адаптера.
    - `Comindware.MessageBroker.Api` — библиотека для взаимодействия со службой брокера сообщений.
    - `Comindware.Platform.FormDefinition` — библиотека для формирования диалоговых окон.
- Библиотека для получения сообщений:
    - `Comindware.Adapter.IncomingService` — библиотека для обработки входящих сообщений.
- Библиотека для отправки сообщений:
    - `Comindware.Adapter.OutgoingService` — библиотека для обработки исходящих сообщений.
- Необязательные библиотеки:
    - `Comindware.Adapter.ExternalServiceContracts` — модели сообщений внешних сервисов.
    - `Comindware.Adapter.CustomLocalization` — локализация полей сообщений и прочие текстовые константы.

### Классы и методы адаптера для получения сообщений

В проекте `{adapterName}` должны быть предусмотренные ниже классы и методы для взаимодействия с **{{ productName }}**:

- Класс `Adapter`

    | Свойство / метод | Описание |
    |---|---|
    | `Название адаптера` | Название адаптера |
    | `Описание адаптера` | Описание адаптера |
    | `Версия адаптера` | Версия адаптера |
    | `GetSignatures()` | Описание всех реализованных путей передачи данных |

- Папка `Behaviour`
    - Класс `Comindware.Adapter.IncomingPerformer`

        | Метод | Описание |
        |---|---|
        | `{communicationRouteName}Performer` | Формирование входящего сообщения и ответа на него |
        | `RecognizeRawRequest` | Определение соответствий во входящем сообщении к внутренним данным (маппинг) |
        | `SendRawResponse` | Вызов интерфейса `IIncomingConnectionService.OnReplyReceive(object message)` для успешного ответа или `IIncomingConnectionService.OnErrorReceive(object message)` для отправки сообщения с ошибкой |

    - Класс `Service`

        | Метод | Описание |
        |---|---|
        | `CreatePerformer` | Инициализация получения входящего сообщения |
        | `OnStart` | Вызывается при создании или включении пути передачи данных на сервере **{{ productName }}** |
        | `OnStop` | Вызывается при удалении или выключении пути передачи данных на сервере **{{ productName }}** |
        | `PerformTest` | Проверка работоспособности сервиса, прослушивающего входящие сообщения |

- Папка `Configuration`
    - Класс `Endpoint`

        | Метод | Описание |
        |---|---|
        | `Endpoint` | Свойства для создания подключения к внешнему сервису |
        | `EndpointForm` | Форма для настройки подключения |

    - Класс `Procedure`

        | Метод | Описание |
        |---|---|
        | `Procedure` | Конфигурация путей передачи данных |
        | `SignatureForm` | Форма для настройки пути передачи данных |

- Папка `Signature`
    - Класс `{communicationRouteName}ExternalMessage`

        | Метод | Описание |
        |---|---|
        | `{communicationRouteName}ExternalMessage` | Модель сообщений внешнего сервиса |
    
    - Класс `{communicationRouteName}IncomingMessage`

        | Метод | Описание |
        |---|---|
        | `{communicationRouteName}IncomingMessage` | Модель входящих сообщений, унаследованная от `Comindware.Adapter.Message` |
    
    - Класс `ErrorMessage`

        | Метод | Описание |
        |---|---|
        | `ErrorMessage` | Модель сообщения об ошибке, унаследованная от `Comindware.Adapter.Message` |

    - Класс `ResponseMessage`

        | Метод | Описание |
        |---|---|
        | `ResponseMessage` | Модель ответного сообщения, унаследованная от `Comindware.Adapter.Message` |

    - Класс `{communicationRouteName}Signature`

        | Метод | Описание |
        |---|---|
        | `GetIncomingMessageType` | Тип входящего сообщения |
        | `GetOutgoingMessageType` | Тип сообщения об ответе без ошибок |
        | `GetErrorMessageType` | Тип сообщения об ошибке |

### Классы и методы адаптера для отправки сообщений

В проекте `{adapterName}` должны быть предусмотренные ниже классы и методы для взаимодействия с **{{ productName }}**:

- Класс `Adapter`

    | Свойство / метод | Описание |
    |---|---|
    | `Название адаптера` | Название адаптера |
    | `Описание адаптера` | Описание адаптера |
    | `Версия адаптера` | Версия адаптера |
    | `GetSignatures()` | Описание всех реализованных путей передачи данных |

- Папка `Behaviour`
    - Класс `Comindware.Adapter.OutgoingPerformer`

        | Метод | Описание |
        |---|---|
        | `TranslateIncomingMessage` | Определение соответствий во внутреннем сообщении к внешним данным (маппинг) |
        | `SendRawRequest` | Отправка сообщения внешнему сервису |
        | `RecognizeRawResponse` | Обработка ответа внешнего сервиса |

    - Класс `Service`

        | Метод | Описание |
        |---|---|
        | `CreatePerformer` | Инициализация отправки исходящего сообщения |
        | `PerformTest` | Проверка соединения с внешним сервисом |

- Папка `Configuration`
    - Класс `Endpoint`

        | Метод | Описание |
        |---|---|
        | `Endpoint` | Свойства для создания подключения к внешнему сервису |
        | `EndpointForm` | Форма для настройки подключения |
    
    - Класс `Procedure`

        | Метод | Описание |
        |---|---|
        | `Procedure` | Конфигурация путей передачи данных |

- Папка `Signature`
    - Класс `{communicationRouteName}ExternalMessage`

        | Метод | Описание |
        |---|---|
        | `{communicationRouteName}ExternalMessage` | Модель сообщений внешнего сервиса |

    - Класс `{communicationRouteName}Request`

        | Метод | Описание |
        |---|---|
        | `{communicationRouteName}Request` | Модель сообщения запроса |

    - Класс `ErrorMessage`

        | Метод | Описание |
        |---|---|
        | `ErrorMessage` | Модель сообщения об ошибке |

    - Класс `ResponseMessage`

        | Метод | Описание |
        |---|---|
        | `ResponseMessage` | Модель ответного сообщения |

    - Класс `{communicationRouteName}Signature`

        | Метод | Описание |
        |---|---|
        | `GetIncomingMessageType` | Входящее сообщение |
        | `GetOutgoingMessageType` | Сообщение об ответе без ошибок |
        | `GetErrorMessageType` | Сообщение об ошибке |

## Просмотр списка адаптеров и настройка адаптера

1. На странице [«**Администрирование**» — «**Инфраструктура**»][administration] выберите пункт «**Адаптеры**» <i class="fa-light fa-puzzle-piece-simple">‌</i>.
2. Отобразится список адаптеров.

    _![Список адаптеров](adapter_list.png)_

3. Нажмите кнопку «**Создать**» или дважды нажмите строку имеющегося адаптера.
4. Отобразится страница свойств адаптера.

    _![Страница свойств адаптера](adapter_properties.png)_

    {% include-markdown ".snippets/pdfPageBreakHard.md" %}

5. В поле «**Исходный код адаптера**» загрузите ZIP-архив с исходным кодом адаптера. Архив должен содержать подготовленное решение Visual Studio. См. [Устройство адаптера](#состав-решения-visual-studio).
6. Нажмите кнопку «**Сохранить**».
7. Нажмите кнопку «**Опубликовать**», чтобы скомпилировать адаптер.
8. В случае успешной компиляции адаптера его название отобразится в списке адаптеров и свойствах адаптера. Название берётся из файлов решения Visual Studio.
9. После компиляции просмотрите **журнал компиляции**.

    _![Пример журнала компиляции](adapter_compilation_log.png)_

10. При необходимости скачайте архив с журналами работы адаптера (вида `_CBAP.adapters.20221026.logs.zip_`), нажав кнопку «**Скачать журнал работы**».

    _![Пример журнала работы адаптера](adapter_execution_log.png)_

    {% include-markdown ".snippets/pdfPageBreakHard.md" %}

11. Пункт с названием подключения для скомпилированного адаптера появится в меню «**Создать**» — «**Пользовательские подключения**» на страницах «**[Подключения][connections]**» и «**[Пути передачи данных][communication_routes]**». При этом для каждой модели данных в пути передачи данных будет предусмотрен соответствующий **тип сообщения**.

_![Создание подключения с использованием адаптера](adapter_custom_connection_create_menu.png)_

_![Создание пути передачи данных с использованием адаптера](adapters_custom_communication_route_create_menu.png)_

## Мониторинг работы адаптера

Для проверки работы адаптера можно воспользоваться встроенными инструментами мониторинга:

- На странице адаптера можно скачать журнал, в котором фиксируется вся информация о работе адаптера, в том числе:
    - статус служб адаптера;
    - статус подключения адаптера;
    - доступность методов;
    - объём выделенной памяти;
    - информация о созданных путях передачи данных;
    - взаимодействие адаптера со службой Kafka.
    - Откройте страницу свойств адаптера и скачайте архив с журналами его работы, нажав кнопку «**Скачать журнал работы**».
    - См. также _«[Журналы адаптеров][logging_engine_adapter_logs]»_ и _«[Событие в адаптере][log_files_event_examples_adapter_event]»_.
- В свойствах подключения имеется журнал, в котором фиксируются следующие события:
    - статус подключения;
    - получение или отправка сообщений;
    - запуск сценария обработки сообщения;
    - использование методов адаптера.
    - Откройте **[подключение][connections]** адаптера и скачайте журнал работы подключения, нажав кнопку «**Скачать журнал**».
    - См. также _«[Статус подключения][log_files_event_examples_connection_status]»_
- При получении или отправке запросов **{{ productName }}** регистрирует их в журнале событий и создаёт связанную цепочку событий обработки запроса на стороне ПО.
    - Откройте страницу «**Администрирование**» — «**[Журналы событий][logs]**».
    - Перейдите на вкладку «**Трассировка событий**».
    - Просмотрите события типа «**Получен запрос**» и «**Запрос отправлен**», связанные с работой адаптера, дважды нажав строку события.
    - См. также _«[Просмотр цепочки событий][logs_event_chain_view]»_.

## Удаление адаптера {: .pageBreakBefore }

!!! warning "Внимание!"

    Пути передачи данных и подключения, сгенерированные для удаленного адаптера, станут неактивны и перестанут работать.

1. Откройте [список адаптеров](#просмотр-списка-адаптеров-и-настройка-адаптера).
2. Установите флажок в первом столбце для адаптера, подлежащего удалению.
3. Нажмите кнопку «**Удалить**».
4. Подтвердите удаление адаптера.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- _[Подключения. Определения, типы, создание, настройка, удаление][connections]_
- _[Журналы событий. Типы, просмотр, цепочки событий][logs]_
- _[Примеры событий в файловых журналах][log_files_event_examples]_
- _[Подсистема журналирования][logging_engine]_

</div>

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}

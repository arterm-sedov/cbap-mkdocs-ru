---
title: Адаптеры
tags:
    - адаптеры
    - создание адаптера
    - подключения
    - создание подключения
hide:
    - tags
kbId: 4672
---

# Адаптеры. Определения, настройка, удаление {: #adapters}

<div class="admonition question" markdown="block">
## Определения {: .admonition-title}

- **Адаптер** — это заказной модуль для подключения **{{ productName }}** к внешним системам.
- Адаптер включает в себя модель данных и методы отправки или получения запросов.
- Для использования адаптера необходимо загрузить и скомпилировать его исходный код на стороне **{{ productName }}**.
- После компиляции адаптера необходимо настроить соответствующие подключение, путь передачи данных и сценарий для взаимодействия с внешней системой. См. [Порядок настройки адаптера](#порядок-настройки-адаптера).

</div>

## Преимущества использования адаптеров

Заказные адаптеры дают следующие преимущества:

- быстрота и гибкость реализации необходимых бизнесу способов обмена данными;
- возможность обрабатывать и преобразовывать данные на уровне специализированных протоколов;
- обработка различных моделей данных с помощью одного адаптера;
- повышенная отказоустойчивость благодаря обмену данными с **{{ productName }}** через брокер сообщений.

## Порядок настройки адаптера

!!! warning "Внимание"

    Для успешной компиляции адаптера должны быть установлены библиотеки .NET версии не ниже 6.0 на сервере **{{ productName }}**.

1. [Определите модель данных](#построение-модели-данных), передаваемых через адаптер.
2. [Определите логику работы](#устройство-адаптера) адаптера для отправки и получения данных.
3. [Подготовьте решение](#структура-исходного-кода-адаптера) Visual Studio с исходным кодом адаптера на C#.
4. [Настройте сервер](#настройка-сервера-по-для-работы-адаптера) для работы адаптера.
5. [Загрузите и скомпилируйте адаптер](#просмотр-списка-адаптеров-и-настройка-адаптера) на сервере **{{ productName }}**.
6. Настройте подключение согласно протоколу соединения с внешней системой.
7. Настройте путь передачи данных согласно модели данных и логике взаимодействия с внешней системой.
8. Настройте шаблоны и сценарий для обработки запросов с помощью адаптера.

## Построение модели данных

Для разработки адаптера сформируйте модель данных:

1. Подготовьте описание структуры данных в стандартизированном формате (например, XML, JSON) или в виде таблицы.
2. Преобразуйте описание структуры данных в модель классов C# адаптера, например с помощью автогенератора <https://json2csharp.com/code-converters/xml-to-csharp>.
3. Модифицируйте полученную модель в соответствии с необходимой бизнес-логикой.

## Устройство адаптера

Адаптер должен состоять из следующих блоков:

- блок сериализации или десериализации данных;
- блок описания моделей данных и их преобразования во внутренние модели адаптера;
- блок конечных точек адаптера (эндпоинтов), распределяющий запросы между методами согласно модели данных адаптера;
- блок служб, который отвечает за работу Kestrel, отправку сообщений, таймауты, проверку данных и т. д.

## Структура исходного кода адаптера

Образец решения запросите у представителя **{{ companyName }}**. На его основе можно разработать адаптер под свои нужды.

Адаптер представляет собой решение Visual Studio из перечисленных ниже компонентов:

- проект с исходным кодом адаптера, включая один файл решения (`.sln`) в корневой папке;
- подпроекты, содержащие интерфейсы для разработки и последующей компиляции адаптера;
- подпроект, содержащий основной функционал адаптера;
- дополнительные подпроекты, например для локализации;
- папка с подключаемыми библиотеками.

Готовое решение упакуйте в ZIP-архив для компиляции в **{{ productName }}**.

_![Пример содержимого архива с исходным кодом адаптера](img/adapter_archive_content.png)_
{% include-markdown ".snippets/pdfEndOfBlockHack.md" %}

Далее используются следующие обозначения:

- `{AdapterName}` — имя адаптера, которое используется в названии решения Visual Studio и в системном имени адаптера в **{{ productName }}**. Например:
    - `IncomingAdapter` — адаптер для получения данных;
    - `OutgoingAdapter` — адаптер для отправки данных.
- `{communicationRouteName}` — название пути передачи данных, который реализуется в адаптере.
- `{communicationRoutePath}` — относительный путь к пути передачи данных.

### Проекты в составе адаптера

Решение в Visual Studio должно включать перечисленные ниже проекты.

Эти проекты следует скопировать из образца решения.

В общем случае изменять следует только проекты `{AdapterName}`, `CustomLocalization` и `ExternalServiceContracts`.

- `{AdapterName}` — проект с основной бизнес-логикой адаптера для [получения](#классы-и-методы-адаптера-для-получения-сообщений) и [отправки](#классы-и-методы-адаптера-для-отправки-сообщений) сообщений.
- `IncomingService` либо `OutgoingService` — проект для обработки входящих или исходящих сообщений в **{{ productName }}**.
- `Adapter` — базовая логика адаптера.
- `ConnectionManager` — диспетчер подключений к внешним службам.
- `Heartbeat` — мониторинг состояния адаптера.
- `Localization.Adapter` — стандартные локализованные сообщения и графический интерфейс адаптера.
- `MessageBroker.Api` — интерфейсы взаимодействия со службой брокера сообщений.
- `Platform.FormDefinition` — графический интерфейс адаптера.
- Необязательные библиотеки:
    - `CustomLocalization` — локализация полей сообщений и прочие текстовые константы.
    - `ExternalServiceContracts` — модели сообщений внешних сервисов.

### Классы и методы адаптера для получения сообщений

В проекте `{AdapterName}` должен быть реализован интерфейс `IIncomingConnectionService` при помощи перечисленных ниже классов и методов для взаимодействия с **{{ productName }}**:

- Класс `Adapter`

    | Метод | Описание |
    |---|---|
    | `GetName()` | Название адаптера |
    | `GetDescription()` | Описание адаптера |
    | `GetVersion()` | Версия адаптера |
    | `GetSignatures()` | Описание всех реализованных путей передачи данных |

- Папка `Behaviour`
    - Папка `{communicationRouteName}`
        - Класс `{communicationRouteName}Performer`
            
            | Метод | Описание |
            |---|---|
            | `{communicationRouteName}Performer()` | Формирование входящего сообщения и ответа на него |
            | `RecognizeRawRequest()` | Определение соответствий во входящем сообщении к внутренним данным (маппинг) |
            | `SendRawResponse()` | Вызов интерфейса `IIncomingConnectionService.OnReplyReceive(object message)` для успешного ответа или `IIncomingConnectionService.OnErrorReceive(object message)` для отправки сообщения с ошибкой (обязательный метод, если включено ожидание синхронного ответа от **{{ productName }}**) |

        - Класс `{communicationRouteName}IncomingService` (наследуется от `GenericIncomingConnectionService`)

            | Свойство | Описание |
            |---|---|
            | `IsWaitResponse` | Определение ожидания синхронного ответа от **{{ productName }}** |
            | `Integration` | Тип интеграции |

    - Класс `Service`

        | Метод / свойство | Описание |
        |---|---|
        | `CreatePerformer()` | Инициализация получения входящего сообщения |
        | `OnStart()` | Вызов интерфейса `IIncomingConnectionService.Subscribe` при создании или включении пути передачи данных на сервере **{{ productName }}** |
        | `OnStop()` | Вызов интерфейса `IIncomingConnectionService.Unsubscribe` при удалении или выключении пути передачи данных на сервере **{{ productName }}** |
        | `PerformTest()` | Проверка работоспособности сервиса с помощью интерфейса `IIncomingConnectionService.PerformTest` |
        | `GetEndpointConfigs()` | Получение списка подключений с указанием `{сommunicationRoutePath}` в свойстве `Route` |
        | `KestrelConfig` | Инициализация список подключений к `Kestrel`, включая `EndpointConfig` |
        | `GetIncomingService()` | Инициализация пути передачи данных |

- Папка `Configuration`
    - Класс `Endpoint`

        | Свойство | Описание |
        |---|---|
        | `Endpoint` | Создание подключения к внешнему сервису |
        | `EndpointForm` | Форма для настройки подключения |

    - Класс `Procedure`

        | Свойство | Описание |
        |---|---|
        | `Procedure` | Конфигурация путей передачи данных |
        | `SignatureForm` | Форма для настройки пути передачи данных |

- Папка `Signature`
    - Класс `{communicationRouteName}ExternalMessage`

        | Свойство | Описание |
        |---|---|
        | `{communicationRouteName}ExternalMessage` | Модель сообщений внешнего сервиса |

    - Класс `{communicationRouteName}IncomingMessage`

        | Свойство | Описание |
        |---|---|
        | `{communicationRouteName}IncomingMessage` | Модель входящих сообщений, обязательно унаследованная от `Comindware.Adapter.Message` с обязательным свойством `Display` для локализации для каждого атрибута посредством `CustomLocalization` |
    
    - Класс `ErrorMessage`

        | Свойство | Описание |
        |---|---|
        | `ErrorMessage` | Модель сообщения об ошибке, унаследованная от `Comindware.Adapter.Message` |

    - Класс `ResponseMessage`

        | Свойство | Описание |
        |---|---|
        | `ResponseMessage` | Модель ответного сообщения, унаследованная от `Comindware.Adapter.Message` |

    - Класс `{communicationRouteName}Signature`

        | Метод | Описание |
        |---|---|
        | `GetIncomingMessageType()` | Определение типа входящего сообщения после его преобразования к внутренним данным |
        | `GetOutgoingMessageType()` | Определение типа сообщения об ответе без ошибок |
        | `GetErrorMessageType()` | Определение типа сообщения об ошибке |

### Классы и методы адаптера для отправки сообщений

В проекте `{adapterName}` должен быть реализован интерфейс `IOutgoingConnectionService` при помощи перечисленных ниже классов и методов для взаимодействия с **{{ productName }}**:

- Класс `Adapter`

    | Метод | Описание |
    |---|---|
    | `GetName()` | Название адаптера |
    | `GetDescription()` | Описание адаптера |
    | `GetVersion()` | Версия адаптера |
    | `GetSignatures()` | Описание всех реализованных путей передачи данных |

- Папка `Behaviour`
    - Папка `{communicationRouteName}`
        - Класс `{communicationRouteName}Performer`

            | Метод | Описание |
            |---|---|
            | `TranslateIncomingMessage()` | Определение соответствий во внутреннем сообщении к внешним данным (маппинг) |
            | `SendRawRequest()` | Отправка сообщения внешнему сервису |
            | `RecognizeRawResponse()` | Обработка ответа внешнего сервиса |

        - Класс `{communicationRouteName}OutgoingService` (наследуется от `GenericOutgoingConnectionService`)

            | Метод / свойство | Описание |
            |---|---|
            | `Execute()` | Реализация исходящих запросов |
            | `ConnectionConfigData` | Конфигурация подключений к внешнему серверу|

    - Класс `Service`

        | Метод / свойство | Описание |
        |---|---|
        | `CreatePerformer()` | Инициализация отправки исходящего сообщения |
        | `PerformTest()` | Проверка соединения с внешним сервисом |
        | `GetEndpointConfigs()` | Получение списка подключений с указанием `{сommunicationRoutePath}` в свойстве `Route` |

- Папка `Configuration`
    - Класс `Endpoint`

        | Свойство | Описание |
        |---|---|
        | `Endpoint` | Свойства для создания подключения к внешнему сервису |
        | `EndpointForm` | Форма для настройки подключения |
    
    - Класс `Procedure`

        | Свойство | Описание |
        |---|---|
        | `Procedure` | Конфигурация путей передачи данных |

- Папка `Signature`
    - Класс `{communicationRouteName}ExternalMessage`

        | Свойство | Описание |
        |---|---|
        | `{communicationRouteName}ExternalMessage` | Модель сообщений внешнего сервиса |

    - Класс `{communicationRouteName}Request`

        | Свойство | Описание |
        |---|---|
        | `{communicationRouteName}Request` | Модель сообщения запроса унаследованная от `Comindware.Adapter.Message` |

    - Класс `ErrorMessage`

        | Свойство | Описание |
        |---|---|
        | `ErrorMessage` | Модель сообщения об ошибке, унаследованная от `Comindware.Adapter.Message` |

    - Класс `ResponseMessage`

        | Свойство | Описание |
        |---|---|
        | `ResponseMessage` | Модель ответного сообщения, унаследованная от `Comindware.Adapter.Message` |

    - Класс `{communicationRouteName}Signature`

        | Метод | Описание |
        |---|---|
        | `GetIncomingMessageType()` | Определение типа входящего сообщения после его преобразования к внутренним данным |
        | `GetOutgoingMessageType()` | Определение типа сообщения об ответе без ошибок |
        | `GetErrorMessageType()` | Определение типа сообщения об ошибке |

## Настройка сервера ПО для работы адаптера

1. Перейдите в режим суперпользователя:

    --8<-- "linux_sudo.md"

2. Откройте файл конфигурации NGINX для редактирования (`instanceName` — имя экземпляра ПО):

    - **Astra Linux**, **Ubuntu**, **Debian** (DEB-based)

        ``` sh
        nano /etc/nginx/sites-available/comindware<instanceName>
        ```

    - **РЕД ОС**, **Rocky** (RPM-based)

        ``` sh
        nano /etc/nginx/conf.d/comindware<instanceName>
        ```

    - **Альт Сервер**

        ``` sh
        nano /etc/nginx/sites-available.d/comindware<instanceName>
        ```

3. Добавьте следующие директивы для каждого пути передачи данных (`communicationRoutePath` — относительный путь к пути передачи данных, `hostName` — адрес сервера **{{ productName }}**, `portNumber` — порт, по которому доступен адаптер):

    !!! warning "Особенности настройки NGINX для адаптеров"

        Порт, по которому доступен адаптер, должен отличаться от номера порта сервера **{{ productName }}**.

    ``` cs
    location <communicationRoutePath> {
                proxy_pass https://<hostName>:<portNumber>;
        }
    ```

## Просмотр списка адаптеров и настройка адаптера

1. На странице [«**Администрирование**» — «**Инфраструктура**»][administration] выберите пункт «**Адаптеры**» <i class="fa-light fa-puzzle-piece-simple">‌</i>.
2. Отобразится список адаптеров.

    _![Список адаптеров](adapter_list.png)_

3. Нажмите кнопку «**Создать**» или дважды нажмите строку имеющегося адаптера.
4. Отобразится страница свойств адаптера.

    _![Страница свойств адаптера](adapter_properties.png)_

    {% include-markdown ".snippets/pdfPageBreakHard.md" %}

5. В поле «**Исходный код адаптера**» загрузите ZIP-архив с исходным кодом адаптера. Архив должен содержать подготовленное решение Visual Studio. См. [Устройство адаптера](#состав-решения-visual-studio).
6. Нажмите кнопку «**Сохранить**».
7. Нажмите кнопку «**Опубликовать**», чтобы скомпилировать адаптер.
8. В случае успешной компиляции адаптера его название отобразится в списке адаптеров и свойствах адаптера. Название берётся из файлов решения Visual Studio.
9. После компиляции просмотрите **журнал компиляции**.

    _![Пример журнала компиляции](adapter_compilation_log.png)_

10. При необходимости скачайте архив с журналами работы адаптера (вида `_CBAP.adapters.20221026.logs.zip_`), нажав кнопку «**Скачать журнал работы**».

    _![Пример журнала работы адаптера](adapter_execution_log.png)_

    {% include-markdown ".snippets/pdfPageBreakHard.md" %}

11. Пункт с названием подключения для скомпилированного адаптера появится в меню «**Создать**» — «**Пользовательские подключения**» на страницах «**[Подключения][connections]**» и «**[Пути передачи данных][communication_routes]**». При этом для каждой модели данных в пути передачи данных будет предусмотрен соответствующий **тип сообщения**.

_![Создание подключения с использованием адаптера](adapter_custom_connection_create_menu.png)_

_![Создание пути передачи данных с использованием адаптера](adapters_custom_communication_route_create_menu.png)_

## Мониторинг работы адаптера

Для проверки работы адаптера можно воспользоваться встроенными инструментами мониторинга.

- На странице свойств адаптера скачайте архив с журналами его работы, нажав кнопку «**Скачать журнал работы**». Этот журнал содержит следующие сведения о работе адаптера:
    - статус служб адаптера;
    - статус подключения адаптера;
    - доступность методов;
    - объём выделенной памяти;
    - информация о созданных путях передачи данных;
    - взаимодействие адаптера со службой Kafka.

    См. также _«[Журналы адаптеров][logging_engine_adapter_logs]»_ и _«[Событие в адаптере][log_files_event_examples_adapter_event]»_.

- В свойствах **[подключения][connections]** адаптера нажмите кнопку «**Скачать журнал**». Этот журнал содержит следующие события:
    - статус подключения;
    - получение или отправка сообщений;
    - запуск сценария обработки сообщения;
    - использование методов адаптера.

    См. также _«[Статус подключения][log_files_event_examples_connection_status]»_

- Просмотрите события получения или отправки запросов и связанные с ними цепочки событий:
    - Откройте страницу «**Администрирование**» — «**[Журналы событий][logs]**».
    - Перейдите на вкладку «**Трассировка событий**».
    - Просмотрите события типа «**Получен запрос**» и «**Запрос отправлен**», связанные с работой адаптера, дважды нажав строку события.

    См. также _«[Просмотр цепочки событий][logs_event_chain_view]»_.

## Удаление адаптера {: .pageBreakBefore }

!!! warning "Внимание!"

    Пути передачи данных и подключения, сгенерированные для удаленного адаптера, станут неактивны и перестанут работать.

1. Откройте [список адаптеров](#просмотр-списка-адаптеров-и-настройка-адаптера).
2. Установите флажок в первом столбце для адаптера, подлежащего удалению.
3. Нажмите кнопку «**Удалить**».
4. Подтвердите удаление адаптера.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- _[Подключения. Определения, типы, создание, настройка, удаление][connections]_
- _[Журналы событий. Типы, просмотр, цепочки событий][logs]_
- _[Примеры событий в файловых журналах][log_files_event_examples]_
- _[Подсистема журналирования][logging_engine]_

</div>

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}

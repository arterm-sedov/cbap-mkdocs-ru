---
kbId: 5135
title: Восстановление кластера {{ productName }}
tags:
    - Ignite
    - Grafana
    - Kafka
    - Loki
    - OpenSearch
    - Prometheus
    - администрирование
    - архитектура
    - балансировка нагрузки
    - восстановление
    - кластер
    - кластеризация
    - мониторинг
    - отказоустойчивость
    - развёртывание
    - резервное копирование
    - управление кластером
hide: tags
---

# Восстановление кластера {{ productName }} {: #cluster_recovery }

{% include-markdown ".snippets/experimental_feature.md" %}

## Введение {: #cluster_recovery_introduction }

**{{ productName }}** поддерживает кластерные конфигурации, которые обеспечивают высокую доступность, отказоустойчивость и горизонтальное масштабирование.

Данная статья описывает процедуры восстановления кластера **{{ productName }}** после аварийных ситуаций. Рассматриваются два основных сценария:

1. **Отказ одного узла** — восстановление узла путём синхронизации с работоспособными узлами
2. **Отказ всего кластера** — восстановление кластера из резервной копии

### Принципы восстановления кластера {: #cluster_recovery_principles }

Кластерная архитектура **{{ productName }}** обеспечивает восстановление после сбоев благодаря:

- **Распределённому хранилищу данных {{ apacheIgniteVariants }}**: обеспечивает репликацию данных между узлами, высокую доступность и производительность обработки данных
- **Распределённой файловой системе (DFS)**: общее хранилище файлов (NFS или S3) обеспечивает синхронизацию данных между всеми узлами
- **Шине сообщений {{ apacheKafkaVariants }}**: обеспечивает межсервисное взаимодействие и обработку событий
- **Хранилищу журналов событий {{ openSearchVariants }}**: обеспечивает сбор, индексирование и обработку журналов распределённых событий
- **Резервному копированию**: регулярные снимки состояния системы и данных
- **Мониторингу состояния**: эндпоинт `api/health` для контроля работоспособности узлов
- **Управлению рабочими процессами**: только один узел выполняет критические фоновые задачи (резервное копирование, обработка процессов)

### Восстановление всего кластера {: #cluster_recovery_complete_cluster_procedure }

При полном отказе кластера восстановление выполняется из резервной копии.

#### 1. Подготовка к восстановлению

**Проверьте доступность резервных копий:**

- Убедитесь в наличии актуальной резервной копии данных
- Проверьте целостность резервных копий
- Подготовьте план восстановления с указанием последовательности действий

**Подготовьте инфраструктуру:**

- Убедитесь в работоспособности {{ apacheIgniteVariants }}, {{ openSearchVariants }} и {{ apacheKafkaVariants }}
- Проверьте доступность распределённой файловой системы (DFS)
- Подготовьте чистые узлы для восстановления

#### 2. Восстановление данных

**Восстановите данные {{ apacheIgniteVariants }}:**

- Остановите все узлы кластера
- Восстановите данные из резервной копии {{ apacheIgniteVariants }}
- Запустите узлы {{ apacheIgniteVariants }} в порядке приоритета

**Восстановите файлы из общего хранилища:**

- Восстановите файлы из резервной копии NFS-сервера
- Проверьте целостность восстановленных файлов
- Убедитесь в доступности файлов для всех узлов через NFS-монтирование

**Восстановите индексы {{ openSearchVariants }}:**

```sh
curl -X GET "localhost:9200/_cluster/health?pretty"
```

- Восстановите индексы из резервной копии
- Проверьте целостность индексов
- Протестируйте поисковые запросы

#### 3. Восстановление узлов приложений

**Восстановите конфигурацию узлов:**

- Восстановите конфигурационные файлы из резервной копии
- Проверьте настройки подключения к кластерам
- Обновите параметры подключения при необходимости

**Запустите узлы поочерёдно:**

```sh
systemctl start comindware<instanceName>
```

- Запустите узлы в порядке приоритета (сначала серверные, затем клиентские)
- Проверьте подключение каждого узла к кластерам
- Мониторьте процесс синхронизации данных
- Дождитесь сообщения об окончании ребалансировки: `INFO Skipping rebalancing (nothing scheduled)`

#### 4. Проверка восстановления кластера

**Проверьте все эндпоинты `api/health`:**

- Убедитесь, что все узлы возвращают статус `200`
- Проверьте время отклика всех узлов
- Протестируйте балансировку нагрузки

**Протестируйте функциональность:**

- Протестируйте все основные функции системы
- Проверьте работу интеграций
- Мониторьте производительность всех компонентов

**Проверьте синхронизацию данных:**

- Убедитесь в синхронизации данных между узлами
- Проверьте репликацию в {{ apacheIgniteVariants }}
- Протестируйте операции чтения/записи

**Проверьте конфигурацию рабочих процессов:**

- Убедитесь, что только один узел имеет включённые службы `BackupSessionsQueue` и `ProcessEngineQueueProcessing`
- Проверьте файл `Workers.config` на всех узлах
- Убедитесь в правильности `ConfigurationId` на всех узлах

## Процедуры восстановления {: #cluster_recovery_procedures .pageBreakBefore }

### Восстановление одного узла {: #cluster_recovery_single_node_procedure }

При отказе одного узла кластера выполните следующие действия:

!!! note "Типы узлов"

    **Серверные узлы** — выполняют полную функциональность приложения и участвуют в кластере {{ apacheIgniteVariants }}
    
    **Клиентские узлы** — работают в режиме тонкого клиента и подключаются к серверным узлам
    
    **Узлы с рабочими процессами** — только один узел должен выполнять критические фоновые задачи

#### 1. Диагностика отказа узла

**Проверьте состояние узла:**

- Используйте эндпоинт `api/health` для проверки состояния узла
- Анализируйте логи состояния экземпляра (`heartbeat_*.log`)
- Мониторьте логи {{ apacheIgniteVariants }} (`igniteClient_*.log`)

**Определите причину отказа:**

- Проверьте состояние файловой системы
- Проверьте доступность сетевых ресурсов
- Анализируйте системные логи на предмет ошибок

#### 2. Восстановление узла

**Остановите проблемный узел:**

```sh
systemctl stop comindware<instanceName>
```

**Восстановите узел:**

- Исправьте выявленные проблемы
- При необходимости восстановите из резервной копии
- Проверьте конфигурацию узла

**Запустите узел:**

```sh
systemctl start comindware<instanceName>
```

#### 3. Синхронизация с кластером

**Проверьте подключение к {{ apacheIgniteVariants }}:**

```sh
bash /usr/share/ignite/bin/control.sh --baseline
```

**Дождитесь синхронизации данных:**

- Дождитесь сообщения: `INFO Skipping rebalancing (nothing scheduled)`
- Проверьте топологию кластера
- Протестируйте операции чтения/записи

**Управление активацией кластера:**

- При восстановлении полного кластера создайте файл `hold.lock` в директории базы данных
- Дождитесь завершения ребалансировки кластера
- Удалите файл `hold.lock` для активации кластера

#### 4. Проверка восстановления

**Мониторьте эндпоинт `api/health`:**

- Убедитесь, что эндпоинт возвращает статус `200`
- Проверьте время отклика (не должно превышать 5 секунд)

**Проверьте синхронизацию данных:**

- Анализируйте логи на предмет ошибок
- Проверьте синхронизацию данных с другими узлами
- Протестируйте основные функции системы

**Проверьте конфигурацию рабочих процессов:**

- Убедитесь, что конфигурация рабочих процессов соответствует роли узла
- Проверьте, что критически важные службы активны только на одном узле
- Убедитесь в правильности `ConfigurationId`

## Мониторинг и диагностика {: #cluster_recovery_monitoring .pageBreakBefore }

### Ключевые индикаторы состояния {: #cluster_recovery_health_indicators }

**Эндпоинт `api/health`:**

- Статус `200 OK` — узел работает корректно
  - Время отклика не должно превышать 5 секунд
- Проверяйте регулярно, например каждые 30 секунд

**{{ apacheIgniteVariants }}:**

- Проверяйте топологию кластера
- Отслеживайте состояние репликации данных
- Контролируйте производительность операций чтения и записи

**{{ openSearchVariants }}:**

- Используйте эндпоинт `/_cluster/health` для проверки состояния
- Проверяйте состояние индексов и их репликации
- Отслеживайте производительность поисковых запросов

**{{ apacheKafkaVariants }}:**

- Контролируйте состояние топиков и партиций
- Отслеживайте задержки обработки сообщений
- Проверяйте размер очередей сообщений

### Диагностика проблем {: #cluster_recovery_diagnosis }

**Проверьте состояние узлов:**

- Используйте эндпоинт `api/health` для проверки состояния узлов приложений
- Анализируйте логи состояния экземпляра (`heartbeat_*.log`)
- Мониторьте логи {{ apacheIgniteVariants }} (`igniteClient_*.log`)

**Проверьте кластерные компоненты:**

- Проверьте топологию кластера {{ apacheIgniteVariants }} через инструменты управления
- Используйте эндпоинт `/_cluster/health` для проверки состояния {{ openSearchVariants }}
- Контролируйте состояние топиков и партиций {{ apacheKafkaVariants }}

**Анализируйте логи:**

- Ищите критические ошибки и предупреждения
- Проверьте сообщения о ребалансировке кластера
- Мониторьте производительность операций

## Устранение неполадок {: #cluster_recovery_troubleshooting .pageBreakBefore }

### Частые проблемы при восстановлении {: #cluster_recovery_common_issues }

**Узел не подключается к кластеру {{ apacheIgniteVariants }}:**

- Проверьте сетевое подключение между узлами
- Убедитесь в правильности конфигурации {{ apacheIgniteVariants }}
- Проверьте файрвол и сетевые настройки

**Ошибки синхронизации данных:**

- Проверьте доступность NFS-сервера и монтирование общих директорий
- Убедитесь в правильности прав доступа к файлам на NFS-сервере
- Проверьте состояние дискового пространства на NFS-сервере
- Проверьте конфигурацию монтирования в `/etc/fstab`

**Проблемы с балансировщиком нагрузки:**

- Проверьте конфигурацию балансировщика
- Убедитесь в доступности эндпоинта `api/health`
- Проверьте настройки проверки состояния узлов

**Проблемы с NFS-монтированием:**

- Проверьте доступность NFS-сервера
- Убедитесь в правильности настроек в `/etc/fstab`
- Проверьте права доступа к общим директориям
- Убедитесь в корректности монтирования директорий приложения

### Логи для диагностики {: #cluster_recovery_logs }

**Основные логи {{ productName }}:**

- `heartbeat_*.log` — состояние экземпляра и процесс запуска
- `igniteClient_*.log` — подключение к {{ apacheIgniteVariants }} и ребалансировка кластера
- `application.log` — общие ошибки приложения
- `Workers.config` — конфигурация рабочих процессов узла

**Логи инфраструктуры:**

- Логи {{ apacheIgniteVariants }} — состояние кластера данных
- Логи {{ openSearchVariants }} — состояние поискового кластера
- Логи {{ apacheKafkaVariants }} — состояние очередей сообщений

### Инструменты диагностики {: #cluster_recovery_diagnostic_tools }

**Проверка состояния узлов:**

```sh
curl -X GET "http://<node-ip>/api/health"
```

**Проверка {{ apacheIgniteVariants }}:**

```sh
bash /usr/share/ignite/bin/control.sh --baseline
```

**Проверка {{ openSearchVariants }}:**

```sh
curl -X GET "localhost:9200/_cluster/health?pretty"
```

**Проверка {{ apacheKafkaVariants }}:**

```sh
kafka-topics.sh --bootstrap-server localhost:9092 --list
```

## Рекомендации по восстановлению {: #cluster_recovery_recommendations .pageBreakBefore }

### Подготовка к авариям {: #cluster_recovery_preparation }

**Создайте план восстановления:**

- Документируйте процедуры восстановления для каждого сценария
- Определите роли и ответственность команды
- Подготовьте контактную информацию и процедуры эскалации

**Регулярно тестируйте восстановление:**

- Протестируйте восстановление одного узла в тестовой среде
- Протестируйте полное восстановление кластера из резервной копии
- Проверяйте актуальность резервных копий

**Настройте мониторинг:**

- Настройте автоматические уведомления о критических событиях
- Регулярно проверяйте состояние всех компонентов
- Ведите журнал инцидентов и их разрешения

### Специфика восстановления различных архитектур {: #cluster_recovery_architectures }

**Кластер из толстых узлов:**

- Все узлы имеют полную функциональность
- Восстановление может выполняться в любом порядке
- Убедитесь в правильности конфигурации рабочих процессов

**Кластер с разноролевыми узлами:**

- Восстанавливайте серверные узлы перед клиентскими
- Проверьте конфигурацию тонких клиентов
- Убедитесь в доступности серверных узлов для клиентских

**Кластер с дополнительными узлами {{ apacheIgniteVariants }}:**

- Восстанавливайте узлы {{ apacheIgniteVariants }} перед узлами приложений
- Проверьте топологию кластера {{ apacheIgniteVariants }}
- Убедитесь в правильности конфигурации портов

### Практики, которых следует избегать {: #cluster_recovery_anti_patterns }

- **Не игнорируйте резервное копирование**: нерегулярное или неправильное резервное копирование данных может осложнить восстановление системы после сбоя.
- **Не пропускайте тестирование восстановления**: невыполнение регулярного тестирования процедур восстановления может привести к неготовности к авариям.
- **Не восстанавливайте несколько узлов одновременно**: одновременное восстановление нескольких узлов может привести к конфликтам данных.
- **Не игнорируйте проверки целостности**: всегда проверяйте целостность данных после восстановления.
- **Не нарушайте конфигурацию рабочих процессов**: только один узел должен выполнять критические фоновые задачи.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- [Установка, запуск, инициализация и остановка ПО][deploy_guide_linux]
- [Обновление кластера {{ productName }}][cluster_upgrade]
- [Системные требования {{ productName }}][system_requirements]
- [Резервное копирование. Настройка и запуск, просмотр журнала сеансов][backup_configure]

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

# Развёртывание  кластера Приложения из трёх толстых узлов

### Используемые серверы

cbap-test_1 - 10.0.0.1 - Сервер Приложения, узел 1

cbap-test_2 - 10.0.0.2 - Сервер Приложения, узел 2

cbap-test_3 - 10.0.0.3 - Сервер Приложения, узел 3

cbap_test_nfs - 10.0.0.4 - Сервер Хранения данных, NFS

### Создание NFS-сервера cbap_test_nfs - 10.0.0.4

```sh

mkdir /share
sudo apt install nfs-kernel-server
sudo systemctl enable nfs-kernel-server.service
```
  
```sh
nano /etc/exports
```

добавить строку:
`/share <clientIP>/<netMask>(rw,sync,no_subtree_check)`

```sh
sudo systemctl start nfs-kernel-server.service
mkdir -p /share/<instanceName>/Streams
mkdir -p /share/<instanceName>/Scripts
mkdir -p /share/<instanceName>/Temp
mkdir -p /share/<instanceName>/Localtemp

chmod -R 777 /share/<instanceName>
chown -R nobody:nogroup /share
```
### На каждом сервере приложения!!!

#### Установка и настройка бинарных пакетов приложения Apache Ignite
Скачать бинарный дистрибутив Apache Ignite, например [apache-ignite-2.16.0-bin.zip](https://downloads.apache.org/ignite/2.16.0/apache-ignite-2.16.0-bin.zip) или более новую версию.
Перейти в режим суперпользователя:
  ```sh
su -
```
или
```sh
sudo -s
```

Распаковать дистрибутив Apache Ignite в домашнюю папку (здесь и далее `username` — имя текущего пользователя):
```sh
unzip apache-ignite-2.16.0-bin.zip -d /usr/share/
mv /usr/share/apache-ignite* /usr/share/ignite
```

Задать переменную среды `IGNITE_HOME`:
```sh
export IGNITE_HOME=/usr/share/ignite
```

Скопировать в папку `/usr/share/ignite` файл `Ignite.config` из папки `/var/www/<instanceName>` (где `<instanceName>` — имя экземпляра ПО):
```sh
cp /var/www/instanceName/Ignite.config /usr/share/ignite/
```

Перейти в папку `bin` Apache Ignite:
```sh
cd /home/username/ignite/bin
```

В файле `control.sh` изменить директиву `DEFAULT_CONFIG`:
```sh
nano control.sh
```

```d
DEFAULT_CONFIG=config/Ignite.config
```

Проверить получение списка узлов, зарегистрированных в базовой топологии:
```sh
bash control.sh --baseline
```

При незапущенных экземплярах приложения запрос должен отдать пустую топологию
#### Установка NFS-клиента на Серверы приложений
После создания NFS-сервера установить NFS-клиент на серверы Приложений
```
sudo apt install nfs-common
nano /etc/fstab
```

добавить строку
`10.0.0.4:/share  /mnt/share  nfs  defaults,nofail,_netdev,x-systemd.automount  0  0`

Выполнить монтирование дисков, создать и настроить директории и ссылки
```sh
mount -a
ls -lh /mnt/share
mkdir /db
mkdir -p /db/<instanceName>/Database/
mkdir /var/lib/comindware
ln -s /db/<instanceName> /var/lib/comindware/<instanceName>
ln -s /mnt/share/<instanceName>/Scripts /db/<instanceName>/Database/Scripts

chown -R www-data: /var/lib/comindware /db/<instanceName>
```
#### Конфигурация окружения экземпляра Приложения
```sh
nano /etc/sysconfig/comindware<instanceName>-env
```

проверить значения в строке
```d
JVM_OPTS=-Xms512m -Xmx4g -XX:MaxDirectMemorySize=1g...
```
### На сервере Приложения cbap-test_1- 10.0.0.1
в директорию `/home/admin` скопирована РК `<instanceName>.XXX.cdbbz`
Установлена версия CBAP, создан экземпляр с именем `<instanceName>`
распаковать и подложить РК в дитекторию БД
```sh
cd /home/admin
unzip -q <instanceName>.XXX.cdbbz
cp -r Scripts/* /mnt/share/<instanceName>/Scripts/
cp -r Streams/* /mnt/share/<instanceName>/Streams/
mv Database/* /db/<instanceName>/Database/
rm -rf Database Scripts Streams
chown -R www-data: /db/<instanceName>
```

Изменить конфигурацию Ignite
```sh
nano /var/www/<instanceName>/Ignite.config
```
заменить значения в `"localAddress"` - указать IP
прописать IP узлов кластера Apache Ignite
проверить размер выделенной памяти
```xml
<property name="discoverySpi">
      <bean class="org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi">
        <property name="localAddress" value="10.0.0.1" />
        <property name="localPort" value="47510" />
        <property name="localPortRange" value="9" />
        <property name="ipFinder">
          <bean class="org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder">
            <property name="addresses">
              <list>
                <value>10.0.0.1:47510..47519</value>
                <value>10.0.0.2:47510..47519</value>
                <value>10.0.0.3:47510..47519</value>
              </list>
            </property>
          </bean>
        </property>
      </bean>
    </property>
    <property name="communicationSpi">
      <bean class="org.apache.ignite.spi.communication.tcp.TcpCommunicationSpi">
        <property name="localPort" value="47101" />
        <property name="localAddress" value="10.0.0.1" />
        <property name="messageQueueLimit" value="1024" />
      </bean>
    </property>
...
...
<property name="dataRegionConfigurations">
          <list>
            <bean class="org.apache.ignite.configuration.DataRegionConfiguration">
              <property name="warmUpConfiguration">
                <bean class="org.apache.ignite.configuration.NoOpWarmUpConfiguration" />
              </property>
              <property name="name" value="Persistent" />
              <property name="persistenceEnabled" value="true" />
              <property name="initialSize" value="#{1024L * 1024 * 1024}" />
              <property name="maxSize" value="#{4L * 1024 * 1024 * 1024}" />
              <property name="pageEvictionMode" value="RANDOM_2_LRU" />
              <property name="checkpointPageBufferSize" value="#{1024L * 1024 * 1024}" />
            </bean>
            <bean class="org.apache.ignite.configuration.DataRegionConfiguration">
              <property name="name" value="InMemory" />
              <property name="persistenceEnabled" value="false" />
              <property name="initialSize" value="#{10 * 1024 * 1024}" />
              <property name="maxSize" value="#{256 * 1024 * 1024}" />
            </bean>
          </list>
        </property>
      </bean>
    </property>
```

Выполнить настройку экземпляра Приложения
```sh
nano /usr/share/comindware/configs/instance/<instanceName>.yml
```

```yml
clusterName: cmwdata
nodeName: cmwdata_1
configPath: /var/www/cmwdata
journal.server: http://localhost:9200
journal.name: pik_prod_test
fqdn:
port: 80
version: 4.7.33413.0
db.workDir: /var/lib/comindware/cmwdata/Database
db.name: pik_test
userStorage.type: LocalDisk
userStorage.localDisk.path: /mnt/share/cmwdata/Streams
tempStorage.type: LocalDisk
tempStorage.localDisk.path: /mnt/share/cmwdata/Temp
tempWorkingDir: /mnt/share/cmwdata/LocalTemp
mq.server: 10.9.10.5:9092
mq.group: pik_cmwdata
mq.name: cmwdata
mq.node: cmwdata_1
backup.defaultFolder: /mnt/share/cmwdata/Backup
backup.defaultFileName: Backup
backup.enabled: true
backup.schedulesEnabled: true
backup.journalRepository.type: LocalDisk
backup.journalRepository.localDisk.path: /mnt/share/elasticsearch

```

перед первым запуском убедиться в отсутствии файла конфигурации служб экземпляра
```sh
rm -f /var/www/npportalid/Workers.config
```
### Запустить  экземпляр приложения на cbap_test_1
```sh
systemctl start comindware<instanceName>
```
Выполнить запрос через браузер
В Maintenance Mode выключить ненужные службы.
Дождаться полного запуска и войти в систему

Открыть файл конфигурации работающих служб, проверить статус служб, скопировать/перенести файл конфигурации на узлы 2 и 3.
```sh
nano /var/www/<instanceName>/Workers.config
```

```xml
<?xml version="1.0" encoding="utf-8"?>
<WorkerEngine xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-i>
  <RebuildThreadWorker>false</RebuildThreadWorker>
  <BackupSessionsQueue>true</BackupSessionsQueue>
  <SessionManagerWorker>false</SessionManagerWorker>
  <NotificationWorker>false</NotificationWorker>
  <EmailListener>false</EmailListener>
  <IndexTasksQueue>false</IndexTasksQueue>
  <ProcessEngineQueueProcessing>false</ProcessEngineQueueProcessing>
  <ProcessEngineTimerProcessing>false</ProcessEngineTimerProcessing>
  <SyncThread>false</SyncThread>
  <SwitchOnFullTextSearch>false</SwitchOnFullTextSearch>
  <PerformanceMonitoring>false</PerformanceMonitoring>
  <ConfigurationId>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</ConfigurationId>
</WorkerEngine>

```

Скопировать и сохранить значение из строки
`<ConfigurationId>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</ConfigurationId>`

```sh
chown www-data: /var/www/<instanceName>/Workers.config
```
### На сервере Приложения cbap_test_2 - 10.0.0.2
Установлена версия CBAP, создан экземпляр с именем `<instanceName>`
Проверить/изменить конфигурацию Apache Ignite 
```sh
nano /var/www/<instanceName>/Ignite.config
```

заменить значения в `"localAddress"` - указать IP
прописать IP узлов кластера Apache Ignite
проверить размер выделенной памяти
```xml
<property name="discoverySpi">
      <bean class="org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi">
        <property name="localAddress" value="10.0.0.2" />
        <property name="localPort" value="47510" />
        <property name="localPortRange" value="9" />
        <property name="ipFinder">
          <bean class="org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder">
            <property name="addresses">
              <list>
                <value>10.0.0.1:47510..47519</value>
                <value>10.0.0.2:47510..47519</value>
                <value>10.0.0.3:47510..47519</value>
              </list>
            </property>
          </bean>
        </property>
      </bean>
    </property>
    <property name="communicationSpi">
      <bean class="org.apache.ignite.spi.communication.tcp.TcpCommunicationSpi">
        <property name="localPort" value="47101" />
        <property name="localAddress" value="10.0.0.2" />
        <property name="messageQueueLimit" value="1024" />
      </bean>
    </property>
...
...
<property name="dataRegionConfigurations">
          <list>
            <bean class="org.apache.ignite.configuration.DataRegionConfiguration">
              <property name="warmUpConfiguration">
                <bean class="org.apache.ignite.configuration.NoOpWarmUpConfiguration" />
              </property>
              <property name="name" value="Persistent" />
              <property name="persistenceEnabled" value="true" />
              <property name="initialSize" value="#{1024L * 1024 * 1024}" />
              <property name="maxSize" value="#{4L * 1024 * 1024 * 1024}" />
              <property name="pageEvictionMode" value="RANDOM_2_LRU" />
              <property name="checkpointPageBufferSize" value="#{1024L * 1024 * 1024}" />
            </bean>
            <bean class="org.apache.ignite.configuration.DataRegionConfiguration">
              <property name="name" value="InMemory" />
              <property name="persistenceEnabled" value="false" />
              <property name="initialSize" value="#{10 * 1024 * 1024}" />
              <property name="maxSize" value="#{256 * 1024 * 1024}" />
            </bean>
          </list>
        </property>
      </bean>
    </property>
```

Выполнить настройку экземпляра Приложения
```sh
nano /usr/share/comindware/configs/instance/<instanceName>.yml
```

```yml
isFederationAuthEnabled: 0
databasePath: /var/lib/comindware/<instanceName>/Database
# /var/lib/comindware/<instanceName> ==> /db/<instanceName>
configPath: /var/www/<instanceName>
backup.config.default.repository.type: LocalDisk
backup.config.default.repository.localDisk.path: /var/lib/comindware/<instanceName>/Backup
userStorage.type: LocalDisk
userStorage.localDisk.path: /mnt/share/<instanceName>/Streams
tempStorage.type: LocalDisk
tempStorage.localDisk.path: /mnt/share/<instanceName>/Temp
  
instanceName: <instanceName>
databaseName: <instanceName>
configName: <instanceName>
nodeName: <instanceName>2 ## у каждого узла своё имя

mq.server: 10.0.0.1:9092 ## all nodes to single kafka
mq.group: <instanceName>
manageAdapterHost: true
elasticsearchUri: http://localhost:9200
version: 4.7.2604.0

```
  
 Открыть файл конфигурации работающих служб
```sh
nano /var/www/<instanceName>/Workers.config
```

Проверить установленный статус служб,
>[!note] Обратить внимание на то, что только ОДИН узел в кластере должен иметь включённые службы `BackupSessionsQueue` или `ProcessEngineQueueProcessing`
 
```xml
<?xml version="1.0" encoding="utf-8"?>
<WorkerEngine xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-i>
  <RebuildThreadWorker>false</RebuildThreadWorker>
  <BackupSessionsQueue>false</BackupSessionsQueue>
  <SessionManagerWorker>false</SessionManagerWorker>
  <NotificationWorker>false</NotificationWorker>
  <EmailListener>true</EmailListener>
  <IndexTasksQueue>false</IndexTasksQueue>
  <ProcessEngineQueueProcessing>true</ProcessEngineQueueProcessing>
  <ProcessEngineTimerProcessing>false</ProcessEngineTimerProcessing>
  <SyncThread>false</SyncThread>
  <SwitchOnFullTextSearch>false</SwitchOnFullTextSearch>
  <PerformanceMonitoring>false</PerformanceMonitoring>
  <ConfigurationId>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</ConfigurationId>
</WorkerEngine>
```

Запустить экземпляр Приложения,
```sh
systemctl start comindware<instanceName>
```

Выполнить запрос через браузер
после выполнения обращения через браузер на втором узле перейти в директорию со скриптами Apache Ignite и выполнить запрос топологии
```sh
cd /home/username/ignite/bin
watch bash control.sh --baseline
```
Дождаться включения второго узла в топологию
Дождаться возможности входа в систему через браузер
### На сервере Приложениcbap-test3 - 10.0.0.3
Установлена версия CBAP, создан экземпляр с именем `<instanceName>`

Проверить/изменить конфигурацию Apache Ignite 
```sh
nano /var/www/<instanceName>/Ignite.config
```

заменить значения в `"localAddress"` - указать IP
прописать IP узлов кластера Apache Ignite
проверить размер выделенной памяти
```xml
<property name="discoverySpi">
      <bean class="org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi">
        <property name="localAddress" value="10.0.0.3" />
        <property name="localPort" value="47510" />
        <property name="localPortRange" value="9" />
        <property name="ipFinder">
          <bean class="org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder">
            <property name="addresses">
              <list>
                <value>10.0.0.1:47510..47519</value>
                <value>10.0.0.2:47510..47519</value>
                <value>10.0.0.3:47510..47519</value>
              </list>
            </property>
          </bean>
        </property>
      </bean>
    </property>
    <property name="communicationSpi">
      <bean class="org.apache.ignite.spi.communication.tcp.TcpCommunicationSpi">
        <property name="localPort" value="47101" />
        <property name="localAddress" value="10.0.0.3" />
        <property name="messageQueueLimit" value="1024" />
      </bean>
    </property>
...
...
<property name="dataRegionConfigurations">
          <list>
            <bean class="org.apache.ignite.configuration.DataRegionConfiguration">
              <property name="warmUpConfiguration">
                <bean class="org.apache.ignite.configuration.NoOpWarmUpConfiguration" />
              </property>
              <property name="name" value="Persistent" />
              <property name="persistenceEnabled" value="true" />
              <property name="initialSize" value="#{1024L * 1024 * 1024}" />
              <property name="maxSize" value="#{4L * 1024 * 1024 * 1024}" />
              <property name="pageEvictionMode" value="RANDOM_2_LRU" />
              <property name="checkpointPageBufferSize" value="#{1024L * 1024 * 1024}" />
            </bean>
            <bean class="org.apache.ignite.configuration.DataRegionConfiguration">
              <property name="name" value="InMemory" />
              <property name="persistenceEnabled" value="false" />
              <property name="initialSize" value="#{10 * 1024 * 1024}" />
              <property name="maxSize" value="#{256 * 1024 * 1024}" />
            </bean>
          </list>
        </property>
      </bean>
    </property>
```


Проверить установленный статус служб,
>[!note] Обратить внимание на то, что только ОДИН узел в кластере должен иметь включённые службы `BackupSessionsQueue` или `ProcessEngineQueueProcessing`

```sh
nano /var/www/<instanceName>/Workers.config
```

```xml
<?xml version="1.0" encoding="utf-8"?>
<WorkerEngine xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-i>
  <RebuildThreadWorker>false</RebuildThreadWorker>
  <BackupSessionsQueue>false</BackupSessionsQueue>
  <SessionManagerWorker>false</SessionManagerWorker>
  <NotificationWorker>false</NotificationWorker>
  <EmailListener>true</EmailListener>
  <IndexTasksQueue>false</IndexTasksQueue>
  <ProcessEngineQueueProcessing>false</ProcessEngineQueueProcessing>
  <ProcessEngineTimerProcessing>false</ProcessEngineTimerProcessing>
  <SyncThread>false</SyncThread>
  <SwitchOnFullTextSearch>false</SwitchOnFullTextSearch>
  <PerformanceMonitoring>false</PerformanceMonitoring>
  <ConfigurationId>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</ConfigurationId>
</WorkerEngine>
```

Запустить экземпляр Приложения,
```sh
systemctl start comindware<instanceName>
```

Выполнить запрос через браузер
после выполнения обращения через браузер на втором узле перейти в директорию со скриптами Apache Ignite и выполнить запрос топологии
```sh
cd /home/username/ignite/bin
watch bash control.sh --baseline
```
Дождаться включения второго узла в топологию
Дождаться возможности входа в систему через браузер

---
title: 'NGINX. Настройка конфигурации для получения HTTP-запросов'
kbTitle: 'NGINX. Настройка конфигурации для получения HTTP-запросов в Comindware Platform'
kbId: 5143
tags:
    - HTTP-запросы
    - Linux
    - NGINX
    - получение запросов
    - прокси-сервер
    - развёртывание
hide:
    - tags
---

# NGINX. Настройка конфигурации для получения HTTP-запросов {: #nginx_configure }

## Введение {: #nginx_configure_intro }

Здесь представлены инструкции по настройке конфигурации прокси-сервера NGINX для перенаправления HTTP-запросов в **{{ productName }}** при использовании подключения типа «**Получение HTTP-запросов**».

Подробные сведения по установке и настройке NGINX представлены на следующих сайтах:

- <http://nginx.org/ru/docs/beginners_guide.html>
- <https://ruvds.com/ru/helpcenter/kak-nastroit-nginx-na-ubuntu-20-04/>
- <https://webdevblog.ru/bezopasnost-nginx-kak-uluchshit-konfiguraciju-vashego-servera/>

См. также:
- _[NGINX. Установка и настройка][nginx_deploy]_
- _[Установка, запуск, инициализация и остановка ПО][deploy_guide_linux]_

## Прикладная задача {: #nginx_configure_task }

В данном примере рассматривается настройка NGINX в качестве прокси-сервера для перенаправления HTTP-запросов из внешних систем в **{{ productName }}**:

- имеется шаблон записи _«Заказы»_ с атрибутами _«Артикул товара»_ типа «**Текст**» и  _«Количество»_ типа «**Число**».
- внешний сервер отправляет HTTP-запросы с искомым артикулом товара (`squ`) на порт `8123` NGINX;
- NGINX должен перенаправлять запросы на порт `39135` **{{ productName }}**, где настроено подключение типа «**Получение HTTP-запросов**»;
- **{{ productName }}** должна обрабатывать запросы и возвращать массив с данными заказов, содержащих указанный артикул товара, вида:

    ``` json
    "orders": [{
        "orderNumber": "string",
        "quantity": "number"
    }]
    ```

## Создание конфигурации прокси-сервера NGINX {: #nginx_configure_create_config }

!!! warning "Внимание!"

    Для выполнения представленных здесь инструкций потребуется доступ к команде `sudo`.

1. Откройте для редактирования файл конфигурации NGINX:

    ``` sh
    sudo nano /etc/nginx/sites-available/proxy-service
    ```

    Здесь `proxy-service` — имя файла конфигурации NGINX. Вы можете использовать собственное наглядное имя.

2. Добавьте в файл следующие директивы:

    ``` sh
    server {
        listen 8123;
        server_name _;

        location /api/public/ {
            proxy_pass http://127.0.0.1:39135/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # При необходимости снимите ограничение на размер тела запроса,
            # закомментировав эту директиву
            client_max_body_size 10M;
        }
    }
    ```

    Здесь:

    - `listen 8123` — порт, на котором NGINX будет принимать HTTP-запросы. Этот порт указывается при отправке запросов из внешних систем, например: `http://<your_host>:8123/api/public/get/request` (`<your_host>` — URL-адрес вашего экземпляра **{{ productName }}**).
    - `server_name _` — имя виртуального хоста. Значение `_` используется как «хост по умолчанию» для запросов, имя сервера которых не совпадает ни с одним другим блоком `server`.
    - `proxy_pass http://127.0.0.1:39135/` — адрес и порт **{{ productName }}**, на который NGINX будет перенаправлять запросы. Порт `39135` должен совпадать с портом, указанным при создании подключения типа «**Получение HTTP-запросов**» в **{{ productName }}**.

3. Сохраните файл.

## Включение конфигурации {: #nginx_configure_enable }

1. Создайте символическую ссылку на файл конфигурации в директории `sites-enabled`:

    ``` sh
    sudo ln -s /etc/nginx/sites-available/proxy-service /etc/nginx/sites-enabled/
    ```

2. Проверьте корректность конфигурации NGINX:

    ``` sh
    sudo nginx -t
    ```

3. Если проверка прошла успешно, перезапустите NGINX:

    ``` sh
    sudo systemctl restart nginx
    ```

## Настройка подключения в {{ productName }} {: #nginx_configure_connection }

1. На странице «**Администрирование**» выберите пункт «**Инфраструктура**» — «[**Подключения**][connections]» <i fal fa-exchange-alt></i>.
2. Создайте или откройте подключение типа «**Подключения REST и OData**» — «**Получение HTTP-запросов**».
3. Настройте подключение:

    - **Системное имя** — введите уникальное имя подключения, например `receiveHttpConnection`.
    - **Описание** — введите наглядное описание подключения.
    - **Запись в файловые журналы** — выберите уровень журналирования событий получения запросов.
    - **Путь URI** — укажите путь, например `orders`, на который внешняя система будет отправлять запросы.
    - **Порт** — укажите порт `39135` (должен совпадать с внутренним портом, указанным [в конфигурации NGINX](#nginx_configure_create_config)).
    - **Формат данных** — выберите формат данных, например **JSON**.

4. Нажмите кнопку «**Проверить соединение**» для проверки корректности настроек.
5. Сохраните подключение.

## Настройка пути передачи данных {: #nginx_configure_route }

1. На странице «**Администрирование**» выберите пункт «[**Пути передачи данных**][communication_routes]» <i class="fa-light fa-route " aria-hidden="true"></i>.
2. Создайте или откройте путь передачи данных типа «**Подключения REST и OData**» — «**Получение HTTP-запросов**».
3. На вкладке «**Основные свойства**» настройте:

    - **Подключение** — выберите созданное ранее [подключение для получения HTTP-запросов](#nginx_configure_connection).
    - **Системное имя** — введите уникальное имя пути передачи данных, например `receiveHttpRoute`.
    - **Описание** — введите наглядное описание пути передачи данных.

4. На вкладке «**Атрибуты сообщений**» настройте структуру данных запроса и ответа:

    - Выберите **тип сообщения** «**Обработка HTTP-запросов**».
    - В таблице «**Запрос**» добавьте атрибуты, соответствующие структуре входящих HTTP-запросов. Например, для запроса с полем номера заказа `orderNumber` добавьте атрибут:
        - **Системное имя:** `orderNumber`
        - **Тип:** `Строка`
    - В таблице «**Ответ**» добавьте атрибуты для структуры ответа. Например, для ответа с массивом данных заказов:
        - атрибут `orders` типа «**Объект**» с установленным флажком «**Массив**».
            - внутри атрибут `orders` дочерние атрибуты:
                - `id` и `product` типа «**Строка**»;
                - `quantity` типа «**Число**».

5. На вкладке «**Интеграция**» настройте:

    - **Путь URI** — укажите дополнительный путь, например `request`.

        Полный путь для отправки запросов будет составлен из компонентов, настроенных в подключении и пути передачи данных, например: `http://<your_host>:8123/api/public/orders/request` (`<your_host>` — URL-адрес вашего экземпляра **{{ productName }}**).

    - **Атрибуты для десериализации данных** — укажите `$` в обоих столбцах для получения всей структуры JSON из запроса.

6. Сохраните путь передачи данных.

## Настройка сценария для обработки входящих сценариев {: #nginx_configure_scenario }

1. Создайте новый сценарий.
2. Настройте созданное по умолчанию событие «**Нажатие кнопки**»:

    - **Тип: получение сообщения**
    - **Контекстный шаблон:** _Заказы_
    - **Подключение:** выберите созданное [подключение для получения HTTP-запросов](#nginx_configure_connection)
    - **Путь передачи данных:** выберите созданный [путь передачи данных](#nginx_configure_route)
    - **Имя переменной:** укажите имя переменной для хранения входящего запроса, например `orderRequest`

4. Добавьте действие «**Сменить контекст**»:

    - **Целевой шаблон записи:** _Заказы_
    - **Атрибут или выражение для поиска объектов:** укажите выражение для выборки заказов по номеру:

        ``` cs
        from a in db->Заказы where a->НомерЗаказа==$$orderRequest->orderNumber select a->id
        ```

        Здесь:

        - `$$orderRequest` — переменная из события «**Получение сообщения**»
        - `orderNumber` — атрибут сообщения, настроенный в [пути передачи данных входящего HTTP-запроса](#nginx_configure_route).

5. Добавьте действие «**Изменить значения переменных**»:

    - **Операция со значениями переменных: заменить**
    - Настройте переменные для передачи данных в запись:

        | Имя переменной | Значение |
        | -------------- | -------- |
        | `orderNumber` | Атрибут _«ID»_ |
        | `quantity` | Атрибут _«Количество»_ |

## Тестирование {: #nginx_configure_testing }

1. Отправьте HTTP-запрос из внешней системы на настроенный адрес NGINX, например:

    ``` sh
    curl -X POST \
        -u username:password \
        -H "Content-Type: application/json" \
        -d '{
            "sku": "12345"
        }' \
        http://<your_host>:8123/api/public/orders/request \
        -v`
    ```

    Здесь:

    - `-X POST` — метод запроса (необязательный ключ);
    - `-u username:password` — базовая аутентификация c учётными данными аккаунта с разрешением на **вызовы API** **{{ productName }}**;
    - `-H "Content-Type: application/json"` — заголовок, указывающий на формат данных JSON;
    - `-d '{"sku": "12345"}'` — тело запроса с JSON-структурой, содержащей артикул искомого товара;
    - `http://<your_host>:8123/api/public/orders/request` — адрес NGINX с путём, настроенным в [подключении](#nginx_configure_connection) и [пути передачи данных](#nginx_configure_route) (`<your_host>` — URL-адрес вашего экземпляра **{{ productName }}**);
    - `-v` — вывод отладочных данных (необязательный ключ).

2. Проверьте обработку запроса. **{{ productName }}** должна вернуть данные заказов с запрошенным товаром, например:

    ``` json
    {
      "orders": [
        {
          "orderNumber": "2235",
          "quantity": 10
        },
        {
          "orderNumber": "2236",
          "quantity": 5
        }
      ]
    }
    ```

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- [HTTP-запросы. Получение JSON-данных в сценарии][http_receive_example]
- [NGINX. Установка и настройка][nginx_deploy]
- [Установка, запуск, инициализация и остановка ПО][deploy_guide_linux]
- [Сценарии. Настройка][scenarios]

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

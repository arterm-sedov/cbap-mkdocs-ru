---
kbId: 5134
title: Обновление кластера {{ productName }}
tags:
    - Ignite
    - Grafana
    - Kafka
    - Loki
    - OpenSearch
    - Prometheus
    - администрирование
    - архитектура
    - балансировка нагрузки
    - кластер
    - кластеризация
    - мониторинг
    - обновление
    - развёртывание
    - управление кластером
hide: tags
---

# Обновление кластера {{ productName }} {: #cluster_upgrade }

{% include-markdown ".snippets/experimental_feature.md" %}

## Введение {: #cluster_upgrade_introduction }

**{{ productName }}** поддерживает кластерные конфигурации, которые обеспечивают высокую доступность, отказоустойчивость и горизонтальное масштабирование.

Здесь представлены рекомендации и процедуры обновления ПО **{{ productName }}** в кластерных конфигурациях без простоя.

### Основные принципы обновления кластера {: #cluster_upgrade_principles }

Кластерная архитектура **{{ productName }}** позволяет обновлять ПО без простоя благодаря следующим возможностям:

- **Проверка здоровья узлов**: все узлы предоставляют эндпоинт `api/health` для мониторинга состояния.
- **Автоматическое перераспределение трафика**: балансировщик нагрузки должен автоматически исключать неисправные узлы.
- **Резервные узлы**: {{ apacheIgniteVariants }}, {{ openSearchVariants }} и {{ apacheKafkaVariants }} обеспечивают избыточность во время обновлений.
- **Распределённое хранилище**: DFS обеспечивает синхронизацию данных для всех узлов.

При обновлении ПО кластера **{{ productName }}** соблюдайте рекомендованный порядок:

1. **Технологическое окно**: для обновления выберите время, когда кластер наименее нагружен.
2. **Перенаправьте нагрузку**: перед началом обновления перенаправьте весь трафик с обновляемого узла.
3. **Обновляйте узлы поочерёдно по одному**: обновляйте один узел, пока остальные продолжают работать.

## Рекомендации по обновлению кластера {: #cluster_upgrade_operations .pageBreakBefore }

- **Запланируйте обновление**:
   - Выберите для обновления период минимальной нагрузки на систему.
   - Заблаговременно уведомьте пользователей о предстоящих работах.
   - Подготовьте план отката на случай проблем.
- **Протестируйте обновление в изолированной среде**:
   - Создайте тестовую копию кластера.
   - Протестируйте обновления.
   - Проверьте совместимость обновлённого кластера с существующими данными.
- **Контролируйте работоспособность кластера в процессе обновления**:
   - Отслеживайте состояние всех компонентов и сервисов.
   - Замеряйте производительность системы.
   - Будьте готовы к немедленному откату при необходимости.

## Ключевые этапы обновления {: #cluster_upgrade_key_principles .pageBreakBefore }

### Подготовка к обновлению {: #cluster_upgrade_preparation }

- Создайте резервную копию данных **{{ productName }}**, чтобы упростить восстановление кластера в случае проблем при обновлении.
- Проверьте доступность и работоспособность {{ apacheIgniteVariants }}, {{ openSearchVariants }} и {{ apacheKafkaVariants }}, чтобы кластер сохранял работоспособность во время обновления.
- Проанализируйте журналы на предмет наличия ошибок и предупреждений, которые могут помешать обновлению.

### Мониторинг во время обновления {: #cluster_upgrade_monitoring }

- Постоянно контролируйте эндпоинт `api/health` на всех узлах, он должен возвращать статус `200`.
- Анализируйте журналы состояния **{{ productName }}** (`heartbeat_*.log`).
- Контролируйте журнал {{ apacheIgniteVariants }} (`igniteClient_*.log`).
- Контролируйте синхронизацию данных между узлами.

### Проверка после обновления {: #cluster_upgrade_verification }

- Дождитесь сообщения об окончании ребалансировки кластера.
- Найдите в журналах балансировщика сообщение `INFO Skipping rebalancing (nothing scheduled)`.
- Проверьте результирующую топологию {{ apacheIgniteVariants }}.

## Архитектура кластера {: #cluster_upgrade_architecture .pageBreakBefore }

Рассмотрим состав и конфигурацию кластера **{{ productName }}** из четырёх узлов, который обслуживает пользователей и интеграцию с внешними системами:

- **PLATFORM-node0** (`XX.XX.101.10`) — основной узел пользовательского трафика. 40% — пользовательский трафик, 10% — интеграционный.
- **PLATFORM-node1** (`XX.XX.101.11`) — узел мониторинга и поиска. 30% — пользовательский трафик, 20% — интеграционный.
- **PLATFORM-node2** (`XX.XX.101.12`) — узел поиска и обработки данных. 20% — пользовательский трафик, 30% — интеграционный.
- **PLATFORM-node3** (`XX.XX.101.13`) — основной узел трафика интеграций. 10% — пользовательский трафик, 40% — интеграционный.

_![Пример конфигурации кластера](img/cluster_upgrade_deploy_configuration.svg)_

### Компоненты узлов {{ productName }} {: #cluster_upgrade_platform_components }

Каждый узел **{{ productName }}** содержит следующие компоненты:

- **Core** — экземпляр ПО **{{ productName }}**.
- **Adapters** — адаптеры для интеграции с внешними системами.
- **Async** — асинхронные обработчики, которые выполняют фоновые задачи.
- **{{ apacheIgniteVariants }}** — распределённое хранилище данных. Отдельный кластер, см. _«[Инфраструктура данных](#cluster_upgrade_data_infrastructure)»_.
- **{{ nginxVariants }}** — обратный прокси-сервер, который обрабатывает HTTP-запросы.
- **{{ apacheKafkaVariants }}** — брокер сообщений, который обеспечивает межсервисное взаимодействие. Отдельный кластер или облачный сервис.

_![Состав кластера](img/cluster_upgrade_landscape.svg)_

### Распределение нагрузки {: #cluster_upgrade_load_balancing }

Нагрузки, исходя из опыта, можно классифицировать на следующие виды:

- пользовательские действия;
- интеграционные сценарии;
- внутренние автоматические операции, процессы и скрипты;
- формирование отчётов.

Для равномерного распределения нагрузки и минимизации времени отклика рекомендуется настраивать балансировщик таким образом, чтобы «разводить» нагрузки различных видов с соблюдением требований высокой доступности, отказоустойчивости и горизонтального масштабирования.

Например:

|              | У1  | У2  | У3  | У4  |
| ------------ | --- | --- | --- | --- |
| Пользователи | 40  | 30  | 20  | 10  |
| Интеграции   | 10  | 20  | 30  | 40  |
| Скрипты      | 20  | 10  | 40  | 30  |
| Отчёты       | 30  | 40  | 10  | 20  |

### Инфраструктура данных {: #cluster_upgrade_data_infrastructure }

- **Распределённое хранилище данных {{ apacheIgniteVariants }}**
    - Обеспечивает репликацию данных между узлами, высокую доступность и производительность обработки данных.
- **Шина сообщений {{ apacheKafkaVariants }}**
    Обеспечивает межсервисное взаимодействие и обработку событий.
- **Хранилище журналов событий {{ openSearchVariants }}**
    - Обеспечивает сбор, индексирование и обработку журналов распределённых событий
- **Распределённая файловая система (DFS)**
    - Общее хранилище файлов может быть реализовано на NFS  или S3.
    - Обеспечивает хранение загружаемых пользовательских файлов и других бинарных данных.

## Пример обновления кластера из четырёх узлов без простоя {: #cluster_upgrade_zero_downtime_strategy .pageBreakBefore }

Рассмотрим пример обновления кластера {{ productName }} из четырёх узлов без прерывания работы пользователей и интеграций.

### Этап 1. Снятие трафика с обновляемого узла {: #cluster_upgrade_step1 }

Перенаправим трафик с узла `PLATFORM-node0` на другие узлы.

**Цель**: вывести трафик с узла, который будет обновляться.

1. Удостоверьтесь, что балансировщик верно настроен и при отключении узла трафик будет распределен на остальные узлы.
2. Уберите узел `PLATFORM-node0` из списка узлов для балансировки нагрузки.
3. Проверьте корректность ребалансировки нагрузки посредством инструментов мониторинга:

    - Убедитесь, что все запросы обрабатывают оставшиеся узлы.
    - Проверьте, что `PLATFORM-node0` не получает новый трафик.
    - Проконтролируйте производительность остальных узлов под увеличенной нагрузкой.

### Этап 2. Обновление одного узла {: #cluster_upgrade_step2 }

Обновим ПО на узле `PLATFORM-node0`.

**Цель**: обновить выведенный из эксплуатации узел без влияния на работу системы.

1. Остановите на узле `PLATFORM-node0` сервисы, затрагиваемые обновлением.
2. Выполните обновление ПО.
3. Настройте конфигурацию обновлённого ПО.
4. Запустите сервисы после обновления.
5. Проверьте работоспособность после обновления посредством инструментов мониторинга:

    - Убедитесь, что эндпоинт `api/health` на `PLATFORM-node0` выдаёт статус `200`.
    - Проверьте подключение к кластеру {{ apacheIgniteVariants }}.
    - Проконтролируйте синхронизацию данных с другими узлами.
    - Проанализируйте журналы на предмет наличия ошибок.

4. Балансировщик автоматически включит обновлённый узел в кластер, когда обнаружит статус `200` на эндпоинте `api/health` на `PLATFORM-node0`.

### Этап 3. Обновление остальных узлов {: #cluster_upgrade_step3 }

Аналогично обновлению `PLATFORM-node0` обновим ПО на узлах `PLATFORM-node1`, `PLATFORM-node2` и `PLATFORM-node3`.

**Цель**: обновить оставшиеся узлы кластера без влияния на работу системы.

1. Выведите обновляемый узел из состава кластера.
2. Выполните обновление ПО.
3. Настройте конфигурацию обновлённого ПО.
4. Запустите сервисы после обновления.
5. Проверьте работоспособность после обновления посредством инструментов мониторинга.
6. Введите обновлённый узел в состав кластера.

## Мониторинг и контроль кластера {: #cluster_upgrade_monitoring_control .pageBreakBefore }

В процессе и после обновления узлов кластера контролируйте состояние его компонентов:

- **Эндпоинт  `api/health`**
  - Контролируйте состояние узлов **{{ productName }}**:
    - Статус `200 OK` — узел работает корректно.
    - Время отклика не должно превышать 5 секунд.
    - Проверяйте регулярно, например каждые 30 секунд.
- **{{ apacheIgniteVariants }}**
    - Проверяйте топологию кластера.
    - Отслеживайте состояние репликации данных.
    - Контролируйте производительность операций чтения и записи.
- **{{ openSearchVariatns }}**
    - Контролируйте состояние с помощью эндпоинта `/_cluster/health`.
    - Проверяйте состояние индексов и их репликации.
    - Отслеживайте производительность обработки поисковых запросов.
- **{{ apacheKafkaVariants }}**
    - Контролируйте состояние топиков и партиций.
    - Отслеживайте задержки обработки сообщений.
    - Проверяйте размер очередей сообщений.

### Оповещения {: #cluster_upgrade_monitoring_alerts }

Настройте оповещения о следующих критических событиях:

- Отказ узла приложения — статус `api/health` отличается от `200`.
- Превышение пороговых значений производительности.
- Ошибки {{ apacheIgniteVariants }}, {{ apacheKafkaVariants }} или {{ openSearchVariants }}.
- Проблемы с балансировкой нагрузки.
- Критические ошибки в системных журналах.

### Инструменты мониторинга {: #cluster_upgrade_alerting_systems }

Используйте следующие инструменты для контроля состояния и производительности кластера:

- **Prometheus + Grafana**: мониторинг показателей и визуализация данных.
- **Loki**: агрегация и анализ журналов.
- **Zabbix**: комплексный мониторинг инфраструктуры.

## Практики, которых следует избегать {: #cluster_upgrade_anti_patterns .pageBreakBefore }

Для обеспечения оптимальной производительности, минимизации рисков простоев и повышения надёжности, доступности и отказоустойчивости **{{ productName }}** соблюдайте следующие рекомендации:

- **Не обновляйте несколько узлов одновременно**: одновременное обновление нескольких узлов кластера может привести к полной неработоспособности системы.
- **Не игнорируйте проверки состояния**: отключение или неправильная настройка проверки эндпоинта `api/health` может привести к нарушению работы балансировщика нагрузки.
- **Не пропускайте тестирование восстановления**: невыполнение регулярного тестирования процедур восстановления может привести к неготовности к авариям после обновления.
- **Не игнорируйте мониторинг и оповещения**: отсутствие постоянного мониторинга состояния системы может привести к пропуску критических инцидентов и увеличению времени простоя.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- [Установка, запуск, инициализация и остановка ПО][deploy_guide_linux]
- [Системные требования {{ productName }}][system_requirements]
- [Резервное копирование. Настройка и запуск, просмотр журнала сеансов][backup_configure]
<!-- - [Восстановление кластера {{ productName }}][cluster_recovery] -->

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

---
title: 'Журнал изменений не записывается. Диагностика и исправление'
kbTitle: 'Журнал изменений не записывается. Диагностика и исправление'
kbId: 5139
tags:
  - Elasticsearch
  - OpenSearch
  - индексы
  - журнал изменений
  - журнал транзакций
  - журналирование
  - логирование
  - реиндексация
  - решение проблем
  - устранение неполадок
hide:
  - tags
---

<!-- Статья во внутренней БЗ. Не включать в PDF -->

# Журнал изменений не записывается. Диагностика и исправление {: #troubleshooting_history_not_written }

## Введение {: #troubleshooting_history_not_written_intro }

**{{ productName }}** использует службу {{ openSearchVariants }} для журналирования транзакций (истории изменений записей и экземпляров процессов).

Если история транзакций не записывается, например не отображается в **журнале изменений**, причины могут быть связаны с доступностью и состоянием {{ openSearchVariants }}, настройками подключения, задержками индексации или некорректным маппингом индексов.

Здесь представлены инструкции по восстановлению индексов {{ openSearchVariants }} путём реиндексации, если нарушена целостность маппинга индексов.

Также даны рекомендации по выявлению других возможных причин нарушения записи истории транзакций в {{ openSearchVariants }}.

См. также прикреплённый архив с файлами: <https://kb.comindware.ru/file.php?id=211>

!!! warning "Внимание!"

    Перед любыми изменениями состояния кластера и особенно перед реиндексацией создайте snapshot/резервную копию данных {{ openSearchVariants }}.

!!! question "Маппинг индексов"

    - **Маппинг** определяет структуру данных в индексе {{ openSearchVariants }}, типы полей и правила индексации.
    - Некорректно определённый маппинг ограничивает функциональность {{ openSearchVariants }}. Например, конфликты типов (`text` вместо `keyword`, неверный `date` и т.&nbsp;п.) приводят к отказам записи и «пропаже» истории.

## Где увидеть историю в {{ productName }} {: #troubleshooting_history_not_written_view_history }

- Откройте _«[Журналы событий][logs]»_ и выберите нужный журнал.
- Для процесса: на _«[Диаграмме экземпляра процесса][process_diagram_view_instance]»_ откройте вкладку _«Журнал изменений»_ и перейдите к цепочке событий.

## Частые причины и решения {: #troubleshooting_history_not_written_common_causes }

- **Нет свободного места на диске**: освободите место/расширьте хранилище, затем повторите запись.

- **Превышен лимит шардов**: увеличьте `cluster.max_shards_per_node` (см. рекомендации по развертыванию) и/или уменьшите число индексов/шардов.

- **Подключение из {{ productName }} настроено неверно**: исправьте URL/учётные данные/префикс и нажмите «Проверить соединение». См. _«[{{ openSearchVariants }}. Настройка подключения][elasticsearch_connection]»_ и _«[Подключения][connections]»_.

- **TLS/сертификаты**: при необходимости настройте сертификаты. См. _«[Настройка SSL-сертификатов для Elasticsearch][elasticsearch_ssl_certificate_configure]»_.

- **Маппинг не совпадает/повреждён**: выполните реиндексацию согласно инструкции выше.

## Быстрый чек-лист диагностики {: #troubleshooting_history_not_written_diagnostic_checklist }

1. Комплексная проверка {{ openSearchVariants }} и {{ productName }}

    - Журналы {{ openSearchVariants }} на ошибки:
        - Типовые признаки: недостаточно места на диске, превышен лимит шардов, ошибки 4xx/5xx при записи.
        - Где искать журналы и конфигурацию: см. _«[Пути и содержимое директорий экземпляра ПО][paths]»_.

    - Состояние кластера {{ openSearchVariants }}:
        - Примеры запросов здоровья кластера (выполните на хосте с доступом к {{ openSearchVariants }}):

        ``` bash
        curl -s http://<host>:9200 | jq .
        curl -s http://<host>:9200/_cluster/health?pretty
        ```

        - Оцените статус (green/yellow/red), pending tasks, доступность узлов.
        - Дополнительно, проверка здоровья/узлов/очереди задач:

        ``` bash
        # Хорошо, если "status" : "yellow" или "green"
        curl -s http://<host>:9200/_cluster/health?pretty
        # Хорошо, если отображается ожидаемое количество узлов
        curl -s http://<host>:9200/_cat/nodes?v
        
        curl -s http://<host>:9200/_cat/pending_tasks?v
        ```

        - Пояснение по `/_cat/pending_tasks`:
          - **Хорошее состояние**: пустой вывод либо 0–2 задачи в очереди; `time_in_queue` не более 1–2 секунд; `priority` — `low` или `normal`.
          - **Допустимо временно** (при запуске/ребалансировке): несколько задач `shard-started`, `cluster_reroute` и т. п., ожидание до пары минут, при повторном запросе количество задач убывает.
          - **Плохое состояние**: десятки/сотни задач, очередь растёт, `time_in_queue` — десятки секунд/минут, приоритет `high/urgent`, типы `reindex`/`put-mapping`/`update-settings` «висят» долго. Это указывает на перегрузку master-узла, проблемы аллокации шардов, нехватку диска/нод или ошибки конфигурации/плагинов.
          - **Действия**: проверить `/_cluster/health`, `/_cat/allocation?v`, журналы master-узла; убедиться в наличии свободного места и доступных нод; что аллокация не отключена; устранить ошибки и дождаться опустошения очереди.

    - Корректность параметров подключения в {{ productName }}:
        - Откройте раздел _«[Подключения][connections]»_ и дважды нажмите подключение _{{ openSearchVariants }}_.
        - Проверьте URL, учётные данные (если используются), префикс индексов.
        - Нажмите «Проверить соединение» — должно отобразиться «Соединение установлено». См. _«[{{ openSearchVariants }}. Настройка подключения][elasticsearch_connection]»_.

    - Учесть задержку появления событий:
        - Внесите тестовое изменение в запись/процесс и подождите 5–10 минут: события истории появляются не мгновенно.
        - Для просмотра используйте _«[Журналы событий][logs]»_ или _«[Цепочку событий][process_diagram_view_instance]»_.

    - Индексы и аллокация:
        - Через API:

        ``` bash
        curl -s http://<host>:9200/_cat/indices?v
        curl -s http://<host>:9200/_cat/allocation?v
        ```
        - Через браузер:
          - Откройте в браузере: `http://xxx.xxx.xxx.xxx:9200/_cat/indices`
          - Найдите индекс вида `cmw_<instanceName>_suffix`.
          - Перейдите по адресу: `http://xxx.xxx.xxx.xxx:9200/cmw_<instanceName>_suffix`.
          - Включите Autoformat (Chrome: Pretty print/Автоформат) и убедитесь, что индекс отдаётся и выглядит корректно.

    - Маппинг и количество документов для конкретного индекса:
        - Через API:

        ``` bash
        curl -s http://<host>:9200/cmw_<instanceName>_suffix/_mapping | jq .
        curl -s http://<host>:9200/cmw_<instanceName>_suffix/_count | jq .
        ```
        - Через браузер (при необходимости дополнительно проверьте):
          - `http://<host>:9200/cmw_<instanceName>_suffix/_mapping` — маппинг индекса.
          - `http://<host>:9200/cmw_<instanceName>_suffix/_count` — количество документов.

5. Проверить индексы и их содержимое через браузер

    - Откройте в браузере: `http://xxx.xxx.xxx.xxx:9200/_cat/indices`
    - Найдите индекс вида `cmw_<instanceName>_suffix`.
    - Перейдите по адресу: `http://xxx.xxx.xxx.xxx:9200/cmw_<instanceName>_suffix`.
    - Включите Autoformat (Chrome: Pretty print/Автоформат) и убедитесь, что индекс отдаётся и выглядит корректно.

    При необходимости дополнительно проверьте:

    - `http://<host>:9200/cmw_<instanceName>_suffix/_mapping` — маппинг индекса.
    - `http://<host>:9200/cmw_<instanceName>_suffix/_count` — количество документов.

6. Если маппинг некорректен/повреждён — выполнить реиндексацию

    - Перед реиндексацией обязательно создайте snapshot.
    - Перед реиндексацией важно сверить маппинг с эталоном: выполните `GET /<index>/_mapping` и сравните с `comindware_default_mapping.json` (**[прилагается](https://kb.comindware.ru/file.php?id=211)**).
    - Убедитесь, что у вас есть валидный JSON с маппингом (например, `comindware_default_mapping.json`).
    - Возьмите префикс индексов из подключения {{ productName }} (UI) — далее он будет использован скриптом.

## Реиндексация индексов по префиксу (локальный {{ openSearchVariants }}) {: #troubleshooting_history_not_written_reindexing }

Ниже кратко описан скрипт и порядок применения.

См.прикреплённый архив с файлами: <https://kb.comindware.ru/file.php?id=211>

### Назначение скрипта {: #troubleshooting_history_not_written_reindexing_script_purpose }

- Найти все индексы по шаблону `cmw_<prefix>*`.

!!! warning "Важно!"

    Нас интересуют индексы с суффиксами `_sln.xx....`

- Для каждого индекса: создать `<index>_v2` с требуемым маппингом, выполнить reindex туда, пересоздать оригинальный индекс с маппингом, выполнить reindex обратно, сверить количество документов, удалить `_v2` при совпадении.

Дополнительно важно учитывать текущее поведение скрипта:

- Если указать префикс без `*`, скрипт автоматически добавит `*` при поиске индексов.
- Если `<index>_v2` существует, он будет удалён перед созданием нового `_v2`.
- Если `<index>` является алиасом, алиас временно удаляется со всех индексов, затем выполняется пересоздание индекса.
- Reindex выполняется синхронно (`wait_for_completion=true`).

### Ключи скрипта {: #troubleshooting_history_not_written_reindexing_script_keys }

- `-p | --prefix` — префикс {{ productName }} (например, `support` → ищет индексы `cmw_support*`).
- `-ip | --journal_srv_ip` — `host:port` {{ openSearchVariants }} (например, `10.0.0.5:9200`).
- `-m | --map-file` — путь к JSON с маппингом (поддерживается как голый `mappings`, так и полный index body).

!!! note "Зависимость jq"

    Скрипт проверяет наличие утилиты `jq` и при её отсутствии пытается установить её автоматически (через `apt-get` или `dnf`). Для установки потребуется `sudo`.
    
    Перед запуском скрипта перейдите в режим суперпользователя:
    
    --8<-- "linux_sudo.md"

!!! warning "Перед выполнением скрипта реиндексации"

    Перед запуском:
    
    - Остановите {{ productName }}.
    - Сделайте актуальную резервную копию.
    - Для остановки {{ productName }} выберите сервисное окно, когда нагрузка минимальна.

### Примеры запуска {: #troubleshooting_history_not_written_reindexing_examples }

- Локальный узел:

``` bash
bash reindex_local_prefix.sh -p <platformPrefix> -ip localhost:9200 -m comindware_default_mapping.json
```

- Удалённый сервер:

``` bash
bash reindex_local_prefix.sh -p <platformPrefix> -ip 10.0.0.5:9200 -m comindware_default_mapping.json
```

После выполнения реиндексации проверьте результат:

- Убедитесь, что схема полей совпадает с эталоном (`comindware_default_mapping.json`), нет лишних/неверных типов.

    ``` bash
    curl -s http://<host>:9200/<index>/_mapping | jq .
    ```

- Проверьте ожидаемое количество документов (не 0 без причины; сопоставимо с до-реиндексным значением).

    ``` bash
    curl -s http://<host>:9200/<index>/_count | jq .
    ```

### Важные примечания {: #troubleshooting_history_not_written_reindexing_notes }

- Скрипту нужен `jq`. При наличии `apt`/`dnf` он установится автоматически.
- Если кластер использует аутентификацию/HTTPS, потребуется доработать вызовы `curl` (добавить `-u user:pass`, `--cacert`/`-k` и т. п.).
- Перед запуском сравните актуальный маппинг индексов с эталонным `comindware_default_mapping.json`. Если маппинги совпадают, реиндексация может не потребоваться.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- [{{ openSearchVariants }}. Настройка подключения][elasticsearch_connection]
- [Пути и содержимое директорий экземпляра ПО][paths]
- [Установочные скрипты. Назначение и ключи][script_keys]
- [Elasticsearch. Установка в базовой конфигурации для Windows][elasticsearch_deploy_windows]
- [Развёртывание Elasticsearch без сертификатов подлинности][elasticsearch_cluster_deploy_no_certificates]
- [Elasticsearch. Установка в базовой конфигурации][elasticsearch_deploy_Linux]
- [Настройка SSL-сертификатов для Elasticsearch][elasticsearch_ssl_certificate_configure]
- [Примеры событий в файловых журналах][log_files_event_examples]
- [Журналы событий. Типы, просмотр, цепочки событий][logs]
- [Использование диаграммы экземпляра процесса][process_diagram_view_instance]
- [Ошибки в процессе. Отслеживание][process_error_monitor]
- [Обновление версии экземпляра ПО с его остановкой][upgrade_version_linux]
- [Обновление версии экземпляра ПО без его остановки][upgrade_version_linux_no_stop]

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}


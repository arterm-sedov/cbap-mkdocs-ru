<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="comindware" dir="ltr"> <div class="md-container" data-md-component="container"> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <nav aria-label="Содержание" class="md-nav md-nav--secondary"> <div class="mce-toc"> <h2 class="toc-heading"> Содержание </h2> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#решение-возможных-проблем"> <span class="md-ellipsis"> Решение возможных проблем </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#связанные-статьи"> <span class="md-ellipsis"> Связанные статьи </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#связанные-статьи_1"> <span class="md-ellipsis"> Связанные статьи </span> </a> </li> </ul> </div> </nav> <div class="md-content" data-md-component="content"> <article class="md-content__inner md-typeset">  <p>В данной статье представлены инструкции по дефрагментации хранилища данных Apache Ignite для ПО Comindware Business Application (далее «ПО») под управлением операционных систем семейства Linux. Дефрагментация хранилища Apache Ignite позволяет повысить производительность работы ПО и сократить объем данных хранилища на диске.</p> <p>Внимание!</p> <p>Во время дефрагментации хранилища Apache Ignite экземпляр ПО будет недоступен. Поэтому дефрагментацию следует выполнять в нерабочее время.</p> <ol class="colored_numbers_list"> <li>Создайте резервную копию базы данных экземпляра ПО.</li> <li>Скачайте бинарный дистрибутив Apache Ignite, например <a class="mkdocs_imported_link" href="https://downloads.apache.org/ignite/2.16.0/apache-ignite-2.16.0-bin.zip">apache-ignite-2.16.0-bin.zip</a> или более новую версию.</li> <li>Перейдите в режим суперпользователя:</li> </ol> <div class="highlight"><code><pre><span></span><code>su -</code><br/>
</pre></code></div> <p>или</p> <div class="highlight"><code><pre><span></span><code>sudo -i</code><br/>
</pre></code></div> <ol class="colored_numbers_list" start="4"> <li>Распакуйте дистрибутив Apache Ignite в домашнюю папку (здесь и далее <code>username</code> — имя текущего пользователя):</li> </ol> <div class="highlight"><code><pre><span></span><code>unzip apache-ignite-2.16.0-bin.zip -d /home/username/ignite        </code><br/>
</pre></code></div> <ol class="colored_numbers_list" start="5"> <li>Задайте переменную среды <code>IGNITE_HOME</code>:</li> </ol> <div class="highlight"><code><pre><span></span><code>export IGNITE_HOME=/home/username/ignite</code><br/>
</pre></code></div> <ol class="colored_numbers_list" start="6"> <li>Скопируйте в папку <code>/home/username/ignite</code> файл <code>Ignite.config</code> из папки <code>/var/www/instancename</code> (где <code>instancename</code> — имя экземпляра ПО):</li> </ol> <div class="highlight"><code><pre><span></span><code>cp /var/www/instancename/Ignite.config /home/username/ignite/</code><br/>
</pre></code></div> <ol class="colored_numbers_list" start="7"> <li>Перейдите в папку <code>bin</code> Apache Ignite:</li> </ol> <div class="highlight"><code><pre><span></span><code>cd /home/username/ignite/bin </code><br/>
</pre></code></div> <ol class="colored_numbers_list" start="8"> <li>В файле <code>control.sh</code> измените директиву <code>DEFAULT_CONFIG</code>:</li> </ol> <div class="highlight"><code><pre><span></span><code>DEFAULT_CONFIG=config/Ignite.config</code><br/>
</pre></code></div> <ol class="colored_numbers_list" start="9"> <li>Получите список узлов, зарегистрированных в базовой топологии:</li> </ol> <div class="highlight"><code><pre><span></span><code>sh control.sh --baseline</code><br/>
</pre></code></div> <ol class="colored_numbers_list" start="10"> <li>Назначьте дефрагментацию данных Apache Ignite при перезапуске экземпляра ПО, указав вместо <code>&lt;id&gt;</code> идентификаторы узлов, полученные на шаге 9:</li> </ol> <div class="highlight"><code><pre><span></span><code>sh control.sh --defragmentation schedule --nodes &lt;id&gt;</code><br/>
</pre></code></div> <ol class="colored_numbers_list" start="11"> <li>Деактивируйте кластер Apache Ignite:</li> </ol> <div class="highlight"><code><pre><span></span><code>sh control.sh --set-state INACTIVE --force </code><br/>
</pre></code></div> <ol class="colored_numbers_list" start="12"> <li>Остановите и запустите экземпляр ПО:</li> </ol> <div class="highlight"><code><pre><span></span><code>systemctl stop comindwareinstancename  </code><br/>
<code>systemctl start comindwareinstancename  </code><br/>
</pre></code></div> <p>Здесь <code>instancename</code> — имя экземпляра ПО.</p> <ol class="colored_numbers_list" start="13"> <li>Дождитесь завершения дефрагментации данных. В процессе дефрагментации Apache Ignite будет вносить сведения в файл журнала вида <code>/var/lib/comindware/instancename/Database/log/ignite-xxxxxxxx.0.log</code>. Признаком окончания дефрагментации служит появление в журнале Apache Ignite события: <code>Defragmentation process complete</code>.</li> <li>Перезапустите экземпляр ПО, чтобы его снова можно было использовать.</li> </ol> <div class="highlight"><code><pre><span></span><code>systemctl restart comindwareinstancename</code><br/>
</pre></code></div> <h2 id="решение-возможных-проблем">Решение возможных проблем</h2> <p>Если во время дефрагментации возникнет ошибка «Слишком много открытых файлов» (Too many open files), выполните указанные ниже шаги (пример для Astra Linux).</p> <ol class="colored_numbers_list"> <li>Добавьте в файл <code>/etc/security/limits.conf</code> строки:</li> </ol> <p><div class="highlight"><code><pre><span></span><code>* soft nproc 65535   </code><br/>
<code>* hard nproc 65535   </code><br/>
<code>* soft nofile 65535   </code><br/>
<code>* hard nofile 65535   </code><br/>
<code>www-data soft nproc 200000   </code><br/>
<code>www-data hard nproc 200000   </code><br/>
<code>www-data soft nofile 200000   </code><br/>
<code>www-data hard nofile 200000</code><br/>
</pre></code></div> 2. Добавьте в файл <code>/etc/pam.d/common-session</code> строку:</p> <p><div class="highlight"><code><pre><span></span><code>session required pam_limits.so</code><br/>
</pre></code></div> 3. Добавьте в файл <code>/etc/sysctl.conf</code> строку:</p> <p><div class="highlight"><code><pre><span></span><code>fs.file-max = 2097152</code><br/>
</pre></code></div> 4. Раскомментируйте строку и задайте значение в файле <code>/etc/systemd/user.conf</code>:</p> <p><div class="highlight"><code><pre><span></span><code>DefaultLimitNOFILE=65536</code><br/>
</pre></code></div> 5. Раскомментируйте строку и задайте значение в файле <code>/etc/systemd/system.conf</code>:</p> <p><div class="highlight"><code><pre><span></span><code>DefaultLimitNOFILE=65536</code><br/>
</pre></code></div> 6. Откройте для редактирования конфигурацию сервиса экземпляра ПО: </p> <p><div class="highlight"><code><pre><span></span><code>systemctl edit comindwareinstancename.service</code><br/>
</pre></code></div> 7. Добавьте в него строки:</p> <h2 id="связанные-статьи">Связанные статьи</h2> <p>[Service] <br/> LimitNOFILE=65536 <br/> LimitNOFILESoft=65536 ``` 8. Перезагрузите машину и экземпляр ПО.</p> <h2 id="связанные-статьи_1">Связанные статьи</h2> <p><strong><a class="mkdocs_imported_link" href="https://kb.comindware.ru/category.php?id=496">Руководство системного администратора. Резервное копирование и восстановление в ОС Linux</a></strong> <br/> <strong><a class="mkdocs_imported_link" href="https://kb.comindware.ru/category.php?id=436">Руководство пользователя. Резервное копирование</a></strong> <br/> <strong><a class="mkdocs_imported_link" href="https://ignite.apache.org/docs/2.11.1/persistence/native-persistence-defragmentation">Дефрагментация персистентного хранилища</a></strong> (руководство Apache Ignite, английский язык)) <br/> <strong><a class="mkdocs_imported_link" href="https://ignite.apache.org/docs/2.11.1/tools/control-script#activation-deactivation-and-topology-management">Активация, деактивация и управление топологией</a></strong> (руководство Apache Ignite, английский язык)</p> </article> </div> </div> <a class="md-top md-icon mkdocs_imported_link" data-md-component="top" href="#"> <i class="fa-light fa-arrow-up">&zwnj;<!--icon--></i> К началу </a> </main> </div> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": true, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
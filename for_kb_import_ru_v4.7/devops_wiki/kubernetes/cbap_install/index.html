<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="comindware" dir="ltr"> <div class="md-container" data-md-component="container"> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <nav aria-label="Содержание" class="md-nav md-nav--secondary"> <div class="mce-toc"> <h2 class="toc-heading"> Содержание </h2> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#необходимые-условия"> <span class="md-ellipsis"> Необходимые условия </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#комплект-поставки"> <span class="md-ellipsis"> Комплект поставки </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#развертывание-comindware-business-application-platform-с-помощью-k8s"> <span class="md-ellipsis"> Развертывание Comindware Business Application Platform с помощью K8s </span> </a> <nav aria-label="Развертывание Comindware Business Application Platform с помощью K8s" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#добавление-образов-компонент-платформы-в-репозиторий-образов"> <span class="md-ellipsis"> Добавление образов компонент Платформы в репозиторий образов </span> </a> <nav aria-label="Добавление образов компонент Платформы в репозиторий образов" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#пример-добавления-образов-в-docker-container-registry"> <span class="md-ellipsis"> Пример добавления образов в Docker Container Registry </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#подготовка-к-развертыванию-платформы"> <span class="md-ellipsis"> Подготовка к развертыванию Платформы </span> </a> <nav aria-label="Подготовка к развертыванию Платформы" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#создать-пространство-имен-для-компонент-платформы"> <span class="md-ellipsis"> Создать пространство имен для компонент Платформы </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#развернуть-сервисы-для-компонент-платформы"> <span class="md-ellipsis"> Развернуть сервисы для компонент Платформы </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#настроить-volume-provisioning"> <span class="md-ellipsis"> Настроить volume provisioning </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#настроить-пути-к-образам-компонент-платформы"> <span class="md-ellipsis"> Настроить пути к образам компонент Платформы </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#развертывание-кластера-брокера-сообщений"> <span class="md-ellipsis"> Развертывание кластера брокера сообщений </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#развертывание-сервисов-платформы"> <span class="md-ellipsis"> Развертывание сервисов Платформы </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#развертывание-базы-данных-платформы"> <span class="md-ellipsis"> Развертывание базы данных Платформы </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#развертывание-и-конфигурирование-бекенда-платформы"> <span class="md-ellipsis"> Развертывание и конфигурирование бекенда Платформы </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#развертывание-балансировщика-платформы"> <span class="md-ellipsis"> Развертывание балансировщика Платформы </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link mkdocs_imported_link" href="#получение-доступа-к-платформу-методом-проброса-портов"> <span class="md-ellipsis"> Получение доступа к Платформу методом проброса портов </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </div> </nav> <div class="md-content" data-md-component="content"> <article class="md-content__inner md-typeset">  <h2 id="необходимые-условия">Необходимые условия</h2> <ul> <li>Кластер K8s</li> <li>Репозиторий для хранения образов контейнеров или container-registry.</li> </ul> <h2 id="комплект-поставки">Комплект поставки</h2> <ul> <li>архив образов компонент Платформы cbap-4.6.1864_images.tgz</li> <li>архив файлов манифестов для K8s cbap-k8s-manifests.tgz</li> </ul> <h2 id="развертывание-comindware-business-application-platform-с-помощью-k8s">Развертывание Comindware Business Application Platform с помощью K8s</h2> <h3 id="добавление-образов-компонент-платформы-в-репозиторий-образов">Добавление образов компонент Платформы в репозиторий образов</h3> <p>Распаковать <code>cbap-4.6.1864-images.tgz</code> и добавить хранящиеся в нем образы в репозиторий образов.</p> <h4 id="пример-добавления-образов-в-docker-container-registry">Пример добавления образов в Docker Container Registry</h4> <p>Используя <code>docker container registry</code>, образы можно добавить с помощью следующих команд:</p> <div class="highlight"><code><pre><span></span><code><span class="c1"># Add container image to container registry:</span></code><br/>
<code>docker<span class="w"> </span>load<span class="w"> </span>&lt;<span class="w"> </span>IMAGE-NAME.tar.gz</code><br/>
<code><span class="c1"># List images in registry:</span></code><br/>
<code>docker<span class="w"> </span>images</code><br/>
</pre></code></div> <p>Образy, находящемуся в <code>container registry</code>, добавить тег и загрузить в Container Registry.</p> <div class="highlight"><code><pre><span></span><code>docker<span class="w"> </span>tag<span class="w"> </span>IMAGE-NAME<span class="o">[</span>:TAG<span class="o">]</span><span class="w"> </span><span class="se">\</span></code><br/>
<code><span class="w">    </span>REGISTRY-NAME/REPO-NAME<span class="o">[</span>:TAG<span class="o">]</span></code><br/>
<code>docker<span class="w"> </span>push<span class="w"> </span>REGISTRY-NAME/REPO-NAME<span class="o">[</span>:TAG<span class="o">]</span></code><br/>
</pre></code></div> <h3 id="подготовка-к-развертыванию-платформы">Подготовка к развертыванию Платформы</h3> <p>Распакуйте архив <code>cbap-k8s.tgz</code> на машине, которая подключена к кластеру K8s.</p> <p>Архив содержит yaml-конфигурации компонент продукта к кластеру K8s. yaml-конфиги в директориях <code>deployment</code>, <code>service</code>, <code>statefulset</code>.</p> <div class="highlight"><code><pre><span></span><code>cbap-k8s</code><br/>
<code><span class="p">|</span>--<span class="w"> </span>deployment</code><br/>
<code><span class="p">|</span><span class="w">   </span><span class="p">|</span>--<span class="w"> </span>adapterhost-deployment.yaml</code><br/>
<code><span class="p">|</span><span class="w">   </span><span class="p">|</span>--<span class="w"> </span>apigateway-deployment.yaml</code><br/>
<code><span class="p">|</span><span class="w">   </span><span class="p">|</span>--<span class="w"> </span>init-kafka-deployment.yaml</code><br/>
<code><span class="p">|</span><span class="w">   </span><span class="p">|</span>--<span class="w"> </span>platform-deployment.yaml</code><br/>
<code><span class="p">|</span><span class="w">   </span><span class="sb">`</span>--<span class="w"> </span>web-app-deployment.yaml</code><br/>
<code><span class="p">|</span>--<span class="w"> </span>service</code><br/>
<code><span class="p">|</span><span class="w">   </span><span class="p">|</span>--<span class="w"> </span>adapterhost-service.yaml</code><br/>
<code><span class="p">|</span><span class="w">   </span><span class="p">|</span>--<span class="w"> </span>apigateway-service.yaml</code><br/>
<code><span class="p">|</span><span class="w">   </span><span class="p">|</span>--<span class="w"> </span>elasticsearch-service.yaml</code><br/>
<code><span class="p">|</span><span class="w">   </span><span class="p">|</span>--<span class="w"> </span>ignite-service.yaml</code><br/>
<code><span class="p">|</span><span class="w">   </span><span class="p">|</span>--<span class="w"> </span>kafka-service.yaml</code><br/>
<code><span class="p">|</span><span class="w">   </span><span class="p">|</span>--<span class="w"> </span>platform-service.yaml</code><br/>
<code><span class="p">|</span><span class="w">   </span><span class="sb">`</span>--<span class="w"> </span>web-app-loadbalancer.yaml</code><br/>
<code><span class="sb">`</span>--<span class="w"> </span>statefulset</code><br/>
<code><span class="w">    </span><span class="p">|</span>--<span class="w"> </span>elasticsearch-statefulset.yaml</code><br/>
<code><span class="w">    </span><span class="p">|</span>--<span class="w"> </span>ignite01-statefulset.yaml</code><br/>
<code><span class="w">    </span><span class="p">|</span>--<span class="w"> </span>ignite02-statefulset.yaml</code><br/>
<code><span class="w">    </span><span class="p">|</span>--<span class="w"> </span>ignite03-statefulset.yaml</code><br/>
<code><span class="w">    </span><span class="p">|</span>--<span class="w"> </span>kafka01-statefulset.yaml</code><br/>
<code><span class="w">    </span><span class="p">|</span>--<span class="w"> </span>kafka02-statefulset.yaml</code><br/>
<code><span class="w">    </span><span class="sb">`</span>--<span class="w"> </span>kafka03-statefulset.yaml</code><br/>
</pre></code></div> <h4 id="создать-пространство-имен-для-компонент-платформы">Создать пространство имен для компонент Платформы</h4> <p>Рекомендуется развертывать компоненты Платформы в выделенном пространстве имен. Манифесты k8s предполагают, что в кластере K8s существует пространство имен <code>cbap</code>. Создать пространство имен <code>cbap</code> можно с помощью команды:</p> <div class="highlight"><code><pre><span></span><code>kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>cbap</code><br/>
</pre></code></div> <div class="notice notice-warning"> <p class="admonition-title">Внимание</p> <p>Если Платформа будет развернута в пространстве имен отличном от <code>cbap</code>, необходимо во всех манифестах заменить значение <code>cbap</code> на имя пространства имен.</p> <p>Например, если Платформа будет развернута в пространстве имен <code>MY-NS</code>, тогда необходимо:</p> <p>• во всех манифестах необходимо заменить значение поля <code>namespace</code> с <code>cbap</code> на <code>MY-NS</code> • в манифестах <code>platfrom-deployment</code>, <code>ignite01-statefulset</code>, <code>ignite02-statefulset</code>, <code>ignite03-statefulset</code> отредактировать значение поля <code>IGNITE_CLUSTER_IP_FINDER</code>, заменив <code>cbap</code> на <code>MY-NS</code> • в манифестах <code>adapterhost-deployment</code>, <code>apigateway-deployment</code>, <code>kafka01-statefulset</code>, <code>kafka02-statefulset</code>, <code>kafka03-statefulset</code> отредактировать значение поля <code>KAFKA_BOOTSTRAP</code>, заменив <code>cbap</code> на <code>MY-NS</code></p> </div> <h4 id="развернуть-сервисы-для-компонент-платформы">Развернуть сервисы для компонент Платформы</h4> <p>Развернуть сервисы <code>adapterhost-service</code>, <code>apigateway-service</code>, <code>elasticsearch-service</code>, <code>ignite-service</code>, <code>kafka-service</code>, <code>platform-service</code>, <code>web-app-loadbalancer</code>.</p> <div class="highlight"><code><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>adapterhost-service.yaml</code><br/>
<code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>apigateway-service.yaml</code><br/>
<code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>elasticsearch-service.yaml</code><br/>
<code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>ignite-service.yaml</code><br/>
<code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>kafka-service.yaml</code><br/>
<code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>platform-service.yaml</code><br/>
<code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>web-app-loadbalancer.yaml</code><br/>
</pre></code></div> <h4 id="настроить-volume-provisioning">Настроить volume provisioning</h4> <p>По-умолчанию в манифестах используется StorageClass <code>yc-network-ssd</code>. Если есть необходимость использовать иное решение, нужно отредактировать поле <code>spec.storageClassName</code> для всех манифестов типа StatefulSet.</p> <h4 id="настроить-пути-к-образам-компонент-платформы">Настроить пути к образам компонент Платформы</h4> <p>Для всех манифестов типа Deployment и StatefulSet отредактировать значение поля <code>spec.containers.image</code>, указав адрес Container Registry и тег образа.</p> <h4 id="развертывание-кластера-брокера-сообщений">Развертывание кластера брокера сообщений</h4> <p>Развернуть StatefulSet <code>kafka01-statefulset.yaml</code> с помощью команды</p> <div class="highlight"><code><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>kafka01-statefulset.yaml</code><br/>
</pre></code></div> <p>Подождать пока под <code>kafka01-0</code> перейдет в статус “ContainerCreating” или “Running”.</p> <p>Развернуть StatefulSet <code>kafka02-statefulset.yaml</code> с помощью команды</p> <div class="highlight"><code><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>kafka02-statefulset.yaml</code><br/>
</pre></code></div> <p>Подождать пока под <code>kafka02-0</code> перейдет в статус “ContainerCreating” или “Running”.</p> <p>Развернуть StatefulSet <code>kafka03-statefulset.yaml</code> с помощью команды</p> <div class="highlight"><code><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>kafka01-statefulset.yaml</code><br/>
</pre></code></div> <p>Подождать пока под <code>kafka03-0</code> перейдет в статус “ContainerCreating” или “Running”.</p> <p>Развернуть Deployment <code>init-kafka-deployment.yaml</code> с помощью команды</p> <div class="highlight"><code><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>init-kafka-deployment.yaml</code><br/>
</pre></code></div> <p>Подождать пока под перейдет в статус “Completed” и удалить Deployment <code>init-kafka</code>.</p> <div class="highlight"><code><pre><span></span><code>kubectl<span class="w"> </span>delete<span class="w"> </span>deployment<span class="w"> </span>init-kafka</code><br/>
</pre></code></div> <p>Посмотреть логи любого из подов <code>kafka01-0</code>, <code>kafka02-0</code>, <code>kafka03-0</code> и убедиться, что топики с префиксом <code>kfk</code> были созданы.</p> <div class="highlight"><code><pre><span></span><code>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-n<span class="w"> </span>cbap</code><br/>
<code>kubectl<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>cbap<span class="w"> </span>kafka01-0-HASHCODE</code><br/>
</pre></code></div> <h4 id="развертывание-сервисов-платформы">Развертывание сервисов Платформы</h4> <p>Развернуть Deployment’ы <code>adapterhost-deployment.yaml</code> и <code>apigateway-deployment.yaml</code> .</p> <div class="highlight"><code><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>adapterhost-deployment.yaml</code><br/>
<code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>apigateway-deployment.yaml</code><br/>
</pre></code></div> <p>Убедитесь, что соответствующие сервисам поды перешли в статус “Running”.</p> <h4 id="развертывание-базы-данных-платформы">Развертывание базы данных Платформы</h4> <p>Развернуть StatefulSet’ы <code>ignite01-statefulset.yaml</code> <code>ignite02-statefulset.yaml</code> <code>ignite03-statefulset.yaml</code>.</p> <div class="highlight"><code><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>ignite01-statefulset.yaml</code><br/>
<code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>ignite02-statefulset.yaml</code><br/>
<code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>ignite03-statefulset.yaml</code><br/>
</pre></code></div> <p>Убедиться, что поды <code>ignite01-0</code>, <code>ignite02-0</code>, <code>ignite03-0</code> перешли в статус “Running”.</p> <p>Посмотреть логи любого из подов и убедиться, что кластер состоит из трех нод:</p> <div class="highlight"><code><pre><span></span><code>kubectl<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>cbap<span class="w"> </span>ignite01-0<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Topology</code><br/>
</pre></code></div> <p>Пример ответа:</p> <div class="highlight"><code><pre><span></span><code><span class="o">[</span><span class="m">09</span>:49:25<span class="o">]</span><span class="w"> </span>Topology<span class="w"> </span>snapshot<span class="w"> </span><span class="o">[</span><span class="nv">ver</span><span class="o">=</span><span class="m">3</span>,<span class="w"> </span><span class="nv">locNode</span><span class="o">=</span>a5ad8fca,<span class="w"> </span><span class="se">\</span></code><br/>
<code><span class="nv">servers</span><span class="o">=</span><span class="m">3</span>,<span class="w"> </span><span class="nv">clients</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">state</span><span class="o">=</span>INACTIVE,<span class="w"> </span><span class="nv">CPUs</span><span class="o">=</span><span class="m">12</span>,<span class="w"> </span><span class="se">\</span></code><br/>
<code><span class="nv">offheap</span><span class="o">=</span><span class="m">20</span>.0GB,<span class="w"> </span><span class="nv">heap</span><span class="o">=</span><span class="m">48</span>.0GB<span class="o">]</span></code><br/>
</pre></code></div> <h4 id="развертывание-и-конфигурирование-бекенда-платформы">Развертывание и конфигурирование бекенда Платформы</h4> <p>Если используется внешний сервис Elasticsearch, отредактировать поле <code>spec.template.spec.env.value</code> для переменной <code>ELASTICSEARCH_URI</code> введя URI внешнего сервиса Elasticsearch.</p> <p>Если необходимо развернуть Elasticsearch в контуре K8s, развернуть StatefulSet <code>elasticsearch-statefulset.yaml</code>.</p> <div class="highlight"><code><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>elasticsearch-statefulset.yaml</code><br/>
</pre></code></div> <p>Убедиться, что под <code>elasticsearch01</code> перешeл в статус “Running”.</p> <h4 id="развертывание-балансировщика-платформы">Развертывание балансировщика Платформы</h4> <p>Развернуть Deployment <code>web-app-loadbalancer.yaml</code>.</p> <div class="highlight"><code><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>web-app-loadbalancer.yaml</code><br/>
</pre></code></div> <p>Убедиться, что соответствующий компоненте под перешел в статус “Running”.</p> <h4 id="получение-доступа-к-платформу-методом-проброса-портов">Получение доступа к Платформу методом проброса портов</h4> <p>Установить проброс портов с сервиса web-app на локальную машину</p> <div class="highlight"><code><pre><span></span><code>kubectl<span class="w"> </span>port-forward<span class="w"> </span>service/web-app<span class="w"> </span><span class="m">30000</span>:8081<span class="w"> </span>-n<span class="w"> </span>cbap</code><br/>
</pre></code></div> <p>В браузере отправиться на <code>localhost:30000</code>.</p> </article> </div> </div> <a class="md-top md-icon mkdocs_imported_link" data-md-component="top" href="#"> <i class="fa-light fa-arrow-up">&zwnj;<!--icon--></i> К началу </a> </main> </div> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": true, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
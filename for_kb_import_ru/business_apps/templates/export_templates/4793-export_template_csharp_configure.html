<div class="md-body" data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="comindware" dir="ltr" kb-id="4793" kb-tags="" kb-title="Шаблон экспорта, Настройка с использованием C#">
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<nav aria-label="Содержание" class="md-nav md-nav--secondary">
</nav>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<p>В <strong>Comindware Platform</strong> помимо стандартной выгрузки отчётов предусмотрен экспорт данных с использованием скриптов на C#. Этот вариант позволяет более гибко настроить параметры экспортируемого файла, например, с дополнительной фильтрацией или заменой информации, либо с форматированным выводом атрибутов-коллекций.</p>
<p><strong>Шаблон документа в формате .xls</strong></p>
<p>Рассмотрим решение следующей задачи: написать скрипт, который формирует Excel-файл, в котором каждый элемент коллекции располагается в отдельной строчке (по умолчанию все элементы коллекции перечисляются в одной строчке через пробел).</p>
<p><strong>1.</strong> Для начала создайте шаблон экспорта по типу:</p>
<figure class="screenshot_with_caption">
<p><img alt="Пример excel шаблона экспорта" src="https://kb.comindware.ru/assets/exp1.jpg"/><figcaption class="caption">Пример excel шаблона экспорта</figcaption></p>
</figure>
<p><strong>&amp;=data.свойство_класса</strong> (Свойства класса — структура подготовки данных, которые определяются в С# скрипте)</p>
<p><strong>Примечание :</strong> в Excel-файле обязательно нужно указывать необходимый формат полей, иначе данные выгрузятся некорректно. Для числа — числовой, для даты и времени — дата, и т.д.</p>
<p>Поля «Клиент», «Контактное лицо», «Телефон» и «Email» будут заполняться из атрибутов записей шаблона «Клиенты». Поле «Договор» — коллекция в шаблоне записей «Клиенты», поле «Статус» — справочник статусов в отдельном шаблоне.</p>
<p><strong>2.</strong> Добавьте созданный шаблон экспорта в текущий шаблон записи (в данном случае, «Клиенты»):</p>
<figure class="screenshot_with_caption">
<p><img alt="Расположение раздела «Шаблоны экспорта»" src="https://kb.comindware.ru/assets/2.1_2021-12-13_114132.png"/><figcaption class="caption">Расположение раздела «Шаблоны экспорта»</figcaption></p>
</figure>
<p><strong>3.</strong>В этом же шаблоне записи автоматически добавится кнопка с операцией «Экспорт записи»:</p>
<figure class="screenshot_with_caption">
<p><img alt="Автоматически созданная кнопка" src="https://kb.comindware.ru/assets/2.2_2021-12-13_124346.png"/><figcaption class="caption">Автоматически созданная кнопка</figcaption></p>
</figure>
<p>Перейдите на вкладку «<strong><em>Скрипт</em></strong>» в свойствах этой кнопки и добавьте следующий код:</p>
<div class="highlight"><code><pre><span></span><code>using System;</code> <br/><code>using System.Collections.Generic;</code> <br/><code>using System.Linq;</code> <br/><code>using System.Text.RegularExpressions;</code> <br/><code>using Comindware.Data.Entity;</code> <br/><code>using Comindware.TeamNetwork.Api.Data.UserCommands;</code> <br/><code>using Aspose.Cells;</code> <br/><code>using Aspose.Cells.Pivot;</code> <br/><code></code> <br/><code>class Script</code> <br/><code>{</code> <br/><code>    public static UserCommandResult Main(UserCommandContext userCommandContext, Comindware.Entities entities)</code> <br/><code>    {</code> <br/><code>var objectsData = Api.TeamNetwork.ObjectService.ListWithAlias("Clients"); // Системное имя ШЗ "Клиенты"</code> <br/><code>var dataToExport = new List&lt;MainData&gt;();</code> <br/><code>foreach (var objectDict in objectsData)</code> <br/><code>{</code> <br/><code>var ContractDataInIds = getterListSTR("Contracts_collection", objectDict); // Атрибут-коллекция в ШЗ "Клиенты"</code> <br/><code>if(ContractDataInIds.Count == 0) {ContractDataInIds.Add("tempID");}</code> <br/><code>var ContractDataInList = new List&lt;ContractData&gt;();</code> <br/><code>foreach (var ContractDataInId in ContractDataInIds)</code> <br/><code>{</code> <br/><code>var ContractDataInData = GetData(ContractDataInId);</code> <br/><code></code> <br/><code>var Status_Id = getterSTR("Status", ContractDataInData); // Атрибут-ссылка в ШЗ "Договоры"</code> <br/><code>var Status_Data = GetData(Status_Id);</code> <br/><code></code> <br/><code>var ContractDataInT = new ContractData</code> <br/><code>{</code> <br/><code>Name = getterSTR("Title", ContractDataInData), // Атрибут "Статус" в ШЗ "Договоры"</code> <br/><code>Date = getterDT("Date", ContractDataInData), // Атрибут "Дата" в ШЗ "Договоры"</code> <br/><code>Total = getterDC("Total", ContractDataInData), // Атрибут "Сумма" в ШЗ "Договоры"</code> <br/><code>Status = getterSTR("Title", Status_Data) // Атрибут "Название" в ШЗ "Статусы договора"</code> <br/><code></code> <br/><code>};</code> <br/><code>ContractDataInList.Add(ContractDataInT);</code> <br/><code>}</code> <br/><code></code> <br/><code>var Data_ = new MainData</code> <br/><code>{</code> <br/><code>Client = getterSTR("Title", objectDict), // Атрибут "Название" в ШЗ "Клиенты"</code> <br/><code>Contact = getterSTR("Contact", objectDict), // Атрибут "Контактное лицо" в ШЗ "Клиенты"</code> <br/><code>Phone = getterSTR("Phone", objectDict), // Атрибут "Телефон" в ШЗ "Клиенты"</code> <br/><code>Email = getterSTR("Email", objectDict), // Атрибут "Email" в ШЗ "Клиенты"</code> <br/><code>Contract = ContractDataInList</code> <br/><code>};</code> <br/><code>dataToExport.Add(Data_);</code> <br/><code>}</code> <br/><code></code> <br/><code>var content = Api.TeamNetwork.ObjectAppExportService.ExecuteExcelExportTemplate(userCommandContext.DocumentTemplateId, dataToExport);</code> <br/><code>var result = new UserCommandResult</code> <br/><code>{</code> <br/><code>Success = true,</code> <br/><code>Commited = true,</code> <br/><code>ResultType = UserCommandResultType.File,</code> <br/><code>File = new UserCommandFileResult()</code> <br/><code>{</code> <br/><code>Name = "Excel_Data.xlsx",</code> <br/><code>Type = "Excel",</code> <br/><code>Content = content</code> <br/><code></code> <br/><code>},</code> <br/><code>Messages = new[]</code> <br/><code>{</code> <br/><code>new UserCommandMessage</code> <br/><code>{</code> <br/><code>Severity = SeverityLevel.Normal,</code> <br/><code>Text = "Файл сформирован"</code> <br/><code>}</code> <br/><code>}</code> <br/><code>};</code> <br/><code>return result;</code> <br/><code>    }</code> <br/><code></code> <br/><code>public static Decimal getterDC(string key, IDictionary&lt;string, object&gt; dictionary = null)</code> <br/><code>{</code> <br/><code>if (dictionary == null || key == null)</code> <br/><code>{</code> <br/><code>return 0;</code> <br/><code>}</code> <br/><code>var stringValue = getterSTR(key, dictionary);</code> <br/><code>if (stringValue != null &amp;&amp; Decimal.TryParse(stringValue, out var result))</code> <br/><code>{</code> <br/><code>return result;</code> <br/><code>}</code> <br/><code>else</code> <br/><code>{</code> <br/><code>return 0;</code> <br/><code>}</code> <br/><code>}</code> <br/><code></code> <br/><code>public static DateTime? getterDT(string key, IDictionary&lt;string, object&gt; dictionary = null)</code> <br/><code>{</code> <br/><code>if (dictionary == null || key == null)</code> <br/><code>{</code> <br/><code>return null;</code> <br/><code>}</code> <br/><code>var stringValue = getterSTR(key, dictionary);</code> <br/><code>if (stringValue != null &amp;&amp; DateTime.TryParse(stringValue, out var result))</code> <br/><code>{</code> <br/><code>return result.AddHours(5);</code> <br/><code>}</code> <br/><code>else</code> <br/><code>{</code> <br/><code>return null;</code> <br/><code>}</code> <br/><code>}</code> <br/><code></code> <br/><code>public static string getterSTR(string key, IDictionary&lt;string, object&gt; dictionary = null)</code> <br/><code>{</code> <br/><code>if (dictionary == null || key == null)</code> <br/><code>{</code> <br/><code>return null;</code> <br/><code>}</code> <br/><code>if (dictionary.TryGetValue(key, out var result))</code> <br/><code>{</code> <br/><code>if (result == null) return null;</code> <br/><code>return result.ToString();</code> <br/><code>}</code> <br/><code>else</code> <br/><code>{</code> <br/><code>return null;</code> <br/><code>}</code> <br/><code></code> <br/><code>}</code> <br/><code></code> <br/><code>public static IList&lt;string&gt; getterListSTR(string key, IDictionary&lt;string, object&gt; dictionary = null)</code> <br/><code>{</code> <br/><code>var result = new List&lt;string&gt;();</code> <br/><code>if (dictionary != null &amp;&amp; key != null)</code> <br/><code>{</code> <br/><code>if (dictionary.TryGetValue(key, out var objectData))</code> <br/><code>{</code> <br/><code>var objectDataArray = objectData as object[];</code> <br/><code>foreach (var singlObject in objectDataArray)</code> <br/><code>{</code> <br/><code>if (singlObject == null) continue;</code> <br/><code>result.Add(singlObject.ToString());</code> <br/><code>}</code> <br/><code>}</code> <br/><code>}</code> <br/><code>return result;</code> <br/><code>}</code> <br/><code></code> <br/><code>public static IDictionary&lt;string, object&gt; GetData(string objectId = null)</code> <br/><code>{</code> <br/><code>if (objectId == null || objectId.Contains("account") || objectId == "tempID")</code> <br/><code>{</code> <br/><code>return null;</code> <br/><code>}</code> <br/><code>var container = Api.TeamNetwork.ObjectAppService.GetByObject(objectId);</code> <br/><code>var result = Api.TeamNetwork.ObjectService.GetWithAlias(container.Alias, objectId);</code> <br/><code>return result;</code> <br/><code>}</code> <br/><code>}</code> <br/><code></code> <br/><code>[Serializable]</code> <br/><code>public class MainData</code> <br/><code>{</code> <br/><code>public string Client { get; set; }</code> <br/><code>public string Contact { get; set; }</code> <br/><code>public string Phone { get; set; }</code> <br/><code>public string Email { get; set; }</code> <br/><code>public List&lt;ContractData&gt; Contract { get; set; }</code> <br/><code>}</code> <br/><code></code> <br/><code>[Serializable]</code> <br/><code>public class ContractData</code> <br/><code>{</code> <br/><code>public string Name { get; set; }</code> <br/><code>public decimal Total { get; set; }</code> <br/><code>public DateTime? Date { get; set; }</code> <br/><code>public string Status { get; set; }</code> <br/><code>}</code> <br/></pre></code></div>
<p>В коде скрипта комментариями помечены 11 мест, где при необходимости можно заменить системные имена своими.</p>
<p>Как выглядят данные в продукте:</p>
<figure class="screenshot_with_caption">
<p><img alt="Список клиентов" src="https://kb.comindware.ru/assets/2.3_2021-12-13_141658.png"/><figcaption class="caption">Список клиентов</figcaption></p>
</figure>
<p>Результат выгрузки:</p>
<figure class="screenshot_with_caption">
<p><img alt="Excel файл" src="https://kb.comindware.ru/assets/exp5.jpg"/><figcaption class="caption">Excel файл</figcaption></p>
</figure>
<p><strong>Шаблон документа в формате .doc</strong></p>
<p>По такой же логике настраиваем выгрузку  Шаблона экспорта в формате Word.</p>
<p>Отличием здесь будет немного иное написание самого шаблона, а также C# скрипта.</p>
<figure class="screenshot_with_caption">
<p><img alt="Пример word шаблона экспорта" src="https://kb.comindware.ru/assets/exp6.jpg"/><figcaption class="caption">Пример word шаблона экспорта</figcaption></p>
</figure>
<p>C# скрипт:</p>
<div class="highlight"><code><pre><span></span><code>using System;</code> <br/><code>using System.Collections.Generic;</code> <br/><code>using System.Diagnostics;</code> <br/><code>using System.Linq;</code> <br/><code>using System.Text.RegularExpressions;</code> <br/><code>using Comindware.Data.Entity;</code> <br/><code>using Comindware.Platform.Api.Data;</code> <br/><code>using Comindware.TeamNetwork.Api.Data.UserCommands;</code> <br/><code>using System.IO;</code> <br/><code>using System.Data;</code> <br/><code></code> <br/><code>class Script</code> <br/><code>{</code> <br/><code>    public static UserCommandResult Main(UserCommandContext userCommandContext, Comindware.Entities entities)</code> <br/><code>    {</code> <br/><code>var objectsData = Api.TeamNetwork.ObjectService.ListWithAlias("Clients"); // Системное имя ШЗ "Клиенты"</code> <br/><code>List&lt;MainData&gt; Data_ = new List&lt;MainData&gt;();</code> <br/><code>foreach (var objectDict in objectsData)</code> <br/><code>{</code> <br/><code>var ContractDataInIds = getterListSTR("Contracts_collection", objectDict); // Атрибут-коллекция в ШЗ "Клиенты"</code> <br/><code>if(ContractDataInIds.Count == 0) {ContractDataInIds.Add("tempID");}</code> <br/><code>bool first_element = true;</code> <br/><code>foreach (var ContractDataInId in ContractDataInIds)</code> <br/><code>{</code> <br/><code>var ContractDataInData = GetData(ContractDataInId);</code> <br/><code></code> <br/><code>var Status_Id = getterSTR("Status", ContractDataInData); // Атрибут-ссылка в ШЗ "Договоры"</code> <br/><code>var Status_Data = GetData(Status_Id);</code> <br/><code></code> <br/><code>if(first_element == true)</code> <br/><code>{</code> <br/><code>first_element = false;</code> <br/><code>var temp = new MainData</code> <br/><code>{</code> <br/><code>Client = getterSTR("Title", objectDict), // Атрибут "Название" в ШЗ "Клиенты"</code> <br/><code>Contact = getterSTR("Contact", objectDict), // Атрибут "Контактное лицо" в ШЗ "Клиенты"</code> <br/><code>Phone = getterSTR("Phone", objectDict), // Атрибут "Телефон" в ШЗ "Клиенты"</code> <br/><code>Email = getterSTR("Email", objectDict), // Атрибут "Email" в ШЗ "Клиенты"</code> <br/><code></code> <br/><code>Name = getterSTR("Title", ContractDataInData), // Атрибут "Статус" в ШЗ "Договоры"</code> <br/><code>Date = getterDT("Date", ContractDataInData), // Атрибут "Дата" в ШЗ "Договоры"</code> <br/><code>Total = getterDC("Total", ContractDataInData), // Атрибут "Сумма" в ШЗ "Договоры"</code> <br/><code>Status = getterSTR("Title", Status_Data) // Атрибут "Название" в ШЗ "Статусы договора"</code> <br/><code>};</code> <br/><code>             Data_.Add(temp);</code> <br/><code>}</code> <br/><code>else</code> <br/><code>{</code> <br/><code>var temp = new MainData</code> <br/><code>{</code> <br/><code>Name = getterSTR("Title", ContractDataInData), // Атрибут "Статус" в ШЗ "Договоры"</code> <br/><code>Date = getterDT("Date", ContractDataInData), // Атрибут "Дата" в ШЗ "Договоры"</code> <br/><code>Total = getterDC("Total", ContractDataInData), // Атрибут "Сумма" в ШЗ "Договоры"</code> <br/><code>Status = getterSTR("Title", Status_Data) // Атрибут "Название" в ШЗ "Статусы договора"</code> <br/><code>};</code> <br/><code>Data_.Add(temp);</code> <br/><code>}</code> <br/><code>}</code> <br/><code>}</code> <br/><code></code> <br/><code>var dataToExport = new RESULT</code> <br/><code>{</code> <br/><code>MainData_ = Data_</code> <br/><code>};</code> <br/><code></code> <br/><code>        var content = Api.TeamNetwork.ObjectAppExportService.ExecuteWordExportTemplate(userCommandContext.DocumentTemplateId,dataToExport,false);</code> <br/><code></code> <br/><code>var result = new UserCommandResult</code> <br/><code>        {</code> <br/><code>            Success = true,</code> <br/><code>            Commited = true,</code> <br/><code>            File=new UserCommandFileResult(){</code> <br/><code>                Content = content,</code> <br/><code>Name = "Word_Data.doc",</code> <br/><code>Type = "Word"</code> <br/><code>            },</code> <br/><code>            ResultType = UserCommandResultType.Notificate,</code> <br/><code>            Messages = new[]</code> <br/><code>            {</code> <br/><code>                new UserCommandMessage</code> <br/><code>                {</code> <br/><code>                    Severity = SeverityLevel.Normal,</code> <br/><code>                    Text = "Документ сформирован"</code> <br/><code>                }</code> <br/><code>            }</code> <br/><code>        };</code> <br/><code>        return result;</code> <br/><code>    }</code> <br/><code></code> <br/><code>public static Decimal getterDC(string key, IDictionary&lt;string, object&gt; dictionary = null)</code> <br/><code>{</code> <br/><code>if (dictionary == null || key == null)</code> <br/><code>{</code> <br/><code>return 0;</code> <br/><code>}</code> <br/><code>var stringValue = getterSTR(key, dictionary);</code> <br/><code>if (stringValue != null &amp;&amp; Decimal.TryParse(stringValue, out var result))</code> <br/><code>{</code> <br/><code>return result;</code> <br/><code>}</code> <br/><code>else</code> <br/><code>{</code> <br/><code>return 0;</code> <br/><code>}</code> <br/><code>}</code> <br/><code></code> <br/><code>public static DateTime? getterDT(string key, IDictionary&lt;string, object&gt; dictionary = null)</code> <br/><code>{</code> <br/><code>if (dictionary == null || key == null)</code> <br/><code>{</code> <br/><code>return null;</code> <br/><code>}</code> <br/><code>var stringValue = getterSTR(key, dictionary);</code> <br/><code>if (stringValue != null &amp;&amp; DateTime.TryParse(stringValue, out var result))</code> <br/><code>{</code> <br/><code>return result.AddHours(5);</code> <br/><code>}</code> <br/><code>else</code> <br/><code>{</code> <br/><code>return null;</code> <br/><code>}</code> <br/><code>}</code> <br/><code></code> <br/><code>public static string getterSTR(string key, IDictionary&lt;string, object&gt; dictionary = null)</code> <br/><code>{</code> <br/><code>if (dictionary == null || key == null)</code> <br/><code>{</code> <br/><code>return null;</code> <br/><code>}</code> <br/><code>if (dictionary.TryGetValue(key, out var result))</code> <br/><code>{</code> <br/><code>if (result == null) return null;</code> <br/><code>return result.ToString();</code> <br/><code>}</code> <br/><code>else</code> <br/><code>{</code> <br/><code>return null;</code> <br/><code>}</code> <br/><code>}</code> <br/><code></code> <br/><code>public static IList&lt;string&gt; getterListSTR(string key, IDictionary&lt;string, object&gt; dictionary = null)</code> <br/><code>{</code> <br/><code>var result = new List&lt;string&gt;();</code> <br/><code>if (dictionary != null &amp;&amp; key != null)</code> <br/><code>{</code> <br/><code>if (dictionary.TryGetValue(key, out var objectData))</code> <br/><code>{</code> <br/><code>var objectDataArray = objectData as object[];</code> <br/><code>foreach (var singlObject in objectDataArray)</code> <br/><code>{</code> <br/><code>if (singlObject == null) continue;</code> <br/><code>result.Add(singlObject.ToString());</code> <br/><code>}</code> <br/><code>}</code> <br/><code>}</code> <br/><code>return result;</code> <br/><code>}</code> <br/><code></code> <br/><code>public static IDictionary&lt;string, object&gt; GetData(string objectId = null)</code> <br/><code>{</code> <br/><code>if (objectId == null || objectId.Contains("account") || objectId == "tempID")</code> <br/><code>{</code> <br/><code>return null;</code> <br/><code>}</code> <br/><code>var container = Api.TeamNetwork.ObjectAppService.GetByObject(objectId);</code> <br/><code>var result = Api.TeamNetwork.ObjectService.GetWithAlias(container.Alias, objectId);</code> <br/><code>return result;</code> <br/><code>}</code> <br/><code>}</code> <br/><code></code> <br/><code>[Serializable]</code> <br/><code>public class MainData</code> <br/><code>{</code> <br/><code>public string Client { get; set; }</code> <br/><code>public string Contact { get; set; }</code> <br/><code>public string Phone { get; set; }</code> <br/><code>public string Email { get; set; }</code> <br/><code>public string Name { get; set; }</code> <br/><code>public decimal Total { get; set; }</code> <br/><code>public DateTime? Date { get; set; }</code> <br/><code>public string Status { get; set; }</code> <br/><code>}</code> <br/><code></code> <br/><code>public class RESULT</code> <br/><code>{</code> <br/><code>    public List&lt;MainData&gt; MainData_ { get; set; }</code> <br/><code>}</code> <br/></pre></code></div>
<p>Результат выгрузки:</p>
<figure class="screenshot_with_caption">
<p><img alt="Word файл" src="https://kb.comindware.ru/assets/exp7.jpg"/><figcaption class="caption">Word файл</figcaption></p>
</figure>
</article>
</div>
</div>
<a class="md-top md-icon mkdocs_imported_link" data-md-component="top" href="#">
<i class="fa-light fa-arrow-up">&zwnj;<!--icon--></i>
            К началу
          </a>
</main>
</div>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": true, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></div>
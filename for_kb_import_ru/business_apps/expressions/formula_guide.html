<div class="md-body" data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="comindware" dir="ltr" kb-id="4999" kb-title="Язык формул. Общие сведения">
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<nav aria-label="Содержание" class="md-nav md-nav--secondary">
<div class="mce-toc">
<h2 class="toc-heading">
      Содержание
      </h2>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#formula_guide_description">
<span class="md-ellipsis">
      Описание языка формул Comindware
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#formula_guide_context">
<span class="md-ellipsis">
      Контекст вычисления формул. Понятие и изменение
    </span>
</a>
<nav aria-label="Контекст вычисления формул. Понятие и изменение" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#formula_guide_context_examples">
<span class="md-ellipsis">
      Примеры смены контекста
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#formula_guide_rules">
<span class="md-ellipsis">
      Основные правила написания формул
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#formula_guide_relations">
<span class="md-ellipsis">
      Вызов связанных данных
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#formula_guide_queries">
<span class="md-ellipsis">
      Написание запросов на языке формул
    </span>
</a>
<nav aria-label="Написание запросов на языке формул" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#formula_guide_queries_operators">
<span class="md-ellipsis">
      Операторы запросов
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#примеры-запросов">
<span class="md-ellipsis">
      Примеры запросов
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#связанные-статьи">
<span class="md-ellipsis">
      Связанные статьи
    </span>
</a>
</li>
</ul>
</div>
</nav>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<p><a class="mkdocs_imported_link" href="" id="formula_introduction"></a></p>
<h2 id="formula_guide_description">Описание языка формул Comindware</h2>
<p>Настройка рабочей среды и пользовательского интерфейса <strong>Comindware Platform</strong> производится простым перетаскиванием элементов и не требует программирования.</p>
<p>В случае если ваш бизнес требует нетривиального подхода, воспользуйтесь возможностями языка формул Comindware, легкого, но эффективного языка программирования, встроенного в продукт.</p>
<p>С помощью формул вы сможете неограниченно масштабировать бизнес-процессы в согласии с нуждами вашего бизнеса.</p>
<p>Возможности языка формул Comindware:</p>
<ul>
<li>Изменение и определение значений атрибутов на основе данных, хранящихся в различных шаблонах записи.</li>
<li>Проверка и изменение процессных данных.</li>
<li>Задание временных рамок выполнения тех или иных процессных действий, например, разрешенные запросы в техподдержку могут закрываться автоматически после двух недель в неактивном состоянии.</li>
<li>Назначение исполнителей задачи на основании того или иного условия (например, в зависимости от категории запроса).</li>
<li>Настройка межпроцессного взаимодействия.</li>
<li>Настройка вызова стороннего процесса внутри текущего.</li>
<li>Настройка условий ветвления процесса.</li>
<li>Защита платформы от негативного влияния человеческого фактора.</li>
</ul>
<p>См. также:</p>
<ul>
<li><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article.php?id=4993">Литералы и функции в формулах. Справочник, описания, примеры</a></li>
<li><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article.php?id=4794">Форматирование значений атрибутов в файле шаблона экспорта и формулах</a></li>
<li><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article.php?id=4757#account_template_attribute_system_names">Системные атрибуты шаблона аккаунта</a></li>
<li><a class="mkdocs_imported_link" href="https://kb.comindware.ru/category.php?id=881">Примеры формул</a></li>
</ul>
<p><a class="mkdocs_imported_link" href="" id="formula_context"></a></p>
<h2 id="formula_guide_context">Контекст вычисления формул. Понятие и изменение</h2>
<p>Понятие контекста всегда используется для настройки бизнес-логики и вычислений в <strong>Comindware Platform</strong>. В первую очередь, у любой информационной системы есть база данных, и чтобы получить какие-то данные из нее, нужно написать запрос к базе.</p>
<p><strong>Контекст</strong> — это отправная точка запроса к базе данных. Границами контекста являются шаблоны записи, шаблоны процессов и пользовательские задачи, в которых пишется запрос (в форме вычисляемых атрибутов, правил на форме, фильтров и т.д.), и их нужно различать для правильного написания формулы.</p>
<p><code>$</code> — обозначение изначального контекста.</p>
<p>Для смены контекста используются атрибуты типа «Запись» или запроса вида <code>from a in db</code>. Чтобы поменять контекст на связанную запись, используются системные имена атрибутов типа «Запись» после <code>$</code> и символы <code>-&gt;</code> после системного имени атрибута. В сценариях можно менять контекст по самим атрибутам типа «Запись» или по выражению типа <code>from a in db</code>.</p>
<h3 id="formula_guide_context_examples">Примеры смены контекста</h3>
<ul>
<li>
<p><strong>Пример 1:</strong> искомый атрибут находится в другом шаблоне, и в текущем контексте (шаблоне) есть ссылка на связанный шаблон.</p>
<div class="highlight"><code><pre><span></span><code><span class="err">$</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">atributSystemName</span></code> <br/></pre></code></div>
<p>Здесь:</p>
<ul>
<li><code>link</code>: системное имя атрибута типа «<strong>Запись</strong>»;</li>
<li><code>atributSystemName</code> — системное имя атрибута в связанной записи.</li>
</ul>
<p>Больше о вызове связанных данных читайте в статье <a class="mkdocs_imported_link" href="https://kb.comindware.ru/article.php?id=4998">Вызов связанных данных</a>.</p>
</li>
<li>
<p><strong>Пример 2:</strong> искомый атрибут находится в другом шаблоне записи, но в текущем контексте (шаблоне записи) нет ссылки на другой шаблон записи.</p>
<div class="highlight"><code><pre><span></span><code><span class="k">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">db</span><span class="o">-&gt;</span><span class="n">recordTemplateSystemName</span></code> <br/><code><span class="k">where</span><span class="w"> </span><span class="k">EQUALS</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">attirbute1</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">attribute2</span><span class="p">)</span></code> <br/><code><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="o">-&gt;</span><span class="n">id</span></code> <br/></pre></code></div>
<p>Здесь:</p>
<ul>
<li><code>recordTemplateSystemName</code>: системное имя искомого шаблона;</li>
<li><code>attribute1</code>: системное имя атрибута в искомом шаблоне;</li>
<li><code>attribute2</code>: системное имя атрибута в текущем шаблоне, с которым нужно сравнить <code>attribute1</code>.</li>
</ul>
</li>
</ul>
<p>См. <em>«<a class="mkdocs_imported_link" href="#formula_guide_queries">Написание запросов на языке формул</a>»</em>.</p>
<ul>
<li>
<p><strong>Пример 3:</strong> текущий контекст — это контекст задачи, а искомый атрибут находится в связанном с шаблоном процесса шаблоне записи.</p>
<div class="highlight"><code><pre><span></span><code><span class="err">$</span><span class="n">cmw</span><span class="p">.</span><span class="n">task</span><span class="p">.</span><span class="n">objectId</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="mi">11</span></code> <br/></pre></code></div>
<p>Здесь <code>op.11</code> — ID атрибута в связанном шаблоне записи.</p>
</li>
<li>
<p><strong>Пример 4:</strong> текущий контекст — это контекст процесса, а искомый атрибут находится в связанном шаблоне записи.</p>
<div class="highlight"><code><pre><span></span><code><span class="err">$$</span><span class="n">BusinessObject</span><span class="o">-&gt;</span><span class="n">attributeSystemName</span><span class="w"> </span></code> <br/></pre></code></div>
<p>Здесь <code>attributeSystemName</code> — системное имя атрибута в связанном шаблоне записи.</p>
</li>
</ul>
<h2 id="formula_guide_rules">Основные правила написания формул</h2>
<p>Работая с формулами в <strong>Comindware Platform</strong>, придерживайтесь следующих правил:</p>
<ol class="colored_numbers_list">
<li>В формулах используйте только идентификаторы и системные имена, а не отображаемые названия объектов.</li>
<li>Для идентификаторов и системных имен учитывается регистр: буквы <code>A</code> и <code>а</code> считаются разными.</li>
<li>Системные имена должны начинаться с буквы или символа подчеркивания (<code>_</code>). В самом системном имени можно использовать латинские и русские буквы (<code>A</code>–<code>Z</code>, <code>a</code>–<code>z</code>, <code>А</code>–<code>Я</code>, <code>а</code>–<code>я</code>), числа (<code>0</code>–<code>9</code>) и символы подчеркивания (<code>_</code>).</li>
<li>Системные имена должны быть уникальны только в рамках одного шаблона. Системные атрибуты создаются автоматически под формализованными именами, такими как <code>id</code>, <code>_creationDate</code>, <code>_creator</code>, <code>_lastWriteDate</code> и др.</li>
<li>Для того чтобы обратиться к тому или иному свойству текущего объекта, используйте оператор <code>$attributeSystemName</code> (<code>$-&gt;attributeSystemName</code>), где символ <code>$</code> представляет текущий шаблон, а <code>attributeSystemName</code> — системное имя атрибута этого шаблона.</li>
<li>Вы можете складывать и вычитать значения атрибутов типа «<strong>Дата и время</strong>» и «<strong>Длительность</strong>» между собой, руководствуясь следующей таблицей:</li>
</ol>
<table style="width: 100%;">
<thead>
<tr>
<th>Действие</th>
<th>Результат</th>
</tr>
</thead>
<tbody>
<tr>
<td>Длительность +/- Длительность</td>
<td>Длительность</td>
</tr>
<tr>
<td>Дата и время +/- Длительность</td>
<td>Дата и время</td>
</tr>
<tr>
<td>Дата и время - Дата и время</td>
<td>Длительность</td>
</tr>
</tbody>
</table>
<p>См. также <em>«<a class="mkdocs_imported_link" href="#formula_guide_queries">Написание запросов на языке формул</a>»</em>.</p>
<h2 id="formula_guide_relations">Вызов связанных данных</h2>
<p>Для того чтобы обратиться к данным связанного шаблона записи через атрибут типа «<strong>Запись</strong>», который ссылается на этот шаблон, введите системное имя атрибута типа «<strong>Запись</strong>», символ <code>-&gt;</code> и системное имя атрибута связанного шаблона записи.</p>
<p>Пример:</p>
<table style="width: 100%;">
<thead>
<tr>
<th>Шаблоны записи</th>
<th>Атрибуты</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Staff</code> (Персонал)</td>
<td><code>Name</code> (Имя) — системное имя атрибута с Ф. И. О. сотрудника.</td>
</tr>
<tr>
<td><code>Cars</code> (Автомобили)</td>
<td><code>Driver</code> (Водитель) — системное имя атрибута типа «<strong>Запись</strong>», ссылающегося на шаблон записи Staff (Персонал).</td>
</tr>
</tbody>
</table>
<p>Чтобы получить имя водителя для записи из шаблона <em>«Автомобили»</em>, используйте следующее выражение: </p>
<div class="highlight"><code><pre><span></span><code><span class="err">$</span><span class="n">Driver</span><span class="o">-&gt;</span><span class="n">Name</span></code> <br/></pre></code></div>
<p>Переходить по ссылкам можно неограниченное количество раз, но будьте внимательны, чтобы не образовалось зацикливание.</p>
<h2 id="formula_guide_queries">Написание запросов на языке формул</h2>
<p>Здесь представлен синтаксис и примеры предложений и операторов для запросов на языке формул <strong>Comindware Platform</strong>.</p>
<div class="notice notice-warning">
<p class="admonition-title">Зарезервированные слова</p>
<ul>
<li>Следующие слова нельзя использовать в запросе в качестве <a class="mkdocs_imported_link" href="#formula_guide_queries_operators">локальной переменной</a>, так как они зарезервированы как системные:<ul>
<li><code>and</code>, <code>ascending</code>, <code>between</code>, <code>by</code>, <code>db</code>, <code>descending</code>, <code>equals</code>, <code>from</code>, <code>group</code>, <code>in</code>, <code>into</code>, <code>item</code>, <code>join</code>, <code>let</code>, <code>on</code>, <code>orderby</code>, <code>select</code>, <code>source</code>, <code>where</code>;</li>
<li>слова, начинающиеся с символа подчеркивания (<code>_</code>);</li>
<li>имена <a class="mkdocs_imported_link" href="https://kb.comindware.ru/article.php?id=4993">функций и литералов</a>;</li>
</ul>
</li>
<li><a class="mkdocs_imported_link" href="#formula_guide_queries_operators">Предложение <code>from</code></a> может содержать подзапросы (также начинающиеся с <code>from</code>).</li>
</ul>
</div>
<h3 id="formula_guide_queries_operators">Операторы запросов</h3>
<table style="width: 100%;">
<tbody>
<tr>
<th colspan="2">
<p><code>from</code></p>
</th>
</tr>
<tr>
<td class="functionDescriptionColumn">
<p><strong>Описание</strong></p>
</td>
<td>
<p>Запрос должен начинаться с предложения <code>from</code>. Предложение <code>from</code> состоит из следующих частей:</p>
<ul>
<li>оператор <code>from</code>;</li>
<li>локальная переменная (например, <code>queryVar</code>), которая представляет отдельные элементы источника данных (например, запись в шаблоне или аккаунт);</li>
<li>оператор <code>in</code>;</li>
<li>источник данных, по которому выполняется запрос.</li>
</ul>
</td>
</tr>
<tr>
<td>
<p><strong>Синтаксис</strong></p>
</td>
<td>
<p><code>from queryVar in dataSource</code></p>
</td>
</tr>
<tr>
<td>
<p><strong>Аргументы</strong></p>
</td>
<td>
<ul>
<li><code>queryVar</code>: имя локальной переменной</li>
<li><code>dataSource</code>:<ul>
<li><code>db-&gt;templateName</code>: шаблон;</li>
<li><code>$path-&gt;to-&gt;attribute</code>: путь к атрибуту шаблона;</li>
<li><code>from queryVar2 in dataSource2 where condition2 select attribute2</code>: подзапрос;</li>
</ul>
</li>
</ul>
</td>
</tr>
<tr>
<th colspan="2">
<p><code>where</code></p>
</th>
</tr>
<tr>
<td class="functionDescriptionColumn">
<p><strong>Описание</strong></p>
</td>
<td>
<p>Предложение <code>where</code> задаёт условие выборки элементов в источнике данных. Условие может содержать несколько предикатов, возвращающих <code>True</code> или <code>False</code>.</p>
<p>В условие можно включить несколько предикатов с помощью логических операторов <code>&amp;&amp;</code> (И),  <code>||</code> (ИЛИ),  <code>==</code> (РАВНО),  <code>!=</code> (НЕ РАВНО) и функций <code>AND()</code>, <code>OR()</code>, <code>EQUALS()</code>, <code>IF()</code>, <code>NOT()</code>, <code>ANY()</code>, <code>ALL()</code>.</p>
</td>
</tr>
<tr>
<td>
<p><strong>Синтаксис</strong></p>
</td>
<td>
<p><code>where condition</code></p>
</td>
</tr>
<tr>
<td>
<p><strong>Аргументы</strong></p>
</td>
<td>
<p><code>condition</code>: логическое значение или выражение, возвращающее <code>True</code> или <code>False</code>.</p>
</td>
</tr>
<tr>
<th colspan="2">
<p><code>orderby</code></p>
</th>
</tr>
<tr>
<td class="functionDescriptionColumn">
<p><strong>Описание</strong></p>
</td>
<td>
<p>Предложение <code>orderby</code> позволяет отсортировать результаты запроса по значению атрибута искомых объектов.</p>
<p>Предложение <code>orderby</code> следует использовать между предложениями <code>where</code> и <code>select</code>.</p>
<p>Предложение <code>orderby</code> состоит из следующих частей:</p>
<ul>
<li>оператор  <code>orderby</code>;</li>
<li>атрибут объекта, по которому следует выполнять сортировку результатов запроса;</li>
<li>оператор порядка сортировки — <code>ascending</code> по возрастанию (по умолчанию, можно не указывать) или <code>descending</code> — по убыванию.</li>
</ul>
</td>
</tr>
<tr>
<td>
<p><strong>Синтаксис</strong></p>
</td>
<td>
<ul>
<li>Сортировка по возрастанию: <code>orderby templateAttribute ascending</code> или <code>orderby templateAttribute</code></li>
<li>Сортировка по убыванию: <code>orderby templateAttribute descending</code></li>
</ul>
</td>
</tr>
<tr>
<td>
<p><strong>Аргументы</strong></p>
</td>
<td>
<p><code>templateAttribute</code>: атрибут шаблона (источника данных).</p>
</td>
</tr>
<tr>
<td>
<p><code>select</code></p>
</td>
</tr>
<tr>
<td class="functionDescriptionColumn">
<p><strong>Описание</strong></p>
</td>
<td>
<p>Предложение <code>select</code> задаёт, атрибут объекта, значения которого вернёт запрос. В конечном результате учитываются как работа предыдущих операторов, так и любые выражения в самом операторе <code>select</code>.</p>
</td>
</tr>
<tr>
<td>
<p><strong>Синтаксис</strong></p>
</td>
<td>
<p><code>select templateAttribute</code></p>
</td>
</tr>
<tr>
<td>
<p><strong>Аргументы</strong></p>
</td>
<td>
<p><code>templateAttribute</code>: атрибут шаблона.</p>
</td>
</tr>
</tbody>
</table>
<h3 id="примеры-запросов">Примеры запросов</h3>
<ul>
<li>
<p>Запрос записей районов Москвы с сортировкой по убыванию названия района.</p>
<div class="highlight"><code><pre><span></span><code><span class="k">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">db</span><span class="o">-&gt;</span><span class="n">Cities</span></code> <br/><code><span class="k">where</span><span class="w"> </span><span class="n">a</span><span class="o">-&gt;</span><span class="n">CityName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">"Москва"</span></code> <br/><code><span class="n">orderby</span><span class="w"> </span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Districts</span><span class="o">-&gt;</span><span class="n">DistrictName</span><span class="w"> </span><span class="n">descending</span></code> <br/><code><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Districts</span></code> <br/></pre></code></div>
</li>
<li>
<p>Запрос названий и авторов книг, у которых указан автор, с сортировкой по возрастанию имени автора и выводом в формате <em>«Название: название книги. Автор: имя автора»</em>.</p>
<div class="highlight"><code><pre><span></span><code><span class="k">from</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">db</span><span class="o">-&gt;</span><span class="n">Books</span></code> <br/><code><span class="k">where</span><span class="w"> </span><span class="k">NOT</span><span class="p">(</span><span class="n">EMPTY</span><span class="p">(</span><span class="n">book</span><span class="o">-&gt;</span><span class="n">Author</span><span class="p">))</span></code> <br/><code><span class="n">orderby</span><span class="w"> </span><span class="n">book</span><span class="o">-&gt;</span><span class="n">Author</span><span class="o">-&gt;</span><span class="n">Name</span></code> <br/><code><span class="k">select</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span></code> <br/><code><span class="w">    </span><span class="n">LIST</span><span class="p">(</span></code> <br/><code><span class="w">        </span><span class="s1">'Название: '</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="s1">'. Автор: '</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="o">-&gt;</span><span class="n">Author</span><span class="o">-&gt;</span><span class="n">Name</span></code> <br/><code><span class="w">    </span><span class="p">)</span></code> <br/><code><span class="p">)</span></code> <br/></pre></code></div>
</li>
</ul>
<div class="relatedTopics">
<h2 id="связанные-статьи">Связанные статьи</h2>
<ul>
<li><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article.php?id=4993">Литералы и функции в формулах. Справочник, описания, примеры</a></li>
<li><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article.php?id=4794">Форматирование значений атрибутов в файле шаблона экспорта и формулах</a></li>
<li><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article.php?id=4757#account_template_attribute_system_names">Системные атрибуты шаблона аккаунта</a></li>
<li><a class="mkdocs_imported_link" href="https://kb.comindware.ru/category.php?id=881">Примеры формул</a></li>
</ul>
</div>
</article>
</div>
</div>
<a class="md-top md-icon mkdocs_imported_link" data-md-component="top" href="#">
<i class="fa-light fa-arrow-up">&zwnj;<!--icon--></i>
            К началу
          </a>
</main>
</div>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": true, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></div>
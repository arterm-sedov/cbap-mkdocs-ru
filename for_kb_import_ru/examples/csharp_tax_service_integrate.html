<div class="md-body" data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="comindware" dir="ltr" kb-id="4924" kb-title="Получение данных от API ФНС с помощью C#">
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<nav aria-label="Содержание" class="md-nav md-nav--secondary">
<div class="mce-toc">
<h2 class="toc-heading">
      Содержание
      </h2>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#example_csharp_tax_service_integrate_intro">
<span class="md-ellipsis">
      Введение
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#example_csharp_tax_service_integrate_use_case">
<span class="md-ellipsis">
      Прикладная задача
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#example_csharp_tax_service_integrate_configure">
<span class="md-ellipsis">
      Настройка интеграции
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#example_csharp_tax_service_integrate_test">
<span class="md-ellipsis">
      Тестирование
    </span>
</a>
</li>
</ul>
</div>
</nav>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h2 id="example_csharp_tax_service_integrate_intro">Введение</h2>
<p>Здесь представлен пример скрипта для автоматического получения данных о компании по её ИНН из базы ФНС.</p>
<p>Скрипт запускается по нажатию кнопки на форме контрагента и заполняет поля данными, полученными из ФНС.</p>
<p>Интеграция с сервисом ФНС осуществляется через <a class="mkdocs_imported_link" href="https://api-fns.ru/index">API-ФНС</a> посредством метода <code>multinfo</code>.</p>
<p>Приведённый пример скрипта поддерживает получение следующих данных:</p>
<ul>
<li><strong>Наименование юридического лица/ИП</strong></li>
<li><strong>Количество сотрудников</strong></li>
<li><strong>Годовой доход</strong></li>
<li><strong>ФИО руководителя</strong></li>
<li><strong>ОГРН/ОГРНИП</strong></li>
<li><strong>КПП</strong> (для юридических лиц)</li>
<li><strong>Юридический адрес</strong></li>
<li><strong>ОКВЭД</strong></li>
<li><strong>Вид деятельности</strong></li>
</ul>
<h2 id="example_csharp_tax_service_integrate_use_case">Прикладная задача</h2>
<p>Имеется шаблон записи <em>«Контрагенты»</em>, в котором хранятся следующие сведения:</p>
<ul>
<li><strong>Для юридического лица</strong><ul>
<li>ИНН</li>
<li>Наименование юридического лица</li>
<li>Количество сотрудников</li>
<li>Годовой доход</li>
<li>Ф. И. О. руководителя</li>
<li>ОГРН</li>
<li>КПП</li>
<li>Юридический адрес</li>
<li>ОКВЭД</li>
<li>Вид деятельности</li>
</ul>
</li>
<li><strong>Для индивидуального предпринимателя</strong><ul>
<li>ИНН</li>
<li>Наименование ИП</li>
<li>Ф. И. О. предпринимателя</li>
<li>ОГРНИП</li>
<li>Юридический адрес</li>
<li>ОКВЭД</li>
<li>Вид деятельности</li>
</ul>
</li>
</ul>
<p>Требуется автоматически получать актуальные сведения о контрагенте из базы ФНС по его ИНН.</p>
<p>Данные необходимо получать по нажатию кнопки <em>«Получить сведения из ФНС»</em> на форме контрагента.</p>
<p>Если ИНН является действительным и сервис API-ФНС отправил данные, скрипт должен определить тип контрагента (юридическое лицо или ИП) и заполнить соответствующие поля.</p>
<p>Если какие-либо данные в ответе API отсутствуют, соответствующие поля заполнять не требуется.</p>
<p>При повторном нажатии кнопки <em>«Получить сведения из ФНС»</em> данные должны перезаписываться.</p>
<h2 class="pageBreakBefore" id="example_csharp_tax_service_integrate_configure">Настройка интеграции</h2>
<div class="notice notice-warning">
<p class="admonition-title">Логика работы скрипта</p>
<p>Представленный здесь скрипт работает следующим образом:</p>
<ol class="colored_numbers_list">
<li>Получает значение ИНН из текущей записи контрагента.</li>
<li>Формирует запрос к API ФНС с полученным ИНН.</li>
<li>Обрабатывает ответ от API и извлекает данные.</li>
<li>Определяет тип контрагента (ЮЛ или ИП) и выбирает соответствующий набор данных.</li>
<li>Записывает полученные данные в соответствующие атрибуты.</li>
<li>Обрабатывает возможные ошибки и выдаёт понятные сообщения пользователю.</li>
<li>Отображает результат выполнения операции.</li>
</ol>
</div>
<ol class="colored_numbers_list">
<li>Зарегистрируйтесь на сайте <a class="mkdocs_imported_link" href="https://api-fns.ru/index">API-ФНС</a> и получите ключ API для подключения.</li>
<li>Создайте шаблон <em>«Контрагенты»</em>.</li>
<li>
<p>Создайте и поместите на форму шаблона следующие текстовые атрибуты:</p>
<table style="width: 100%;">
<thead>
<tr>
<th>Название</th>
<th>Системное имя</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>ИНН</em></td>
<td><code>ИНН</code></td>
</tr>
<tr>
<td><em>Наименование ЮЛ</em></td>
<td><code>НаименованиеЮЛ</code></td>
</tr>
<tr>
<td><em>Количество сотрудников</em></td>
<td><code>КоличествоСотрудников</code></td>
</tr>
<tr>
<td><em>Годовой доход</em></td>
<td><code>ГодовойДоход</code></td>
</tr>
<tr>
<td><em>ФИО руководителя</em></td>
<td><code>ФИОРуководителя</code></td>
</tr>
<tr>
<td><em>ОГРН</em></td>
<td><code>ОГРН</code></td>
</tr>
<tr>
<td><em>КПП</em></td>
<td><code>КПП</code></td>
</tr>
<tr>
<td><em>Юридический адрес</em></td>
<td><code>ЮридическийАдрес</code></td>
</tr>
<tr>
<td><em>ОКВЭД</em></td>
<td><code>ОКВЭД</code></td>
</tr>
<tr>
<td><em>Вид деятельности</em></td>
<td><code>ВидДеятельности</code></td>
</tr>
<tr>
<td><em>Наименование ИП</em></td>
<td><code>НаименованиеИП</code></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>В шаблоне <em>«Контрагенты»</em> создайте кнопку со следующими свойствами:</p>
<ul>
<li><strong>Отображаемое название:</strong> <em>Получить данные из ФНС</em></li>
<li><strong>Контекст операции: запись</strong></li>
<li><strong>Операция: C#-скрипт</strong></li>
<li><strong>Результат выполнения: обновить данные</strong></li>
</ul>
</li>
<li>
<p>На вкладке «<strong>Скрипт</strong>» введите следующий код:</p>
<div class="notice notice-warning">
<p class="admonition-title">Подстановка фактических имён и значений</p>
<p>Замените в коде:</p>
<ul>
<li>значение <code>123</code> на ключ API, полученный от ФНС.</li>
<li>имя <code>Контрагенты</code> на фактическое системное имя вашего шаблона записи с данными контрагентов.</li>
<li>системные имена атрибутов на фактически используемые в вашем шаблоне контрагентов.</li>
</ul>
</div>
<div class="highlight"><code><pre><span></span><code><span class="c1">// Импортируем базовые типы и функции .NET Framework.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span><span class="w"> </span></code> <br/><code><span class="c1">// Импортируем классы коллекций и словарей для хранения данных.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">System.Collections.Generic</span><span class="p">;</span></code> <br/><code><span class="c1">// Импортируем расширения LINQ для работы с коллекциями и выполнения запросов.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">System.Linq</span><span class="p">;</span></code> <br/><code><span class="c1">// Импортируем классы для работы с сущностями данных.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">Comindware.Data.Entity</span><span class="p">;</span></code> <br/><code><span class="c1">// Импортируем классы для обработки нажатий кнопок и возврата результатов выполнения скрипта.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">Comindware.TeamNetwork.Api.Data.UserCommands</span><span class="p">;</span></code> <br/><code><span class="c1">// Импортируем классы для работы с данными.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">Comindware.TeamNetwork.Api.Data</span><span class="p">;</span></code> <br/><code><span class="c1">// Импортируем библиотеку RestSharp для отправки HTTP-запросов в API ФНС.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">RestSharp</span><span class="p">;</span></code> <br/><code><span class="c1">// Импортируем библиотеку Newtonsoft.Json для обработки JSON-ответов от API.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">Newtonsoft.Json.Linq</span><span class="p">;</span></code> <br/><code></code> <br/><code><span class="k">class</span><span class="w"> </span><span class="nc">Script</span><span class="p">{</span></code> <br/><code><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">UserCommandResult</span><span class="w"> </span><span class="nf">Main</span><span class="p">(</span><span class="n">UserCommandContext</span><span class="w"> </span><span class="n">userCommandContext</span><span class="p">,</span><span class="w"> </span><span class="n">Comindware</span><span class="p">.</span><span class="n">Entities</span><span class="w"> </span><span class="n">entities</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span></code> <br/><code><span class="w">        </span><span class="c1">// Получаем ID текущей записи контрагента.</span></code> <br/><code><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">contextObjectId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userCommandContext</span><span class="p">.</span><span class="n">ObjectIds</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></code> <br/><code><span class="w">        </span><span class="c1">// Устанавливаем флаг успешного выполнения операции.</span></code> <br/><code><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">successFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span></code> <br/><code><span class="w">        </span><span class="c1">// Задаём текст сообщения об успешном получении данных от ФНС.</span></code> <br/><code><span class="w">        </span><span class="kt">string</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Данные контрагента получены"</span><span class="p">;</span></code> <br/><code><span class="w">        </span><span class="c1">// Инициализируем переменные для работы с API.</span></code> <br/><code><span class="w">        </span><span class="n">IRestResponse</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestResponse</span><span class="p">();</span></code> <br/><code><span class="w">        </span><span class="c1">// Задаём URL-адрес API ФНС для получения данных об организации.</span></code> <br/><code><span class="w">        </span><span class="kt">string</span><span class="w"> </span><span class="n">url_Source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"https://api-fns.ru/api/multinfo"</span><span class="p">;</span></code> <br/><code><span class="w">        </span><span class="c1">// Инициализируем клиент для отправки HTTP-запросов.</span></code> <br/><code><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestClient</span><span class="p">(</span><span class="n">url_Source</span><span class="p">);</span></code> <br/><code><span class="w">        </span><span class="c1">// Создаём пустой GET-запрос к API.</span></code> <br/><code><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestSharp</span><span class="p">.</span><span class="n">RestRequest</span><span class="p">(</span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="p">.</span><span class="n">GET</span><span class="p">);</span></code> <br/><code><span class="w">        </span><span class="c1">// Устанавливаем заголовки запроса для получения JSON-ответа.</span></code> <br/><code><span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="n">AddHeader</span><span class="p">(</span><span class="s">"RestRequest"</span><span class="p">,</span><span class="w"> </span><span class="s">"application/json"</span><span class="p">);</span></code> <br/><code><span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="n">AddHeader</span><span class="p">(</span><span class="s">"Accept"</span><span class="p">,</span><span class="w"> </span><span class="s">"application/json"</span><span class="p">);</span></code> <br/><code><span class="w">        </span><span class="c1">// Создаём переменную для хранения годового дохода компании.</span></code> <br/><code><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">revenue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span></code> <br/><code><span class="w">        </span><span class="c1">// Создаём словарь для хранения и записи данных данных в атрибуты.</span></code> <br/><code><span class="w">        </span><span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="kt">object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="kt">object</span><span class="o">&gt;</span><span class="p">();</span></code> <br/><code><span class="w">        </span><span class="c1">// Создаём массив c системным именем атрибута, содержащего ИНН.</span></code> <br/><code><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">InnAttributeSystemName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"ИНН"</span><span class="p">;</span></code> <br/><code><span class="w">        </span><span class="k">try</span><span class="p">{</span></code> <br/><code><span class="w">            </span><span class="c1">// Получаем значение ИНН из текущей записи.</span></code> <br/><code><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">innAttributeValueObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Api</span><span class="p">.</span><span class="n">TeamNetwork</span><span class="p">.</span><span class="n">ObjectService</span><span class="p">.</span><span class="n">GetPropertyValues</span><span class="p">(</span><span class="k">new</span><span class="p">[]{</span><span class="n">userCommandContext</span><span class="p">.</span><span class="n">ObjectIds</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span><span class="w"> </span><span class="k">new</span><span class="p">[]</span><span class="w"> </span><span class="p">{</span><span class="s">"ИНН"</span><span class="p">});</span></code> <br/><code><span class="w">            </span><span class="c1">// Создаём словарь для хранения ID и значения атрибута "ИНН".</span></code> <br/><code><span class="w">            </span><span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">innAttributeDictionary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">object</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{{</span><span class="s">"id"</span><span class="p">,</span><span class="w"> </span><span class="n">innAttributeValueObject</span><span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">().</span><span class="n">Key</span><span class="p">}};</span></code> <br/><code><span class="w">            </span><span class="c1">// Извлекаем значение ИНН из полученных данных.</span></code> <br/><code><span class="w">            </span><span class="kt">object</span><span class="w"> </span><span class="n">_Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">;</span></code> <br/><code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">innAttributeValueObject</span><span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">().</span><span class="n">Value</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">InnAttributeSystemName</span><span class="p">,</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">object</span><span class="w"> </span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">null</span><span class="p">){</span><span class="n">_Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;}</span></code> <br/><code><span class="w">            </span><span class="n">innAttributeDictionary</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">InnAttributeSystemName</span><span class="p">,</span><span class="w"> </span><span class="n">_Value</span><span class="p">);</span></code> <br/><code><span class="w">            </span><span class="c1">// Добавляем в запрос параметры: ИНН и ключ API.</span></code> <br/><code><span class="w">            </span><span class="n">request</span><span class="p">.</span><span class="n">AddParameter</span><span class="p">(</span><span class="s">"req"</span><span class="p">,</span><span class="w"> </span><span class="n">innAttributeDictionary</span><span class="p">[</span><span class="s">"ИНН"</span><span class="p">].</span><span class="n">ToString</span><span class="p">());</span></code> <br/><code><span class="w">            </span><span class="c1">// 123 — полученный ключ API ФНС.</span></code> <br/><code><span class="w">            </span><span class="n">request</span><span class="p">.</span><span class="n">AddParameter</span><span class="p">(</span><span class="s">"key"</span><span class="p">,</span><span class="w"> </span><span class="s">"123"</span><span class="p">);</span></code> <br/><code><span class="w">            </span><span class="k">try</span><span class="p">{</span></code> <br/><code><span class="w">                </span><span class="c1">// Выполняем запрос к API ФНС и сохраняем ответ.</span></code> <br/><code><span class="w">                </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">request</span><span class="p">);</span></code> <br/><code><span class="w">                </span><span class="c1">// Проверяем успешность запроса и наличие данных в ответе.</span></code> <br/><code><span class="w">                </span><span class="k">if</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">response</span><span class="p">.</span><span class="n">StatusCode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="n">Length</span><span class="o">&gt;</span><span class="mi">15</span><span class="p">){</span></code> <br/><code><span class="w">                    </span><span class="c1">// Обрабатываем JSON-ответ.</span></code> <br/><code><span class="w">                    </span><span class="n">JObject</span><span class="w"> </span><span class="n">jObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JObject</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">);</span></code> <br/><code><span class="w">                    </span><span class="c1">// Определяем тип контрагента (ЮЛ или ИП).</span></code> <br/><code><span class="w">                    </span><span class="kt">var</span><span class="w"> </span><span class="n">responseItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">ToString</span><span class="p">().</span><span class="n">Split</span><span class="p">(</span><span class="sc">'{'</span><span class="p">);</span></code> <br/><code><span class="w">                    </span><span class="n">responseItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">responseItems</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Split</span><span class="p">(</span><span class="sc">':'</span><span class="p">);</span></code> <br/><code><span class="w">                    </span><span class="n">responseItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">responseItems</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Split</span><span class="p">(</span><span class="sc">'"'</span><span class="p">);</span></code> <br/><code><span class="w">                    </span><span class="kt">string</span><span class="w"> </span><span class="n">companyType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">responseItems</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span></code> <br/><code><span class="w">                    </span><span class="c1">// Обрабатываем данные для юридического лица.</span></code> <br/><code><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">companyType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"ЮЛ"</span><span class="p">){</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем годовой доход (выручку) компании.</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">revenue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ЮЛ"</span><span class="p">][</span><span class="s">"Финансы"</span><span class="p">][</span><span class="s">"Выручка"</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="mi">1000</span><span class="p">;}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем и сохраняем наименование юридического лица</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "НаименованиеЮЛ".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"НаименованиеЮЛ"</span><span class="p">,</span><span class="w"> </span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ЮЛ"</span><span class="p">][</span><span class="s">"НаимСокрЮЛ"</span><span class="p">].</span><span class="n">ToString</span><span class="p">());}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем и сохраняем количество сотрудников</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "КоличествоСотрудников".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"КоличествоСотрудников"</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ЮЛ"</span><span class="p">][</span><span class="s">"ОткрСведения"</span><span class="p">][</span><span class="s">"КолРаб"</span><span class="p">]</span><span class="w"> </span><span class="p">);</span></code> <br/><code><span class="w">                        </span><span class="p">}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Сохраняем годовой доход</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "ГодовойДоход".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"ГодовойДоход"</span><span class="p">,</span><span class="w"> </span><span class="n">revenue</span><span class="p">);}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем и сохраняем ФИО руководителя</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "ФИОРуководителя".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"ФИОРуководителя"</span><span class="p">,</span><span class="w"> </span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ЮЛ"</span><span class="p">][</span><span class="s">"Руководитель"</span><span class="p">][</span><span class="s">"ФИОПолн"</span><span class="p">].</span><span class="n">ToString</span><span class="p">());</span></code> <br/><code><span class="w">                        </span><span class="p">}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем и сохраняем ОГРН</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "ОГРН".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"ОГРН"</span><span class="p">,</span><span class="w"> </span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ЮЛ"</span><span class="p">][</span><span class="s">"ОГРН"</span><span class="p">].</span><span class="n">ToString</span><span class="p">());}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем и сохраняем КПП</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "КПП".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"КПП"</span><span class="p">,</span><span class="w"> </span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ЮЛ"</span><span class="p">][</span><span class="s">"КПП"</span><span class="p">].</span><span class="n">ToString</span><span class="p">());}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем и сохраняем юридический адрес</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "ЮридическийАдрес".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"ЮридическийАдрес"</span><span class="p">,</span><span class="w"> </span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ЮЛ"</span><span class="p">][</span><span class="s">"Адрес"</span><span class="p">][</span><span class="s">"АдресПолн"</span><span class="p">].</span><span class="n">ToString</span><span class="p">());</span></code> <br/><code><span class="w">                        </span><span class="p">}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем и сохраняем код ОКВЭД</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "ОКВЭД".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"ОКВЭД"</span><span class="p">,</span><span class="w"> </span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ЮЛ"</span><span class="p">][</span><span class="s">"ОснВидДеят"</span><span class="p">][</span><span class="s">"Код"</span><span class="p">].</span><span class="n">ToString</span><span class="p">());}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем и сохраняем описание вида деятельности</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "ВидДеятельности".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"ВидДеятельности"</span><span class="p">,</span><span class="w"> </span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ЮЛ"</span><span class="p">][</span><span class="s">"ОснВидДеят"</span><span class="p">][</span><span class="s">"Текст"</span><span class="p">].</span><span class="n">ToString</span><span class="p">());}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Обновляем текущую запись контрагента полученными данными.</span></code> <br/><code><span class="w">                        </span><span class="c1">// Контрагенты — системное имя шаблона записи.</span></code> <br/><code><span class="w">                        </span><span class="n">Api</span><span class="p">.</span><span class="n">TeamNetwork</span><span class="p">.</span><span class="n">ObjectService</span><span class="p">.</span><span class="n">EditWithAlias</span><span class="p">(</span><span class="s">"Контрагенты"</span><span class="p">,</span><span class="w"> </span><span class="n">contextObjectId</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span></code> <br/><code><span class="w">                    </span><span class="p">}</span></code> <br/><code><span class="w">                    </span><span class="c1">// Обрабатываем данные для индивидуального предпринимателя.</span></code> <br/><code><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="p">(</span><span class="n">companyType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"ИП"</span><span class="p">){</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем и сохраняем наименование ИП</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "НаименованиеИП".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"НаименованиеИП"</span><span class="p">,</span><span class="w"> </span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ИП"</span><span class="p">][</span><span class="s">"НаимПолнЮЛ"</span><span class="p">].</span><span class="n">ToString</span><span class="p">());}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем и сохраняем ФИО ИП</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "ФИОРуководителя".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"ФИОРуководителя"</span><span class="p">,</span><span class="w"> </span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ИП"</span><span class="p">][</span><span class="s">"ФИОПолн"</span><span class="p">].</span><span class="n">ToString</span><span class="p">());}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем и сохраняем ОГРНИП</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "ОГРН".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"ОГРН"</span><span class="p">,</span><span class="w"> </span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ИП"</span><span class="p">][</span><span class="s">"ОГРНИП"</span><span class="p">].</span><span class="n">ToString</span><span class="p">());}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем и сохраняем юридический адрес</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "ЮридическийАдрес".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"ЮридическийАдрес"</span><span class="p">,</span><span class="w"> </span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ИП"</span><span class="p">][</span><span class="s">"Адрес"</span><span class="p">][</span><span class="s">"АдресПолн"</span><span class="p">].</span><span class="n">ToString</span><span class="p">());</span></code> <br/><code><span class="w">                        </span><span class="p">}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем и сохраняем код ОКВЭД</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "ОКВЭД".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"ОКВЭД"</span><span class="p">,</span><span class="w"> </span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ИП"</span><span class="p">][</span><span class="s">"ОснВидДеят"</span><span class="p">][</span><span class="s">"Код"</span><span class="p">].</span><span class="n">ToString</span><span class="p">());}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Извлекаем и сохраняем описание вида деятельности</span></code> <br/><code><span class="w">                        </span><span class="c1">// в атрибут с системным именем "ВидДеятельности".</span></code> <br/><code><span class="w">                        </span><span class="k">try</span><span class="p">{</span><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"ВидДеятельности"</span><span class="p">,</span><span class="w"> </span><span class="n">jObject</span><span class="p">[</span><span class="s">"items"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"ИП"</span><span class="p">][</span><span class="s">"ОснВидДеят"</span><span class="p">][</span><span class="s">"Текст"</span><span class="p">].</span><span class="n">ToString</span><span class="p">());</span></code> <br/><code><span class="w">                        </span><span class="p">}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Обновляем запись контрагента полученными данными.</span></code> <br/><code><span class="w">                        </span><span class="c1">// Контрагенты — системное имя шаблона записи.</span></code> <br/><code><span class="w">                        </span><span class="n">Api</span><span class="p">.</span><span class="n">TeamNetwork</span><span class="p">.</span><span class="n">ObjectService</span><span class="p">.</span><span class="n">EditWithAlias</span><span class="p">(</span><span class="s">"Контрагенты"</span><span class="p">,</span><span class="w"> </span><span class="n">contextObjectId</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span></code> <br/><code><span class="w">                    </span><span class="p">}</span></code> <br/><code><span class="w">                </span><span class="p">}</span></code> <br/><code><span class="w">                </span><span class="c1">// Обрабатываем случай, когда компания не найдена по ИНН.</span></code> <br/><code><span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="n">Length</span><span class="o">&lt;</span><span class="mi">15</span><span class="p">){</span></code> <br/><code><span class="w">                    </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Нет компании по такому ИНН"</span><span class="p">;</span></code> <br/><code><span class="w">                    </span><span class="n">successFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span></code> <br/><code><span class="w">                </span><span class="p">}</span></code> <br/><code><span class="w">                </span><span class="c1">// Обрабатываем другие ошибки.</span></code> <br/><code><span class="w">                </span><span class="k">else</span><span class="p">{</span></code> <br/><code><span class="w">                    </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Непредвиденная ошибка"</span><span class="p">;</span></code> <br/><code><span class="w">                </span><span class="p">}</span></code> <br/><code><span class="w">            </span><span class="p">}</span></code> <br/><code><span class="w">            </span><span class="c1">// Обрабатываем исключения при выполнении запроса к API.</span></code> <br/><code><span class="w">            </span><span class="k">catch</span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){</span></code> <br/><code><span class="w">                </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Проблема с ответом от ФНС. Ошибка: "</span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">Message</span><span class="p">;</span></code> <br/><code><span class="w">                </span><span class="n">successFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span></code> <br/><code><span class="w">            </span><span class="p">}</span></code> <br/><code><span class="w">        </span><span class="p">}</span></code> <br/><code><span class="w">        </span><span class="c1">// Обрабатываем случай, когда ИНН не указан в записи.</span></code> <br/><code><span class="w">        </span><span class="k">catch</span><span class="p">{</span></code> <br/><code><span class="w">            </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Укажите ИНН"</span><span class="p">;</span></code> <br/><code><span class="w">            </span><span class="n">successFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span></code> <br/><code><span class="w">        </span><span class="p">}</span></code> <br/><code><span class="w">        </span><span class="c1">// Формируем результат выполнения скрипта с сообщением для пользователя.</span></code> <br/><code><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserCommandResult</span><span class="p">{</span></code> <br/><code><span class="w">            </span><span class="n">Success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">successFlag</span><span class="p">,</span></code> <br/><code><span class="w">            </span><span class="n">Commited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span></code> <br/><code><span class="w">            </span><span class="n">ResultType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserCommandResultType</span><span class="p">.</span><span class="n">Notificate</span><span class="p">,</span></code> <br/><code><span class="w">            </span><span class="n">Messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">[]{</span></code> <br/><code><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">UserCommandMessage</span><span class="p">{</span></code> <br/><code><span class="w">                    </span><span class="n">Severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SeverityLevel</span><span class="p">.</span><span class="n">Normal</span><span class="p">,</span></code> <br/><code><span class="w">                    </span><span class="n">Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">text</span></code> <br/><code><span class="w">                </span><span class="p">}</span></code> <br/><code><span class="w">            </span><span class="p">}</span></code> <br/><code><span class="w">        </span><span class="p">};</span></code> <br/><code><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span></code> <br/><code><span class="w">    </span><span class="p">}</span></code> <br/><code><span class="p">}</span></code> <br/></pre></code></div>
</li>
<li>
<p>Сохраните кнопку.</p>
</li>
<li>Поместите кнопку <em>«Получить данные из ФНС»</em> на форму контрагента.</li>
</ol>
<h2 id="example_csharp_tax_service_integrate_test">Тестирование</h2>
<ol class="colored_numbers_list">
<li>Откройте или создайте запись контрагента.</li>
<li>Введите ИНН существующей компании или ИП.</li>
<li>Нажмите кнопку <em>«Получить данные из ФНС»</em>.</li>
<li>Через некоторое время поля записи должны заполниться данными из ФНС.</li>
<li>Убедитесь, что данные соответствуют типу контрагента (юридическое лицо или ИП).</li>
</ol>
<div class="notice notice-info">
<p class="admonition-title">Возможные сообщения об ошибках</p>
<ul>
<li><em>Укажите ИНН</em> — не указан ИНН контрагента.</li>
<li><em>Проблема с ответом от ФНС</em> — проблема обмена данными с API ФНС.</li>
<li><em>Нет компании по такому ИНН</em> — компания не найдена в базе ФНС.</li>
<li><em>Непредвиденная ошибка</em> — иные проблемы.</li>
</ul>
</div>
</article>
</div>
</div>
<a class="md-top md-icon mkdocs_imported_link" data-md-component="top" href="#">
<i class="fa-light fa-arrow-up">&zwnj;<!--icon--></i>
            К началу
          </a>
</main>
</div>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": true, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></div>
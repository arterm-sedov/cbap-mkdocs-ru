<div class="md-body" data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="comindware" dir="ltr" kb-id="5008" kb-tags="" kb-title="Выгрузка выбранных записей и столбцов из таблицы с помощью C#">
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<nav aria-label="Содержание" class="md-nav md-nav--secondary">
<div class="mce-toc">
<h2 class="toc-heading">
      Содержание
      </h2>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#example_csharp_table_download_selection_intro">
<span class="md-ellipsis">
      Введение
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#example_csharp_table_download_selection_use_case">
<span class="md-ellipsis">
      Прикладная задача
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#example_csharp_table_download_selection_script_configure">
<span class="md-ellipsis">
      Настройка скрипта
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#example_csharp_table_download_selection_test">
<span class="md-ellipsis">
      Тестирование скрипта
    </span>
</a>
</li>
</ul>
</div>
</nav>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h2 id="example_csharp_table_download_selection_intro">Введение</h2>
<p>Здесь представлен пример скрипта для скачивания выбранных столбцов и строк из таблицы в виде файла Excel.</p>
<p>Скрипт запускается по нажатию кнопки.</p>
<p>Приведённый пример скрипта поддерживает экспорт столбцов следующих типов:</p>
<ul>
<li><strong>Логический</strong></li>
<li><strong>Число</strong></li>
<li><strong>Длительность</strong></li>
<li><strong>Текст</strong></li>
<li><strong>Запись</strong></li>
<li><strong>Дата и время</strong></li>
<li><strong>Аккаунт</strong></li>
</ul>
<h2 id="example_csharp_table_download_selection_use_case">Прикладная задача</h2>
<p>Имеется шаблон <em>«Заявки»</em>.</p>
<p>Требуется экспортировать из таблицы в шаблоне <em>«Заявки»</em> строки и столбцы, выбранные пользователем.</p>
<p>Данные должны выгружаться в файл формата <code>.XLSX</code> по нажатию кнопки.</p>
<p>Пользователь выбирает столбцы и строки для экспорта следующим образом:</p>
<ul>
<li>устанавливает флажки выбора в требуемых строках;</li>
<li>скрывает ненужные столбцы с помощью меню «<strong>Мои настройки</strong>» <i class="fa-light fa-edit">&zwnj;<!--icon--></i> — «<strong>Настроить внешний вид</strong>» <i class="fa-light fa-table">&zwnj;<!--icon--></i>.</li>
</ul>
<h2 class="pageBreakBefore" id="example_csharp_table_download_selection_script_configure">Настройка скрипта</h2>
<div class="notice notice-warning">
<p class="admonition-title">Логика работы скрипта</p>
<p>Представленный здесь скрипт работает следующим образом:</p>
<ol class="colored_numbers_list">
<li>Получает список видимых и выбранных пользователем строк (записей) в таблице.</li>
<li>Получает список видимых столбцов на основе настроенного пользователем представления таблицы.</li>
<li>Создаёт пустой файл Excel с помощью библиотеки <code>Aspose.Cells</code>.</li>
<li>Заполняет файл данными из выбранных строк и столбцов.</li>
<li>Форматирует ячейки в Excel в соответствии с типом экспортируемых данных (текст, числа, даты и т. д.)</li>
<li>Формирует таблицу на листе для более наглядного отображения и фильтрации данных.</li>
<li>Возвращает сформированный файл пользователю для скачивания.</li>
<li>Обрабатывает возможные ошибки (отсутствие выбранных записей, сбои при экспорте).</li>
</ol>
</div>
<ol class="colored_numbers_list">
<li>
<p>В шаблоне <em>«Заявки»</em> создайте кнопку со следующими свойствами:</p>
<ul>
<li><strong>Отображаемое название:</strong> <em>Экспортировать в Excel</em></li>
<li><strong>Контекст операции: запись</strong></li>
<li><strong>Операция: C#-скрипт</strong></li>
<li><strong>Результат выполнения: скачать документ</strong></li>
</ul>
</li>
<li>
<p>Сохраните кнопку.</p>
</li>
<li>
<p>На вкладке «<strong>Скрипт</strong>» введите следующий код:</p>
<div class="highlight"><span class="filename">Скрипт для выгрузки выбранных ячеек из таблицы</span><code><pre><span></span><code><span class="c1">// Импорт базовых типов и функций .NET Framework для работы с основными типами данных.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span></code> <br/><code><span class="c1">// Импорт расширений LINQ для работы с коллекциями и выполнения запросов.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">System.Linq</span><span class="p">;</span></code> <br/><code><span class="c1">// Импорт классов для обработки нажатий кнопок и возврата результатов выполнения скрипта.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">Comindware.TeamNetwork.Api.Data.UserCommands</span><span class="p">;</span></code> <br/><code><span class="c1">// Импорт основных классов для работы с данными в {{ pdroductName }}.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">Comindware.TeamNetwork.Api.Data</span><span class="p">;</span></code> <br/><code><span class="c1">// Импорт классов для работы с формами.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">Comindware.TeamNetwork.Api.Data.Forms</span><span class="p">;</span></code> <br/><code><span class="c1">// Импорт классов для работы с потоками данных, файлами и операциями ввода-вывода.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">System.IO</span><span class="p">;</span></code> <br/><code><span class="c1">// Импорт библиотеки Aspose.Cells для создания и форматирования документов Excel.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">Aspose.Cells</span><span class="p">;</span></code> <br/><code><span class="c1">// Импорт дополнительных классов Aspose.Cells для работы с таблицами и их стилями в Excel.</span></code> <br/><code><span class="k">using</span><span class="w"> </span><span class="nn">Aspose.Cells.Tables</span><span class="p">;</span></code> <br/><code></code> <br/><code><span class="k">class</span><span class="w"> </span><span class="nc">Script</span></code> <br/><code><span class="p">{</span></code> <br/><code><span class="w">    </span><span class="c1">// userCommandContext содержит данные контекста при нажатии кнопки.</span></code> <br/><code><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">UserCommandResult</span><span class="w"> </span><span class="nf">Main</span><span class="p">(</span><span class="n">UserCommandContext</span><span class="w"> </span><span class="n">userCommandContext</span><span class="p">,</span><span class="w"> </span><span class="n">Comindware</span><span class="p">.</span><span class="n">Entities</span><span class="w"> </span><span class="n">entities</span><span class="p">)</span></code> <br/><code><span class="w">    </span><span class="p">{</span></code> <br/><code><span class="w">        </span><span class="c1">// Получаем ID выбранных записей (строк) в таблице при нажатии кнопки.</span></code> <br/><code><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">selectedTableRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userCommandContext</span><span class="p">.</span><span class="n">ObjectIds</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span></code> <br/><code><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">selectedTableRows</span><span class="p">.</span><span class="n">Count</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span></code> <br/><code><span class="w">        </span><span class="p">{</span></code> <br/><code><span class="w">            </span><span class="k">try</span></code> <br/><code><span class="w">            </span><span class="p">{</span></code> <br/><code><span class="w">                </span><span class="c1">// Получаем ID экспортируемой таблицы.</span></code> <br/><code><span class="w">                </span><span class="kt">var</span><span class="w"> </span><span class="n">tableToExportId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userCommandContext</span><span class="p">.</span><span class="n">Query</span><span class="p">.</span><span class="n">DatasetId</span><span class="p">;</span></code> <br/><code><span class="w">                </span><span class="c1">// Получаем параметры разбиения таблицы на страницы.</span></code> <br/><code><span class="w">                </span><span class="kt">var</span><span class="w"> </span><span class="n">paging</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userCommandContext</span><span class="p">.</span><span class="n">Query</span><span class="p">.</span><span class="n">Paging</span><span class="p">;</span></code> <br/><code><span class="w">                </span><span class="c1">// Получаем параметры сортировки данных в таблице.</span></code> <br/><code><span class="w">                </span><span class="kt">var</span><span class="w"> </span><span class="n">sorting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userCommandContext</span><span class="p">.</span><span class="n">Query</span><span class="p">.</span><span class="n">Sorting</span><span class="p">;</span></code> <br/><code><span class="w">                </span><span class="c1">// Получаем параметры фильтрации данных в таблице.</span></code> <br/><code><span class="w">                </span><span class="kt">var</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userCommandContext</span><span class="p">.</span><span class="n">Query</span><span class="p">.</span><span class="n">Filter</span><span class="p">;</span></code> <br/><code><span class="w">                </span><span class="c1">// Получаем ID шаблона, к которому относится таблица, по ID первой из записей.</span></code> <br/><code><span class="w">                </span><span class="kt">var</span><span class="w"> </span><span class="n">templateId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Api</span><span class="p">.</span><span class="n">Base</span><span class="p">.</span><span class="n">OntologyService</span><span class="p">.</span><span class="n">GetAxioms</span><span class="p">(</span><span class="n">selectedTableRows</span><span class="p">.</span><span class="n">First</span><span class="p">())[</span><span class="s">"cmw.container"</span><span class="p">].</span><span class="n">First</span><span class="p">().</span><span class="n">ToString</span><span class="p">();</span></code> <br/><code><span class="w">                </span><span class="c1">// Получаем все таблицы шаблона для дальнейшей обработки.</span></code> <br/><code><span class="w">                </span><span class="kt">var</span><span class="w"> </span><span class="n">templateTables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Api</span><span class="p">.</span><span class="n">TeamNetwork</span><span class="p">.</span><span class="n">DatasetService</span><span class="p">.</span><span class="n">GetQueries</span><span class="p">(</span><span class="n">templateId</span><span class="p">);</span><span class="w"> </span></code> <br/><code></code> <br/><code><span class="w">                </span><span class="c1">// Создаём пустой набор экспортируемых данных.</span></code> <br/><code><span class="w">                </span><span class="n">Dataset</span><span class="w"> </span><span class="n">datasetToExport</span><span class="p">;</span></code> <br/><code><span class="w">                </span><span class="c1">// Создаём пустой файл Excel для экспорта данных.</span></code> <br/><code><span class="w">                </span><span class="n">Workbook</span><span class="w"> </span><span class="n">excelWorkbook</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Workbook</span><span class="p">();</span></code> <br/><code><span class="w">                </span><span class="c1">// Получаем первый лист книги Excel для заполнения данными.</span></code> <br/><code><span class="w">                </span><span class="n">Worksheet</span><span class="w"> </span><span class="n">excelSheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">excelWorkbook</span><span class="p">.</span><span class="n">Worksheets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></code> <br/><code></code> <br/><code><span class="w">                </span><span class="c1">// Создаём стили для форматирования ячеек Excel.</span></code> <br/><code><span class="w">                </span><span class="kt">var</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">excelWorkbook</span><span class="p">.</span><span class="n">CreateStyle</span><span class="p">();</span></code> <br/><code><span class="w">                </span><span class="c1">// Разрешаем числовые типы для форматирования ячеек.</span></code> <br/><code><span class="w">                </span><span class="kt">var</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StyleFlag</span><span class="p">();</span></code> <br/><code><span class="w">                </span><span class="n">flag</span><span class="p">.</span><span class="n">NumberFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span></code> <br/><code></code> <br/><code></code> <br/><code></code> <br/><code><span class="w">                </span><span class="c1">// Перебираем все таблицы шаблона для поиска экспортируемой таблицы по её ID.</span></code> <br/><code><span class="w">                </span><span class="k">foreach</span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">templateTables</span><span class="p">)</span></code> <br/><code><span class="w">                </span><span class="p">{</span></code> <br/><code><span class="w">                    </span><span class="c1">// Применяем  к таблице параметры разбиения на страницы, сортировки и фильтрации.</span></code> <br/><code><span class="w">                    </span><span class="n">table</span><span class="p">.</span><span class="n">Paging</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paging</span><span class="p">;</span></code> <br/><code><span class="w">                    </span><span class="n">table</span><span class="p">.</span><span class="n">Sorting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sorting</span><span class="p">;</span></code> <br/><code><span class="w">                    </span><span class="n">table</span><span class="p">.</span><span class="n">Filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">;</span></code> <br/><code><span class="w">                    </span><span class="c1">// Проверяем, требуется ли экспортировать таблицу.</span></code> <br/><code><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">table</span><span class="p">.</span><span class="n">DatasetId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tableToExportId</span><span class="p">)</span></code> <br/><code><span class="w">                    </span><span class="p">{</span></code> <br/><code><span class="w">                        </span><span class="c1">// Получаем настроенную пользователем конфигурацию таблицы.</span></code> <br/><code><span class="w">                        </span><span class="kt">var</span><span class="w"> </span><span class="n">personalTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Api</span><span class="p">.</span><span class="n">TeamNetwork</span><span class="p">.</span><span class="n">DatasetConfigurationService</span><span class="p">.</span><span class="n">GetPersonalDataset</span><span class="p">(</span><span class="n">table</span><span class="p">.</span><span class="n">DatasetId</span><span class="p">);</span></code> <br/><code><span class="w">                        </span><span class="c1">// Получаем данные строки и столбцы таблицы, без учёта выбора пользователя.</span></code> <br/><code><span class="w">                        </span><span class="n">datasetToExport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Api</span><span class="p">.</span><span class="n">TeamNetwork</span><span class="p">.</span><span class="n">DatasetService</span><span class="p">.</span><span class="n">QueryData</span><span class="p">(</span><span class="n">table</span><span class="p">);</span></code> <br/><code><span class="w">                        </span><span class="c1">// Создаем массив контейнеров для хранения выбранных пользователем столбцов таблицы.</span></code> <br/><code><span class="w">                        </span><span class="kt">var</span><span class="w"> </span><span class="n">selectedTableColumns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">columnContainer</span><span class="p">[</span><span class="n">personalTable</span><span class="p">.</span><span class="n">Columns</span><span class="p">.</span><span class="n">Count</span><span class="p">()];</span></code> <br/><code><span class="w">                        </span><span class="c1">// Инициализируем счётчик столбцов.</span></code> <br/><code><span class="w">                        </span><span class="kt">var</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span></code> <br/><code><span class="w">                        </span><span class="c1">// Перебираем все столбцы настроенной пользователем таблицы.</span></code> <br/><code><span class="w">                        </span><span class="k">foreach</span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">coll</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">personalTable</span><span class="p">.</span><span class="n">Columns</span><span class="p">)</span></code> <br/><code><span class="w">                        </span><span class="p">{</span></code> <br/><code><span class="w">                            </span><span class="c1">// Проверяем, что столбец не скрыт пользователем.</span></code> <br/><code><span class="w">                            </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">coll</span><span class="p">.</span><span class="n">IsHidden</span><span class="p">)</span></code> <br/><code><span class="w">                            </span><span class="p">{</span></code> <br/><code><span class="w">                                </span><span class="c1">// Создаём контейнер с данными столбца.</span></code> <br/><code><span class="w">                                </span><span class="n">selectedTableColumns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">columnContainer</span><span class="p">(</span><span class="n">coll</span><span class="p">.</span><span class="n">DataSourceInfo</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span></code> <br/><code><span class="w">                                </span><span class="c1">// Записываем название столбца в заголовок Excel.</span></code> <br/><code><span class="w">                                </span><span class="n">excelSheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">].</span><span class="n">PutValue</span><span class="p">(</span><span class="n">coll</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span></code> <br/><code><span class="w">                                </span><span class="c1">// Получаем путь к свойству столбца для определения его типа.</span></code> <br/><code><span class="w">                                </span><span class="kt">var</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coll</span><span class="p">.</span><span class="n">DataSourceInfo</span><span class="p">.</span><span class="n">PropertyPath</span><span class="p">.</span><span class="n">Last</span><span class="p">().</span><span class="n">ToString</span><span class="p">();</span></code> <br/><code></code> <br/><code><span class="w">                                </span><span class="c1">// Проверяем, что атрибут в столбце не является системным.</span></code> <br/><code><span class="w">                                </span><span class="k">if</span><span class="p">(</span><span class="n">attribute</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">"id"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">"lastWriteDate"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">"creationDate"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">"В архиве"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">"creator"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">"processes"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">"isDisabled"</span><span class="p">)</span></code> <br/><code><span class="w">                                </span><span class="p">{</span></code> <br/><code><span class="w">                                    </span><span class="c1">// Получаем свойства атрибута для определения его типа.</span></code> <br/><code><span class="w">                                    </span><span class="kt">var</span><span class="w"> </span><span class="n">attributeProperties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Api</span><span class="p">.</span><span class="n">Base</span><span class="p">.</span><span class="n">OntologyService</span><span class="p">.</span><span class="n">GetAxioms</span><span class="p">(</span><span class="n">attribute</span><span class="p">);</span></code> <br/><code><span class="w">                                    </span><span class="c1">// Получаем тип атрибута.</span></code> <br/><code><span class="w">                                    </span><span class="n">attribute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attributeProperties</span><span class="p">[</span><span class="s">"cmw.propertyType"</span><span class="p">].</span><span class="n">Last</span><span class="p">().</span><span class="n">ToString</span><span class="p">();</span></code> <br/><code><span class="w">                                </span><span class="p">}</span></code> <br/><code></code> <br/><code></code> <br/><code></code> <br/><code><span class="w">                                </span><span class="c1">// Форматируем ячейки в соответствии с типом данных.</span></code> <br/><code><span class="w">                                </span><span class="k">switch</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span></code> <br/><code><span class="w">                                </span><span class="p">{</span></code> <br/><code><span class="w">                                    </span><span class="k">case</span><span class="w"> </span><span class="s">"xsd.decimal"</span><span class="p">:</span></code> <br/><code><span class="w">                                    </span><span class="p">{</span></code> <br/><code><span class="w">                                        </span><span class="c1">// Устанавливаем числовой формат (код 1) для десятичных чисел.</span></code> <br/><code><span class="w">                                        </span><span class="n">style</span><span class="p">.</span><span class="n">Number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span></code> <br/><code><span class="w">                                        </span><span class="c1">// Применяем формат к столбцу</span></code> <br/><code><span class="w">                                        </span><span class="n">excelSheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">.</span><span class="n">Columns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ApplyStyle</span><span class="p">(</span><span class="n">style</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">);</span></code> <br/><code><span class="w">                                    </span><span class="p">}</span></code> <br/><code><span class="w">                                    </span><span class="k">break</span><span class="p">;</span></code> <br/><code><span class="w">                                    </span><span class="k">case</span><span class="w"> </span><span class="s">"lastWriteDate"</span><span class="p">:</span></code> <br/><code><span class="w">                                        </span><span class="p">{</span></code> <br/><code><span class="w">                                            </span><span class="c1">// Устанавливаем формат даты (код 22) для столбца даты.</span></code> <br/><code><span class="w">                                            </span><span class="n">style</span><span class="p">.</span><span class="n">Number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">22</span><span class="p">;</span></code> <br/><code><span class="w">                                            </span><span class="c1">// Применяем формат к столбцу.</span></code> <br/><code><span class="w">                                            </span><span class="n">excelSheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">.</span><span class="n">Columns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ApplyStyle</span><span class="p">(</span><span class="n">style</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">);</span></code> <br/><code><span class="w">                                            </span><span class="c1">// Устанавливаем ширину столбца для отображения даты  и времени.</span></code> <br/><code><span class="w">                                            </span><span class="n">excelSheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">.</span><span class="n">Columns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span></code> <br/><code><span class="w">                                        </span><span class="p">}</span></code> <br/><code><span class="w">                                    </span><span class="k">break</span><span class="p">;</span></code> <br/><code><span class="w">                                    </span><span class="k">case</span><span class="w"> </span><span class="s">"creationDate"</span><span class="p">:</span></code> <br/><code><span class="w">                                        </span><span class="p">{</span></code> <br/><code><span class="w">                                            </span><span class="c1">// Устанавливаем формат даты (код 22) для столбца даты создания.</span></code> <br/><code><span class="w">                                            </span><span class="n">style</span><span class="p">.</span><span class="n">Number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">22</span><span class="p">;</span></code> <br/><code><span class="w">                                            </span><span class="c1">// Применяем формат к столбцу.</span></code> <br/><code><span class="w">                                            </span><span class="n">excelSheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">.</span><span class="n">Columns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ApplyStyle</span><span class="p">(</span><span class="n">style</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">);</span></code> <br/><code><span class="w">                                            </span><span class="c1">// Устанавливаем ширину столбца для отображения даты и времени.</span></code> <br/><code><span class="w">                                            </span><span class="n">excelSheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">.</span><span class="n">Columns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span></code> <br/><code><span class="w">                                        </span><span class="p">}</span></code> <br/><code><span class="w">                                    </span><span class="k">break</span><span class="p">;</span></code> <br/><code><span class="w">                                    </span><span class="k">case</span><span class="w"> </span><span class="s">"xsd.dateTime"</span><span class="p">:</span></code> <br/><code><span class="w">                                        </span><span class="p">{</span></code> <br/><code><span class="w">                                            </span><span class="c1">// Устанавливаем формат даты (код 22) для столбца даты и времени.</span></code> <br/><code><span class="w">                                            </span><span class="n">style</span><span class="p">.</span><span class="n">Number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">22</span><span class="p">;</span></code> <br/><code><span class="w">                                            </span><span class="c1">// Применяем формат к столбцу.</span></code> <br/><code><span class="w">                                            </span><span class="n">excelSheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">.</span><span class="n">Columns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ApplyStyle</span><span class="p">(</span><span class="n">style</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">);</span></code> <br/><code><span class="w">                                            </span><span class="c1">// Устанавливаем ширину столбца для отображения даты и времени.</span></code> <br/><code><span class="w">                                            </span><span class="n">excelSheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">.</span><span class="n">Columns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span></code> <br/><code><span class="w">                                        </span><span class="p">}</span></code> <br/><code><span class="w">                                    </span><span class="k">break</span><span class="p">;</span></code> <br/><code><span class="w">                                </span><span class="p">}</span></code> <br/><code><span class="w">                                </span><span class="c1">// Увеличиваем счётчик столбцов.</span></code> <br/><code><span class="w">                                </span><span class="n">i</span><span class="o">++</span><span class="p">;</span></code> <br/><code><span class="w">                            </span><span class="p">}</span></code> <br/><code><span class="w">                        </span><span class="p">}</span></code> <br/><code></code> <br/><code><span class="w">                        </span><span class="c1">// Инициализируем счётчик строк, начиная с 1 (0 — заголовки).</span></code> <br/><code><span class="w">                        </span><span class="kt">var</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span></code> <br/><code><span class="w">                        </span><span class="c1">// Инициализируем счётчик столбцов.</span></code> <br/><code><span class="w">                        </span><span class="kt">var</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span></code> <br/><code><span class="w">                        </span><span class="c1">// Перебираем все столбцы из набора данных для экспорта.</span></code> <br/><code><span class="w">                        </span><span class="k">foreach</span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">datasetColumn</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">datasetToExport</span><span class="p">.</span><span class="n">Columns</span><span class="p">)</span></code> <br/><code><span class="w">                        </span><span class="p">{</span></code> <br/><code><span class="w">                            </span><span class="k">try</span></code> <br/><code><span class="w">                            </span><span class="p">{</span></code> <br/><code><span class="w">                                </span><span class="c1">// Получаем идентификатор столбца в данных для экспорта.</span></code> <br/><code><span class="w">                                </span><span class="kt">var</span><span class="w"> </span><span class="n">columnId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datasetColumn</span><span class="p">.</span><span class="n">DataSourceInfo</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span></code> <br/><code><span class="w">                                </span><span class="c1">// Находим индекс столбца в массиве выбранных пользователем столбцов.</span></code> <br/><code><span class="w">                                </span><span class="kt">var</span><span class="w"> </span><span class="n">selectedColumnIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">selectedTableColumns</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">dataSourceId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">columnId</span><span class="p">).</span><span class="n">columnIndex</span><span class="p">;</span></code> <br/><code><span class="w">                                </span><span class="c1">// Сохраняем позицию столбца в массиве выбранных пользователем столбцов.</span></code> <br/><code><span class="w">                                </span><span class="n">selectedTableColumns</span><span class="p">[</span><span class="n">selectedColumnIndex</span><span class="p">].</span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span></code> <br/><code><span class="w">                            </span><span class="p">}</span><span class="k">catch</span><span class="p">{}</span></code> <br/><code><span class="w">                            </span><span class="c1">// Увеличиваем счётчик позиции.</span></code> <br/><code><span class="w">                            </span><span class="n">y</span><span class="o">++</span><span class="p">;</span></code> <br/><code><span class="w">                        </span><span class="p">}</span></code> <br/><code></code> <br/><code><span class="w">                        </span><span class="c1">// Перебираем все строки из набора данных.</span></code> <br/><code><span class="w">                        </span><span class="k">foreach</span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">datasetToExport</span><span class="p">.</span><span class="n">Rows</span><span class="p">)</span></code> <br/><code><span class="w">                        </span><span class="p">{</span></code> <br/><code><span class="w">                            </span><span class="c1">// Проверяем, что строка выбрана пользователем для экспорта.</span></code> <br/><code><span class="w">                            </span><span class="k">if</span><span class="p">(</span><span class="n">Array</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">selectedTableRows</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">row</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">null</span><span class="p">)</span></code> <br/><code><span class="w">                            </span><span class="p">{</span></code> <br/><code><span class="w">                                </span><span class="c1">// Получаем данные строки.</span></code> <br/><code><span class="w">                                </span><span class="kt">var</span><span class="w"> </span><span class="n">rowData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row</span><span class="p">.</span><span class="n">Data</span><span class="p">;</span></code> <br/><code><span class="w">                                </span><span class="c1">// Перебираем все видимые столбцы.</span></code> <br/><code><span class="w">                                </span><span class="k">for</span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">++</span><span class="p">)</span></code> <br/><code><span class="w">                                </span><span class="p">{</span></code> <br/><code><span class="w">                                    </span><span class="c1">// Получаем позицию столбца в исходных данных.</span></code> <br/><code><span class="w">                                    </span><span class="kt">var</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selectedTableColumns</span><span class="p">[</span><span class="n">jj</span><span class="p">].</span><span class="n">Position</span><span class="p">;</span></code> <br/><code><span class="w">                                    </span><span class="c1">// Проверяем, что данные в ячейке не пустые.</span></code> <br/><code><span class="w">                                    </span><span class="k">if</span><span class="p">(</span><span class="n">rowData</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">null</span><span class="p">)</span></code> <br/><code><span class="w">                                    </span><span class="p">{</span></code> <br/><code><span class="w">                                        </span><span class="c1">// Проверяем тип данных в ячейке и обрабатываем их соответственно.</span></code> <br/><code><span class="w">                                        </span><span class="k">if</span><span class="p">(</span><span class="n">rowData</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">GetType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">typeof</span><span class="p">(</span><span class="n">Comindware</span><span class="p">.</span><span class="n">TeamNetwork</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Forms</span><span class="p">.</span><span class="n">AccountReference</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">rowData</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">GetType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">typeof</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Boolean</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">rowData</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">GetType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">typeof</span><span class="p">(</span><span class="n">Comindware</span><span class="p">.</span><span class="n">TeamNetwork</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Forms</span><span class="p">.</span><span class="n">InstanceReference</span><span class="p">))</span></code> <br/><code><span class="w">                                        </span><span class="p">{</span></code> <br/><code><span class="w">                                            </span><span class="c1">// Для обычных типов данных просто записываем значение в ячейку.</span></code> <br/><code><span class="w">                                            </span><span class="n">excelSheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">jj</span><span class="p">].</span><span class="n">PutValue</span><span class="p">(</span><span class="n">rowData</span><span class="p">[</span><span class="n">ii</span><span class="p">]);</span></code> <br/><code><span class="w">                                        </span><span class="p">}</span></code> <br/><code><span class="w">                                        </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">rowData</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">GetType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">typeof</span><span class="p">(</span><span class="n">Comindware</span><span class="p">.</span><span class="n">TeamNetwork</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Forms</span><span class="p">.</span><span class="n">AccountReference</span><span class="p">))</span></code> <br/><code><span class="w">                                        </span><span class="p">{</span></code> <br/><code><span class="w">                                            </span><span class="c1">// Для ссылок на аккаунты записываем имя аккаунта.</span></code> <br/><code><span class="w">                                            </span><span class="n">excelSheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">jj</span><span class="p">].</span><span class="n">PutValue</span><span class="p">(((</span><span class="n">AccountReference</span><span class="p">)</span><span class="n">rowData</span><span class="p">[</span><span class="n">ii</span><span class="p">]).</span><span class="n">Name</span><span class="p">);</span></code> <br/><code><span class="w">                                        </span><span class="p">}</span></code> <br/><code></code> <br/><code><span class="w">                                        </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="p">(</span><span class="n">rowData</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">GetType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">typeof</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Boolean</span><span class="p">))</span></code> <br/><code><span class="w">                                        </span><span class="p">{</span></code> <br/><code><span class="w">                                            </span><span class="c1">// Логические значения преобразуем в строку.</span></code> <br/><code><span class="w">                                            </span><span class="k">if</span><span class="p">((</span><span class="kt">bool</span><span class="p">)</span><span class="n">rowData</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span></code> <br/><code><span class="w">                                            </span><span class="p">{</span></code> <br/><code><span class="w">                                                </span><span class="n">excelSheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">jj</span><span class="p">].</span><span class="n">PutValue</span><span class="p">(</span><span class="s">"Истина"</span><span class="p">);</span></code> <br/><code><span class="w">                                            </span><span class="p">}</span></code> <br/><code><span class="w">                                            </span><span class="k">else</span></code> <br/><code><span class="w">                                            </span><span class="p">{</span></code> <br/><code><span class="w">                                                </span><span class="n">excelSheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">jj</span><span class="p">].</span><span class="n">PutValue</span><span class="p">(</span><span class="s">"Ложь"</span><span class="p">);</span></code> <br/><code><span class="w">                                            </span><span class="p">}</span></code> <br/><code><span class="w">                                        </span><span class="p">}</span></code> <br/><code><span class="w">                                        </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="p">(</span><span class="n">rowData</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">GetType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">typeof</span><span class="p">(</span><span class="n">Comindware</span><span class="p">.</span><span class="n">TeamNetwork</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Forms</span><span class="p">.</span><span class="n">InstanceReference</span><span class="p">))</span></code> <br/><code><span class="w">                                        </span><span class="p">{</span></code> <br/><code><span class="w">                                            </span><span class="c1">// Для ссылок на записи записываем имя записи.</span></code> <br/><code><span class="w">                                            </span><span class="n">excelSheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">jj</span><span class="p">].</span><span class="n">PutValue</span><span class="p">(((</span><span class="n">Comindware</span><span class="p">.</span><span class="n">TeamNetwork</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Forms</span><span class="p">.</span><span class="n">InstanceReference</span><span class="p">)</span><span class="n">rowData</span><span class="p">[</span><span class="n">ii</span><span class="p">]).</span><span class="n">Name</span><span class="p">);</span></code> <br/><code><span class="w">                                        </span><span class="p">}</span></code> <br/><code><span class="w">                                    </span><span class="p">}</span></code> <br/><code><span class="w">                                </span><span class="p">}</span></code> <br/><code><span class="w">                                </span><span class="c1">// Увеличиваем счётчик строк после обработки текущей строки.</span></code> <br/><code><span class="w">                                </span><span class="n">j</span><span class="o">++</span><span class="p">;</span></code> <br/><code><span class="w">                            </span><span class="p">}</span></code> <br/><code><span class="w">                        </span><span class="p">}</span></code> <br/><code><span class="w">                        </span><span class="c1">// Формируем таблицу на листе Excel:</span></code> <br/><code><span class="w">                        </span><span class="c1">// - Применяем фильтры к заголовкам столбцов для сортировки и фильтрации данных.</span></code> <br/><code><span class="w">                        </span><span class="c1">// - Применяем чередующуюся заливку строк для наглядности.</span></code> <br/><code><span class="w">                        </span><span class="c1">// - Применяем автоматическое форматирование заголовков.</span></code> <br/><code><span class="w">                        </span><span class="c1">// - Параметры таблицы: </span></code> <br/><code><span class="w">                        </span><span class="c1">//   - начальные строка и столбец (0,0)</span></code> <br/><code><span class="w">                        </span><span class="c1">//   - конечные строка и столбец (j-1,i-1)</span></code> <br/><code><span class="w">                        </span><span class="c1">//   - включить заголовки (true)</span></code> <br/><code><span class="w">                        </span><span class="n">ListObject</span><span class="w"> </span><span class="n">listObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">excelSheet</span><span class="p">.</span><span class="n">ListObjects</span><span class="p">[</span><span class="n">excelSheet</span><span class="p">.</span><span class="n">ListObjects</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">true</span><span class="p">)];</span></code> <br/><code><span class="w">                    </span><span class="p">}</span></code> <br/><code><span class="w">                </span><span class="p">}</span></code> <br/><code></code> <br/><code><span class="w">                </span><span class="c1">// Создаем поток в памяти для сохранения файла Excel.</span></code> <br/><code><span class="w">                </span><span class="n">MemoryStream</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MemoryStream</span><span class="p">();</span></code> <br/><code><span class="w">                </span><span class="c1">// Сохраняем рабочую книгу в поток в формате XLSX.</span></code> <br/><code><span class="w">                </span><span class="n">excelWorkbook</span><span class="p">.</span><span class="n">Save</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">SaveFormat</span><span class="p">.</span><span class="n">Xlsx</span><span class="p">);</span></code> <br/><code></code> <br/><code><span class="w">                </span><span class="c1">// Формируем результат нажатия кнопки с успешным статусом.</span></code> <br/><code><span class="w">                </span><span class="kt">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserCommandResult</span></code> <br/><code><span class="w">                </span><span class="p">{</span></code> <br/><code><span class="w">                    </span><span class="n">Success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span></code> <br/><code><span class="w">                    </span><span class="n">Commited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span></code> <br/><code></code> <br/><code><span class="w">                    </span><span class="n">File</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">UserCommandFileResult</span><span class="p">(){</span></code> <br/><code><span class="w">                        </span><span class="n">Content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stream</span><span class="p">.</span><span class="n">ToArray</span><span class="p">(),</span></code> <br/><code><span class="w">                        </span><span class="c1">// Задаём имя файла для экспорта.</span></code> <br/><code><span class="w">                        </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"ЭкспортИзТаблицы.xlsx"</span></code> <br/><code><span class="w">                        </span><span class="p">},</span></code> <br/><code></code> <br/><code></code> <br/><code></code> <br/><code><span class="w">                    </span><span class="n">Messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">[]</span></code> <br/><code><span class="w">                    </span><span class="p">{</span></code> <br/><code><span class="w">                        </span><span class="k">new</span><span class="w"> </span><span class="n">UserCommandMessage</span></code> <br/><code><span class="w">                        </span><span class="p">{</span></code> <br/><code><span class="w">                            </span><span class="n">Severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SeverityLevel</span><span class="p">.</span><span class="n">Normal</span><span class="p">,</span></code> <br/><code><span class="w">                            </span><span class="n">Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Экспорт выполнен"</span></code> <br/><code><span class="w">                            </span><span class="p">}</span></code> <br/><code><span class="w">                    </span><span class="p">}</span></code> <br/><code><span class="w">                </span><span class="p">};</span></code> <br/><code><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span></code> <br/><code></code> <br/><code><span class="w">            </span><span class="p">}</span></code> <br/><code><span class="w">            </span><span class="k">catch</span></code> <br/><code><span class="w">            </span><span class="p">{</span></code> <br/><code><span class="w">                </span><span class="c1">// Формируем результат нажатия кнопки с ошибкой.</span></code> <br/><code><span class="w">                </span><span class="kt">var</span><span class="w"> </span><span class="n">result1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserCommandResult</span></code> <br/><code><span class="w">                </span><span class="p">{</span></code> <br/><code><span class="w">                    </span><span class="n">Success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">,</span></code> <br/><code><span class="w">                    </span><span class="n">Commited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span></code> <br/><code><span class="w">                    </span><span class="n">Messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">[]</span></code> <br/><code><span class="w">                    </span><span class="p">{</span></code> <br/><code><span class="w">                        </span><span class="k">new</span><span class="w"> </span><span class="n">UserCommandMessage</span></code> <br/><code><span class="w">                        </span><span class="p">{</span></code> <br/><code><span class="w">                            </span><span class="n">Severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SeverityLevel</span><span class="p">.</span><span class="n">Normal</span><span class="p">,</span></code> <br/><code><span class="w">                            </span><span class="n">Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Не удалось выполнить экспорт"</span></code> <br/><code><span class="w">                            </span><span class="p">}</span></code> <br/><code><span class="w">                    </span><span class="p">}</span></code> <br/><code><span class="w">                </span><span class="p">};</span></code> <br/><code><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">result1</span><span class="p">;</span></code> <br/><code><span class="w">            </span><span class="p">}</span></code> <br/><code><span class="w">        </span><span class="p">}</span></code> <br/><code><span class="w">        </span><span class="k">else</span></code> <br/><code><span class="w">        </span><span class="p">{</span></code> <br/><code><span class="w">            </span><span class="c1">// Формируем результат нажатия кнопки с ошибкой, если не выбрано ни одной записи.</span></code> <br/><code><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">result1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserCommandResult</span></code> <br/><code><span class="w">            </span><span class="p">{</span></code> <br/><code><span class="w">                </span><span class="n">Success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">,</span></code> <br/><code><span class="w">                </span><span class="n">Commited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span></code> <br/><code><span class="w">                </span><span class="n">Messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">[]</span></code> <br/><code><span class="w">                </span><span class="p">{</span></code> <br/><code><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">UserCommandMessage</span></code> <br/><code><span class="w">                    </span><span class="p">{</span></code> <br/><code><span class="w">                        </span><span class="n">Severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SeverityLevel</span><span class="p">.</span><span class="n">Normal</span><span class="p">,</span></code> <br/><code><span class="w">                        </span><span class="n">Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Выберите хотя бы одну строку таблицы для экспорта"</span></code> <br/><code><span class="w">                        </span><span class="p">}</span></code> <br/><code><span class="w">                </span><span class="p">}</span></code> <br/><code><span class="w">            </span><span class="p">};</span></code> <br/><code><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">result1</span><span class="p">;</span></code> <br/><code><span class="w">        </span><span class="p">}</span></code> <br/><code><span class="w">    </span><span class="p">}</span></code> <br/><code></code> <br/><code></code> <br/><code></code> <br/><code><span class="w">    </span><span class="c1">// Вспомогательный класс для хранения информации о столбцах таблицы.</span></code> <br/><code><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">columnContainer</span></code> <br/><code><span class="w">    </span><span class="p">{</span></code> <br/><code><span class="w">        </span><span class="c1">// Индекс выбранного пользователем столбца.</span></code> <br/><code><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">columnIndex</span><span class="w"> </span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;}</span></code> <br/><code><span class="w">        </span><span class="c1">// Позиция столбца в исходных данных.</span></code> <br/><code><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;}</span></code> <br/><code><span class="w">        </span><span class="c1">// Идентификатор источника данных столбца.</span></code> <br/><code><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">dataSourceId</span><span class="w"> </span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;}</span></code> <br/><code></code> <br/><code><span class="w">        </span><span class="c1">// Конструктор класса.</span></code> <br/><code><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">columnContainer</span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="p">)</span></code> <br/><code><span class="w">        </span><span class="p">{</span></code> <br/><code><span class="w">            </span><span class="n">dataSourceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="n">columnIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="p">;</span></code> <br/><code><span class="w">        </span><span class="p">}</span></code> <br/><code><span class="w">    </span><span class="p">}</span></code> <br/><code><span class="p">}</span></code> <br/></pre></code></div>
</li>
<li>
<p>Сохраните кнопку.</p>
</li>
<li>Поместите кнопку <em>«Экспортировать в Excel»</em> на <strong>область кнопок</strong> таблицы «<strong>Все записи</strong>» шаблона <em>«Заявки»</em>.</li>
</ol>
<h2 id="example_csharp_table_download_selection_test">Тестирование скрипта</h2>
<ol class="colored_numbers_list">
<li>Откройте таблицу «<strong>Все записи</strong>» шаблона <em>«Заявки»</em>.</li>
<li>Откройте меню «<strong>Мои настройки</strong>» <i class="fa-light fa-edit">&zwnj;<!--icon--></i> — «<strong>Настроить внешний вид</strong>» <i class="fa-light fa-table">&zwnj;<!--icon--></i>.</li>
<li>Скройте любой из столбцов таблицы и сохраните настройки внешнего вида.</li>
<li>Выберите требуемые строки в таблице с помощью флажков в левом столбце.</li>
<li>Нажмите кнопку <em>«Экспортировать в Excel»</em>.</li>
<li>Браузер должен скачать файл формата <code>.XLSX</code> с выбранными данными.</li>
</ol>
</article>
</div>
</div>
<a class="md-top md-icon mkdocs_imported_link" data-md-component="top" href="#">
<i class="fa-light fa-arrow-up">&zwnj;<!--icon--></i>
            К началу
          </a>
</main>
</div>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": true, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></div>
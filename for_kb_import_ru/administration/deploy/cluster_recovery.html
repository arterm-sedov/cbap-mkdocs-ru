<div class="md-body" data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="comindware" dir="ltr" kb-id="5135" kb-tags="Ignite,Grafana,Kafka,Loki,OpenSearch,Prometheus,администрирование,архитектура,балансировка нагрузки,восстановление,кластер,кластеризация,мониторинг,отказоустойчивость,развёртывание,резервное копирование,управление кластером" kb-title="Кластер Comindware Platform. Восстановление после аварий">
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<nav aria-label="Содержание" class="md-nav md-nav--secondary">
<div class="mce-toc">
<h2 class="toc-heading">
      Содержание
      </h2>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_about">
<span class="md-ellipsis">
      Введение
    </span>
</a>
<nav aria-label="Введение" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_philosophy">
<span class="md-ellipsis">
      Основные принципы восстановления кластера
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_architecture">
<span class="md-ellipsis">
      Архитектурные основы восстановления
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_strategies">
<span class="md-ellipsis">
      Рекомендации по восстановлению кластера
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_key_principles">
<span class="md-ellipsis">
      Ключевые этапы восстановления
    </span>
</a>
<nav aria-label="Ключевые этапы восстановления" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_preparation">
<span class="md-ellipsis">
      Подготовка к восстановлению
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_monitoring">
<span class="md-ellipsis">
      Мониторинг во время восстановления
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_verification">
<span class="md-ellipsis">
      Проверка после восстановления
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_single_node">
<span class="md-ellipsis">
      Восстановление одного узла
    </span>
</a>
<nav aria-label="Восстановление одного узла" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_complete_cluster">
<span class="md-ellipsis">
      Полное восстановление кластера
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#подготовка-к-восстановлению">
<span class="md-ellipsis">
      Подготовка к восстановлению
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#восстановление-данных">
<span class="md-ellipsis">
      Восстановление данных
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#запуск-узлов">
<span class="md-ellipsis">
      Запуск узлов
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#проверка-восстановления">
<span class="md-ellipsis">
      Проверка восстановления
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_single_node">
<span class="md-ellipsis">
      Восстановление одного узла
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#диагностика-отказа-узла">
<span class="md-ellipsis">
      Диагностика отказа узла
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#восстановление-узла">
<span class="md-ellipsis">
      Восстановление узла
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#синхронизация-с-кластером">
<span class="md-ellipsis">
      Синхронизация с кластером
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#проверка-восстановления_1">
<span class="md-ellipsis">
      Проверка восстановления
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_monitoring">
<span class="md-ellipsis">
      Мониторинг и диагностика
    </span>
</a>
<nav aria-label="Мониторинг и диагностика" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_monitoring_philosophy">
<span class="md-ellipsis">
      Мониторинг в ходе восстановления
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_health_indicators">
<span class="md-ellipsis">
      Ключевые индикаторы состояния
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_diagnosis">
<span class="md-ellipsis">
      Диагностика проблем
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_troubleshooting">
<span class="md-ellipsis">
      Устранение неполадок
    </span>
</a>
<nav aria-label="Устранение неполадок" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_common_issues">
<span class="md-ellipsis">
      Частые проблемы при восстановлении
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_logs">
<span class="md-ellipsis">
      Журналы для диагностики
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_diagnostic_tools">
<span class="md-ellipsis">
      Инструменты диагностики
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_strategic_principles">
<span class="md-ellipsis">
      Стратегические принципы восстановления
    </span>
</a>
<nav aria-label="Стратегические принципы восстановления" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_preparation_philosophy">
<span class="md-ellipsis">
      Подготовка к авариям
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_backup_strategy">
<span class="md-ellipsis">
      Стратегия резервного копирования
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_testing">
<span class="md-ellipsis">
      Тестирование восстановления
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_monitoring_culture">
<span class="md-ellipsis">
      Мониторинг
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_architectures">
<span class="md-ellipsis">
      Специфика восстановления различных архитектур
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_component_scenarios">
<span class="md-ellipsis">
      Сценарии восстановления по компонентам
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_specific_scenarios">
<span class="md-ellipsis">
      Специфические сценарии восстановления
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_environment_scenarios">
<span class="md-ellipsis">
      Восстановление по типам контуров
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#cluster_recovery_anti_patterns">
<span class="md-ellipsis">
      Практики, которых следует избегать
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link mkdocs_imported_link" href="#связанные-статьи">
<span class="md-ellipsis">
      Связанные статьи
    </span>
</a>
</li>
</ul>
</div>
</nav>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<div class="notice notice-error">
<p class="admonition-title">Экспериментальная функция</p>
<p>Представленная здесь функция находится на стадии разработки. См. <em>«<a class="mkdocs_imported_link" href="https://kb.comindware.ru/article.php?id=4579#experimental_feature_support">Поддержка экспериментальных функций</a>»</em>.</p>
</div>
<h2 id="cluster_recovery_about">Введение</h2>
<p><strong>Comindware Platform</strong> поддерживает кластерные конфигурации, которые обеспечивают высокую доступность, отказоустойчивость и горизонтальное масштабирование.</p>
<p>Здесь представлены рекомендации и процедуры восстановления ПО <strong>Comindware Platform</strong> в кластерных конфигурациях после сбоев.</p>
<h3 id="cluster_recovery_philosophy">Основные принципы восстановления кластера</h3>
<p>Кластерная архитектура <strong>Comindware Platform</strong> позволяет восстанавливать систему благодаря следующим возможностям:</p>
<ul>
<li><strong>Проверка здоровья узлов</strong>: все узлы предоставляют эндпоинт <code>api/health</code> для мониторинга состояния.</li>
<li><strong>Автоматическое перераспределение трафика</strong>: балансировщик нагрузки должен автоматически исключать неисправные узлы.</li>
<li><strong>Резервные узлы</strong>: Apache Ignite, OpenSearch (Elasticsearch) и Apache Kafka обеспечивают избыточность во время восстановления.</li>
<li><strong>Распределённое хранилище</strong>: DFS обеспечивает синхронизацию данных для всех узлов.</li>
</ul>
<p>При восстановлении кластера <strong>Comindware Platform</strong> соблюдайте рекомендованный порядок:</p>
<ol class="colored_numbers_list">
<li><strong>Диагностика проблемы</strong>: определите причину сбоя и масштаб повреждений.</li>
<li><strong>Выберите стратегию восстановления</strong>: восстановление одного узла или полное восстановление кластера.</li>
<li><strong>Выполните восстановление</strong>: следуйте процедурам для выбранной стратегии.</li>
<li><strong>Проверьте работоспособность</strong>: убедитесь, что все компоненты функционируют корректно.</li>
</ol>
<h3 id="cluster_recovery_architecture">Архитектурные основы восстановления</h3>
<p>Кластерная архитектура <strong>Comindware Platform</strong> обеспечивает восстановление благодаря следующим компонентам:</p>
<p><strong>Распределённое хранилище данных Apache Ignite</strong> — обеспечивает репликацию данных между узлами, высокую доступность и производительность обработки данных.</p>
<p><strong>Шина сообщений Apache Kafka</strong> — обеспечивает межсервисное взаимодействие и обработку событий.</p>
<p><strong>Хранилище журналов событий OpenSearch (Elasticsearch)</strong> — обеспечивает сбор, индексирование и обработку журналов распределённых событий.</p>
<p><strong>Распределённая файловая система (DFS)</strong> — общее хранилище файлов может быть реализовано на NFS или S3. Обеспечивает хранение загружаемых пользовательских файлов и других бинарных данных.</p>
<p><strong>Управление рабочими процессами</strong> — только один узел выполняет критические фоновые задачи (резервное копирование, обработка процессов).</p>
<h2 class="pageBreakBefore" id="cluster_recovery_strategies">Рекомендации по восстановлению кластера</h2>
<ul>
<li><strong>Запланируйте восстановление</strong>:</li>
<li>Определите причину сбоя и масштаб повреждений.</li>
<li>Выберите подходящую стратегию восстановления.</li>
<li>Подготовьте план действий и необходимые ресурсы.</li>
<li><strong>Заранее протестируйте восстановление в изолированной среде</strong>:</li>
<li>Создайте тестовую копию кластера.</li>
<li>Протестируйте процедуры восстановления.</li>
<li>Проверьте совместимость восстановленного кластера с существующими данными.</li>
<li><strong>Контролируйте работоспособность кластера в процессе восстановления</strong>:</li>
<li>Отслеживайте состояние всех компонентов и сервисов.</li>
<li>Контролируйте состояние топологии кластера Apache Ignite.</li>
<li>Замеряйте производительность системы.</li>
<li>Будьте готовы к немедленному откату при необходимости.</li>
</ul>
<h2 class="pageBreakBefore" id="cluster_recovery_key_principles">Ключевые этапы восстановления</h2>
<h3 id="cluster_recovery_preparation">Подготовка к восстановлению</h3>
<ul>
<li>Создайте резервную копию данных <strong>Comindware Platform</strong>, чтобы упростить восстановление кластера в случае проблем.</li>
<li>Проверьте доступность и работоспособность Apache Ignite, OpenSearch (Elasticsearch) и Apache Kafka, чтобы кластер сохранял работоспособность во время восстановления.</li>
<li>Проанализируйте журналы на предмет наличия ошибок и предупреждений, которые могут помешать восстановлению.</li>
</ul>
<h3 id="cluster_recovery_monitoring">Мониторинг во время восстановления</h3>
<ul>
<li>Постоянно контролируйте эндпоинт <code>api/health</code> на всех узлах, он должен возвращать статус <code>200</code>.</li>
<li>Анализируйте журналы состояния <strong>Comindware Platform</strong> (<code>heartbeat_*.log</code>).</li>
<li>Контролируйте журнал Apache Ignite (<code>igniteClient_*.log</code>).</li>
<li>Контролируйте состояние топологии кластера Apache Ignite с нескольких узлов во время восстановления.</li>
<li>Контролируйте синхронизацию данных между узлами.</li>
</ul>
<h3 id="cluster_recovery_verification">Проверка после восстановления</h3>
<ul>
<li>Дождитесь сообщения об окончании ребалансировки кластера.</li>
<li>Найдите в журналах балансировщика сообщение <code>INFO Skipping rebalancing (nothing scheduled)</code>.</li>
<li>Проверьте результирующую топологию Apache Ignite с нескольких узлов.</li>
</ul>
<h2 class="pageBreakBefore" id="cluster_recovery_single_node">Восстановление одного узла</h2>
<div class="notice notice-warning">
<p class="admonition-title">Фактические пути и имена файлов</p>
<p>При выполнении инструкций будьте внимательны: указывайте фактические имена файлов и пути, которые используются в вашей системе.</p>
<p>Такие имена указаны в угловых скобках, например:</p>
<ul>
<li><code>&lt;instanceName&gt;</code> — имя экземпляра ПО, для которого выполняется восстановление;</li>
<li><code>&lt;osName&gt;</code> — название операционной системы, для которой предназначен дистрибутив (например, <code>Astra</code>);</li>
<li><code>&lt;versionNumber&gt;</code> — номер версии ПО.</li>
<li><code>&lt;path/to&gt;</code> — путь к директории или файлу в вашей системе; замените на фактический путь согласно своей структуре каталогов.</li>
<li><code>&lt;serviceName&gt;</code> — имя службы, которую требуется проверить или остановить (например, <code>comindware&lt;instanceName&gt;</code>,<code>apigateway&lt;instanceName&gt;</code>, <code>adapterhost&lt;instanceName&gt;</code>);</li>
</ul>
<p>См. <em>«<a class="mkdocs_imported_link" href="https://kb.comindware.ru/article.php?id=4620">Пути и содержимое директорий экземпляра ПО</a>»</em>.</p>
</div>
<h3 id="cluster_recovery_complete_cluster">Полное восстановление кластера</h3>
<h3 id="подготовка-к-восстановлению">Подготовка к восстановлению</h3>
<ul>
<li>Убедитесь в наличии актуальной резервной копии данных.</li>
<li>Проверьте целостность резервных копий.</li>
<li>Убедитесь в работоспособности Apache Ignite, OpenSearch (Elasticsearch) и Apache Kafka.</li>
<li>Проверьте доступность распределённой файловой системы (DFS).</li>
</ul>
<h3 id="восстановление-данных">Восстановление данных</h3>
<ul>
<li>Остановите все узлы кластера в правильном порядке.</li>
<li>Восстановите данные из резервной копии на основной узел.</li>
<li>Восстановите файлы из общего хранилища (NFS).</li>
<li>Восстановите индексы OpenSearch (Elasticsearch).</li>
<li>Восстановите конфигурационные файлы узлов.</li>
</ul>
<h3 id="запуск-узлов">Запуск узлов</h3>
<ul>
<li>Запустите узлы в порядке приоритета (сначала основной узел, затем дополнительные).</li>
<li>Запустите службы в правильном порядке: Apache Ignite (по необходимости) → Comindware Platform → API Gateway → NGINX.</li>
<li>Проверьте подключение каждого узла к кластеру.</li>
<li>Проверьте подключение каждого узла к сервисам (Apache Kafka, {{ opensearchVariants }}).</li>
<li>Дождитесь сообщения об окончании ребалансировки: <code>INFO Skipping rebalancing (nothing scheduled)</code>.</li>
</ul>
<h3 id="проверка-восстановления">Проверка восстановления</h3>
<ul>
<li>Убедитесь, что все узлы возвращают статус <code>200</code> на эндпоинте <code>api/health</code>.</li>
<li>Проверьте время отклика всех узлов.</li>
<li>Протестируйте балансировку нагрузки.</li>
</ul>
<p><strong>Протестируйте функциональность:</strong></p>
<ul>
<li>Протестируйте все основные функции <strong>Comindware Platform</strong>.</li>
<li>Проверьте работу интеграций.</li>
<li>Проконтролируйте производительность всех компонентов.</li>
</ul>
<p><strong>Проверьте синхронизацию данных:</strong></p>
<ul>
<li>Убедитесь в синхронизации данных между узлами.</li>
<li>Проверьте репликацию в Apache Ignite.</li>
<li>Протестируйте операции чтения/записи.</li>
</ul>
<p><strong>Проверьте конфигурацию рабочих процессов:</strong></p>
<ul>
<li>Убедитесь, что только один узел имеет включённые службы <code>BackupSessionsQueue</code> и <code>ProcessEngineQueueProcessing</code>.</li>
<li>Проверьте файлы конфигурации на всех узлах:<ul>
<li><code>/usr/share/comindware/configs/instance/&lt;instanceName&gt;.yml</code></li>
<li><code>/var/www/&lt;instanceName&gt;/adapterhost.yml</code></li>
<li><code>/var/www/&lt;instanceName&gt;/apigateway.yml</code></li>
</ul>
</li>
</ul>
<h3 id="cluster_recovery_single_node">Восстановление одного узла</h3>
<p>Когда отказывает один узел, остальные узлы кластера продолжают обрабатывать нагрузку. Данные остаются доступными через другие узлы, а конфигурация кластера не теряется.</p>
<p><strong>Типы узлов:</strong></p>
<ul>
<li><strong>Узлы сервера приложений</strong> — выполняют функции <strong>Comindware Platform</strong> и участвуют в кластере Apache Ignite.</li>
<li><strong>Клиентские узлы</strong> — работают в режиме тонкого клиента и подключаются к серверным узлам.</li>
<li><strong>Узлы с служебными процессами</strong> — только один узел должен выполнять критические фоновые задачи.</li>
</ul>
<p><strong>Стратегии восстановления:</strong></p>
<ul>
<li><strong>Быстрое восстановление</strong> — перезапуск служб без изменения конфигурации.</li>
<li><strong>Восстановление с ребалансировкой</strong> — восстановление данных с других узлов кластера.</li>
<li><strong>Полное восстановление узла</strong> — восстановление из резервной копии с последующей ребалансировкой.</li>
</ul>
<h3 id="диагностика-отказа-узла">Диагностика отказа узла</h3>
<ul>
<li>Используйте эндпоинт <code>api/health</code> для проверки состояния узла.</li>
<li>Проверьте журналы состояния экземпляра <strong>Comindware Platform</strong> (<code>heartbeat_*.log</code>).</li>
<li>Проверьте журналы Apache Ignite (<code>igniteClient_*.log</code>).</li>
<li>Проверьте состояние файловой системы.</li>
<li>Проверьте доступность сетевых ресурсов.</li>
<li>Проверьте текущее состояние топологии кластера Apache Ignite со всех узлов.</li>
</ul>
<h3 id="восстановление-узла">Восстановление узла</h3>
<ol class="colored_numbers_list">
<li>
<p>Остановите проблемный узел:</p>
<p><div class="highlight"><code><pre><span></span><code>systemctl<span class="w"> </span>stop<span class="w"> </span>comindware&lt;instanceName&gt;</code> <br/></pre></code></div>
2. Исправьте выявленные проблемы.
3. При необходимости восстановите из резервной копии.
4. Проверьте конфигурацию узла.
5. Запустите узел:</p>
<div class="highlight"><code><pre><span></span><code>systemctl<span class="w"> </span>start<span class="w"> </span>comindware&lt;instanceName&gt;</code> <br/></pre></code></div>
</li>
</ol>
<h3 id="синхронизация-с-кластером">Синхронизация с кластером</h3>
<ol class="colored_numbers_list">
<li>
<p>Проверьте подключение к Apache Ignite. Для этого выполните на восстановленном и соседнем узлах команду:</p>
<div class="highlight"><code><pre><span></span><code>bash<span class="w"> </span>/usr/share/ignite/bin/control.sh<span class="w"> </span>--baseline</code> <br/></pre></code></div>
</li>
<li>
<p>Удостоверьтесь, что топологии совпадают на всех узлах.</p>
</li>
<li>Дождитесь сообщения: <code>INFO Skipping rebalancing (nothing scheduled)</code> в <code>igniteClient_*.log</code>.</li>
<li>В случае полного восстановления кластера создайте файл <code>hold.lock</code> в директории базы данных. Этот файл служит для блокировки передачи запросов из веб-интерфейса <strong>Comindware Platform</strong> в БД Apache Ignite до завершения ребалансировки узла.</li>
<li>Удалите файл <code>hold.lock</code>, чтобы снова активировать кластер.</li>
</ol>
<h3 id="проверка-восстановления_1">Проверка восстановления</h3>
<ol class="colored_numbers_list">
<li>Убедитесь, что эндпоинт <code>api/health</code> возвращает статус <code>200</code>.</li>
<li>Проверьте время отклика (не должно превышать 5 секунд).</li>
<li>Проанализируйте журналы на предмет ошибок.</li>
<li>Проверьте синхронизацию данных между узлами.</li>
<li>Убедитесь, что критически важные службы активны только на одном узле.</li>
</ol>
<h2 class="pageBreakBefore" id="cluster_recovery_monitoring">Мониторинг и диагностика</h2>
<h3 id="cluster_recovery_monitoring_philosophy">Мониторинг в ходе восстановления</h3>
<p>Во время восстановления система находится в переходном состоянии. Мониторинг помогает:</p>
<ul>
<li>оценить прогресс восстановления;</li>
<li>выявить новые проблемы, возникшие в процессе;</li>
<li>принять решение о готовности системы к полноценной работе</li>
</ul>
<h3 id="cluster_recovery_health_indicators">Ключевые индикаторы состояния</h3>
<p><strong>Эндпоинт <code>api/health</code>:</strong></p>
<ul>
<li>Статус <code>200 OK</code> — узел работает корректно<ul>
<li>Время отклика не должно превышать 5 секунд</li>
</ul>
</li>
<li>Проверяйте регулярно, например каждые 30 секунд</li>
</ul>
<p><strong>Apache Ignite:</strong></p>
<ul>
<li>Контролируйте топологию кластера.</li>
<li>Отслеживайте состояние репликации данных.</li>
<li>Контролируйте производительность операций чтения и записи.</li>
</ul>
<p><strong>OpenSearch (Elasticsearch):</strong></p>
<ul>
<li>Используйте эндпоинт <code>/_cluster/health</code> для проверки состояния</li>
<li>Проверяйте состояние индексов и их репликации</li>
<li>Отслеживайте производительность поисковых запросов</li>
</ul>
<p><strong>Apache Kafka:</strong></p>
<ul>
<li>Контролируйте состояние топиков и партиций.</li>
<li>Отслеживайте задержки обработки сообщений.</li>
<li>Контролируйте размер очередей сообщений.</li>
</ul>
<h3 id="cluster_recovery_diagnosis">Диагностика проблем</h3>
<p><strong>Проверьте состояние узлов:</strong></p>
<ul>
<li>Используйте эндпоинт <code>api/health</code> для проверки состояния узлов <strong>Comindware Platform</strong>.</li>
<li>Контролируйте журналы состояния экземпляра <strong>Comindware Platform</strong> (<code>heartbeat_*.log</code>).</li>
<li>Контролируйте журналы Apache Ignite (<code>igniteClient_*.log</code>).</li>
</ul>
<p><strong>Проверьте кластерные компоненты:</strong></p>
<ul>
<li>Проверьте топологию кластера Apache Ignite с помощью инструментов управления.</li>
<li>Используйте эндпоинт <code>/_cluster/health</code> для проверки состояния OpenSearch (Elasticsearch).</li>
<li>Контролируйте состояние топиков и партиций Apache Kafka.</li>
</ul>
<p><strong>Анализируйте журналы:</strong></p>
<ul>
<li>Ищите критические ошибки и предупреждения.</li>
<li>Проверьте сообщения о ребалансировке кластера.</li>
<li>Отслеживайте производительность операций.</li>
</ul>
<h2 class="pageBreakBefore" id="cluster_recovery_troubleshooting">Устранение неполадок</h2>
<h3 id="cluster_recovery_common_issues">Частые проблемы при восстановлении</h3>
<ul>
<li><strong>Узел не подключается к кластеру Apache Ignite</strong>: проверьте сетевое подключение между узлами, конфигурацию Apache Ignite, файрвол и сетевые настройки.</li>
<li><strong>Ошибки синхронизации данных</strong>: проверьте доступность NFS-сервера, права доступа к файлам, состояние дискового пространства, конфигурацию монтирования в <code>/etc/fstab</code>.</li>
<li><strong>Проблемы с балансировщиком нагрузки</strong>: проверьте конфигурацию балансировщика, доступность эндпоинта <code>api/health</code>, настройки проверки состояния узлов.</li>
<li><strong>Проблемы с NFS-монтированием</strong>: проверьте доступность NFS-сервера, настройки в <code>/etc/fstab</code>, права доступа к общим директориям.</li>
</ul>
<h3 id="cluster_recovery_logs">Журналы для диагностики</h3>
<p><strong>Основные журналы Comindware Platform:</strong></p>
<ul>
<li><code>heartbeat_*.log</code> — состояние экземпляра и процесс запуска</li>
<li><code>igniteClient_*.log</code> — подключение к Apache Ignite и ребалансировка кластера</li>
</ul>
<p><strong>Журналы инфраструктуры:</strong></p>
<ul>
<li>Журналы Apache Ignite — состояние кластера хранилища данных.</li>
<li>Журналы OpenSearch (Elasticsearch) — состояние кластера журналирования транзакций.</li>
<li>Журналы Apache Kafka — состояние очередей сообщений.</li>
</ul>
<h3 id="cluster_recovery_diagnostic_tools">Инструменты диагностики</h3>
<p><strong>Проверка состояния узлов:</strong></p>
<div class="highlight"><code><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span><span class="s2">"http://&lt;node-ip&gt;/api/health"</span></code> <br/></pre></code></div>
<p><strong>Проверка Apache Ignite:</strong></p>
<p><div class="highlight"><code><pre><span></span><code>bash<span class="w"> </span>/usr/share/ignite/bin/control.sh<span class="w"> </span>--baseline</code> <br/></pre></code></div>
&lt;-- требуется предварительная настройка --&gt;</p>
<p><strong>Проверка OpenSearch (Elasticsearch):</strong></p>
<div class="highlight"><code><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span><span class="s2">"localhost:9200/_cluster/health?pretty"</span></code> <br/></pre></code></div>
<p><strong>Проверка Apache Kafka:</strong></p>
<div class="highlight"><code><pre><span></span><code>kafka-topics.sh<span class="w"> </span>--bootstrap-server<span class="w"> </span>localhost:9092<span class="w"> </span>--list</code> <br/></pre></code></div>
<h2 class="pageBreakBefore" id="cluster_recovery_strategic_principles">Стратегические принципы восстановления</h2>
<h3 id="cluster_recovery_preparation_philosophy">Подготовка к авариям</h3>
<p>Чтобы быстрее и надёжнее восстановить систему в случае аварий, рекомендуется регулярно проводить тестирование восстановления:</p>
<ul>
<li>команда должна знать процедуры и не должна тратить время на их изучение;</li>
<li>любые проблемы с восстановлением следует выявлять и устранять в процессе тестирования;</li>
<li>следует подготовить план действий в нештатных ситуациях.</li>
</ul>
<h3 id="cluster_recovery_backup_strategy">Стратегия резервного копирования</h3>
<p><strong>Многоуровневый подход к резервному копированию:</strong></p>
<p>Современные системы требуют многоуровневого подхода к резервному копированию, где каждый уровень решает свои задачи:</p>
<ul>
<li><strong>Полные резервные копии всей системы</strong> (еженедельно для продуктивных систем, ежемесячно для тестовых) — обеспечивают точку восстановления для критических ситуаций.</li>
<li><strong>Инкрементальные копии</strong> (ежедневно для всех систем) — минимизируют потерю данных при ежедневных сбоях.</li>
<li><strong>Копии базы данных Comindware Platform</strong> (каждые 4–12 часов в зависимости от критичности) — обеспечивают быстрое восстановление конфигурации и данных экземпляра ПО.</li>
<li><strong>Различные периоды хранения</strong> (от 1 дня до 1 месяца) — балансируют между требованиями к хранению и стоимостью.</li>
</ul>
<p><strong>Детализированная стратегия резервного копирования по контурам:</strong></p>
<p><strong>Продуктивный контур:</strong>
- <strong>Полные копии</strong>: еженедельно (воскресенье), хранение 1 месяц.
- <strong>Инкрементальные копии</strong>: ежедневно (00:00-03:00), хранение 2 недели.
- <strong>Копии базы данных</strong>: не реже 1 раза в 4 часа, хранение не менее одного дня.
- <strong>Автоматизация</strong>: VEEAM для полных и инкрементальных копий, платформа <strong>Comindware Platform</strong> для платформенных копий.</p>
<p><strong>Предпродуктивный контур:</strong></p>
<ul>
<li><strong>Полные копии</strong>: ежемесячно, хранение 1 месяц.</li>
<li><strong>Инкрементальные копии</strong>: ежедневно (00:00-03:00), хранение 2 недели.</li>
<li><strong>Копии базы данных</strong>: каждые 12 часов, хранение 3 дня.</li>
</ul>
<p><strong>Тестовый контур:</strong>
- <strong>Полные копии</strong>: ежемесячно, хранение 1 месяц.
- <strong>Инкрементальные копии</strong>: ежедневно (00:00-03:00), хранение 2 недели.
- <strong>Копии базы данных</strong>: каждые 8 часов, хранение 2 дня.</p>
<h3 id="cluster_recovery_testing">Тестирование восстановления</h3>
<p>Регулярное тестирование помогает:
- Выявить проблемы в процедурах восстановления
- Обучить команду работе в нештатных ситуациях
- Проверить актуальность резервных копий
- Оценить время восстановления (RTO) и потери данных (RPO)</p>
<p><strong>Сценарии тестирования:</strong></p>
<ul>
<li><strong>Восстановление одного узла</strong> — наиболее частый сценарий, требует регулярного тестирования</li>
<li><strong>Полное восстановление кластера</strong> — критический сценарий, тестируется реже, но более тщательно</li>
<li><strong>Восстановление по приоритету</strong> — проверяет готовность к частичным сбоям</li>
<li><strong>Восстановление в различных условиях</strong> — тестирует устойчивость процедур к различным сценариям</li>
</ul>
<h3 id="cluster_recovery_monitoring_culture">Мониторинг</h3>
<p>Эффективный мониторинг помогает:
- Предотвратить сбои до их возникновения
- Быстро диагностировать проблемы при их возникновении
- Оценить эффективность восстановительных процедур</p>
<p><strong>Компоненты мониторинга:</strong></p>
<ul>
<li><strong>Автоматические уведомления</strong> о критических событиях</li>
<li><strong>Регулярные проверки</strong> состояния компонентов</li>
<li><strong>Журнал инцидентов</strong></li>
<li><strong>Мониторинг резервных копий</strong></li>
</ul>
<h3 id="cluster_recovery_architectures">Специфика восстановления различных архитектур</h3>
<p><strong>Кластер из толстых узлов:</strong></p>
<ul>
<li>Все узлы имеют полную функциональность</li>
<li>Восстановление может выполняться в любом порядке</li>
<li>Убедитесь в правильности конфигурации рабочих процессов</li>
</ul>
<p><strong>Кластер с разноролевыми узлами:</strong></p>
<ul>
<li>Восстанавливайте серверные узлы перед клиентскими</li>
<li>Проверьте конфигурацию тонких клиентов</li>
<li>Убедитесь в доступности серверных узлов для клиентских</li>
</ul>
<p><strong>Кластер с дополнительными узлами Apache Ignite:</strong></p>
<ul>
<li>Восстанавливайте узлы Apache Ignite перед узлами <strong>Comindware Platform</strong></li>
<li>Проверьте топологию кластера Apache Ignite</li>
<li>Убедитесь в правильности конфигурации портов</li>
</ul>
<h3 id="cluster_recovery_component_scenarios">Сценарии восстановления по компонентам</h3>
<p><strong>Восстановление основного узла кластера:</strong></p>
<ul>
<li>Требует полной остановки кластера</li>
<li>Необходима реконфигурация всех дополнительных узлов</li>
<li>Восстановление данных из последней резервной копии</li>
<li>Последовательный запуск узлов с реконфигурацией кластера</li>
</ul>
<p><strong>Восстановление дополнительного узла кластера:</strong></p>
<ul>
<li>Может выполняться без остановки основного узла</li>
<li>Восстановление конфигурации и данных узла</li>
<li>Подключение к существующему кластеру</li>
<li>Синхронизация данных с основным узлом</li>
</ul>
<p><strong>Восстановление инфраструктурных компонентов:</strong></p>
<ul>
<li><strong>Серверы логирования</strong>: восстановление OpenSearch (Elasticsearch) и Apache Kafka</li>
<li><strong>Файловые серверы</strong>: восстановление NFS-сервера и общих директорий</li>
<li><strong>База данных</strong>: восстановление данных экземпляра <strong>Comindware Platform</strong></li>
</ul>
<p><strong>Восстановление по критичности:</strong></p>
<ul>
<li><strong>Критичные компоненты</strong>: основные узлы <strong>Comindware Platform</strong>, база данных</li>
<li><strong>Важные компоненты</strong>: серверы логирования, файловое хранилище</li>
<li><strong>Вспомогательные компоненты</strong>: мониторинг, дополнительные сервисы</li>
</ul>
<h3 id="cluster_recovery_specific_scenarios">Специфические сценарии восстановления</h3>
<p><strong>Полное восстановление основного узла кластера:</strong></p>
<p>При отказе основного узла кластера (например, cmw-node0) требуется полная остановка кластера и последовательное восстановление всех узлов:</p>
<ul>
<li>Остановите все службы на остальных узлах кластера в следующем порядке: NGINX → API Gateway → Comindware Platform → Apache Ignite.</li>
<li>Восстановите основной узел из резервной копию.</li>
<li>Восстановите данные и конфигурацию <strong>Comindware Platform</strong>.</li>
<li>Запустите основной узел и проверьте его работоспособность.</li>
<li>Последовательно восстановите остальные узлы с реконфигурацией кластера.</li>
<li>Выполните проверку целостности данных и работоспособности системы.</li>
</ul>
<p><strong>Полное восстановление дополнительного узла кластера:</strong></p>
<p>При отказе дополнительного узла (например, cmw-node1 или cmw-node2) восстановление может выполняться без остановки основного узла:</p>
<ul>
<li>Восстановите узел из резервной копии</li>
<li>Очистите локальную базу данных узла</li>
<li>Настройте ссылки на общие файлы (Scripts)</li>
<li>Запустите службы в правильном порядке</li>
<li>Выполните реконфигурацию кластера для подключения узла</li>
<li>Проверьте синхронизацию данных с основным узлом</li>
</ul>
<p><strong>Частичное восстановление сервера Comindware Platform:</strong></p>
<p>При незначительных сбоях, не требующих полного восстановления:</p>
<ul>
<li>Проверьте настройки и доступы согласно документации</li>
<li>Перезапустите службы в правильном порядке при необходимости</li>
<li>Проверьте подключение к кластерным компонентам</li>
<li>Убедитесь в работоспособности <strong>Comindware Platform</strong></li>
</ul>
<p><strong>Восстановление сервера логирования:</strong></p>
<ul>
<li><strong>Полное восстановление</strong>: восстановите сервер из резервной копии, службы OpenSearch (Elasticsearch) запустятся автоматически</li>
<li><strong>Частичное восстановление</strong>: проверьте настройки и перезапустите службу OpenSearch (Elasticsearch) при необходимости</li>
</ul>
<p><strong>Восстановление файлового хранилища:</strong></p>
<ul>
<li>Восстановите файловый сервер из резервной копии</li>
<li>Перезапустите службы на всех узлах <strong>Comindware Platform</strong> поочерёдно</li>
<li>Проверьте доступность файлов через веб-интерфейс</li>
<li>Убедитесь в работоспособности управления файлами</li>
</ul>
<p><strong>Восстановление базы данных экземпляра Comindware Platform:</strong></p>
<ul>
<li>Остановите все узлы кластера</li>
<li>Восстановите данные из резервной копии платформы (формат .cdbbz)</li>
<li>Восстановите файлы скриптов и потоков в общее хранилище</li>
<li>Настройте ссылки на общие файлы</li>
<li>Запустите узлы в правильном порядке с реконфигурацией кластера</li>
<li>Проверьте целостность данных и функциональность</li>
</ul>
<h3 id="cluster_recovery_environment_scenarios">Восстановление по типам контуров</h3>
<p><strong>Продуктивный контур:</strong></p>
<ul>
<li>Требует наиболее тщательного планирования и тестирования</li>
<li>Использует полные резервные копии еженедельно</li>
<li>Инкрементальные копии ежедневно</li>
<li>Платформенные копии каждые 4 часа</li>
<li>Максимальный период хранения резервных копий</li>
</ul>
<p><strong>Предпродуктивный контур:</strong></p>
<ul>
<li>Менее критичен, но требует регулярного тестирования</li>
<li>Полные копии ежемесячно</li>
<li>Инкрементальные копии ежедневно</li>
<li>Платформенные копии каждые 12 часов</li>
<li>Средний период хранения резервных копий</li>
</ul>
<p><strong>Тестовый контур:</strong></p>
<ul>
<li>Наименее критичен, но важен для разработки</li>
<li>Полные копии ежемесячно</li>
<li>Инкрементальные копии ежедневно</li>
<li>Платформенные копии каждые 8 часов</li>
<li>Минимальный период хранения резервных копий</li>
</ul>
<h3 id="cluster_recovery_anti_patterns">Практики, которых следует избегать</h3>
<ul>
<li><strong>Не игнорируйте резервное копирование</strong>: нерегулярное или неправильное резервное копирование данных может осложнить восстановление системы после сбоя.</li>
<li><strong>Не пропускайте тестирование восстановления</strong>: невыполнение регулярного тестирования процедур восстановления может привести к неготовности к авариям.</li>
<li><strong>Не восстанавливайте несколько узлов одновременно</strong>: одновременное восстановление нескольких узлов может привести к конфликтам данных.</li>
<li><strong>Не игнорируйте проверки целостности</strong>: всегда проверяйте целостность данных после восстановления.</li>
<li>
<p><strong>Не нарушайте конфигурацию рабочих процессов</strong>: только один узел должен выполнять критические фоновые задачи.</p>
</li>
<li>
<p><strong>Не нарушайте порядок остановки и запуска служб</strong>: неправильный порядок может привести к повреждению данных или неработоспособности кластера.</p>
</li>
<li><strong>Не игнорируйте реконфигурацию кластера</strong>: после восстановления основного узла необходимо реконфигурировать все дополнительные узлы.</li>
<li><strong>Не восстанавливайте компоненты в произвольном порядке</strong>: соблюдайте приоритеты восстановления (критичные → важные → вспомогательные).</li>
</ul>
<div class="relatedTopics">
<h2 id="связанные-статьи">Связанные статьи</h2>
<ul>
<li><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article.php?id=4622">Установка, запуск, инициализация и остановка ПО</a></li>
<li><a class="autorefs autorefs-internal mkdocs_imported_link" href="cluster_upgrade.html#cluster_upgrade" title="Кластер Comindware Platform. Обновление">Обновление кластера Comindware Platform</a></li>
<li><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article.php?id=4659">Системные требования Comindware Platform</a></li>
<li><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article.php?id=4642">Резервное копирование. Настройка и запуск, просмотр журнала сеансов</a></li>
</ul>
</div>
</article>
</div>
</div>
<a class="md-top md-icon mkdocs_imported_link" data-md-component="top" href="#">
<i class="fa-light fa-arrow-up">&zwnj;<!--icon--></i>
            К началу
          </a>
</main>
</div>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": true, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></div>
<h1>Выгрузка вложений в локальную папку на сервере</h1><p>Чтобы сохранить один или несколько вложенных файлов из атрибута типа «<strong>Документ</strong>» в локальную папку <strong>на сервере</strong>, используйте приведённый ниже скрипт в настройках <strong><a href="https://kb.comindware.ru/article.php?id=2276">кнопки</a></strong>.</p>
<p><strong>Здесь:</strong></p>
<p><code>C:\document\</code> — путь для скачивания файлов на сервере;</p>
<p><code>Document</code> — системное имя атрибута типа «<strong>Документ</strong>».</p>
<pre class="source_code_container"><span style="font-size: 8pt;"><code>using System;</code> <br/><code>using System.Collections.Generic;</code> <br/><code>using System.Linq;</code> <br/><code>using Comindware.Data.Entity;</code> <br/><code>using Comindware.TeamNetwork.Api.Data.UserCommands;</code> <br/><code>using Comindware.TeamNetwork.Api.Data;</code> <br/><code>using System.IO;</code> <br/><code>class Script</code> <br/><code>{</code> <br/><code>    public static UserCommandResult Main(UserCommandContext userCommandContext, Comindware.Entities entities)</code> <br/><code>    {</code> <br/><code>        try {</code> <br/><span style="color: #339966;"><em><code><span style="color: #339966;">//Укажите путь для скачивания файлов на сервере<br/></span></code></em><code>              var path = @"C:\document\";</code> <br/><span style="color: #339966;"><em><code><span style="color: #339966;">//"Document" – поменяйте на системное имя своего атрибута типа «Документ»<br/></span></code></em><code>              var data = Api.TeamNetwork.ObjectService.GetPropertyValues(new string[] {userCommandContext.ObjectIds[0]}, new string[] {"Document"});</code> <br/><span style="color: #339966;"><em><code><span style="color: #339966;">//"Document" – поменяйте на системное имя своего атрибута типа «Документ»<br/></span>    </code> </em> <code>        var documentIdsObj = data[userCommandContext.ObjectIds[0]]["Document"];</code> <br/><code>              var documentIds = documentIdsObj as IEnumerable&lt;object&gt;;</code> <br/><code>                  if (documentIds == null)</code> <br/><code>                     {documentIds = new string[] {documentIdsObj as string};}</code> <br/><code>                  foreach (var documentIdObj in documentIds)</code> <br/><code>                          {</code> <br/><code>                           var documentId = documentIdObj as string;</code> <br/><code>                           var documentData = Api.TeamNetwork.DocumentService.GetContent(documentId);</code> <br/><code>                           var documentInfo = Api.TeamNetwork.DocumentService.GetDocument(documentId);</code> <br/><code>                           var docData = new Document</code> <br/><code>                               {</code> <br/><code>                                Title = documentData.Name,</code> <br/><code>                                Extension = documentInfo.Extension</code> <br/><code>                               };</code> <br/><code>                                 var stream = new MemoryStream();</code> <br/><code>                                 stream.Write(documentData.Data, 0, documentData.Data.Length);</code> <br/><code>                                 stream.Seek(0, SeekOrigin.Begin);</code> <br/><code>                                 var filepath = path + documentData.Name;</code> <br/><code>                                 using(FileStream outstr = new FileStream(filepath, FileMode.Create))</code> <br/><code>                                    {</code> <br/><code>                                     stream.CopyTo(outstr);</code> <br/><code>                                     }</code> <br/><code>                                      }</code> <br/><code>                               }</code> <br/><code>                               catch</code> <br/><code>                               {</code> <br/><code>                                var badresult = new UserCommandResult</code> <br/><code>                                    {</code> <br/><code>                                      Success = true,</code> <br/><code>                                      Commited = true,</code> <br/><code>                                      ResultType = UserCommandResultType.DataChange,</code> <br/><code>                                      Messages = new[]</code> <br/><code>                                         {</code> <br/><code>                                          new UserCommandMessage</code> <br/><code>                                            {</code> <br/><code>                                             Severity = SeverityLevel.Normal,</code> <br/><code>                                             Text = "Неудачно"</code> <br/><code>                                              }</code> <br/><code>                                            }</code> <br/><code>                                  };</code> <br/><code>                                  return badresult;</code> <br/><code>                               }</code> <br/><code>                               var result = new UserCommandResult</code> <br/><code>                               {</code> <br/><code>                                 Success = true,</code> <br/><code>                                 Commited = true,</code> <br/><code>                                 ResultType = UserCommandResultType.DataChange,</code> <br/><code>                                 Messages = new[]</code> <br/><code>                                    {</code> <br/><code>                                     new UserCommandMessage</code> <br/><code>                                        {</code> <br/><code>                                         Severity = SeverityLevel.Normal,</code> <br/><code>                                         Text = "Удачно"</code> <br/><code>                                        }</code> <br/><code>                                  }</code> <br/><code>                   };</code> <br/><code>                   return result;</code> <br/><code>    }</code> <br/><code>}</code> </span> </span> </span> </span></pre>
<p> </p>
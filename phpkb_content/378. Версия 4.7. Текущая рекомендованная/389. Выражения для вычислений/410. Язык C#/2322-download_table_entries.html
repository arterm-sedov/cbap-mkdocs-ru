<h1>Выгрузка выбранных записей из пользовательской таблицы</h1><p>Данный скрипт предназначен для скачивания выбранных записей из таблицы, с учетом пользовательской настройки. То есть пользователь на нужной таблице выбирает столбцы и записи, которые должны быть выгружены в Excel. Записи выбираются галочкой в левом крайнем столбце, а столбцы настраиваются через кнопку «<em><strong>Мои настройки</strong></em>»-&gt;«<em><strong>Настроить внешний вид</strong></em>».</p>
<p>Скрипт работает с атрибутами с типом данных:</p>
<ul>
<li>Логический;</li>
<li>Число;</li>
<li>Длительность;</li>
<li>Текст;</li>
<li>Запись;</li>
<li>Дата и время;</li>
<li>Аккаунт.</li>
</ul>
<div>
<table class="source_code_container">
<tbody>
<tr>
<td class="source_code">
<p>using System; <br/>using System.Collections.Generic;<br/>using System.Linq;<br/>using Comindware.Data.Entity;<br/>using Comindware.TeamNetwork.Api.Data.UserCommands;<br/>using Comindware.TeamNetwork.Api.Data;<br/>using Comindware.TeamNetwork.Api.Data.Forms;<br/>using Comindware.Platform.Api.Data;<br/>using System.IO;<br/>using Aspose.Cells;<br/>using Aspose.Cells.Tables;</p>
<p>class Script<br/>{<br/>public static UserCommandResult Main(UserCommandContext userCommandContext, Comindware.Entities entities)<br/>{<br/>var items = userCommandContext.ObjectIds as string[]; //выбранные записи<br/>if(items.Count() &gt; 0)<br/>{<br/>try<br/>{<br/>var listId = userCommandContext.Query.DatasetId; //таблица, на которой нажали на кнопку выгрузки<br/>var paging = userCommandContext.Query.Paging;<br/>var sorting = userCommandContext.Query.Sorting;<br/>var filtr = userCommandContext.Query.Filter;<br/>var containerId = Api.Base.OntologyService.GetAxioms(items.First())["container"].First().ToString(); //получение контейнера по первому значению<br/>var dataTablts = Api.TeamNetwork.DatasetService.GetQueries(containerId); //контейнер</p>
<p>Dataset dataset;<br/>Workbook workbook = new Workbook(); //создание нового файла excel<br/>Worksheet wh = workbook.Worksheets[0];</p>
<p>var style = workbook.CreateStyle(); //стили<br/>var flag = new StyleFlag(); //разрешить числовые типы (2 - число| 22 - дата)<br/>flag.NumberFormat = true;</p>
<p>foreach(var table in dataTablts) //получаем все таблицы контейнера<br/>{<br/>table.Paging = paging;<br/>table.Sorting = sorting;<br/>table.Filter = filtr;<br/>if(table.DatasetId == listId) //идем только по той таблице, на которой нажали на кнопку выгрузки<br/>{<br/>var personaldataset = Api.TeamNetwork.DatasetConfigurationService.GetPersonalDataset(table.DatasetId); //получение персональных настроек таблицы<br/>dataset = Api.TeamNetwork.DatasetService.QueryData(table); //получение значений таблицы (значения + столбцы)<br/>var columnsTabale = new Container[personaldataset.Columns.Count()]; //таблица указатель какие столбцы видны<br/>var i=0; //переменная количества столбцов<br/>foreach(var coll in personaldataset.Columns) //для каждой колонки из пользовательской таблицы <br/>{<br/>if(!coll.IsHidden) //если столбец не скрыт<br/>{ <br/>columnsTabale[i] = new Container(coll.DataSourceInfo.Id, i); //помечаем ячейку как видимую<br/>wh.Cells[0,i].PutValue(coll.Name); //каждое название столбца кладу в ячейку - являются заголовками столбцов<br/>var prop = coll.DataSourceInfo.PropertyPath.Last().ToString(); //получаем op атрибута (иили системное значение для id ...)</p>
<p>if(prop != "id" &amp;&amp; prop != "lastWriteDate" &amp;&amp; prop != "creationDate" &amp;&amp; prop != "В архиве" &amp;&amp; prop != "creator") //для всех не системных атрибутов<br/>{<br/>var propData = Api.Base.OntologyService.GetAxioms(prop); //получаем данные атрибутов<br/>prop = propData["propertyType"].Last().ToString(); //тип атрибута<br/>}</p>
<p>switch(prop) //в зависимости от спец типа разные стили для столбцов<br/>{<br/>case "xsd.decimal":<br/>{<br/>style.Number = 1;<br/>wh.Cells.Columns[i].ApplyStyle(style, flag);<br/>}break;<br/>case "lastWriteDate":<br/>{<br/>style.Number = 22;<br/>wh.Cells.Columns[i].ApplyStyle(style, flag);<br/>wh.Cells.Columns[i].Width = 15;<br/>}break;<br/>case "creationDate":<br/>{<br/>style.Number = 22;<br/>wh.Cells.Columns[i].ApplyStyle(style, flag);<br/>wh.Cells.Columns[i].Width = 15;<br/>}break;<br/>case "xsd.dateTime":<br/>{<br/>style.Number = 22;<br/>wh.Cells.Columns[i].ApplyStyle(style, flag);<br/>wh.Cells.Columns[i].Width = 15;<br/>}break;<br/>}<br/>i++;<br/>}<br/>}<br/>var j=1; // переменная количества строк (0 - заголовки)<br/>var y = 0;<br/>foreach(var coll in dataset.Columns)<br/>{<br/>try<br/>{<br/>var ds = coll.DataSourceInfo.Id;<br/>var t = Array.Find(columnsTabale, x=&gt; x.DS == ds).Id;<br/>columnsTabale[t].Place = y;<br/>}catch{}<br/>y++;<br/>}</p>
<p>foreach(var row in dataset.Rows) //для каждой строки<br/>{<br/>if(Array.Find(items, v =&gt; v == row.Id) != null) //работаем только с выбранными пользователем строками<br/>{<br/>var rowData = row.Data;<br/>for(var jj = 0; jj &lt; i; jj++) //для каждого столбца<br/>{<br/>var ii = columnsTabale[jj].Place;<br/>if(rowData[ii] != null) //если данные есть<br/>{ <br/>if(rowData[ii].GetType() != typeof(Comindware.TeamNetwork.Api.Data.Forms.AccountReference) &amp;&amp; rowData[ii].GetType() != typeof(System.Boolean) &amp;&amp; rowData[ii].GetType() != typeof(Comindware.Platform.Api.Data.Reference)) //если данные не аккаунт или bool<br/>{<br/>wh.Cells[j,jj].PutValue(rowData[ii]);<br/>}<br/>else if (rowData[ii].GetType() == typeof(Comindware.TeamNetwork.Api.Data.Forms.AccountReference)) //если значение аккаунт<br/>{<br/>wh.Cells[j,jj].PutValue(((AccountReference)rowData[ii]).Name);<br/>}<br/>else if(rowData[ii].GetType() == typeof(System.Boolean)) //если значение bool<br/>{<br/>if((bool)rowData[ii])<br/>{<br/>wh.Cells[j,jj].PutValue("Истина");<br/>}<br/>else<br/>{<br/>wh.Cells[j,jj].PutValue("Ложь");<br/>}<br/>}<br/>else if(rowData[ii].GetType() == typeof(Comindware.Platform.Api.Data.Reference))<br/>{<br/>wh.Cells[j,jj].PutValue(((Comindware.Platform.Api.Data.Reference)rowData[ii]).Name);<br/>}<br/>}<br/>}<br/>j++;<br/>}<br/>}<br/>ListObject listObject = wh.ListObjects[wh.ListObjects.Add(0,0, j-1,i-1, true)]; //красота - представление как таблицы<br/>}<br/>}</p>
<p>MemoryStream stream = new MemoryStream();<br/>workbook.Save(stream, SaveFormat.Xlsx);</p>
<p>var result = new UserCommandResult<br/>{<br/>Success = true,<br/>Commited = true,</p>
<p>File=new UserCommandFileResult(){<br/>Content = stream.ToArray(),<br/>Name = "Файл.xlsx"<br/>},</p>
<p>Messages = new[]<br/>{<br/>new UserCommandMessage<br/>{<br/>Severity = SeverityLevel.Normal,<br/>Text = "Успешно"<br/>}<br/>} <br/>};<br/>return result;</p>
<p>}<br/>catch<br/>{<br/>var result1 = new UserCommandResult<br/>{<br/>Success = false,<br/>Commited = true,<br/>Messages = new[]<br/>{<br/>new UserCommandMessage<br/>{<br/>Severity = SeverityLevel.Normal,<br/>Text = "Неудачно"<br/>}<br/>} <br/>};<br/>return result1;<br/>}<br/>}<br/>else<br/>{<br/>var result1 = new UserCommandResult<br/>{<br/>Success = false,<br/>Commited = true,<br/>Messages = new[]<br/>{<br/>new UserCommandMessage<br/>{<br/>Severity = SeverityLevel.Normal,<br/>Text = "Неудачно"<br/>}<br/>} <br/>};<br/>return result1;<br/>}<br/>}</p>
<p>public class Container<br/>{<br/>public int Id {get;set;}<br/>public int Place {get;set;}<br/>public string DS {get;set;}</p>
<p>public Container(string ds , int id )<br/>{<br/>DS = ds; Id = id;<br/>}<br/>}<br/>}</p>
</td>
</tr>
</tbody>
</table>
</div>
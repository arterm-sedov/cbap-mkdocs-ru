<h1>Интеграция с Telegram-ботом. Пример: настройка приложения, Telegram и кода бота</h1><div class="mce-toc">
<h2 class="toc-heading">Содержание</h2>
<ul>
<li><a href="#mcetoc_1huitujaj3">Введение</a></li>
<li><a href="#mcetoc_1hukr3rs30">Прикладная задача</a></li>
<li><a href="#mcetoc_1huitu96r2">Алгоритм взаимодействия</a></li>
<li><a href="#mcetoc_1huitu5d31">Предварительная настройка со стороны Comindware Business Application Platform</a></li>
<li><a href="#mcetoc_1huitu1b50">Настройка интеграции</a></li>
</ul>
</div>
<h2 id="mcetoc_1huitujaj3">Введение</h2>
<p>В этой статье разберём пример того, как настроить интеграцию <strong>Comindware Business Application Platform</strong> и Telegram-бота.</p>
<p>Telegram-бот будет представлять собой проект в Visual Studio на языке C# (Windows Forms Application).</p>
<p>Скачайте готовый проект Visual Studio с исходным кодом бота по ссылке: <a href="https://kb.comindware.ru/file.php?id=191">TelegramBotComindwareIntegration.zip</a></p>
<p>Также можно воспользоваться аналогичным кодом на языке Python в файле <code>TelegramBotComplete.py</code> по ссылке: <a href="https://kb.comindware.ru/file.php?id=193">TelegramBotComindwareIntegrationPython.zip</a></p>
<h2 id="mcetoc_1hul314to0">Прикладная задача</h2>
<p>Требуется создать Telegram-бот, в котором пользователь мог бы взаимодействовать с <strong>Comindware Business Application Platform</strong>.</p>
<p>Перед использованием бота пользователь должен пройти авторизацию следующим образом:</p>
<ul>
<li>При первом обращении бот запрашивает в адрес эл. почты пользователя.</li>
<li>Бот ищет аккаунт с указанным адресом в <strong>Comindware Business Application Platform</strong>.</li>
<li>Если аккаунт найден:
<ul>
<li>бот высылает 4-значный код авторизации на эл. почту пользователя с помощью процесса в <strong>Comindware Business Application Platform</strong>;</li>
<li>бот запрашивает код  авторизации у пользователя в чате</li>
</ul>
</li>
<li>Если пользователь указывает верный код авторизации, авторизация считается пройденной.</li>
</ul>
<h2 id="mcetoc_1huitu96r2">Алгоритм авторизации</h2>
<ul>
<li>На сервере выполняется бот, передающий данные между API Telegram и API <strong>Comindware Business Application Platform</strong>.</li>
<li>Пользователь пишет боту сообщение в Telegram.</li>
<li>Бот предлагает пользователю авторизоваться, указав адрес эл. почты, с которым пользователь зарегистрирован в <strong>Comindware Business Application Platform</strong>.</li>
<li>Пользователь сообщает боту свой адрес эл. почты.</li>
<li>Бот отправляет <em><strong>GET</strong></em>-запрос в <strong>Comindware Business Application Platform</strong> для получения данных аккаунтов в Системе.</li>
<li>Бот получает <em><strong>JSON</strong></em>-ответ с данными аккаунтов и ищет среди них аккаунт с указанным адресом эл. почты.</li>
<li>Если аккаунт найден, выполняется следующая процедура:
<ul style="list-style-type: circle;">
<li>Бот генерирует 4-значный код авторизации.</li>
<li>Бот записывает код авторизации в атрибут аккаунта с помощью <em><strong>POST</strong></em>-запроса.</li>
<li>С помощью <strong><em>POST</em></strong>-запроса бот отправляет эл. письмо пользователю с кодом авторизации.</li>
<li>Пользователь указывает Telegram-боту код авторизации, полученный из эл. письма</li>
</ul>
</li>
<li>Если код, записанный в <strong>Comindware Business Application Platform</strong> и полученный ботом в последнем сообщении совпадают, авторизация считается пройденной.</li>
<li>После прохождения авторизации пользователь может <strong> </strong>посредством бота инициировать действия в  <strong>Comindware Business Application Platform</strong>.</li>
</ul>
<div class="notice notice-info">
<p class="admonition-title">Примечание</p>
<p>На основе созданного промежуточного ПО и примера настройки взаимодействия бота с <strong>Comindware Business Application Platform</strong> можно в дальнейшем реализовать различные сценарии: подача заявок, заявлений на отпуск, запрос какой-либо информации из системы и т.д.</p>
</div>
<h2 id="mcetoc_1huitu5d31">Предварительная настройка со стороны Comindware Business Application Platform</h2>
<ol class="colored_numbers_list">
<li>
<p>Создайте шаблон аккаунта <em>«Sotrudniki»</em> (с таким же системным именем). В этом шаблоне уже есть системные атрибуты, такие как имя, почта и т.д.</p>
</li>
<li>
<p>Добавьте атрибут <em>«ChatID»</em> типа «<strong>Текст</strong>» (в нашем примере ID атрибута — <em>op.13</em>).</p>
</li>
<li>
<p>Добавьте атрибут <em>«Proverochnyykod»</em> типа «<strong>Текст</strong>» (в нашем примере ID атрибута — <em>op.14</em>).</p>
</li>
<li>
<p>Создайте и настройте шаблон процесса для отправки эл. почты пользователю (в нашем примере ID шаблона — <em>pa.3</em>).</p>
<ul>
<li>
<p>В связанном с шаблоном процесса шаблоне записи создайте два атрибута типа «<strong>Текст</strong>»:</p>
<ul>
<li>
<p><em>Код</em> (в нашем примере ID атрибута — <em>op.23</em>) — значение этого атрибута процесс должен отправлять пользователю;</p>
</li>
<li>
<p><em>Кому</em> (в нашем примере ID атрибута — <em>op.24</em>) — адрес, на который процесс должен отправлять код.</p>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<div class="notice notice-info">
<p class="admonition-title">Примечание</p>
<p><span style="letter-spacing: 0.2px;">В исходном коде промежуточного ПО замените ID и системные имена атрибутов и шаблонов на фактически используемые.</span></p>
</div>
<h2 id="mcetoc_1huitu1b50">Настройка интеграции</h2>
<ol class="colored_numbers_list">
<li>В Telegram найдите BotFather (<a href="https://t.me/BotFather">https://t.me/BotFather</a>) и запросите у него создание бота. Подробные инструкции см. в <a href="https://core.telegram.org/api">официальной документации Telegram</a>.</li>
<li>Скачайте и распакуйте проект для Visual Studio с промежуточным ПО по ссылке: <a href="https://kb.comindware.ru/file.php?id=191">TelegramBotComindwareIntegration.zip</a></li>
<li>
<p>Восстановите библиотеки с помощью команды Restore NuGet Packages: Newtonsoft.Json, RestSharp, Telegram.Bot и Telegram.bot.Extensions.Polling.</p>
</li>
<li>При необходимости установите пакет .Net SDK 3.1.</li>
<li>
<p>Откройте файл <code>MainWindow.xaml</code> с формой приложения.</p>
</li>
<li>
<p>Замените в разделе <code>Grid </code>значения атрибутов <code>Text</code> на фактические значения:</p>
<pre class="source_code_container" style="max-height: 400px;"><code><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">Grid</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&gt;</span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">Grid.RowDefinitions</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&gt; </span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">RowDefinition</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">Height</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="0.5*"/&gt;</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">RowDefinition</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">/&gt; </span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">RowDefinition</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">/&gt; </span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">RowDefinition</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">/&gt; </span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">RowDefinition</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">/&gt; </span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;/</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">Grid.RowDefinitions</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&gt; </span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">Button</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Width</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="150"</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Height</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="30"</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Click</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="Button_Click" <span style="font-size: 9.5pt; font-family: Consolas; color: red;">Grid.Row</span>="0"&gt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">Старт</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;/</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">Button</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&gt;</span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">StackPanel</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">Grid.Row</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="1"&gt;</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">Label</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Height</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="25"</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Margin</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="10,5,0,5"&gt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">Токен API Telegram-бота</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;/</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">Label</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&gt;</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">TextBox</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">x</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">:</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;">Name</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="apitoken"</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">Text</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="введите токен API своего Telegram-бота"</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Width</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="240"</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">Height</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="25"/&gt;</span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;/</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">StackPanel</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&gt; </span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">StackPanel</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">Grid.Row</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="2"&gt;</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">Label</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">Height</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="25"</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Margin</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="10,5,0,5"&gt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">Путь к API Comindware Business Application Platform</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;/</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">Label</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&gt;</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">TextBox</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">x</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">:</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;">Name</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="Apipath"</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">Text</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="http://yourinstance/api/public/"</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Width</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="240"</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">Height</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="25" /&gt;</span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;/</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">StackPanel</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&gt; </span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">StackPanel</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">Grid.Row</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="3"&gt;</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">Label</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Height</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="25"</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Margin</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="10,5,0,5"&gt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">Имя пользователя</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;/</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">Label</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&gt;</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">TextBox</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">x</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">:</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;">Name</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="login"</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Text</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="введите имя пользователя, у которого есть доступ к API  Comindware Business Application Platform"</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Width</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="240"</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">Height</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="25" /&gt;</span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;/</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">StackPanel</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&gt; </span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">StackPanel</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">Grid.Row</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="4"&gt;</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">Label</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">Height</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="25"</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Margin</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="10,5,0,5"&gt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">Пароль</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;/</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">Label</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&gt;</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">PasswordBox</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">x</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">:</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;">Name</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="password"</span> <span style="font-size: 9.5pt; font-family: Consolas; color: red;">Password</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="введите пароль пользователя API  Comindware Business Application Platform"</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Width</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="240"</span><span style="font-size: 9.5pt; font-family: Consolas; color: red;"> Height</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">="25" /&gt;</span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&lt;/</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">StackPanel</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">&gt; </span></code> <br/><code><span style="font-size: 9.5pt; line-height: 115%; font-family: Consolas; color: blue;">&lt;/</span><span style="font-size: 9.5pt; line-height: 115%; font-family: Consolas; color: #a31515;">Grid</span><span style="font-size: 9.5pt; line-height: 115%; font-family: Consolas; color: blue;">&gt;</span></code></pre>
<p> </p>
</li>
<li>
<p>Откройте файл <code>MainWindow.xaml.cs</code> с исходным кодом проекта и вставьте в него приведённый ниже код.</p>
<pre class="source_code_container" style="max-height: 400px;"><code><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">using</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> System.Windows;</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">using</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> System;</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">using</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> System.Threading;</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">using</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> System.Threading.Tasks;</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">using</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Telegram.Bot;</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">using</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Telegram.Bot.Extensions.Polling;</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">using</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Telegram.Bot.Types;</span></code> <br/><br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">namespace</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Telegram</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">{ </span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">public</span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">partial</span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">class</span> <span style="font-size: 9.5pt; font-family: Consolas; color: #2b91af;">MainWindow</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> : Window</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">    {</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">static</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> ITelegramBotClient bot;</span></code> <br/><code> </code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">public</span> <span style="font-size: 9.5pt; font-family: Consolas; color: #2b91af;">MainWindow</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">()</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            InitializeComponent();</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        }</span></code> <br/><code> </code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">private</span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">void</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Button_Click(</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">object</span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> sender, RoutedEventArgs e) </span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            bot = </span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">new</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> TelegramBotClient(apitoken.Text);</span></code> <br/><code>            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> cts = </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> new </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> CancellationTokenSource();</span></code> <br/><code>            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> cancellationToken = cts.Token;</span></code> <br/><code>            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> receiverOptions = </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> new </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> ReceiverOptions</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                AllowedUpdates = { }, </span><span style="font-size: 9.5pt; font-family: Consolas; color: green;">// receive all update types</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            };</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            bot.StartReceiving(</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                HandleUpdateAsync,</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                HandleErrorAsync,</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                receiverOptions,</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                cancellationToken</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            );</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            MessageBox.Show(</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">"Бот запущен"</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        }</span></code> <br/><code> </code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">public</span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">async</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Task HandleUpdateAsync(ITelegramBotClient botClient, Update update, CancellationToken cancellationToken)</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        {</span></code> <br/><code>            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">try</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            {</span></code> <br/><code>                <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">if</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (update.Type == Telegram.Bot.Types.Enums.UpdateType.Message)</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                {</span></code> <br/><code>                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> message = update.Message;</span></code> <br/><code>                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">await</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> bot.SendTextMessageAsync(message.Chat.Id, </span> <span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;"> "Вы написали мне: " </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> + message.Text, Telegram.Bot.Types.Enums.ParseMode.Markdown);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                }</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            }</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">catch</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> { }</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        }</span></code> <br/><br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">public</span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">async</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Task HandleErrorAsync(ITelegramBotClient botClient, Exception exception, CancellationToken cancellationToken)</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            MessageBox.Show(</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">"Ошибка "</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> + exception.Message);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        }</span></code> <br/><code><span style="font-size: 9.5pt; line-height: 115%; font-family: Consolas; color: black;">    }}</span></code></pre>
<p> </p>
</li>
<li>
<p>Сохраните файл.</p>
</li>
<li>
<p>Скомпилируйте и запустите приложение.</p>
</li>
<li>В окне приложения нажмите кнопку <em>«Старт»</em> и подтвердите запуск ПО.</li>
<li>Напишите в Telegram-бот сообщение, например: «<em>Привет».</em></li>
<li>
<p>Бот должен ответить: «<em>Вы написали мне:</em> <em>Привет»</em>.</p>
<div class="notice notice-info">
<p class="admonition-title">Примечание</p>
<p>Вы можете воспользоваться аналогичным кодом простейшей реализации бота на языке Python из файла <code>TelegramBotPrimer.py</code> по ссылке: <a href="https://kb.comindware.ru/file.php?id=193">TelegramBotComindwareIntegrationPython.zip</a></p>
</div>
<div class="screenshot_with_caption" style="font-size: 15px !important;">
<p><img alt="Запуск бота" class="img-responsive" height="240" src="https://kb.comindware.ru/assets/img_664f1796168fe.png" width="656"/></p>
<p class="caption" style="font-size: 15px !important;">Запуск бота</p>
</div>
</li>
<li>
<p>Для взаимодействия с <strong>Comindware Business Application Platform</strong> воспользуемся <strong><a href="https://kb.comindware.ru/article.php?id=2073">Solution API</a></strong>.</p>
</li>
<li>
<p>Допишите <code>/Docs/SolutionApi/</code> в адресной строке браузера после адреса экземпляра <strong>Comindware Business Application Platform</strong>.</p>
</li>
<li>
<p>Отобразится страница Swagger с перечнем доступных методов <strong>Solution API</strong>.</p>
<div class="screenshot_with_caption" style="font-size: 15px !important;">
<p><img alt="Переход в область SolutionApi" class="img-responsive" height="483" src="https://kb.comindware.ru/assets/telegram_bot1.png" width="1350"/></p>
<p class="caption" style="font-size: 15px !important;">Переход в область SolutionApi</p>
</div>
<div class="notice notice-info">
<p class="admonition-title">Примечание</p>
<p>На последующих шагах используйте готовый исходный код (<a href="https://kb.comindware.ru/file.php?id=191">TelegramBotComindwareIntegration.zip</a>) или копируйте приведённые ниже фрагменты кода.</p>
</div>
</li>
<li>
<p>Добавьте в файл <code>MainWindow.xaml.cs</code> две функции:</p>
<ul>
<li>
<p><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">Get()</span></code> будет делать <strong><em>GET</em></strong>-запрос для получения данных из шаблона аккаунта <em>«Sotrudniki»</em>. Результатом будет <em><strong>JSON</strong></em>-ответ.</p>
</li>
<li>
<p><span style="letter-spacing: 0.2px;"><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">ValueFromJSON()</span>
</code> будет извлекать из этого ответа нужный атрибут.  </span></p>
<pre class="source_code_container" style="max-height: 400px;"><code><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">private</span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Get(</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> OA_system_name) </span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">{</span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> client = </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> new </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> RestClient(Domain);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">    client.Authenticator = </span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">new</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> HttpBasicAuthenticator(Login, Password);</span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> request = </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> new </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> RestRequest(</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">"solution/"</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> + OA_system_name, Method.Get);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">    request.AddHeader(</span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">"Accept"</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">, </span> <span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;"> "application/json" </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;">);</span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> response = client.Execute(request);</span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">return</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> response.Content;</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">}</span></code> <br/><code> </code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">private</span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> ValueFromJSON(</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> data, </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> attribute_name, </span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> chat_id) </span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">{</span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> doc = JsonDocument.Parse(data);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">    JsonElement root = doc.RootElement;</span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> users = root.EnumerateArray();</span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">while</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (users.MoveNext())</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">    {</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> user = users.Current;</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> props = user.EnumerateObject();</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> value_ = </span> <span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;"> "" </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;">, chat_id_ = </span><span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">""</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">;</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">while</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (props.MoveNext())</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        {</span></code> <br/><code>            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> prop = props.Current;</span></code> <br/><code>            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">if</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (prop.Name.ToLower() == attribute_name.ToLower())</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                value_ = prop.Value.ToString();</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            }</span></code> <br/><code>            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">if</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (prop.Name.ToLower() == </span> <span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;"> "chatid" </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;">)</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                chat_id_ = prop.Value.ToString();</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            }</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        }</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">if</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (chat_id_ == chat_id)</span></code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: black;">{</span></code> <br/><code>            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">return</span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;">value</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">_;</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        }</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">    }</span></code> <br/><code>    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">return</span> <span style="font-size: 9.5pt; font-family: Consolas; color: #a31515;">""</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">;</span></code> <br/><code><span style="font-size: 9.5pt; line-height: 115%; font-family: Consolas; color: black;">}</span></code></pre>
<p> </p>
</li>
</ul>
</li>
<li><span style="letter-spacing: 0.2px;">Теперь при запуске промежуточного ПО Telegram-бот запросит авторизацию.</span></li>
<li>
<p>Реализуем процесс авторизации следующим образом: если пользователь по ChatID не найден, то будем рассматривать 3 варианта:</p>
<ul>
<li>сообщение содержит символ '@', следовательно в сообщении указат адрес эл. почты — запускаем процесс отправки 4-значного кода;</li>
<li>длина сообщения — 4 символа — проверка отправленного кода на соответствие;</li>
<li>во всех остальных случаях бот отвечает: <em>«Укажите адрес эл. почты для авторизации»</em>.</li>
</ul>
</li>
<li>
<p>Добавьте в файл <code>MainWindow.xaml.cs</code> следующую функцию для обработки сообщений от пользователя<span style="letter-spacing: 0.2px;">.</span></p>
<div>
<pre class="source_code_container" style="max-height: 400px;"><code><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">public async</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Task HandleUpdateAsync(ITelegramBotClient botClient, Update update, CancellationToken cancellationToken)</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        {</span></code> <br/><code>            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">try</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            {</span></code> <br/><code>                <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">if</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (update.Type == Telegram.Bot.Types.Enums.UpdateType.Message)</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                {</span></code> <br/><code>                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> message = update.Message;</span></code> <br/><code> </code> <br/><code>                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> data = Get("Sotrudniki");</span></code> <br/><code>                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">if</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (ValueFromJSON(data, "ChatID", message.Chat.Id.ToString()) == "")</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                    {</span></code> <br/><code>                        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">if</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (message.Text.Contains("@"))</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                        {</span></code> <br/><code>                            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> doc = JsonDocument.Parse(data);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                            JsonElement root = doc.RootElement;</span></code> <br/><code>                            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> users = root.EnumerateArray();</span></code> <br/><code>                            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">while</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (users.MoveNext())</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                            {</span></code> <br/><code>                                <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> user = users.Current;</span></code> <br/><code>                                <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> props = user.EnumerateObject();</span></code> <br/><code>                                <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> account_id = "", current_email = "";</span></code> <br/><code>                                <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">while</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (props.MoveNext())</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                {</span></code> <br/><code>                                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> prop = props.Current;</span></code> <br/><code>                                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">if</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (prop.Name.ToLower() == "mbox")</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                        current_email = prop.Value.ToString();</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    }</span></code> <br/><code>                                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">if</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (prop.Name.ToLower() == "id")</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                        account_id = prop.Value.ToString();</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    }</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                }</span></code> <br/><code>                                <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">if</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (current_email.ToLower() == message.Text.ToLower())</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                {</span></code> <br/><code>                                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> symbols = "0123456789";</span></code> <br/><code>                                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> code = "";</span></code> <br/><code>                                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> random = </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> new </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Random();</span></code> <br/><code>                                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">for</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (</span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> int </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> i = 0; i &lt; 4; i++)</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                        code += symbols[random.Next(symbols.Length)].ToString();</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    }</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    // найденному пользователю в системе проставим ChatID с пометкой _NA (т.е. не авторизован)</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    // и сгенерированный 4-х значный код</span></code> <br/><code>                                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> data_ = </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> new </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Dictionary&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">, </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> object </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;">&gt;</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                        {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                            {"op.13", message.Chat.Id.ToString() + "_NA"},//ChatId</span></code> <br/><code>                                            <span style="font-size: 9.5pt; font-family: Consolas; color: black;">{"op.14", code}//Proverochnyykod</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                        };</span></code> <br/><code>                                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> client = </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> new </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> RestClient(Domain);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    client.Authenticator = </span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">new</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> HttpBasicAuthenticator(Login, Password);</span></code> <br/><code>                                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> request = </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> new </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> RestSharp.RestRequest("system/TeamNetwork/ObjectService/Edit", Method.Post); // POST-запрос к найденному пользователю для обновления данных</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    request.AddHeader("content-type", "application/json");</span></code> <br/><code>                                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> sendData = </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> new </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Dictionary&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">, </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> object </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;">&gt;</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                        {"objectId", account_id},</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                        {"objectData", data_ }</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    };</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    request.AddParameter("application/json", JsonSerializer.Serialize(sendData), ParameterType.RequestBody);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    client.Execute(request);</span></code> <br/><code> </code> <br/><code>                                    </code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    // запустим процесс отправки сгенерированного кода на email</span></code> <br/><code>                                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> data_for_proccess = </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> new </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Dictionary&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">, </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> object </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;">&gt;</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                        {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                            {"op.23", code}, // Код</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                            {"op.24", current_email} // Кому</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                        };</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    request = </span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">new</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> RestSharp.RestRequest("system/Process/ProcessObjectService/Create1", Method.Post);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    request.AddHeader("content-type", "application/json");</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    data_ = </span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">new</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Dictionary&lt;string, object&gt;</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                        {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                            {"processAppId", "pa.3"}, // process_id</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                            {"objectName", </span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">null</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">},</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                            {"syncActivityQuantity", 2},</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                            {"objectData", data_for_proccess}</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                        };</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    request.AddParameter("application/json", JsonSerializer.Serialize(data_), ParameterType.RequestBody);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    client.Execute(request);</span></code> <br/><code>                                    </code> <br/><code>                                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">await</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> bot.SendTextMessageAsync(message.Chat.Id, "На указанную почту отправлено письмо с 4-значным кодом, введите его ниже для авторизации");</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                }</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                            }</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                        }</span></code> <br/><code>                        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">else</span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">if</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (message.Text.Length == 4)</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                        {</span></code> <br/><code>                            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">value</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> = ValueFromJSON(data, "Proverochnyykod", message.Chat.Id.ToString() + "_NA");</span></code> <br/><code>                            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">if</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> (message.Text == </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> value </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;">)</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                            {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                // у ChatID убираем пометку "_NA" и очищаем поле "Проверочный код"</span></code> <br/><code>                                <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> data_ = </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> new </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Dictionary&lt;</span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">, </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> object </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;">&gt;</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                        {"op.13", message.Chat.Id.ToString()},//ChatId</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                        {"op.14", null}//Proverochnyykod</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    };</span></code> <br/><code>                                <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> client = new RestClient(Domain);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                client.Authenticator = </span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">new</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> HttpBasicAuthenticator(Login, Password);</span></code> <br/><code>                                <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">value</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> = ValueFromJSON(data, "id", message.Chat.Id.ToString() + "_NA");</span></code> <br/><code>                                <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> request = </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> new </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> RestSharp.RestRequest("system/TeamNetwork/ObjectService/Edit", Method.Post);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                request.AddHeader("content-type", "application/json");</span></code> <br/><code>                                <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">var</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> sendData = </span> <span style="font-size: 9.5pt; font-family: Consolas; color: blue;"> new </span> <span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Dictionary&lt;string, object&gt;</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    {"objectId", </span><span style="font-size: 9.5pt; font-family: Consolas; color: blue;">value</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;">},</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                    {"objectData", data_}</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                };</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                request.AddParameter("application/json", JsonSerializer.Serialize(sendData), ParameterType.RequestBody);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                                client.Execute(request);</span></code> <br/><code>                                <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">await</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> bot.SendTextMessageAsync(message.Chat.Id, "Вы успешно авторизованы");</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                            }</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                        }</span></code> <br/><code>                        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">else</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                        {</span></code> <br/><code>                            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">await</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> bot.SendTextMessageAsync(message.Chat.Id, "Укажите адрес эл. почты для авторизации");</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                        }</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                    }</span></code> <br/><code>                    <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">else</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                    {</span></code> <br/><code>                        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">string</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> name = ValueFromJSON(data, "fullName", message.Chat.Id.ToString());</span></code> <br/><code>                        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">await</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> bot.SendTextMessageAsync(message.Chat.Id, "Добрый день, " + name + "! Вы успешно авторизованы");</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                    }</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">                }</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            }</span></code> <br/><code>            <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">catch</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> { }</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        }</span></code> <br/><code> </code> <br/><code>        <span style="font-size: 9.5pt; font-family: Consolas; color: blue;">public async</span><span style="font-size: 9.5pt; font-family: Consolas; color: black;"> Task HandleErrorAsync(ITelegramBotClient botClient, Exception exception, CancellationToken cancellationToken)</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        {</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">            MessageBox.Show("Ошибка " + exception.Message);</span></code> <br/><code><span style="font-size: 9.5pt; font-family: Consolas; color: black;">        }</span></code></pre>
</div>
<div> </div>
<p> </p>
</li>
<li>
<p><span style="letter-spacing: 0.2px;">Протестируйте работу промежуточного ПО и Telegram-бота.</span></p>
<div class="screenshot_with_caption" style="font-size: 15px !important;">
<p><img alt="Авторизация через бот" class="img-responsive" height="351" src="https://kb.comindware.ru/assets/img_664f17cea8721.png" width="655"/></p>
<p class="caption" style="font-size: 15px !important;">Авторизация через бот</p>
</div>
</li>
</ol>
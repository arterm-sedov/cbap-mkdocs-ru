---
title: Резервное копирование и восстановление Comindware Business Application Platform. Краткое руководство для ОС Windows
kbId: 2101
---

# Резервное копирование и восстановление {{ productName }}. Краткое руководство для ОС Windows

## Введение

В этой статье представлены инструкции по резервномму копированию и восстановлению данных **{{ productName }}** в ОС Windows.

### Определения

**Продукт** — программное обеспечение **{{ productName }}**.

**Экземпляр продукта** — развернутый сервер с продуктом **{{ productName }}**.

**Elasticsearch** — система журналирования в составе **{{ productName }}**.

**Снимок** — набор данных, сохранённый на определённый момент времени.

## 1. Подготовка к резервному копированию и восстановлению данных

Для создания резервных копий и восстановления из них данных {{ productName }} необходимо подготовить конфигурацию резервного копирования, как указано ниже.

**1.1.** Подготовьте следующие данные о конфигурации экземпляра продукта:

- Название экземпляра продукта — `InstanceId`(например, `CBAP4.2`).
- Путь к папке с базой данных экземпляра продукта, например `DatabasePath` (по умолчанию: `C:\ProgramData\Comindware\Instances\InstanceId\Data`).
- Путь к папке резервных копий базы данных — `DatabaseBackupPath` (например, `С:\DatabaseBackups`).
- Имя репозитория снимков Elasticsearch — *`repository_name`* (например, `elastic_backup`).
- Путь к репозиторию снимков Elasticsearch — `elastic_backup_path`(например, `e:\elastic_backup`).
- Имя снимка Elasticsearch — `snapshot_name` (например, `InstanceId01022022080800` — в формате `<InstanceId><Date><Time>`). См. инструкции Elasticsearch по формированию имён снимков с использованием текущей даты  (на английском языке): <https://www.elastic.co/guide/en/elasticsearch/reference/current/api-conventions.html#api-date-math-index-names>.

**1.2.** Настройте конфигурацию репозитория снимков сервера Elasticseach.

**1.2.1.** Откройте файл `elasticsearch.yml` в папке с данными конфигурации Elasticseach (например: `C:\ElasticsearchData`)

**1.2.2.** В файле `elasticsearch.yml` и добавьте директиву `path.repo` и через двоеточие укажите путь к репозиторию снимков (папке с резервными копиями), например: 

`path.repo: elastic_backup_path`

## 2. Порядок резервного копирования данных экземпляра продукта

Данные экземпляра продукта хранятся в двух независимых друг от друга хранилищах: на сервере Elasticsearch и в папке с базой данных экземпляра продукта — `DatabasePath` ([см. параграф 1.1](#P1.1)).

Так как осуществить одновременное резервное копирование двух хранилищ не представляется возможным, резервное копирование данных из каждого хранилища выполняется отдельно в два этапа и в отдельные папки:

1. [Создание снимка сервера Elasticsearch](#mcetoc_1g7edvirt0) — данные истории и мониторинга копируются в отдельную папку.
2. [Сохранение резервной копии базы данных экземпляра продукта](#mcetoc_1g7ee4cdh1) в папку *`DatabaseBackupPath`* ([см. параграф 1.1](#P1.1)).

## 3. Выполнение резервного копирования

### 3.1. Регистрация репозитория и создание снимка Elasticsearch

**3.1.1.** Чтобы зарегистрировать репозиторий, выполните следующую команду, указав в URL имя репозитория `repository_name` ([см. параграф 1.1](#P1.1)), а в параметре `location` — путь к репозиторию из директивы `path.repo` в файле конфигурации сервера Elasticsearch [(см. параграф 1.2.2](#P1.2.2)):

`curl -X PUT "localhost:9200/_snapshot/repository_name?pretty" -H 'Content-Type: application/json' -d' {"type": "fs", "settings": {"location": "elastic_backup_path"}}'`

Подробные сведения о регистрации репозитория Elasticsearch см. в официальной документации (на английском языке): <https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-register-repository.html>

**3.1.2.** Чтобы создать снимок Elasticsearch, выполните следующую команду, указав имя снимка `snapshot_name` ([см. параграф 1.1](#P1.1)), а в параметре `indices` — индексы, которые требуется включить в снимок (индексы {{ productName }} имеют префикс, например, `cmw_<InstanceId>_`):

`curl -X PUT "localhost:9200/_snapshot/repository_name/snapshot_name?wait_for_completion=true&pretty" -H 'Content-Type: application/json' -d' {"indices": "cmw_<InstanceId>_*", "ignore_unavailable": true, "include_global_state": false}'`

Подробные сведения о создании снимка Elasticsearch см. в официальной документации (на английском языке): <https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-take-snapshot.html>

### 3.2. Сохранение резервной копии базы данных экземпляра продукта

**3.2.1.** В экземпляре продукта откройте раздел «**Администрирование**» — «**Инфраструктура**» — «**Резервное копирование**».

**3.2.2.** Нажмите кнопку «**Создать**» в списке конфигураций резервного копирования.

_![Создание новой конфигурации резервного копирования](https://kb.comindware.ru/assets/img_6321d80a2b32d.png)_

**3.2.3.** В окне «**Новая конфигурация резервного копирования**»:

1. В поле «**Название**» укажите наглядное название конфигурации (например, «`Резервная копия InstanceId`»).
2. В поле «**Путь к файлу**» укажите путь к файлу резервной копии в папке `DatabaseBackupPath` на сервере ([см. параграф 1.1](#P1.1)).
3. В поле «**Имя файла**» укажите имя файла резервной копии (например, `Backup`).
4. Установите флажки «**С файлами**» и «**Со скриптами**».
5. Нажмите кнопку «**Сохранить**».

_![Настройка новой конфигурации резервного копирования](https://kb.comindware.ru/assets/img_6321d7573245a.png)_

**3.2.4.** Запустите резервное копирование:

1. В списке конфигураций резервного копирования с помощью флажка выбора выберите созданную на [шаге 3.2.3](#P3.2.3) конфигурацию.
2. Нажмите кнопку «**Запустить копирование**».

_![Запуск резервного копирования](https://kb.comindware.ru/assets/img_6321d902288c2.png)_
3. В фоновом режиме начнется процесс резервного копирования.
4. Прогресс и результат резервного копирования можно просмотреть в журнале резервного копирования, выбрав вкладку «**Журнал**» над списком конфигураций резервного копирования.
5. В процессе резервного копирования к имени файла, указанному [на шаге 3.2.3.3](#P3.2.3.3) будут добавлена метка времени в формате `ГГГГММДДЧЧММ` и расширение `CDBBZ`, например для имени файла `Backup`: `Backup``.202202161625.cdbbz`

![Переход к журналу резервного копирования](https://kb.comindware.ru/assets/img_6321dbd1da164.png)

*Переход к журналу резервного копирования*

## 4. Порядок восстановления данных экземпляра продукта

Данные экземпляра продукта хранятся в трех независимых друг от друга хранилищах:  сервере Apache Ignite, сервере Elasticsearch и папке `DatabaseBackupPath` ([см. параграф 1.1](#P1.1)). Поэтому восстановление осуществляется последовательно для каждого хранилища.

**ВАЖНО**! Восстановление следует выполнять при остановленном экземпляре продукта.

Восстановление данных из резервных копий выполняется в два этапа:

1. [Восстановление снимка сервера Elasticsearch](#mcetoc_1g7eehk6m6).
2. [Восстановление базы данных экземпляра продукта](#mcetoc_1g7eej4fc7) из папки `DatabaseBackupPath` ([см. параграф 1.1](#P1.1)).

## 5. Выполнение восстановления

### 5.2. Восстановление снимка Elasticsearch

**5.2.1.** Выполните следующую команду, указав имя репозитораия `repository_name` и имя снимка `snapshot_name` ([см. параграф 1.1](#P1.1)):

`curl -X POST "localhost:9200/_snapshot/repository_name/snapshot_name/_restore?pretty"`

Подробные сведения о восстановлении снимков Elasticsearch см. в официальной документации (на английском языке): <https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-restore-snapshot.html>

### 5.3. Восстановление базы данных экземпляра продукта

**5.3.1.** Восстановите базу данных экземпляра продукта согласно инструкциям в статье «[Восстановление экземпляра продукта из резервной копии][admin_utility_instance_backup_restore]».

## 6. Проверка конфигурации экземпляра ПО

6.1. Запустите экземпляр ПО.

6.2. При необходимости откроется страница настройки подключения к службе Elasticsearch.

6.3. В поле «URI» введите адрес автоматически своего сервера Elasticsearch.

6.4. Введите **префикс индекса**, **имя пользователя** и **пароль сервера Elasticsearch**. .

6.5. Нажмите кнопку «**Далее**».

_![Настройка подключения к Elasticsearch](https://kb.comindware.ru/assets/Picture16.png)_

6.6. При необходимости откроется страница инициализации данных в Elasticsearch.

6.7. Нажмите кнопку «**Обновить**».

_![Страница инициализации данных в Elasticsearch](https://kb.comindware.ru/assets/Picture17.png)_

6.8. Дождитесь открытия начальной страницы **{{ productName }}**.

6.9. Откройте страницу «**Администрирование**» — «**Подключения**».

_![Переход к свойства подключения к Elasticsearch](https://kb.comindware.ru/assets/img_64d09fd6ec3ba.png)_

6.10. Откройте подключение к серверу Elasticsearch.

6.11. Удостоверьтесь, что корректно указаны **префикс индекса** и **URL подключения** к серверу Elasticsearch.

_![Свойства подключения к серверу Elasticsearch](https://kb.comindware.ru/assets/img_64d0a41fc5e0b.png)_

6.12. Откройте страницу «**Администрирование**» — «**Глобальная конфигурация**».

6.13. Удостоверьтесь, что указан корректный **URL-адрес сервера**.

_![URL-адрес сервера в глобальной конфигурации](https://kb.comindware.ru/assets/img_64d0a4feebc80.png)_

6.14. Откройте страницу «**Администрирование**» — «**Резервное копирование**».

6.15. Удостоверьтесь, что в конфигурациях резервного копирования правильно указаны пути для сохранения резервных копий.

_![Путь к папке резервных копий в конфигурации резервного копирования](https://kb.comindware.ru/assets/img_64d0a5817d06a.png)_

6.16. При необходимости измените конфигурации резервного копирования, указав корректные пути к файлам.

_![Настройка пути к файлам резервной копии](https://kb.comindware.ru/assets/img_64d0a5f075838.png)_



{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

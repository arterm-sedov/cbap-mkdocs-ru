---
title: Получение документов из «СФЕРА Курьер». Настройка подключения, пути передачи данных и сценария
kbId: 5061
---

# Получение документов из «СФЕРА Курьер». Настройка подключения, пути передачи данных и сценария

## Введение

В **{{ productName }}** можно настроить подключение к системе электронного документооборота «СФЕРА Курьер». Интеграция с этой системой позволяет:

- осуществлять поиск контрагентов по реквизитам и проверять корректность реквизитов;
- осуществлять обмен документами с контрагентами;
- производить с документами и квитанциями различные действия:
    - создавать,
    - отправлять,
    - подписывать,
    - принимать,
    - отзывать,
    - аннулировать,
    - отклонять;
- подписывать документы квалифицированной электронной подписью;
- контролировать сроки подписания документов.

## Прикладная задача

Здесь приведён пример настройки подключения, пути передачи данных, шаблона записи и сценария для получения документов из системы «СФЕРА Курьер».

Имеется шаблон *«Реестр документов из СФЕРА Курьер»*, в котором хранятся сведения о документах, полученных через «СФЕРА Курьер».

Требуется настроить автоматизированное получение новых документов.

## Порядок настройки

1. Настройте [подключение](#настройка-подключения-для-получения-id-документов) типа «**Получение сообщений из системы «СФЕРА Курьер**».
2. Настройте [путь передачи данных](#настройка-пути-передачи-данных-для-получения-id-документов) «**Приём сообщений из «СФЕРА Курьер**», использующий созданное подключение.
3. Настройте [подключение](#configure_connection_send_request) типа «**Отправка сообщений в систему «СФЕРА Курьер**».
4. Настройте [путь передачи данных](#настройка-пути-передачи-данных-для-запроса-документов-из-сфера-курьер) «**Отправка сообщений в «СФЕРА Курьер**» типа «**Получить документ**», использующий созданное подключение.
5. Настройте [шаблон записи](#настройка-шаблона-записи) для хранения данных электронных документов.
6. Настройте [сценарий](#настройка-сценария) для получения данных о контрагенте из системы «СФЕРА Курьер».

Совет

Из-за особенностей API «СФЕРА Курьер» при получении сообщений могут приходить не все атрибуты электронного документа. Чтобы получить недостающие атрибуты, отправьте дополнительный запрос с ID требуемого документа в «СФЕРА Курьер». Пример такого запроса приведён ниже в инструкциях по [настройке сценария](#настройка-сценария).

## Настройка подключения для получения ID документов

1. Откройте страницу «**Администрирование**» — «**[Подключения][connections]**».
2. В списке подключений откройте или создайте подключение типа «**Пользовательские подключения**» — «**Получение сообщений из системы «СФЕРА Курьер**».

3. Настройте свойства подключения:

    - **Системное имя** — введите уникальное имя подключения.
    - **Отключить** — установите этот флажок, если требуется временно деактивировать данное подключение.
    - **Описание** — введите наглядное описание подключения.
    - **Запись в файловые журналы** — выберите, какие события следует записывать в журналы:
        - **Полные сведения об обработке сообщения**;
        - **Только ошибки**;
        - **Отключить** — не регистрировать в журнале события отправки сообщений.
    - **Тестовый сервер** — установите этот флажок, чтобы настроить подключение к тестовому серверу.
    - **Интервал запроса данных, в минутах** — укажите интервал запроса к серверу.
    - **ApiKey** — введите ключ API для подключения к «СФЕРА Курьер».
    - **Имя пользователя** — укажите учётную запись для подключения к «СФЕРА Курьер».
    - **Пароль** — введите пароль для подключения к «СФЕРА Курьер».
    - **Идентификатор участника ЭДО получателя документа** — укажите идентификатор, присвоенный участнику «СФЕРА Курьер».
4. Нажмите кнопку «**Проверить соединение**» и удостоверьтесь, что соединение установлено.
5. Чтобы просмотреть журнал событий отправки сообщений, нажмите кнопку «**Скачать журнал**».
6. Сохраните подключение.

## Настройка пути передачи данных для получения ID документов

1. Откройте страницу «**Администрирование**» — «**[Пути передачи данных][communication_routes]**».
2. Откройте двойным нажатием в списке или создайте путь передачи данных типа «**Пользовательские подключения**» — «**Приём сообщений из «СФЕРА Курьер**».
3. Настройте свойства пути передачи данных на следующих вкладках:

    - [**Основные свойства**](#основные-свойства)
    - [**Атрибуты сообщений**](#атрибуты-сообщений)
    - [**Интеграция**](#интеграция)
4. Сохраните путь передачи данных.

### Основные свойства

На вкладке «**Основные свойства**» настройте параметры использования пути передачи данных.

- **Подключение** — выберите [подключение для отправки сообщений в систему «СФЕРА Курьер»](#configure_connection_send_request).
- **Системное имя** — введите уникальное имя пути передачи данных.
- **Отключить** — установите этот флажок, если требуется временно деактивировать данный путь передачи данных.
- **Описание** — введите наглядное описание пути передачи данных.
- **Номер шины данных** — выберите номер от 0 до 3, если требуется распределить потоки данных нескольких путей для повышения производительности.

### Атрибуты сообщений

На вкладке «**Атрибуты сообщения**» настройте атрибуты, значения которых будут подставляться в содержимое сообщений в зависимости от его типа.

1. Выберите **тип сообщения**:

    - **Найти документы**;
    - **Перечислить компании по ИНН**.В примере используется тип сообщения «**"Найти документы**».
2. В таблицах «**Запрос**», «**Ответ**» и «**Ответ с ошибкой**» отобразятся готовые атрибуты, соответствующие выбранному **типу сообщения**.

Подробные сведения об атрибутах, которые используются при обмене сообщениями с системой «СФЕРА Курьер», см. в *[Справочном руководстве API СФЕРА Курьер](https://www.esphere.ru/assets/download/integration/ws-courier.pdf)*.

### Интеграция

На вкладке «**Интеграция**» задайте статические параметры запроса к системе «СФЕРА Курьер»:

- Для типа сообщения «**"Найти документы**»:
    - **Папка документов** — укажите название папки в «СФЕРА Курьер» для поиска документов.
    - **Количество строк** — укажите максимальное количество документов, которые могут быть получены в одном запросе.
    - **Идентификатор статуса** — укажите идентификатор статуса искомого документа в «СФЕРА Курьер».
    - **Признак завершённости документооборота** — установите флажок для поиска документа с этим признаком.
    - **Признак того, что документ назначен текущему пользователю** — установите флажок для поиска документа с этим признаком.
    - **Номер договора** — укажите номер договора для поиска документа в «СФЕРА Курьер».
    - **Имя файла** — укажите имя файла для поиска документа в «СФЕРА Курьер».
    - **Идентификатор участника маршрута** — укажите уникальный идентификатор участника системы электронного документооборота (ЭДО).
    - **Идентификатор группы участников маршрута** — укажите уникальный идентификатор группы участников системы электронного документооборота (ЭДО).
    - Укажите **даты** для поиска документа в «СФЕРА Курьер».
- Для типа сообщения «**Перечислить компании по ИНН**»:
    - **ИНН клиента** — укажите ИНН клиента для поиска в «СФЕРА Курьер».
    - **ОГРН клиента** — укажите ОГРН клиента для поиска в «СФЕРА Курьер».
    - **КПП клиента** — укажите КПП клиента для поиска в «СФЕРА Курьер».

## Настройка подключения для запроса документов из «СФЕРА Курьер»

1. Откройте страницу «**Администрирование**» — «**[Подключения][connections]**».
2. В списке подключений откройте или создайте подключение типа «**Пользовательские подключения**» — «**Отправка сообщений в систему «СФЕРА Курьер**».
3. Настройте свойства подключения:

    - **Системное имя** — введите уникальное имя подключения.
    - **Отключить** — установите этот флажок, если требуется временно деактивировать данное подключение.
    - **Описание** — введите наглядное описание подключения.
    - **Запись в файловые журналы** — выберите, какие события следует записывать в журналы:
        - **Полные сведения об обработке сообщения**;
        - **Только ошибки**;
        - **Отключить** — не регистрировать в журнале события отправки сообщений.
    - **Тестовый сервер** — установите этот флажок, чтобы настроить подключение к тестовому серверу.
    - **Интервал запроса данных, в минутах** — укажите интервал запроса к серверу.
    - **ApiKey** — введите ключ API для подключения к «СФЕРА Курьер».
    - **Имя пользователя** — укажите учётную запись для подключения к «СФЕРА Курьер».
    - **Пароль** — введите пароль для подключения к «СФЕРА Курьер».
    - **Идентификатор участника ЭДО получателя документа** — укажите идентификатор, присвоенный участнику «СФЕРА Курьер».
4. Нажмите кнопку «**Проверить соединение**» и удостоверьтесь, что соединение установлено.
5. Чтобы просмотреть журнал событий отправки сообщений, нажмите кнопку «**Скачать журнал**».
6. Сохраните подключение.

## Настройка пути передачи данных для запроса документов из «СФЕРА Курьер»

1. Откройте страницу «**Администрирование**» — «**[Пути передачи данных][communication_routes]**».
2. Откройте двойным нажатием в списке или путь передачи данных типа «**Пользовательские подключения**» — «**Отправка сообщений в «СФЕРА Курьер**» типа «**Зачитывает данные об организации**.
3. Настройте свойства пути передачи данных на следующих вкладках:

    - [**Основные свойства**](#configure_communication_route_send_request_main_properties)
    - [**Атрибуты сообщения**](#configure_communication_route_send_request_message_attributes)
4. Сохраните путь передачи данных.

### Основные свойства

На вкладке «**Основные свойства**» настройте параметры использования пути передачи данных.

- **Подключение** — выберите [подключение для отправки сообщений в систему «СФЕРА Курьер»](#configure_connection_send_request).
- **Системное имя** — введите уникальное имя пути передачи данных.
- **Отключить** — установите этот флажок, если требуется временно деактивировать данный путь передачи данных.
- **Описание** — введите наглядное описание пути передачи данных.
- **Номер шины данных** — выберите номер от 0 до 3, если требуется распределить потоки данных нескольких путей для повышения производительности.

### Атрибуты сообщений

На вкладке «**Атрибуты сообщения**» настройте атрибуты, значения которых будут подставляться в содержимое сообщений в зависимости от его типа.

1. Выберите **тип сообщения** «**Получить документ**»:
2. В таблицах «**Запрос**», «**Ответ**» и «**Ответ с ошибкой**» отобразятся готовые атрибуты, соответствующие выбранному **типу сообщения**.

Подробные сведения об атрибутах, которые используются при обмене сообщениями с системой «СФЕРА Курьер», см. в *[Справочном руководстве API СФЕРА Курьер](https://www.esphere.ru/assets/download/integration/ws-courier.pdf)*.

## Настройка шаблона записи

1. Создайте шаблон записи *«Реестр документов из СФЕРА Курьер»* со следующими атрибутами:

    - *Идентификатор документа «СФЕРА Курьер»* типа «**Текст**»;
    - *Электронный договор* типа «**Логический**»;
    - *Сумма документа* типа «**Число**»;
    - *Сумма НДС* типа «**Число**»;
    - *Номер документа контрагента* типа «**Текст**»;
    - *Дата документа контрагента* типа «**Дата и время**»;
    - *Документ* типа «**Документ**».
2. Поместите атрибуты на **основную форму**.

## Настройка сценария

1. Создайте сценарий:

    - **Название:** *Получение документов из СФЕРА Курьер*
    - **Контекст выполнения: от инициатора**
2. Настройте событие сценария:

    - **Тип: получение сообщения**
    - **Контекстный шаблон:** *Реестр документов из СФЕРА Курьер*
    - **Подключение:** выберите [подключение для получения сообщения из системы «СФЕРА Курьер»](#настройка-подключения-для-получения-id-документов)
    - **Путь передачи данных:** выберите [путь передачи данных для получения сообщений из системы «СФЕРА Курьер» типа «**"Найти документы**»](#настройка-пути-передачи-данных-для-получения-id-документов)
    - **Имя переменной:** *Message*
3. Добавьте действие «**Изменить значения переменных**»:

    - **Операция со значениями переменных: добавить**
    - **Набор переменных:** *Request*
    - Добавьте переменную *DocumentId* со **значением** на **N3**:````
# Импортируем функции для работы с переменными
@prefix session: <http://comindware.com/ontology/session#>.
@prefix variable: <http://comindware.com/ontology/session/variable#>.
{
    # Получаем значение локальной переменной Message и помещаем в ?message
    session:context variable:Message ?message.
    # Из ?message получаем ID документа и возвращаем его
    ?message variable:Id ?value.
}

````
4. Добавьте действие «**Отправить сообщение**» со следующими свойствами:

    - **Подключение:** выберите [подключение для запроса документов из «СФЕРА Курьер»](#configure_connection_send_request)
    - **Путь передачи данных:** выберите [путь передачи данных для для запроса документов из «СФЕРА Курьер» типа «**Получить документ**»](#настройка-пути-передачи-данных-для-запроса-документов-из-сфера-курьер)
    - **Переменная с сообщением:** *Request*
    - **Переменная для успешного ответа:** *Response*
    - **Переменная для ответа с ошибкой:** *Error*
5. Добавьте действие «**Изменить значения переменных**» со следующими свойствами:

    - **Операция со значениями переменных: добавить**
    - **Набор переменных:** *Document*
    - добавьте следующие переменные:
    
    
        - *Content* со **значением** на **N3**:
        
        
        ````
        # Импортируем функции для работы с переменными
        @prefix session: <http://comindware.com/ontology/session#>.
        @prefix variable: <http://comindware.com/ontology/session/variable#>.
        
        {
            # Получаем значение локальной переменной Response и помещаем в ?response
            session:context variable:Response ?response.
            # Из ?response получаем документ и помещаем в ?document
            ?response variable:Content ?document.
            # Из ?document получаем содержимое документа и возвращаем его
            ?document variable:Content ?value.
        }
        
        ````
        - *Name* со **значением** на **N3**:
        
        
        ````
        # Импортируем функции для работы с переменными
        @prefix session: <http://comindware.com/ontology/session#>.
        @prefix var: <http://comindware.com/ontology/session/variable#>.
        
        {
            # Получаем значение локальной переменной Response и помещаем в ?response
            session:context var:Response ?response.
            # Из ?response получаем документ и помещаем в ?document
            ?response var:Content ?document.
            # Из ?document получаем имя файла документа и возвращаем его
            ?document var:Filename ?value.
        }
        
        ````
6. Добавьте действие «**Выполнить по условиям**» со следующими параметрами:

    - **Название условия:** *NotHaveDocument*
    - **Выражение: N3**````
# Импортируем функции для работы с переменными и атрибутами
@prefix object: <http://comindware.com/ontology/object#>.
@prefix variable: <http://comindware.com/ontology/session/variable#>.
@prefix session: <http://comindware.com/ontology/session#>.
@prefix cmwui: <http://comindware.com/ontology/ui#>.
@prefix assert: <http://comindware.com/logics/assert#>.
{
    # Получаем значение локальной переменной Response и помещаем в ?response
    session:context variable:Response ?response.
    # Получаем из ?response ID документа и помещаем его в ?docId
    ?response variable:Id ?docId.
    # Приводим ?docId к строковому типу и помещаем в ?docIdStr
    ?docId cmwui:toClientString ?docIdStr.
    # Находим атрибут idDokumentaEDO (Идентификатор документа «СФЕРА Курьер»)
    # в шаблоне Reestrdokumentov (Реестр документов из СФЕРА Курьер)
    ("Reestrdokumentov" "idDokumentaEDO") object:findProperty ?foundIds.

    # Сравниваем ?foundIds и ?docIdStr на предмет совпадений
    {?coincidence ?foundIds ?docIdStr.} assert:count ?countCoincidence.
    # Если совпадений нет (т.е. ID документа из полученного сообщения
    # не встречается в шаблоне «Реестр документов из СФЕРА Курьер»)
    if {?countCoincidence == 0}
    # возвращаем значение true
    then {true -> ?value.}.
}

````
7. Внутрь действия «**Выполнить по условиям**» поместите действие «**Создать запись**» и выберите **целевой шаблон** *«Реестр документов из СФЕРА Курьер»*.
8. Внутрь действия «**Создать запись**» поместите действие «**Прикрепить документ к атрибуту**» со следующими свойствами:

    - **Атрибут:** *Документ*
    - **Операция со значениями: добавить**
    - **Значение: формула**````
$$Document

````
9. Внутрь действия «**Создать запись**» поместите действие «**Изменить значения атрибутов**» со следующими свойствами:

| Атрибут  Операция со значениями  Значение | | |
| --- | --- | --- |
| *Идентификатор документа «СФЕРА Курьер»* | **Заменить** | **N3:** ```` # Импортируем функции для работы с переменными @prefix variable: <http://comindware.com/ontology/session/variable#>. @prefix session: <http://comindware.com/ontology/session#>. @prefix ui: <http://comindware.com/ontology/ui#>. {     # Получаем значение локальной переменной Response     # и помещаем в ?response     session:context variable:Response ?response.     # Получаем из ?response ID документа и помещаем его в ?docId     ?response variable:Id ?docId.     # Приводим ?docId к строковому типу и возвращаем значение ID     ?docId ui:toClientString ?value. }  ```` |
| *Электронный договор* | **Заменить** | **Формула:** `true` |
| *Сумма документа* | **Заменить** | **Формула:** `$$Response->TotalSum` |
| *Сумма НДС* | **Заменить** | **Формула:** `$$Response->VatSum` |
| *Номер документа контрагента* | **Заменить** | **Формула:** `$$Response->Number` |
| *Дата документа контрагента* | **Заменить** | **Формула:** `$$Response->Date` |

_![Сценарий получения документов из «СФЕРА Курьер»](/platform/v5.0/administration/connections_communication_routes/custom_connections/img/esphere_receive_configure_scenario.png)_

## Тестирование

1. С помощью системы «СФЕРА Курьер» отправьте документ пользователю, API-ключ которого используется для [интеграции со «СФЕРА Курьер»](#порядок-настройки).
2. Перейдите к записям шаблона *«Реестр документов из СФЕРА Курьер»*.
3. В списке должна отобразиться новая запись.
4. Перейдите к новой записи и посмотрите полученные данные. К записи должен быть прикреплён документ и должны быть заполнены поля атрибутов.

--8<-- "related_topics_heading.md"

- *[Отправка документов через «СФЕРА Курьер»][esphere_send_configure]*
- *[Подключения. Определения, типы, создание, настройка, удаление][connections]*
- *[Пути передачи данных][communication_routes]*

[*‌*
 К началу](#)

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

---
title: HTTP-запросы. Получение JSON-данных. Настройка подключения, пути передачи данных и сценария
kbId: 4700
---

# HTTP-запросы. Получение JSON-данных. Настройка подключения, пути передачи данных и сценария

## Введение

**{{ productName }}** может получать и обрабатывать HTTP-запросы из внешних систем.

Здесь представлен пример настройки подключения, пути передачи данных и сценария для получения и обработки HTTP-запроса в формате JSON с данными заказов.

Настройка для обработки XML и простого текста будет аналогичной.

Логика обработки входящих HTTP-запросов

- Для получения HTTP-запросов из внешних систем **{{ productName }}** позволяет настроить конечные точки API вида:

````
https://<instanceUrl>/api/public/adapter/<connectionUri>/<routeUri>

````
Здесь:

    - `<instanceUrl>` — адрес экземпляра **{{ productName }}**;
    - `<connectionUri>` — путь URI, настроенный в свойствах подключения для получения HTTP-запросов;
    - `<routeUri>` — путь URI, настроенный в свойствах пути передачи данных для получения HTTP-запросов.
- При поступлении HTTP-запроса на настроенную конечную точку **{{ productName }}** запускает сценарий по событию «**Получение сообщения**» и передаёт в него данные запроса.

Аутентификация для доступа к {{ productName }} по HTTP

- Для базовой аутентификации при отправке HTTP-запросов в **{{ productName }}** следует использовать учётные данные аккаунта, который имеет разрешение на **вызовы API**. По умолчанию такое разрешение имеют аккаунты с **системной ролью** «**Системные администраторы**».

При базовой аутентификации для безопасной обработки входящих HTTP-запросов рекомендуется:

    - создать специальный аккаунт для авторизации HTTP-запросов;
    - создать системную роль с разрешением на **вызовы API**;
    - добавить в данную системную роль аккаунт для HTTP-запросов.См. *[Аккаунты][accounts]* и *[Системные роли][system_roles]*.
- Кроме того, можно использовать аутентификацию посредством ключей API. См. *[Ключи аутентификации API][authentication_keys]*.

См. также *«[HTTP-запросы с составным содержимым. Получение файлов в сценарии][http_receive_file]»*

## Прикладная задача

- Имеется шаблон записи *«Заказы»*, с атрибутами:
    - *Номер* типа «**Число**»
    - *Клиент* типа «**Текст**»
    - *Товар* типа «**Текст**»
- Внешний сервер отправляет в **{{ productName }}** HTTP-запросы с данными в формате JSON следующего вида:

````
{
    "ListZakazov":[
        {
            "Zakaz":{
                "Client": "STRING",
                "Nomer": "NUMBER",
                "Tovar": "STRING"
            }
        }
    ]
}

````
- Требуется настроить получение c внешнего сервера HTTP-запросов с данными заказов.
- При получении HTTP-запроса требуется создать запись в шаблоне *«Заказы»* и заполнить её полученными данными.

Примечание

Здесь не рассматривается проверка полученных данных на уникальность и совпадение с имеющимися в записях.

## Порядок настройки получения HTTP-запросов

1. Настройте [подключение](#настройка-подключения) для получения HTTP-запросов.
2. Настройте [путь передачи данных](#настройка-пути-передачи-данных) для получения HTTP-запросов.
3. Настройте [сценарий](#настройка-сценария) для обработки входящих HTTP-запросов.
4. [Проверьте работоспособность](#тестирование) настроенной конфигурации.

## Настройка подключения

1. На странице «**Администрирование**» выберите пункт «**Инфраструктура**» — «[**Подключения**][connections]» *‌*.
2. Откройте или создайте подключение типа «**Подключения REST и OData**» — «**Получение HTTP-запросов**».
3. Настройте подключение к серверу:

    - **Системное имя** — введите уникальное имя подключения.
     Не должно начинаться с цифры. Разрешены английские и русские буквы, цифры и символ «\_». Рекомендуется использовать английские буквы.
    - **Отключить** — установите этот флажок, если требуется временно деактивировать данное подключение.
    - **Описание** — введите наглядное описание подключения, например *«Подключение для получения заказов HTTP»*.
    - **Запись в файловые журналы** — выберите, какие события следует записывать в журналы:
        - **Полные сведения об обработке сообщения**;
        - **Только ошибки**;
        - **Отключить** — не регистрировать в журнале события получения запросов.
    - **Базовый путь получения HTTP-запросов** — добавьте **путь URI**, например `uploadData`. При необходимости введите дополнительный **путь URI** на вкладке «**Интеграция**» в свойствах [пути передачи данных](#настройка-пути-передачи-данных). Укажите результирующий путь на внешнем сервере в качестве получателя запроса, например:
    
    
    ````
    https://example.com/api/public/adapter/uploadData
    
    ````
    - **Формат данных** — выберите представление данных:
    
    
        - **JSON** — используется в данном примере;
        - **XML**;
        - **Простой текст**.
    - **Тип аутентификации** — выберите способ проверки подлинности, используемый сервером:
        - **Отсутствует**;
        - **Базовая**;
        - **Аутентификация Windows**.
4. Сохраните подключение.

## Настройка пути передачи данных

1. Откройте страницу «**Администрирование**» — «**Архитектура**» или страницу «**Администрирование**» приложения.
2. Выберите пункт «[**Пути передачи данных**][communication_routes]» *‌*.
3. Откройте или создайте путь передачи данных типа «**Подключения REST и OData**» — «**Получение HTTP-запросов**».
4. Настройте свойства пути передачи данных на следующих вкладках:

    - [**Основные свойства**](#основные-свойства)
    - [**Атрибуты сообщений**](#атрибуты-сообщений)
    - [**Интеграция**](#интеграция)
5. Сохраните путь передачи данных.

### Основные свойства

На вкладке «**Основные свойства**» настройте параметры использования пути передачи данных:

- **Подключение** — выберите [подключение для получения HTTP-запросов](#настройка-подключения).
- **Системное имя** — введите уникальное имя пути передачи данных.
 Не должно начинаться с цифры. Разрешены английские и русские буквы, цифры и символ «\_». Рекомендуется использовать английские буквы.
- **Отключить** — установите этот флажок, если требуется временно деактивировать путь передачи данных.
- **Описание** — введите наглядное описание пути передачи данных, например *«Получение заказов по HTTP»*.
- **Номер шины данных** — выберите номер от 0 до 3, если требуется распределить потоки данных нескольких путей для повышения производительности.

### Атрибуты сообщений

Составление атрибута сообщения типа «Объект»

Чтобы составить **атрибут сообщения** типа «**Объект**» для хранения структурированных данных, необходимо создать структуру из родительского и дочерних атрибутов:

- Создайте атрибут типа «**Объект**», задайте его имя, но оставьте значение пустым.
- Установите флажок у имени родительского атрибута в таблице и нажмите кнопку «**Добавить**».
- Дважды нажмите значок *‌* рядом с родительским атрибутом.
- В таблице отобразится строка дочернего атрибута.
- Задайте системное имя и тип дочернего атрибута.

1. Выберите **тип сообщения** «**Обработка HTTP-запросов**».
2. В таблице «**Запрос**» сопоставьте данные HTTP-запроса с атрибутами **{{ productName }}**, то есть воссоздайте структуру JSON входящего запроса:

    - В таблицу «**Запрос**» добавьте атрибут *ListZakazov* типа «**Объект**». Установите флажок «**Массив**», так как этот атрибут будет содержать массив данных по всем заказам. **Системное имя** должно совпадать с именем соответствующего поля HTTP-запроса.
    - В атрибут *FileObject* добавьте дочерний атрибут *Zakaz* типа «**Объект**». Он будет содержать данные по одному заказу.
    - В атрибут *Zakaz* добавьте следующие дочерние атрибуты:

| Системное имя | Тип | Описание |
| --- | --- | --- |
| *Nomer* | **Число** | Номер заказа |
| *Client* | **Строка** | Название клиента |
| *Tovar* | **Строка** | Название товара |

**Системные имена** этих атрибутов должны совпадать с именами соответствующих полей HTTP-запроса.

_![Настройка атрибутов сообщения](/platform/v5.0/administration/connections_communication_routes/rest_odata_connections/img/json3.jpg)_
3. При необходимости настройте **ответ** — здесь можно составить структуру JSON, которая будет отправляться в ответе на запрос после его успешной обработки, и ответ с ошибкой — структуру JSON для ответа на запрос, при обработке которого произошла ошибка.

### Интеграция

1. При необходимости укажите дополнительный суффикс в поле «**Путь URI**». Этот суффикс будет добавлен к URL-адресу в поле «**Базовый путь получения HTTP-запросов**» (совпадает с путём, настроенным в [подключении](#настройка-подключения)). Укажите результирующий адрес на внешнем сервере в качестве получателя запросов, например:

````
https://example.com/api/public/adapter/uploadData

````
2. Укажите **атрибуты для десериализации данных**. По умолчанию следует указать `$` в обоих столбцах, чтобы получить всю структуру JSON из запроса. Для поиска определенного атрибута используйте JSONPath.
3. При необходимости укажите **атрибут для заголовков**, в котором будут содержаться все атрибуты заголовков запроса, **атрибут для параметров запроса**, в котором будут содержаться все параметры запроса, и **атрибут для тела запроса**, в котором будет содержаться всё тело запроса.

_![Настройка интеграции](/platform/v5.0/administration/connections_communication_routes/rest_odata_connections/img/json4.png)_

## Настройка сценария

1. Создайте новый сценарий *«Обработка заказов»*.
2. У начального события измените тип на «**Получение сообщения**» и настройте его:

    - **Контекстный шаблон:** *Заказы*
    - **Подключение:** [подключение для получения HTTP-запросов](#настройка-подключения)
    - **Путь передачи данных:** [путь передачи данных для получения HTTP-запросов](#настройка-пути-передачи-данных)
    - **Имя переменной:** *Request*
3. Добавьте действие «**Повторять по количеству объектов**» со следующими свойствами:

- **Имя переменной:** *local*
- **Атрибут или выражение для поиска объектов: N3**

````
# Импортируем функции для работы
# с данными текущего сеанса и переменными
@prefix session: <http://comindware.com/ontology/session#>.
@prefix var: <http://comindware.com/ontology/session/variable#>.
{
    # Request — переменная из первого блока,
    # в которой находится разобранный JSON
    session:context var:Request ?req.
    # ListZakazov - переменная,
    # в которой находится массив объектов
    ?req var:ListZakazov ?value.
}

````

4. Внутрь действия «**Повторять по количеству объектов**» добавьте действие «**Создать запись**» и укажите шаблон записи *«Заказы»*.
5. Внутрь действия «**Создать запись**» добавьте действие «**Изменить значения атрибутов**».
6. В действии «**Изменить значения атрибутов**» на вкладке «**Дополнительно**» установите флажок «**Сбрасывать кэш значений**».
7. На вкладке «**Основные**» настройте следующие атрибуты::

| Атрибут | Операция со значениями | Значение |
| --- | --- | --- |
| *Клиент* | **Заменить** | **Формула:** `$$local—Zakaz—Client` |
| *Номер* | **Заменить** | **Формула:** `$$local—Zakaz—Nomer` |
| *Товар* | **Заменить** | **Формула:** `$$local—Zakaz—Tovar` |

Примечание

Переменная `$$local` — хранит значение текущего объекта итерации. Пример:

````
{
    "Zakaz":{
        "Client": "Петров",
        "Nomer": 54,
        "Tovar": "Яблоко"
    }
}

````
Переменная `$$local—>Zakaz` содержит данные заказа из текущего объекта итерации. Пример:

````
{
    "Client": "Петров",
    "Nomer": 54,
    "Tovar": "Яблоко"
}

````
Переменная `$$local—>Zakaz—>Tovar` содержит данные о товаре по заказу из текущего объекта итерации. Пример:

````
"Яблоко"

````
8. Получившийся сценарий должен выглядеть следующим образом:

_![Сценарий обработки заказа](/platform/v5.0/administration/connections_communication_routes/rest_odata_connections/img/json10.png)_

## Тестирование

1. С внешнего сервера отправьте в **{{ productName }}** запрос с данными заказов, например:

````
curl -X POST \\
    -u username:password \\
    -H "Content-Type: application/json" \\
    -d '{
        "ListZakazov": [
            {
                "Zakaz": {
                    "Client": "Петров",
                    "Nomer": 54,
                    "Tovar": "Яблоко"
                }
            },
            {
                "Zakaz": {
                    "Client": "Иванов",
                    "Nomer": 60,
                    "Tovar": "Банан"
                }
            },
            {
                "Zakaz": {
                    "Client": "Сидоров",
                    "Nomer": 61,
                    "Tovar": "Груша"
                }
            }
        ]
    }' \\
    https://example.com/api/public/adapter/uploadData
    - v

````
Здесь:

    - `-X POST` — метод запроса (необязательный ключ);
    - `-u username:password` — базовая аутентификация c учётными данными аккаунта с разрешением на **вызовы API** **{{ productName }}**;
    - `-H "Content-Type: application/json"` — заголовок, указывающий на формат данных JSON;
    - `-d '...'` — тело запроса с JSON-структурой;
    - `https://example.com/api/public/adapter/uploadData` — **базовый путь получения HTTP-запросов** и **путь URI**, настроенные в [пути передачи данных](#настройка-пути-передачи-данных);
    - `-v` — вывод отладочных данных (необязательный ключ).
2. Проверьте обработку запроса: должны быть созданы записи в шаблоне *«Заказы»*, соответствующие полученному запросу, как показано на иллюстрации:

_![Полученные заказы](/platform/v5.0/administration/connections_communication_routes/rest_odata_connections/img/json9.jpg)_

--8<-- "related_topics_heading.md"

- *[HTTP-запросы с составным содержимым. Получение файлов в сценарии][http_receive_file]*
- *[HTTP-запросы типа POST. Отправка составного содержимого и файлов](http_send_file.html#http_send_file)*
- *[Сценарии][scenarios]*
- *[Аккаунты][accounts]*
- *[Системные роли][system_roles]*
- *[Ключи аутентификации API][authentication_keys]*

[*‌*
 К началу](#)

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

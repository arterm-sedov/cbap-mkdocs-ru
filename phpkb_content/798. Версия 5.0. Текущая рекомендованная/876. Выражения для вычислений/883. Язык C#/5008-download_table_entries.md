---
title: Выгрузка выбранных записей из пользовательской таблицы
kbId: 5008
---

# Выгрузка выбранных записей из пользовательской таблицы

Данный скрипт предназначен для скачивания выбранных записей из таблицы, с учетом пользовательской настройки. То есть пользователь на нужной таблице выбирает столбцы и записи, которые должны быть выгружены в Excel. Записи выбираются галочкой в левом крайнем столбце, а столбцы настраиваются через кнопку «***Мои настройки***»->«***Настроить внешний вид***».

Скрипт работает с атрибутами с типом данных:

- Логический;
- Число;
- Длительность;
- Текст;
- Запись;
- Дата и время;
- Аккаунт.

| using System; using System.Collections.Generic;using System.Linq;using Comindware.Data.Entity;using Comindware.TeamNetwork.Api.Data.UserCommands;using Comindware.TeamNetwork.Api.Data;using Comindware.TeamNetwork.Api.Data.Forms;using Comindware.Platform.Api.Data;using System.IO;using Aspose.Cells;using Aspose.Cells.Tables; class Script{public static UserCommandResult Main(UserCommandContext userCommandContext, Comindware.Entities entities){var items = userCommandContext.ObjectIds as string[]; //выбранные записиif(items.Count() > 0){try{var listId = userCommandContext.Query.DatasetId; //таблица, на которой нажали на кнопку выгрузкиvar paging = userCommandContext.Query.Paging;var sorting = userCommandContext.Query.Sorting;var filtr = userCommandContext.Query.Filter;var containerId = Api.Base.OntologyService.GetAxioms(items.First())["container"].First().ToString(); //получение контейнера по первому значениюvar dataTablts = Api.TeamNetwork.DatasetService.GetQueries(containerId); //контейнер Dataset dataset;Workbook workbook = new Workbook(); //создание нового файла excelWorksheet wh = workbook.Worksheets[0]; var style = workbook.CreateStyle(); //стилиvar flag = new StyleFlag(); //разрешить числовые типы (2 - число| 22 - дата)flag.NumberFormat = true; foreach(var table in dataTablts) //получаем все таблицы контейнера{table.Paging = paging;table.Sorting = sorting;table.Filter = filtr;if(table.DatasetId == listId) //идем только по той таблице, на которой нажали на кнопку выгрузки{var personaldataset = Api.TeamNetwork.DatasetConfigurationService.GetPersonalDataset(table.DatasetId); //получение персональных настроек таблицыdataset = Api.TeamNetwork.DatasetService.QueryData(table); //получение значений таблицы (значения + столбцы)var columnsTabale = new Container[personaldataset.Columns.Count()]; //таблица указатель какие столбцы видныvar i=0; //переменная количества столбцовforeach(var coll in personaldataset.Columns) //для каждой колонки из пользовательской таблицы {if(!coll.IsHidden) //если столбец не скрыт{ columnsTabale[i] = new Container(coll.DataSourceInfo.Id, i); //помечаем ячейку как видимуюwh.Cells[0,i].PutValue(coll.Name); //каждое название столбца кладу в ячейку - являются заголовками столбцовvar prop = coll.DataSourceInfo.PropertyPath.Last().ToString(); //получаем op атрибута (иили системное значение для id ...) if(prop != "id" && prop != "lastWriteDate" && prop != "creationDate" && prop != "В архиве" && prop != "creator") //для всех не системных атрибутов{var propData = Api.Base.OntologyService.GetAxioms(prop); //получаем данные атрибутовprop = propData["propertyType"].Last().ToString(); //тип атрибута} switch(prop) //в зависимости от спец типа разные стили для столбцов{case "xsd.decimal":{style.Number = 1;wh.Cells.Columns[i].ApplyStyle(style, flag);}break;case "lastWriteDate":{style.Number = 22;wh.Cells.Columns[i].ApplyStyle(style, flag);wh.Cells.Columns[i].Width = 15;}break;case "creationDate":{style.Number = 22;wh.Cells.Columns[i].ApplyStyle(style, flag);wh.Cells.Columns[i].Width = 15;}break;case "xsd.dateTime":{style.Number = 22;wh.Cells.Columns[i].ApplyStyle(style, flag);wh.Cells.Columns[i].Width = 15;}break;}i++;}}var j=1; // переменная количества строк (0 - заголовки)var y = 0;foreach(var coll in dataset.Columns){try{var ds = coll.DataSourceInfo.Id;var t = Array.Find(columnsTabale, x=> x.DS == ds).Id;columnsTabale[t].Place = y;}catch{}y++;} foreach(var row in dataset.Rows) //для каждой строки{if(Array.Find(items, v => v == row.Id) != null) //работаем только с выбранными пользователем строками{var rowData = row.Data;for(var jj = 0; jj < i; jj++) //для каждого столбца{var ii = columnsTabale[jj].Place;if(rowData[ii] != null) //если данные есть{ if(rowData[ii].GetType() != typeof(Comindware.TeamNetwork.Api.Data.Forms.AccountReference) && rowData[ii].GetType() != typeof(System.Boolean) && rowData[ii].GetType() != typeof(Comindware.Platform.Api.Data.Reference)) //если данные не аккаунт или bool{wh.Cells[j,jj].PutValue(rowData[ii]);}else if (rowData[ii].GetType() == typeof(Comindware.TeamNetwork.Api.Data.Forms.AccountReference)) //если значение аккаунт{wh.Cells[j,jj].PutValue(((AccountReference)rowData[ii]).Name);}else if(rowData[ii].GetType() == typeof(System.Boolean)) //если значение bool{if((bool)rowData[ii]){wh.Cells[j,jj].PutValue("Истина");}else{wh.Cells[j,jj].PutValue("Ложь");}}else if(rowData[ii].GetType() == typeof(Comindware.Platform.Api.Data.Reference)){wh.Cells[j,jj].PutValue(((Comindware.Platform.Api.Data.Reference)rowData[ii]).Name);}}}j++;}}ListObject listObject = wh.ListObjects[wh.ListObjects.Add(0,0, j-1,i-1, true)]; //красота - представление как таблицы}} MemoryStream stream = new MemoryStream();workbook.Save(stream, SaveFormat.Xlsx); var result = new UserCommandResult{Success = true,Commited = true, File=new UserCommandFileResult(){Content = stream.ToArray(),Name = "Файл.xlsx"}, Messages = new[]{new UserCommandMessage{Severity = SeverityLevel.Normal,Text = "Успешно"}} };return result; }catch{var result1 = new UserCommandResult{Success = false,Commited = true,Messages = new[]{new UserCommandMessage{Severity = SeverityLevel.Normal,Text = "Неудачно"}} };return result1;}}else{var result1 = new UserCommandResult{Success = false,Commited = true,Messages = new[]{new UserCommandMessage{Severity = SeverityLevel.Normal,Text = "Неудачно"}} };return result1;}} public class Container{public int Id {get;set;}public int Place {get;set;}public string DS {get;set;} public Container(string ds , int id ){DS = ds; Id = id;}}} |
| --- |

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}

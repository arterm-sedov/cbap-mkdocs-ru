<h1>Изменение статусов в коллекции и завершение пользовательской задачи</h1><p>Для того, чтобы по кнопке можно было менять статус записей в коллекции в зависимости от определенного условия и завершать связанную с основной записью пользовательскую задачу, введите следующее выражение:</p>
<div>
<table class="source_code_container">
<tbody>
<tr>
<td class="source_code"> 
<p>using System;<br/>using System.Collections.Generic;<br/>using System.Linq;<br/>using Comindware.Data.Entity;<br/>using Comindware.TeamNetwork.Api.Data.UserCommands;<br/>using Comindware.TeamNetwork.Api.Data;<br/>public class Script<br/>{<br/>    public static UserCommandResult Main(UserCommandContext userCommandContext, Comindware.Entities entities)<br/>    {<br/>        var objectId = userCommandContext.ObjectIds.FirstOrDefault();<br/>        var data = Api.TeamNetwork.ObjectService.GetWithAlias("Register", objectId);<br/>        object[] Applications = data["Applications"] as object[];<br/>        var allApplications = new List&lt;string&gt;();</p>
<p>        foreach (var app in Applications)<br/>        {<br/>            var apps = app as string;<br/>            allApplications.Add(apps);<br/>        }</p>
<p>        var LevelRef = data["RegisterLevel"];<br/>        var Level = Api.TeamNetwork.ObjectService.GetWithAlias("RegisterLevels", LevelRef as string);<br/>        var LevelNum = (decimal)Level["Level"];</p>
<p>        if (LevelNum == 1)<br/>        {<br/>            var approvedStatus = entities.ApplicationStatus.Where(x =&gt; x.Name == "Согласована в первом реестре").Select(x =&gt; x.id).FirstOrDefault();<br/>            foreach(var a in allApplications) <br/>            {<br/>                var data1 = new Dictionary&lt;string, object&gt;<br/>                {<br/>                    { "Status", approvedStatus}<br/>                };<br/>                Api.TeamNetwork.ObjectService.EditWithAlias("Application", a, data1);<br/>            }<br/>        }<br/>        else<br/>        {<br/>            var approvedStatus = entities.ApplicationStatus.Where(x =&gt; x.Name == "Согласована во втором реестре").Select(x =&gt; x.id).FirstOrDefault();<br/>            foreach(var a in allApplications) <br/>            {<br/>                var data1 = new Dictionary&lt;string, object&gt;<br/>                {<br/>                    { "Status", approvedStatus}<br/>                };<br/>                Api.TeamNetwork.ObjectService.EditWithAlias("Application", a, data1);<br/>            }<br/>        }<br/>        <br/>        var result = new UserCommandResult<br/>        {<br/>            Success = true,<br/>            Commited = true,<br/>            ResultType = UserCommandResultType.Navigate,<br/>            NavigationResult = new UserCommandNavigationResult<br/>            {<br/>                Title = "Register",<br/>                ObjectId = objectId,<br/>                ContainerId = "oa.13",<br/>                Context = ContextType.Record <br/>            },<br/>            Messages = new[]<br/>            {<br/>                new UserCommandMessage<br/>                {<br/>                    Severity = SeverityLevel.Normal,<br/>                    Text = "Register approved"<br/>                    }<br/>            }<br/>        };<br/>        var activeTask = Api.Process.ProcessObjectService.GetReferencedTasks(objectId).Where(x =&gt; x.Status == UserTaskStatus.InProgress).FirstOrDefault().Id;<br/>        Api.TeamNetwork.UserTaskService.Complete(activeTask, true);<br/>        return result;<br/>    }<br/>}</p>
</td>
</tr>
</tbody>
</table>
</div>
<p><span style="text-decoration: underline;"><strong>где:</strong></span></p>
<p><strong>Register</strong> - системное имя текущего Шаблона записи;</p>
<p><strong>Applications</strong> - системное имя атрибута типа Коллекция в текущем Шаблоне записи;</p>
<p><strong>RegisterLevel</strong> - системное имя атрибута типа Ссылка в текущем Шаблоне записи (для условия);</p>
<p><strong>RegisterLevels</strong> - системное имя Шаблона записи, на который ссылается RegisterLevel <span style="color: #333333; font-family: 'Open Sans', sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 100; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: #ffffff; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">(для условия)</span>;</p>
<p><strong>Level</strong> - системное имя атрибута типа Число в Шаблоне записи RegisterLevels <span style="color: #333333; font-family: 'Open Sans', sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 100; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: #ffffff; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">(для условия);</span></p>
<p><strong>Согласована в первом реестре / Согласована во втором реестре</strong> - значение статуса для записи в коллекции, на которое нужно поменять статус при выполнении условия;</p>
<p><strong>Application</strong> - системное имя Шаблона записи, на который ссылается Applications;</p>
<p><strong>Status</strong> - системное имя атрибута типа Ссылка в Шаблоне записи Application, значение которого нужно поменять;</p>
<p><strong>oa.13</strong> - ИД текущего Шаблона записи для навигации;</p>
<p><strong>Register approved</strong> - текст сообщения при успешном выполнении операции.</p>
<div class="blue_note"><strong>Примечание :</strong> скрипт работает только с одной записью (выбирает первую запись, если на списке было выбрано несколько элементов). Для обработки нескольких записей скрипт нужно дописать.</div>